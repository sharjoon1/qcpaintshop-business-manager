<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192x192.png">
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
    <title>My Profile - Quality Colours</title>
    <script src="/js/auth-helper.js"></script>
    <script>checkAuthOrRedirect();</script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/css/design-system.css">
    <script src="/universal-nav-loader.js"></script>
    <style>
        .section-card { background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 24px; margin-bottom: 20px; }
        .section-title { font-size: 15px; font-weight: 700; color: #1f2937; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        .section-title svg { width: 20px; height: 20px; color: #667eea; }
        .field-label { font-size: 12px; font-weight: 600; color: #6b7280; margin-bottom: 4px; display: block; }
        .field-input { width: 100%; padding: 9px 14px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px; outline: none; transition: border 0.2s, box-shadow 0.2s; }
        .field-input:focus { border-color: #667eea; box-shadow: 0 0 0 3px rgba(102,126,234,0.15); }
        .field-input:disabled { background: #f9fafb; color: #6b7280; cursor: not-allowed; }
        .status-badge { display: inline-flex; align-items: center; gap: 6px; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .status-complete { background: #d1fae5; color: #065f46; }
        .status-incomplete { background: #fef3c7; color: #92400e; }
        .aadhar-preview { max-width: 100%; max-height: 200px; object-fit: contain; border-radius: 8px; border: 1px solid #e5e7eb; }
        .toast { position: fixed; top: 20px; right: 20px; padding: 14px 24px; border-radius: 10px; color: white; font-weight: 600; font-size: 14px; z-index: 1000; transform: translateX(120%); transition: transform 0.3s ease; }
        .toast.show { transform: translateX(0); }
        .toast-success { background: #059669; }
        .toast-error { background: #dc2626; }
    </style>
</head>
<body class="bg-gray-50" data-page="profile">
    <!-- Toast -->
    <div id="toast" class="toast"></div>

    <div class="max-w-4xl mx-auto p-4 sm:p-6" style="padding-top: 1.5rem;">
        <!-- Profile Header -->
        <div class="bg-gradient-to-r from-purple-600 to-indigo-600 rounded-xl shadow-lg p-6 sm:p-8 mb-6 text-white">
            <div class="flex flex-col sm:flex-row items-center sm:items-start gap-5">
                <div class="relative">
                    <div class="w-28 h-28 bg-white rounded-full flex items-center justify-center shadow-xl">
                        <img id="profilePreview" src="" alt="Profile" class="w-full h-full rounded-full object-cover hidden">
                        <span id="profileInitial" class="text-purple-600 text-3xl font-bold">S</span>
                    </div>
                    <label class="absolute bottom-0 right-0 bg-white text-purple-600 rounded-full p-2 shadow-lg cursor-pointer hover:bg-gray-100 transition">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                        <input type="file" id="profilePicture" accept="image/*" class="hidden" onchange="handleImageUpload(event)">
                    </label>
                </div>
                <div class="text-center sm:text-left flex-1">
                    <h2 class="text-2xl font-bold mb-1" id="displayName">Loading...</h2>
                    <p class="text-purple-200 mb-1 text-sm" id="displayRole">Staff</p>
                    <p class="text-sm text-purple-100" id="displayEmail">Loading...</p>
                    <p class="text-xs text-purple-200 mt-2">Member since: <span id="memberSince">-</span></p>
                </div>
                <!-- Completion status -->
                <div class="text-center sm:text-right">
                    <div class="text-xs text-purple-200 mb-1">Profile Completion</div>
                    <div class="text-2xl font-bold" id="completionPercent">0%</div>
                    <div class="w-24 h-2 bg-purple-400 rounded-full mt-2 mx-auto sm:ml-auto sm:mr-0">
                        <div id="completionBar" class="h-full bg-white rounded-full transition-all" style="width:0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section Status Overview -->
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-6">
            <div class="bg-white rounded-lg p-3 text-center shadow-sm">
                <div class="text-xs text-gray-500 mb-1">Personal</div>
                <span id="statusPersonal" class="status-badge status-incomplete">Incomplete</span>
            </div>
            <div class="bg-white rounded-lg p-3 text-center shadow-sm">
                <div class="text-xs text-gray-500 mb-1">Address</div>
                <span id="statusAddress" class="status-badge status-incomplete">Incomplete</span>
            </div>
            <div class="bg-white rounded-lg p-3 text-center shadow-sm">
                <div class="text-xs text-gray-500 mb-1">KYC</div>
                <span id="statusKYC" class="status-badge status-incomplete">Incomplete</span>
            </div>
            <div class="bg-white rounded-lg p-3 text-center shadow-sm">
                <div class="text-xs text-gray-500 mb-1">Bank</div>
                <span id="statusBank" class="status-badge status-incomplete">Incomplete</span>
            </div>
        </div>

        <!-- Personal Information -->
        <div class="section-card">
            <div class="section-title">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                Personal Information
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label class="field-label">Full Name *</label>
                    <input type="text" id="fullName" class="field-input" required>
                </div>
                <div>
                    <label class="field-label">Username</label>
                    <input type="text" id="username" class="field-input" disabled>
                </div>
                <div>
                    <label class="field-label">Email *</label>
                    <input type="email" id="email" class="field-input" required>
                </div>
                <div>
                    <label class="field-label">Phone *</label>
                    <input type="tel" id="phone" class="field-input" required>
                </div>
                <div>
                    <label class="field-label">Date of Birth</label>
                    <input type="date" id="dateOfBirth" class="field-input">
                </div>
                <div>
                    <label class="field-label">Role</label>
                    <input type="text" id="role" class="field-input" disabled>
                </div>
            </div>
        </div>

        <!-- Address -->
        <div class="section-card">
            <div class="section-title">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                Address Details
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label class="field-label">Door No / House No</label>
                    <input type="text" id="doorNo" class="field-input" placeholder="e.g. 12/3">
                </div>
                <div>
                    <label class="field-label">Street</label>
                    <input type="text" id="street" class="field-input" placeholder="Street name">
                </div>
                <div>
                    <label class="field-label">City</label>
                    <input type="text" id="city" class="field-input" placeholder="City">
                </div>
                <div>
                    <label class="field-label">State</label>
                    <input type="text" id="state" class="field-input" placeholder="State" value="Tamil Nadu">
                </div>
                <div>
                    <label class="field-label">Pincode</label>
                    <input type="text" id="pincode" class="field-input" placeholder="6-digit pincode" maxlength="6" inputmode="numeric">
                </div>
            </div>
        </div>

        <!-- Emergency Contact -->
        <div class="section-card">
            <div class="section-title">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>
                Emergency Contact
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label class="field-label">Contact Person Name</label>
                    <input type="text" id="emergencyName" class="field-input" placeholder="Name of emergency contact">
                </div>
                <div>
                    <label class="field-label">Contact Phone</label>
                    <input type="tel" id="emergencyPhone" class="field-input" placeholder="10-digit phone number">
                </div>
            </div>
        </div>

        <!-- KYC Documents -->
        <div class="section-card">
            <div class="section-title">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>
                KYC Documents
                <span id="kycStatusBadge" class="ml-auto text-xs font-semibold px-2 py-0.5 rounded-full bg-red-100 text-red-700">Incomplete</span>
            </div>

            <!-- Aadhar -->
            <p class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Aadhar Card</p>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                <div>
                    <label class="field-label">Aadhar Number</label>
                    <input type="text" id="aadharNumber" class="field-input" placeholder="12-digit Aadhar number" maxlength="12" inputmode="numeric">
                    <p class="text-xs text-gray-400 mt-1">Enter your 12-digit Aadhar number</p>
                </div>
                <div>
                    <label class="field-label">Aadhar Proof Document</label>
                    <div id="aadharProofView" class="hidden mb-2">
                        <div class="flex items-center gap-3 p-3 bg-green-50 border border-green-200 rounded-lg">
                            <svg class="w-5 h-5 text-green-600 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                            <span class="text-sm text-green-700 flex-1">Document uploaded</span>
                            <a id="aadharViewLink" href="#" target="_blank" class="text-purple-600 text-xs font-semibold hover:underline">View</a>
                        </div>
                    </div>
                    <div id="aadharProofImgContainer" class="hidden mb-2">
                        <img id="aadharProofImg" class="aadhar-preview" alt="Aadhar proof">
                    </div>
                    <label class="flex items-center justify-center gap-2 p-3 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:border-purple-400 hover:bg-purple-50 transition">
                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                        <span class="text-sm text-gray-500" id="aadharUploadText">Upload Aadhar (Image/PDF, max 5MB)</span>
                        <input type="file" id="aadharFile" accept="image/*,application/pdf" class="hidden" onchange="handleAadharUpload(event)">
                    </label>
                </div>
            </div>

            <!-- PAN Card -->
            <p class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">PAN Card</p>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label class="field-label">PAN Number</label>
                    <input type="text" id="panNumber" class="field-input" placeholder="e.g. ABCDE1234F" maxlength="10" style="text-transform: uppercase;">
                    <p class="text-xs text-gray-400 mt-1">10-character PAN (e.g. ABCDE1234F)</p>
                </div>
                <div>
                    <label class="field-label">PAN Proof Document</label>
                    <div id="panProofView" class="hidden mb-2">
                        <div class="flex items-center gap-3 p-3 bg-green-50 border border-green-200 rounded-lg">
                            <svg class="w-5 h-5 text-green-600 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                            <span class="text-sm text-green-700 flex-1">PAN document uploaded</span>
                            <a id="panViewLink" href="#" target="_blank" class="text-purple-600 text-xs font-semibold hover:underline">View</a>
                        </div>
                    </div>
                    <div id="panProofImgContainer" class="hidden mb-2">
                        <img id="panProofImg" class="aadhar-preview" alt="PAN proof">
                    </div>
                    <label class="flex items-center justify-center gap-2 p-3 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:border-purple-400 hover:bg-purple-50 transition">
                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                        <span class="text-sm text-gray-500" id="panUploadText">Upload PAN (Image/PDF, max 5MB)</span>
                        <input type="file" id="panFile" accept="image/*,application/pdf" class="hidden" onchange="handlePanUpload(event)">
                    </label>
                </div>
            </div>
        </div>

        <!-- Bank Details -->
        <div class="section-card">
            <div class="section-title">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/></svg>
                Bank Account Details
                <span class="text-xs font-normal text-gray-400 ml-auto">For salary processing</span>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label class="field-label">Account Holder Name *</label>
                    <input type="text" id="bankAccName" class="field-input" placeholder="Full name as per bank account">
                </div>
                <div>
                    <label class="field-label">Bank Name *</label>
                    <input type="text" id="bankName" class="field-input" placeholder="e.g. State Bank of India">
                </div>
                <div>
                    <label class="field-label">Account Number *</label>
                    <input type="text" id="bankAccNo" class="field-input" placeholder="Account number" inputmode="numeric">
                </div>
                <div>
                    <label class="field-label">IFSC Code *</label>
                    <input type="text" id="bankIFSC" class="field-input uppercase" placeholder="e.g. SBIN0001234" maxlength="11">
                </div>
                <div>
                    <label class="field-label">UPI ID (Optional)</label>
                    <input type="text" id="bankUPI" class="field-input" placeholder="e.g. name@upi">
                </div>
            </div>
        </div>

        <!-- Save Button -->
        <div class="flex gap-3 mb-6">
            <button type="button" onclick="history.back()" class="flex-1 px-6 py-3 border border-gray-300 rounded-lg text-gray-700 font-semibold hover:bg-gray-50 transition bg-white shadow-sm">
                Cancel
            </button>
            <button type="button" onclick="saveAllProfile()" id="btnSave" class="flex-1 px-6 py-3 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-lg font-semibold hover:from-purple-700 hover:to-indigo-700 transition shadow-lg">
                Save All Changes
            </button>
        </div>

        <!-- Change Password Card -->
        <div class="section-card">
            <div class="section-title">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
                Change Password
            </div>
            <form id="passwordForm" class="space-y-4">
                <div>
                    <label class="field-label">Current Password *</label>
                    <input type="password" id="currentPassword" required class="field-input">
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="field-label">New Password *</label>
                        <input type="password" id="newPassword" required minlength="6" class="field-input">
                        <p class="text-xs text-gray-400 mt-1">Minimum 6 characters</p>
                    </div>
                    <div>
                        <label class="field-label">Confirm New Password *</label>
                        <input type="password" id="confirmPassword" required minlength="6" class="field-input">
                    </div>
                </div>
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                    <p class="text-xs text-yellow-800">After changing your password, you'll need to login again.</p>
                </div>
                <button type="submit" class="w-full px-6 py-3 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 transition">
                    Update Password
                </button>
            </form>
        </div>
    </div>

    <script>
        let currentUser = null;
        let profileImageFile = null;
        let aadharFile = null;

        // ══════════════════════════════
        // LOAD PROFILE
        // ══════════════════════════════
        async function loadProfile() {
            try {
                const authToken = localStorage.getItem('auth_token');
                if (!authToken) { window.location.href = '/login.html'; return; }

                try {
                    const meRes = await fetch('/api/auth/me', { headers: { 'Authorization': `Bearer ${authToken}` } });
                    if (meRes.ok) {
                        const meData = await meRes.json();
                        if (meData.success && meData.user) {
                            currentUser = meData.user;
                            localStorage.setItem('user', JSON.stringify(currentUser));
                        }
                    }
                } catch (e) { console.warn('Could not fetch fresh user data'); }

                if (!currentUser) {
                    const storedUser = localStorage.getItem('user');
                    if (!storedUser) { window.location.href = '/login.html'; return; }
                    currentUser = JSON.parse(storedUser);
                }

                populateForm(currentUser);
                updateCompletionStatus(currentUser);

            } catch (error) {
                console.error('Error loading profile:', error);
                showToast('Failed to load profile', 'error');
            }
        }

        function populateForm(u) {
            // Header
            const displayName = u.full_name || u.name || u.username || 'User';
            document.getElementById('displayName').textContent = displayName;
            document.getElementById('displayRole').textContent = (u.role || 'Staff').charAt(0).toUpperCase() + (u.role || 'Staff').slice(1);
            document.getElementById('displayEmail').textContent = u.email || '';
            document.getElementById('profileInitial').textContent = displayName.charAt(0).toUpperCase();

            if (u.created_at) {
                document.getElementById('memberSince').textContent = new Date(u.created_at).toLocaleDateString('en-IN', { year: 'numeric', month: 'long' });
            }

            if (u.profile_image_url) {
                document.getElementById('profilePreview').src = u.profile_image_url;
                document.getElementById('profilePreview').classList.remove('hidden');
                document.getElementById('profileInitial').classList.add('hidden');
            }

            // Personal
            document.getElementById('fullName').value = u.full_name || '';
            document.getElementById('username').value = u.username || '';
            document.getElementById('email').value = u.email || '';
            document.getElementById('phone').value = u.phone || '';
            document.getElementById('dateOfBirth').value = u.date_of_birth ? u.date_of_birth.split('T')[0] : '';
            document.getElementById('role').value = (u.role || 'Staff').charAt(0).toUpperCase() + (u.role || 'Staff').slice(1);

            // Address
            document.getElementById('doorNo').value = u.door_no || '';
            document.getElementById('street').value = u.street || '';
            document.getElementById('city').value = u.city || '';
            document.getElementById('state').value = u.state || 'Tamil Nadu';
            document.getElementById('pincode').value = u.pincode || '';

            // Emergency
            document.getElementById('emergencyName').value = u.emergency_contact_name || '';
            document.getElementById('emergencyPhone').value = u.emergency_contact_phone || '';

            // KYC
            document.getElementById('aadharNumber').value = u.aadhar_number || '';
            if (u.aadhar_proof_url) {
                document.getElementById('aadharProofView').classList.remove('hidden');
                document.getElementById('aadharViewLink').href = u.aadhar_proof_url;
                if (u.aadhar_proof_url.match(/\.(jpg|jpeg|png|gif|webp)$/i)) {
                    document.getElementById('aadharProofImg').src = u.aadhar_proof_url;
                    document.getElementById('aadharProofImgContainer').classList.remove('hidden');
                }
            }

            // PAN
            document.getElementById('panNumber').value = u.pan_number || '';
            if (u.pan_proof_url) {
                document.getElementById('panProofView').classList.remove('hidden');
                document.getElementById('panViewLink').href = u.pan_proof_url;
                if (u.pan_proof_url.match(/\.(jpg|jpeg|png|gif|webp)$/i)) {
                    document.getElementById('panProofImg').src = u.pan_proof_url;
                    document.getElementById('panProofImgContainer').classList.remove('hidden');
                }
            }

            // KYC Status Badge
            const kycBadge = document.getElementById('kycStatusBadge');
            if (u.kyc_status === 'complete') {
                kycBadge.textContent = 'Complete';
                kycBadge.className = 'ml-auto text-xs font-semibold px-2 py-0.5 rounded-full bg-green-100 text-green-700';
            } else if (u.kyc_status === 'verified') {
                kycBadge.textContent = 'Verified';
                kycBadge.className = 'ml-auto text-xs font-semibold px-2 py-0.5 rounded-full bg-blue-100 text-blue-700';
            } else {
                kycBadge.textContent = 'Incomplete';
                kycBadge.className = 'ml-auto text-xs font-semibold px-2 py-0.5 rounded-full bg-red-100 text-red-700';
            }

            // Bank
            document.getElementById('bankAccName').value = u.bank_account_name || '';
            document.getElementById('bankName').value = u.bank_name || '';
            document.getElementById('bankAccNo').value = u.bank_account_number || '';
            document.getElementById('bankIFSC').value = u.bank_ifsc_code || '';
            document.getElementById('bankUPI').value = u.upi_id || '';
        }

        function updateCompletionStatus(u) {
            let total = 0, filled = 0;

            // Personal (name, email, phone, dob)
            const personalFields = [u.full_name, u.email, u.phone, u.date_of_birth];
            total += personalFields.length;
            filled += personalFields.filter(Boolean).length;
            const personalComplete = personalFields.every(Boolean);

            // Address (door_no, street, city, state, pincode)
            const addressFields = [u.door_no, u.street, u.city, u.state, u.pincode];
            total += addressFields.length;
            filled += addressFields.filter(Boolean).length;
            const addressComplete = addressFields.filter(Boolean).length >= 3;

            // KYC (aadhar + pan)
            const kycFields = [u.aadhar_number, u.aadhar_proof_url, u.pan_number, u.pan_proof_url];
            total += kycFields.length;
            filled += kycFields.filter(Boolean).length;
            const kycComplete = kycFields.every(Boolean);

            // Bank (account_name, bank_name, account_number, ifsc)
            const bankFields = [u.bank_account_name, u.bank_name, u.bank_account_number, u.bank_ifsc_code];
            total += bankFields.length;
            filled += bankFields.filter(Boolean).length;
            const bankComplete = bankFields.every(Boolean);

            const percent = Math.round((filled / total) * 100);
            document.getElementById('completionPercent').textContent = percent + '%';
            document.getElementById('completionBar').style.width = percent + '%';

            setStatus('statusPersonal', personalComplete);
            setStatus('statusAddress', addressComplete);
            setStatus('statusKYC', kycComplete);
            setStatus('statusBank', bankComplete);
        }

        function setStatus(elId, complete) {
            const el = document.getElementById(elId);
            if (complete) {
                el.className = 'status-badge status-complete';
                el.innerHTML = '<svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>Complete';
            } else {
                el.className = 'status-badge status-incomplete';
                el.innerHTML = 'Incomplete';
            }
        }

        // ══════════════════════════════
        // IMAGE UPLOADS
        // ══════════════════════════════
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            if (!file.type.startsWith('image/')) { showToast('Please select an image file', 'error'); return; }
            if (file.size > 5 * 1024 * 1024) { showToast('Image must be under 5MB', 'error'); return; }
            profileImageFile = file;
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('profilePreview').src = e.target.result;
                document.getElementById('profilePreview').classList.remove('hidden');
                document.getElementById('profileInitial').classList.add('hidden');
            };
            reader.readAsDataURL(file);
        }

        function handleAadharUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            if (!file.type.startsWith('image/') && file.type !== 'application/pdf') {
                showToast('Only image or PDF files allowed', 'error'); return;
            }
            if (file.size > 5 * 1024 * 1024) { showToast('File must be under 5MB', 'error'); return; }
            aadharFile = file;
            document.getElementById('aadharUploadText').textContent = file.name;

            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('aadharProofImg').src = e.target.result;
                    document.getElementById('aadharProofImgContainer').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        let panFile = null;
        function handlePanUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            if (!file.type.startsWith('image/') && file.type !== 'application/pdf') {
                showToast('Only image or PDF files allowed', 'error'); return;
            }
            if (file.size > 5 * 1024 * 1024) { showToast('File must be under 5MB', 'error'); return; }
            panFile = file;
            document.getElementById('panUploadText').textContent = file.name;

            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('panProofImg').src = e.target.result;
                    document.getElementById('panProofImgContainer').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        // ══════════════════════════════
        // SAVE ALL PROFILE
        // ══════════════════════════════
        async function saveAllProfile() {
            const btn = document.getElementById('btnSave');
            btn.disabled = true;
            btn.textContent = 'Saving...';

            try {
                const token = localStorage.getItem('auth_token');

                // 1. Upload profile image if changed
                let newProfileUrl = null;
                if (profileImageFile) {
                    const formData = new FormData();
                    formData.append('profile_image', profileImageFile);
                    const uploadRes = await fetch('/api/upload/profile', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` },
                        body: formData
                    });
                    if (uploadRes.ok) {
                        const uploadResult = await uploadRes.json();
                        newProfileUrl = uploadResult.profileUrl;
                    }
                }

                // 2. Upload Aadhar proof if changed (endpoint saves to DB directly)
                if (aadharFile) {
                    const formData = new FormData();
                    formData.append('aadhar_proof', aadharFile);
                    const uploadRes = await fetch('/api/upload/aadhar', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` },
                        body: formData
                    });
                    if (!uploadRes.ok) {
                        showToast('Failed to upload Aadhar proof', 'error');
                    }
                }

                // 2b. Upload PAN proof if changed
                if (panFile) {
                    const formData = new FormData();
                    formData.append('pan_proof', panFile);
                    const uploadRes = await fetch('/api/upload/pan-proof', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` },
                        body: formData
                    });
                    if (!uploadRes.ok) {
                        showToast('Failed to upload PAN proof', 'error');
                    }
                }

                // 2c. Validate PAN format if provided
                const panVal = document.getElementById('panNumber').value.trim().toUpperCase();
                if (panVal && !/^[A-Z]{5}[0-9]{4}[A-Z]$/.test(panVal)) {
                    showToast('Invalid PAN format (e.g. ABCDE1234F)', 'error');
                    btn.disabled = false;
                    btn.textContent = 'Save All Changes';
                    return;
                }

                // 3. Validate bank IFSC if bank details provided
                const bankIFSC = document.getElementById('bankIFSC').value.trim().toUpperCase();
                const bankAccName = document.getElementById('bankAccName').value.trim();
                if (bankAccName && bankIFSC && !/^[A-Z]{4}0[A-Z0-9]{6}$/i.test(bankIFSC)) {
                    showToast('Invalid IFSC code format', 'error');
                    btn.disabled = false;
                    btn.textContent = 'Save All Changes';
                    return;
                }

                // 4. Build profile data
                const profileData = {
                    full_name: document.getElementById('fullName').value.trim(),
                    email: document.getElementById('email').value.trim(),
                    phone: document.getElementById('phone').value.trim() || null,
                    date_of_birth: document.getElementById('dateOfBirth').value || null,
                    door_no: document.getElementById('doorNo').value.trim() || null,
                    street: document.getElementById('street').value.trim() || null,
                    city: document.getElementById('city').value.trim() || null,
                    state: document.getElementById('state').value.trim() || null,
                    pincode: document.getElementById('pincode').value.trim() || null,
                    emergency_contact_name: document.getElementById('emergencyName').value.trim() || null,
                    emergency_contact_phone: document.getElementById('emergencyPhone').value.trim() || null,
                    aadhar_number: document.getElementById('aadharNumber').value.trim() || null,
                    pan_number: panVal || null,
                    bank_account_name: bankAccName || null,
                    bank_name: document.getElementById('bankName').value.trim() || null,
                    bank_account_number: document.getElementById('bankAccNo').value.trim() || null,
                    bank_ifsc_code: bankIFSC || null,
                    upi_id: document.getElementById('bankUPI').value.trim() || null
                };

                if (newProfileUrl) profileData.profile_image_url = newProfileUrl;

                // 5. Save profile
                const res = await fetch('/api/users/profile/me', {
                    method: 'PUT',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(profileData)
                });

                if (res.ok) {
                    profileImageFile = null;
                    aadharFile = null;
                    showToast('Profile updated successfully!', 'success');
                    // Reload fresh data
                    currentUser = null;
                    await loadProfile();
                } else {
                    const error = await res.json();
                    showToast(error.error || 'Failed to update profile', 'error');
                }
            } catch (error) {
                console.error('Save error:', error);
                showToast('Network error. Please try again.', 'error');
            }

            btn.disabled = false;
            btn.textContent = 'Save All Changes';
        }

        // ══════════════════════════════
        // CHANGE PASSWORD
        // ══════════════════════════════
        document.getElementById('passwordForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (newPassword !== confirmPassword) { showToast('New passwords do not match', 'error'); return; }
            if (newPassword.length < 6) { showToast('Password must be at least 6 characters', 'error'); return; }

            try {
                const response = await fetch('/api/users/change-password', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        user_id: currentUser.id,
                        current_password: currentPassword,
                        new_password: newPassword
                    })
                });

                if (response.ok) {
                    showToast('Password changed! Please login again.', 'success');
                    setTimeout(() => {
                        localStorage.removeItem('auth_token');
                        localStorage.removeItem('user');
                        window.location.href = '/login.html';
                    }, 1500);
                } else {
                    const error = await response.json();
                    showToast(error.error || 'Incorrect current password', 'error');
                }
            } catch (error) {
                showToast('Network error. Please try again.', 'error');
            }
        });

        // ══════════════════════════════
        // TOAST
        // ══════════════════════════════
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast toast-${type} show`;
            setTimeout(() => { toast.classList.remove('show'); }, 3000);
        }

        // Init
        loadProfile();
    </script>
    <script src="/components/logo-loader.js"></script>
</body>
</html>
