<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192x192.png">
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
    <title>Painters - Quality Colours Business Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/css/design-system.css">
    <script src="/universal-nav-loader.js"></script>
    <script src="/js/auth-helper.js"></script>
    <script>requireAdminOrRedirect();</script>
    <style>
        body { background: #f9fafb; }
        .tab-btn { padding: 0.5rem 1rem; border-radius: 0.5rem; font-size: 0.875rem; font-weight: 500; color: #64748b; cursor: pointer; transition: all 0.2s; border: 1px solid transparent; }
        .tab-btn:hover { background: #f1f5f9; color: #334155; }
        .tab-btn.active { background: linear-gradient(135deg, #667eea, #764ba2); color: #fff; border-color: transparent; box-shadow: 0 2px 8px rgba(102,126,234,0.3); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .stat-card { background: #fff; border-radius: 12px; padding: 1.25rem; border: 1px solid #e8ecf1; }
        .stat-value { font-size: 1.75rem; font-weight: 700; color: #1e293b; }
        .stat-label { font-size: 0.8125rem; color: #64748b; margin-top: 2px; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th { text-align: left; padding: 0.75rem; font-size: 0.75rem; font-weight: 600; color: #64748b; text-transform: uppercase; border-bottom: 2px solid #e8ecf1; }
        .data-table td { padding: 0.75rem; font-size: 0.875rem; border-bottom: 1px solid #f1f5f9; }
        .data-table tr:hover { background: #fafbfd; }
        .badge { display: inline-flex; align-items: center; padding: 2px 8px; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
        .badge-pending { background: #fef3c7; color: #92400e; }
        .badge-approved { background: #d1fae5; color: #065f46; }
        .badge-rejected { background: #fee2e2; color: #991b1b; }
        .badge-suspended { background: #e2e8f0; color: #475569; }
        .badge-paid { background: #dbeafe; color: #1e40af; }
        .btn-sm { padding: 0.375rem 0.75rem; border-radius: 0.375rem; font-size: 0.8125rem; font-weight: 500; cursor: pointer; transition: all 0.15s; border: none; }
        .btn-primary { background: #667eea; color: #fff; }
        .btn-primary:hover { background: #5a6fd6; }
        .btn-success { background: #10b981; color: #fff; }
        .btn-success:hover { background: #059669; }
        .btn-danger { background: #ef4444; color: #fff; }
        .btn-danger:hover { background: #dc2626; }
        .btn-outline { background: transparent; border: 1px solid #d1d5db; color: #374151; }
        .btn-outline:hover { background: #f9fafb; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center; }
        .modal-content { background: #fff; border-radius: 12px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; padding: 1.5rem; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; font-size: 0.8125rem; font-weight: 600; color: #374151; margin-bottom: 0.25rem; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102,126,234,0.1); }
        .empty-state { text-align: center; padding: 3rem; color: #94a3b8; }
        .empty-state svg { width: 48px; height: 48px; margin: 0 auto 1rem; stroke: #cbd5e1; }
    </style>
</head>
<body data-page="painters">
    <div class="min-h-screen bg-gray-50">
        <div class="max-w-7xl mx-auto px-4 py-6">
            <!-- Page Header -->
            <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
                <h1 class="text-2xl font-bold text-gray-900">Painter Management</h1>
                <div class="flex gap-2">
                    <button onclick="showAddPainterModal()" class="btn-sm btn-primary">+ Add Painter</button>
                </div>
            </div>

            <!-- Tabs -->
            <div class="flex flex-wrap gap-2 mb-6">
                <button class="tab-btn active" onclick="switchTab('painters')">Painters</button>
                <button class="tab-btn" onclick="switchTab('points')">Points & Invoices</button>
                <button class="tab-btn" onclick="switchTab('rates')">Rates & Slabs</button>
                <button class="tab-btn" onclick="switchTab('withdrawals')">Withdrawals</button>
                <button class="tab-btn" onclick="switchTab('reports')">Referrals & Reports</button>
                <button class="tab-btn" onclick="switchTab('estimates')">Estimates</button>
            </div>

            <!-- Tab 1: Painters -->
            <div id="tab-painters" class="tab-content active">
                <div class="bg-white rounded-xl border border-gray-200 p-4 mb-4">
                    <div class="flex flex-wrap gap-3 items-center">
                        <input type="text" id="painterSearch" placeholder="Search by name, phone, city..." class="flex-1 min-w-[200px] px-3 py-2 border border-gray-300 rounded-lg text-sm" oninput="debounceLoadPainters()">
                        <select id="painterStatusFilter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm" onchange="loadPainters()">
                            <option value="">All Status</option>
                            <option value="pending">Pending</option>
                            <option value="approved">Approved</option>
                            <option value="suspended">Suspended</option>
                            <option value="rejected">Rejected</option>
                        </select>
                    </div>
                </div>
                <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Phone</th>
                                    <th>City</th>
                                    <th>Status</th>
                                    <th>Regular Pts</th>
                                    <th>Annual Pts</th>
                                    <th>Credit</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="paintersTableBody">
                                <tr><td colspan="8" class="text-center py-8 text-gray-400">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div id="paintersPagination" class="flex justify-between items-center mt-4 text-sm text-gray-500"></div>
            </div>

            <!-- Tab 2: Points & Invoices -->
            <div id="tab-points" class="tab-content">
                <!-- Invoice Linking Section -->
                <div class="bg-white rounded-xl border border-gray-200 p-5 mb-4">
                    <h3 class="text-lg font-semibold mb-4">Link Invoice to Painter</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="form-group">
                            <label>Select Painter</label>
                            <select id="invoicePainterId" class="w-full">
                                <option value="">Choose painter...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Billing Type</label>
                            <select id="invoiceBillingType" class="w-full">
                                <option value="customer">Customer Billing</option>
                                <option value="self">Self Billing</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Invoice Number</label>
                            <input type="text" id="invoiceSearchInput" placeholder="Enter Zoho invoice number...">
                        </div>
                    </div>
                    <div id="invoicePreview" class="hidden mt-4 p-4 bg-gray-50 rounded-lg"></div>
                    <div class="mt-4">
                        <button onclick="processInvoice()" class="btn-sm btn-primary" id="processInvoiceBtn" disabled>Process Invoice</button>
                    </div>
                </div>

                <!-- Manual Point Adjustment -->
                <div class="bg-white rounded-xl border border-gray-200 p-5 mb-4">
                    <h3 class="text-lg font-semibold mb-4">Manual Point Adjustment</h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="form-group">
                            <label>Painter</label>
                            <select id="adjustPainterId"></select>
                        </div>
                        <div class="form-group">
                            <label>Pool</label>
                            <select id="adjustPool">
                                <option value="regular">Regular</option>
                                <option value="annual">Annual</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Amount (+/-)</label>
                            <input type="number" id="adjustAmount" step="0.01" placeholder="e.g. 50 or -20">
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <input type="text" id="adjustDescription" placeholder="Reason for adjustment">
                        </div>
                    </div>
                    <button onclick="adjustPoints()" class="btn-sm btn-primary mt-2">Apply Adjustment</button>
                </div>

                <!-- Recent Processed Invoices -->
                <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
                    <div class="p-4 border-b"><h3 class="font-semibold">Recent Processed Invoices</h3></div>
                    <div class="overflow-x-auto">
                        <table class="data-table">
                            <thead>
                                <tr><th>Invoice #</th><th>Painter</th><th>Type</th><th>Total</th><th>Regular Pts</th><th>Annual Pts</th><th>Referral Pts</th><th>Date</th></tr>
                            </thead>
                            <tbody id="processedInvoicesBody"><tr><td colspan="8" class="text-center py-4 text-gray-400">Loading...</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Tab 3: Rates & Slabs -->
            <div id="tab-rates" class="tab-content">
                <!-- Product Rates -->
                <div class="bg-white rounded-xl border border-gray-200 p-5 mb-4">
                    <div class="flex flex-wrap justify-between items-center gap-3 mb-4">
                        <div class="flex items-center gap-3">
                            <h3 class="text-lg font-semibold">Product Point Rates</h3>
                            <span id="ratesItemCount" class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded-full"></span>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <button onclick="syncZohoThenRates()" class="btn-sm btn-outline" id="syncZohoBtn" title="Step 1: Refresh Zoho cache, Step 2: Import to rates table">Sync from Zoho</button>
                            <button onclick="saveProductRates()" class="btn-sm btn-primary">Save Changes</button>
                        </div>
                    </div>
                    <!-- Search & Filter -->
                    <div class="flex flex-wrap gap-3 mb-4">
                        <input type="text" id="ratesSearch" placeholder="Search by name or brand..." class="flex-1 min-w-[180px] px-3 py-2 border border-gray-300 rounded-lg text-sm" oninput="filterRatesTable()">
                        <select id="ratesBrandFilter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm" onchange="filterRatesTable()">
                            <option value="">All Brands</option>
                        </select>
                        <select id="ratesCategoryFilter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm" onchange="filterRatesTable()">
                            <option value="">All Categories</option>
                        </select>
                    </div>
                    <!-- Sync Progress -->
                    <div id="syncProgress" class="hidden mb-4 p-3 bg-blue-50 rounded-lg text-sm text-blue-700">
                        <div class="flex items-center gap-2">
                            <svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>
                            <span id="syncProgressText">Syncing...</span>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="data-table" id="ratesTable">
                            <thead>
                                <tr>
                                    <th>Item Name</th>
                                    <th>Brand</th>
                                    <th>Category</th>
                                    <th>MRP</th>
                                    <th>Regular Pts/Unit</th>
                                    <th>Annual Eligible</th>
                                    <th>Annual %</th>
                                </tr>
                            </thead>
                            <tbody id="ratesTableBody"><tr><td colspan="7" class="text-center py-4 text-gray-400">Loading...</td></tr></tbody>
                        </table>
                    </div>
                </div>

                <!-- Value Slabs -->
                <div class="bg-white rounded-xl border border-gray-200 p-5">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">Value Slabs</h3>
                        <button onclick="showSlabModal()" class="btn-sm btn-primary">+ Add Slab</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="data-table">
                            <thead>
                                <tr><th>Period</th><th>Label</th><th>Min Amount</th><th>Max Amount</th><th>Bonus Points</th><th>Status</th><th>Actions</th></tr>
                            </thead>
                            <tbody id="slabsTableBody"><tr><td colspan="7" class="text-center py-4 text-gray-400">Loading...</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Tab 4: Withdrawals -->
            <div id="tab-withdrawals" class="tab-content">
                <div class="bg-white rounded-xl border border-gray-200 p-4 mb-4">
                    <select id="withdrawalStatusFilter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm" onchange="loadWithdrawals()">
                        <option value="">All Status</option>
                        <option value="pending" selected>Pending</option>
                        <option value="approved">Approved</option>
                        <option value="rejected">Rejected</option>
                        <option value="paid">Paid</option>
                    </select>
                </div>
                <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="data-table">
                            <thead>
                                <tr><th>Painter</th><th>Phone</th><th>Pool</th><th>Amount</th><th>Status</th><th>Requested</th><th>Actions</th></tr>
                            </thead>
                            <tbody id="withdrawalsTableBody"><tr><td colspan="7" class="text-center py-4 text-gray-400">Loading...</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Tab 5: Referrals & Reports -->
            <div id="tab-reports" class="tab-content">
                <!-- Summary Cards -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6" id="summaryCards">
                </div>

                <!-- Top Earners -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    <div class="bg-white rounded-xl border border-gray-200 p-5">
                        <h3 class="text-lg font-semibold mb-4">Top Earners</h3>
                        <div id="topEarnersBody"><div class="empty-state">Loading...</div></div>
                    </div>
                    <div class="bg-white rounded-xl border border-gray-200 p-5">
                        <h3 class="text-lg font-semibold mb-4">Referral Network</h3>
                        <div class="overflow-x-auto">
                            <table class="data-table">
                                <thead><tr><th>Referrer</th><th>Referred</th><th>Bills</th><th>Tier %</th><th>Points Earned</th></tr></thead>
                                <tbody id="referralsTableBody"><tr><td colspan="5" class="text-center py-4 text-gray-400">Loading...</td></tr></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 6: Estimates -->
            <div id="tab-estimates" class="tab-content">
                <div class="bg-white rounded-xl border border-gray-200 p-4 mb-4">
                    <div class="flex flex-wrap gap-3 items-center">
                        <input type="text" id="estSearch" placeholder="Search estimate #, painter..." class="flex-1 min-w-[200px] px-3 py-2 border border-gray-300 rounded-lg text-sm" oninput="debounceEstimates()">
                        <select id="estStatusFilter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm" onchange="loadEstimates()">
                            <option value="">All Status</option>
                            <option value="draft">Draft</option>
                            <option value="pending_admin">Pending Review</option>
                            <option value="admin_review">Needs Markup</option>
                            <option value="approved">Approved</option>
                            <option value="sent_to_customer">Sent to Customer</option>
                            <option value="payment_recorded">Payment Recorded</option>
                            <option value="pushed_to_zoho">Pushed to Zoho</option>
                            <option value="rejected">Rejected</option>
                        </select>
                        <select id="estTypeFilter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm" onchange="loadEstimates()">
                            <option value="">All Types</option>
                            <option value="self">Self Billing</option>
                            <option value="customer">Customer Billing</option>
                        </select>
                    </div>
                </div>
                <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Est #</th>
                                    <th>Painter</th>
                                    <th>Type</th>
                                    <th>Customer</th>
                                    <th>Items</th>
                                    <th>Total</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="estimatesTableBody">
                                <tr><td colspan="9" class="text-center py-4 text-gray-400">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div id="estimatesPagination" class="p-3 flex justify-center gap-2"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Estimate Detail Modal -->
    <div id="estimateDetailModal" class="modal-overlay" style="display:none" onclick="if(event.target===this)closeEstimateDetail()">
        <div class="modal-content" style="max-width:720px" id="estimateDetailContent"></div>
    </div>

    <!-- Painter Detail Modal -->
    <div id="painterDetailModal" class="modal-overlay" style="display:none" onclick="if(event.target===this)closePainterDetail()">
        <div class="modal-content" id="painterDetailContent"></div>
    </div>

    <!-- Add/Edit Slab Modal -->
    <div id="slabModal" class="modal-overlay" style="display:none" onclick="if(event.target===this)closeSlabModal()">
        <div class="modal-content">
            <h3 class="text-lg font-semibold mb-4" id="slabModalTitle">Add Value Slab</h3>
            <input type="hidden" id="slabEditId">
            <div class="form-group">
                <label>Period Type</label>
                <select id="slabPeriodType"><option value="monthly">Monthly</option><option value="quarterly">Quarterly</option></select>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div class="form-group"><label>Min Amount</label><input type="number" id="slabMin" step="0.01"></div>
                <div class="form-group"><label>Max Amount</label><input type="number" id="slabMax" step="0.01" placeholder="Leave empty for no max"></div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div class="form-group"><label>Bonus Points</label><input type="number" id="slabPoints" step="0.01"></div>
                <div class="form-group"><label>Label</label><input type="text" id="slabLabel" placeholder="e.g. Silver Tier"></div>
            </div>
            <div class="flex justify-end gap-2 mt-4">
                <button onclick="closeSlabModal()" class="btn-sm btn-outline">Cancel</button>
                <button onclick="saveSlab()" class="btn-sm btn-primary">Save</button>
            </div>
        </div>
    </div>

    <!-- Add Painter Modal -->
    <div id="addPainterModal" class="modal-overlay" style="display:none" onclick="if(event.target===this)closeAddPainterModal()">
        <div class="modal-content">
            <h3 class="text-lg font-semibold mb-4">Add Painter</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="form-group"><label>Full Name *</label><input type="text" id="addPainterName"></div>
                <div class="form-group"><label>Phone *</label><input type="text" id="addPainterPhone"></div>
                <div class="form-group"><label>Email</label><input type="email" id="addPainterEmail"></div>
                <div class="form-group"><label>City</label><input type="text" id="addPainterCity"></div>
                <div class="form-group"><label>Experience (years)</label><input type="number" id="addPainterExp" min="0"></div>
                <div class="form-group">
                    <label>Specialization</label>
                    <select id="addPainterSpec"><option value="both">Both</option><option value="interior">Interior</option><option value="exterior">Exterior</option><option value="industrial">Industrial</option></select>
                </div>
            </div>
            <div class="form-group"><label>Status</label>
                <select id="addPainterStatus"><option value="approved">Approved</option><option value="pending">Pending</option></select>
            </div>
            <div class="flex justify-end gap-2 mt-4">
                <button onclick="closeAddPainterModal()" class="btn-sm btn-outline">Cancel</button>
                <button onclick="addPainter()" class="btn-sm btn-primary">Add Painter</button>
            </div>
        </div>
    </div>

    <script>
    const API = '/api/painters';
    let currentPage = 1;
    let debounceTimer;
    let allPainters = [];

    // ═══════════════════════════════════════
    // TAB MANAGEMENT
    // ═══════════════════════════════════════
    function switchTab(tab) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-' + tab).classList.add('active');
        event.target.classList.add('active');

        if (tab === 'painters') loadPainters();
        if (tab === 'points') loadPointsTab();
        if (tab === 'rates') loadRatesTab();
        if (tab === 'withdrawals') loadWithdrawals();
        if (tab === 'reports') loadReportsTab();
        if (tab === 'estimates') loadEstimates();
    }

    // ═══════════════════════════════════════
    // PAINTERS TAB
    // ═══════════════════════════════════════
    function debounceLoadPainters() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(loadPainters, 300);
    }

    async function loadPainters(page = 1) {
        currentPage = page;
        const search = document.getElementById('painterSearch').value;
        const status = document.getElementById('painterStatusFilter').value;
        try {
            const params = new URLSearchParams({ page, limit: 50 });
            if (search) params.set('search', search);
            if (status) params.set('status', status);
            const res = await fetch(`${API}?${params}`, { headers: authHeaders() });
            const data = await res.json();
            if (!data.success) throw new Error(data.message);

            allPainters = data.painters;
            renderPaintersTable(data.painters);
            renderPagination(data.total, data.page, data.pages);
        } catch (err) {
            document.getElementById('paintersTableBody').innerHTML = `<tr><td colspan="8" class="text-center py-4 text-red-500">${err.message}</td></tr>`;
        }
    }

    function renderPaintersTable(painters) {
        if (!painters.length) {
            document.getElementById('paintersTableBody').innerHTML = '<tr><td colspan="8" class="text-center py-8 text-gray-400">No painters found</td></tr>';
            return;
        }
        document.getElementById('paintersTableBody').innerHTML = painters.map(p => `
            <tr class="cursor-pointer" onclick="showPainterDetail(${p.id})">
                <td class="font-medium">${esc(p.full_name)}</td>
                <td>${esc(p.phone)}</td>
                <td>${esc(p.city || '-')}</td>
                <td><span class="badge badge-${p.status}">${p.status}</span></td>
                <td>${parseFloat(p.regular_points).toFixed(2)}</td>
                <td>${parseFloat(p.annual_points).toFixed(2)}</td>
                <td>${p.credit_enabled ? '₹' + parseFloat(p.credit_limit).toLocaleString() : '-'}</td>
                <td>
                    ${p.status === 'pending' ? `
                        <button onclick="event.stopPropagation();approvePainter(${p.id},'approve')" class="btn-sm btn-success mr-1">Approve</button>
                        <button onclick="event.stopPropagation();approvePainter(${p.id},'reject')" class="btn-sm btn-danger">Reject</button>
                    ` : `<button onclick="event.stopPropagation();showPainterDetail(${p.id})" class="btn-sm btn-outline">View</button>`}
                </td>
            </tr>
        `).join('');
    }

    function renderPagination(total, page, pages) {
        if (pages <= 1) { document.getElementById('paintersPagination').innerHTML = ''; return; }
        document.getElementById('paintersPagination').innerHTML = `
            <span>Showing page ${page} of ${pages} (${total} total)</span>
            <div class="flex gap-2">
                ${page > 1 ? `<button onclick="loadPainters(${page-1})" class="btn-sm btn-outline">Prev</button>` : ''}
                ${page < pages ? `<button onclick="loadPainters(${page+1})" class="btn-sm btn-outline">Next</button>` : ''}
            </div>
        `;
    }

    async function approvePainter(id, action) {
        if (!confirm(`${action === 'approve' ? 'Approve' : 'Reject'} this painter?`)) return;
        try {
            const res = await fetch(`${API}/${id}/approve`, { method: 'PUT', headers: authHeaders(), body: JSON.stringify({ action }) });
            const data = await res.json();
            alert(data.message);
            loadPainters(currentPage);
        } catch (err) { alert('Error: ' + err.message); }
    }

    async function showPainterDetail(id) {
        try {
            const res = await fetch(`${API}/${id}`, { headers: authHeaders() });
            const data = await res.json();
            if (!data.success) throw new Error(data.message);
            const p = data.painter;

            document.getElementById('painterDetailContent').innerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h2 class="text-xl font-bold">${esc(p.full_name)}</h2>
                        <p class="text-gray-500">${esc(p.phone)} ${p.email ? '| ' + esc(p.email) : ''}</p>
                    </div>
                    <button onclick="closePainterDetail()" class="text-gray-400 hover:text-gray-600 text-xl">&times;</button>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                    <div class="stat-card"><div class="stat-value text-lg">${parseFloat(p.regular_points).toFixed(2)}</div><div class="stat-label">Regular Points</div></div>
                    <div class="stat-card"><div class="stat-value text-lg">${parseFloat(p.annual_points).toFixed(2)}</div><div class="stat-label">Annual Points</div></div>
                    <div class="stat-card"><div class="stat-value text-lg">${p.experience_years || 0}yr</div><div class="stat-label">Experience</div></div>
                    <div class="stat-card"><div class="stat-value text-lg"><span class="badge badge-${p.status}">${p.status}</span></div><div class="stat-label">Status</div></div>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4 text-sm">
                    <div><strong>City:</strong> ${esc(p.city || '-')}</div>
                    <div><strong>District:</strong> ${esc(p.district || '-')}</div>
                    <div><strong>Specialization:</strong> ${p.specialization}</div>
                    <div><strong>Referral Code:</strong> <code>${esc(p.referral_code || '-')}</code></div>
                    <div><strong>Credit:</strong> ${p.credit_enabled ? '₹' + parseFloat(p.credit_limit).toLocaleString() + ' (used: ₹' + parseFloat(p.credit_used).toLocaleString() + ')' : 'Disabled'}</div>
                    ${data.referrer ? `<div><strong>Referred by:</strong> ${esc(data.referrer.full_name)} (${data.referrer.phone})</div>` : ''}
                    <div><strong>Zoho Contact:</strong> ${esc(p.zoho_contact_id || 'Not linked')}</div>
                    <div><strong>Joined:</strong> ${new Date(p.created_at).toLocaleDateString()}</div>
                </div>
                ${p.credit_enabled ? '' : `
                <div class="border-t pt-4 mt-4">
                    <h4 class="font-semibold mb-2">Credit Settings</h4>
                    <div class="flex gap-3 items-end">
                        <div class="form-group mb-0"><label>Credit Limit (₹)</label><input type="number" id="detailCreditLimit" value="${p.credit_limit}" class="w-32"></div>
                        <button onclick="updateCredit(${p.id}, true)" class="btn-sm btn-primary">Enable Credit</button>
                    </div>
                </div>`}
                ${p.credit_enabled ? `
                <div class="border-t pt-4 mt-4">
                    <h4 class="font-semibold mb-2">Credit Settings</h4>
                    <div class="flex gap-3 items-end">
                        <div class="form-group mb-0"><label>Credit Limit (₹)</label><input type="number" id="detailCreditLimit" value="${p.credit_limit}" class="w-32"></div>
                        <button onclick="updateCredit(${p.id}, true)" class="btn-sm btn-primary">Update</button>
                        <button onclick="updateCredit(${p.id}, false)" class="btn-sm btn-danger">Disable</button>
                    </div>
                </div>` : ''}
                <div class="border-t pt-4 mt-4">
                    <h4 class="font-semibold mb-2">Recent Transactions</h4>
                    ${data.recentTransactions.length ? `
                    <table class="data-table">
                        <thead><tr><th>Date</th><th>Pool</th><th>Type</th><th>Amount</th><th>Source</th><th>Description</th></tr></thead>
                        <tbody>
                            ${data.recentTransactions.map(t => `
                                <tr>
                                    <td>${new Date(t.created_at).toLocaleDateString()}</td>
                                    <td>${t.pool}</td>
                                    <td>${t.type}</td>
                                    <td class="${parseFloat(t.amount) >= 0 ? 'text-green-600' : 'text-red-600'}">${parseFloat(t.amount).toFixed(2)}</td>
                                    <td>${t.source}</td>
                                    <td class="text-xs">${esc(t.description || '-')}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>` : '<p class="text-gray-400 text-sm">No transactions yet</p>'}
                </div>
            `;
            document.getElementById('painterDetailModal').style.display = 'flex';
        } catch (err) { alert('Error loading painter: ' + err.message); }
    }

    function closePainterDetail() { document.getElementById('painterDetailModal').style.display = 'none'; }

    async function updateCredit(painterId, enabled) {
        const limit = document.getElementById('detailCreditLimit')?.value || 0;
        try {
            const res = await fetch(`${API}/${painterId}/credit`, { method: 'PUT', headers: authHeaders(), body: JSON.stringify({ credit_enabled: enabled, credit_limit: limit }) });
            const data = await res.json();
            alert(data.message);
            closePainterDetail();
            loadPainters(currentPage);
        } catch (err) { alert('Error: ' + err.message); }
    }

    // ═══════════════════════════════════════
    // ADD PAINTER
    // ═══════════════════════════════════════
    function showAddPainterModal() { document.getElementById('addPainterModal').style.display = 'flex'; }
    function closeAddPainterModal() { document.getElementById('addPainterModal').style.display = 'none'; }

    async function addPainter() {
        const name = document.getElementById('addPainterName').value.trim();
        const phone = document.getElementById('addPainterPhone').value.trim();
        if (!name || !phone) return alert('Name and phone are required');

        try {
            const body = {
                full_name: name,
                phone,
                email: document.getElementById('addPainterEmail').value.trim() || undefined,
                city: document.getElementById('addPainterCity').value.trim() || undefined,
                experience_years: parseInt(document.getElementById('addPainterExp').value) || 0,
                specialization: document.getElementById('addPainterSpec').value
            };
            const res = await fetch(`${API}/register`, { method: 'POST', headers: authHeaders(), body: JSON.stringify(body) });
            const data = await res.json();
            if (!data.success) throw new Error(data.message);

            // Auto-approve if status is approved
            if (document.getElementById('addPainterStatus').value === 'approved') {
                await fetch(`${API}/${data.painterId}/approve`, { method: 'PUT', headers: authHeaders(), body: JSON.stringify({ action: 'approve' }) });
            }

            alert('Painter added successfully! Referral code: ' + data.referralCode);
            closeAddPainterModal();
            loadPainters();
        } catch (err) { alert('Error: ' + err.message); }
    }

    // ═══════════════════════════════════════
    // POINTS & INVOICES TAB
    // ═══════════════════════════════════════
    async function loadPointsTab() {
        await loadPainterSelects();
        // Load recent processed invoices (show all painters)
        try {
            const res = await fetch(`${API}/reports/summary`, { headers: authHeaders() });
            // Just load a generic view - we'd need a separate endpoint for all invoices
            // For now show instructions
        } catch (err) {}
    }

    async function loadPainterSelects() {
        try {
            const res = await fetch(`${API}?limit=500&status=approved`, { headers: authHeaders() });
            const data = await res.json();
            const opts = data.painters.map(p => `<option value="${p.id}">${esc(p.full_name)} (${p.phone})</option>`).join('');
            const selectHtml = '<option value="">Choose painter...</option>' + opts;
            document.getElementById('invoicePainterId').innerHTML = selectHtml;
            document.getElementById('adjustPainterId').innerHTML = selectHtml;
        } catch (err) {}
    }

    async function adjustPoints() {
        const painterId = document.getElementById('adjustPainterId').value;
        const pointPool = document.getElementById('adjustPool').value;
        const amount = document.getElementById('adjustAmount').value;
        const description = document.getElementById('adjustDescription').value;
        if (!painterId || !amount) return alert('Painter and amount required');

        try {
            const res = await fetch(`${API}/${painterId}/points/adjust`, {
                method: 'POST', headers: authHeaders(),
                body: JSON.stringify({ pool: pointPool, amount: parseFloat(amount), description })
            });
            const data = await res.json();
            if (!data.success) throw new Error(data.message);
            alert(`Points adjusted. New ${pointPool} balance: ${data.balance[pointPool]}`);
            document.getElementById('adjustAmount').value = '';
            document.getElementById('adjustDescription').value = '';
        } catch (err) { alert('Error: ' + err.message); }
    }

    async function processInvoice() {
        alert('To process an invoice, search for it in Zoho Books first, then link it here. This feature integrates with the Zoho API.');
    }

    // ═══════════════════════════════════════
    // RATES & SLABS TAB
    // ═══════════════════════════════════════
    let allRates = [];

    async function loadRatesTab() {
        await loadProductRates();
        await loadSlabs();
    }

    async function loadProductRates() {
        try {
            const res = await fetch(`${API}/config/product-rates`, { headers: authHeaders() });
            const data = await res.json();

            // Populate filter dropdowns
            const brandFilter = document.getElementById('ratesBrandFilter');
            const catFilter = document.getElementById('ratesCategoryFilter');
            brandFilter.innerHTML = '<option value="">All Brands</option>' +
                (data.brands || []).map(b => `<option value="${esc(b)}">${esc(b)}</option>`).join('');
            catFilter.innerHTML = '<option value="">All Categories</option>' +
                (data.categories || []).map(c => `<option value="${esc(c)}">${esc(c)}</option>`).join('');

            allRates = data.rates || [];
            document.getElementById('ratesItemCount').textContent = `${allRates.length} items`;
            renderRatesTable(allRates);
        } catch (err) {
            document.getElementById('ratesTableBody').innerHTML = `<tr><td colspan="7" class="text-center py-4 text-red-500">${err.message}</td></tr>`;
        }
    }

    function filterRatesTable() {
        const search = (document.getElementById('ratesSearch').value || '').toLowerCase();
        const brand = document.getElementById('ratesBrandFilter').value;
        const category = document.getElementById('ratesCategoryFilter').value;

        const filtered = allRates.filter(r => {
            if (search && !(r.item_name || '').toLowerCase().includes(search) && !(r.brand || '').toLowerCase().includes(search)) return false;
            if (brand && r.brand !== brand) return false;
            if (category && r.category !== category) return false;
            return true;
        });
        renderRatesTable(filtered);
    }

    function renderRatesTable(rates) {
        if (!rates.length) {
            document.getElementById('ratesTableBody').innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-400">No product rates configured. Click "Sync from Zoho" to import items.</td></tr>';
            return;
        }
        document.getElementById('ratesTableBody').innerHTML = rates.map(r => `
            <tr data-item-id="${esc(r.item_id)}">
                <td class="font-medium">${esc(r.item_name || r.item_id)}</td>
                <td class="text-xs text-gray-500">${esc(r.brand || '-')}</td>
                <td class="text-xs text-gray-500">${esc(r.category || '-')}</td>
                <td class="text-xs">${r.mrp ? '₹' + parseFloat(r.mrp).toFixed(2) : '-'}</td>
                <td><input type="number" value="${r.regular_points_per_unit}" step="0.01" min="0" class="rate-input w-20 px-2 py-1 border rounded text-sm" data-field="regular_points_per_unit"></td>
                <td><input type="checkbox" ${r.annual_eligible ? 'checked' : ''} class="rate-checkbox" data-field="annual_eligible"></td>
                <td><input type="number" value="${r.annual_pct}" step="0.01" min="0" class="rate-input w-20 px-2 py-1 border rounded text-sm" data-field="annual_pct"></td>
            </tr>
        `).join('');
    }

    async function saveProductRates() {
        const rows = document.querySelectorAll('#ratesTableBody tr[data-item-id]');
        if (!rows.length) return alert('No rates to save');
        const rates = Array.from(rows).map(row => ({
            item_id: row.dataset.itemId,
            regular_points_per_unit: parseFloat(row.querySelector('[data-field="regular_points_per_unit"]').value) || 0,
            annual_eligible: row.querySelector('[data-field="annual_eligible"]').checked,
            annual_pct: parseFloat(row.querySelector('[data-field="annual_pct"]').value) || 1.0
        }));

        try {
            const res = await fetch(`${API}/config/product-rates`, { method: 'PUT', headers: authHeaders(), body: JSON.stringify({ rates }) });
            const data = await res.json();
            alert(data.message);
        } catch (err) { alert('Error: ' + err.message); }
    }

    async function syncZohoThenRates() {
        const btn = document.getElementById('syncZohoBtn');
        const progress = document.getElementById('syncProgress');
        const progressText = document.getElementById('syncProgressText');
        btn.disabled = true;
        progress.classList.remove('hidden');

        try {
            // Step 1: Sync Zoho items cache
            progressText.textContent = 'Step 1/2: Refreshing Zoho items cache...';
            try {
                const zohoRes = await fetch('/api/zoho/sync/items', { method: 'POST', headers: authHeaders() });
                const zohoData = await zohoRes.json();
                if (!zohoRes.ok && zohoRes.status !== 429) {
                    progressText.textContent = 'Zoho sync skipped (may require zoho.sync permission). Proceeding with cached data...';
                    await new Promise(r => setTimeout(r, 1500));
                }
            } catch (e) {
                progressText.textContent = 'Zoho cache refresh skipped. Using existing data...';
                await new Promise(r => setTimeout(r, 1000));
            }

            // Step 2: Sync to rates table
            progressText.textContent = 'Step 2/2: Importing items to painter rates...';
            const res = await fetch(`${API}/config/product-rates/sync`, { method: 'POST', headers: authHeaders() });
            const data = await res.json();
            if (!data.success) throw new Error(data.message);

            progress.classList.remove('bg-blue-50', 'text-blue-700');
            progress.classList.add('bg-green-50', 'text-green-700');
            progressText.innerHTML = `Done! ${data.synced} new items imported, ${data.skipped} already existed. Total: ${data.total} Zoho items.`;

            await loadProductRates();
            setTimeout(() => {
                progress.classList.add('hidden');
                progress.classList.remove('bg-green-50', 'text-green-700');
                progress.classList.add('bg-blue-50', 'text-blue-700');
            }, 4000);
        } catch (err) {
            progress.classList.remove('bg-blue-50', 'text-blue-700');
            progress.classList.add('bg-red-50', 'text-red-700');
            progressText.textContent = 'Error: ' + err.message;
            setTimeout(() => {
                progress.classList.add('hidden');
                progress.classList.remove('bg-red-50', 'text-red-700');
                progress.classList.add('bg-blue-50', 'text-blue-700');
            }, 5000);
        } finally {
            btn.disabled = false;
        }
    }

    async function loadSlabs() {
        try {
            const res = await fetch(`${API}/config/slabs`, { headers: authHeaders() });
            const data = await res.json();
            if (!data.slabs.length) {
                document.getElementById('slabsTableBody').innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-400">No slabs configured</td></tr>';
                return;
            }
            document.getElementById('slabsTableBody').innerHTML = data.slabs.map(s => `
                <tr>
                    <td class="capitalize">${s.period_type}</td>
                    <td>${esc(s.label || '-')}</td>
                    <td>₹${parseFloat(s.min_amount).toLocaleString()}</td>
                    <td>${s.max_amount ? '₹' + parseFloat(s.max_amount).toLocaleString() : 'No limit'}</td>
                    <td>${parseFloat(s.bonus_points).toFixed(2)}</td>
                    <td><span class="badge ${s.is_active ? 'badge-approved' : 'badge-suspended'}">${s.is_active ? 'Active' : 'Inactive'}</span></td>
                    <td>
                        <button onclick="editSlab(${s.id}, '${s.period_type}', ${s.min_amount}, ${s.max_amount || 'null'}, ${s.bonus_points}, '${esc(s.label || '')}')" class="btn-sm btn-outline mr-1">Edit</button>
                        <button onclick="deleteSlab(${s.id})" class="btn-sm btn-danger">Delete</button>
                    </td>
                </tr>
            `).join('');
        } catch (err) {
            document.getElementById('slabsTableBody').innerHTML = `<tr><td colspan="7" class="text-center py-4 text-red-500">${err.message}</td></tr>`;
        }
    }

    function showSlabModal() {
        document.getElementById('slabEditId').value = '';
        document.getElementById('slabPeriodType').value = 'monthly';
        document.getElementById('slabMin').value = '';
        document.getElementById('slabMax').value = '';
        document.getElementById('slabPoints').value = '';
        document.getElementById('slabLabel').value = '';
        document.getElementById('slabModalTitle').textContent = 'Add Value Slab';
        document.getElementById('slabModal').style.display = 'flex';
    }

    function editSlab(id, period, min, max, points, label) {
        document.getElementById('slabEditId').value = id;
        document.getElementById('slabPeriodType').value = period;
        document.getElementById('slabMin').value = min;
        document.getElementById('slabMax').value = max || '';
        document.getElementById('slabPoints').value = points;
        document.getElementById('slabLabel').value = label;
        document.getElementById('slabModalTitle').textContent = 'Edit Value Slab';
        document.getElementById('slabModal').style.display = 'flex';
    }

    function closeSlabModal() { document.getElementById('slabModal').style.display = 'none'; }

    async function saveSlab() {
        const id = document.getElementById('slabEditId').value;
        const body = {
            period_type: document.getElementById('slabPeriodType').value,
            min_amount: parseFloat(document.getElementById('slabMin').value),
            max_amount: document.getElementById('slabMax').value ? parseFloat(document.getElementById('slabMax').value) : null,
            bonus_points: parseFloat(document.getElementById('slabPoints').value),
            label: document.getElementById('slabLabel').value
        };
        if (isNaN(body.min_amount) || isNaN(body.bonus_points)) return alert('Min amount and bonus points required');

        try {
            const url = id ? `${API}/config/slabs/${id}` : `${API}/config/slabs`;
            const method = id ? 'PUT' : 'POST';
            const res = await fetch(url, { method, headers: authHeaders(), body: JSON.stringify(body) });
            const data = await res.json();
            alert(data.message);
            closeSlabModal();
            loadSlabs();
        } catch (err) { alert('Error: ' + err.message); }
    }

    async function deleteSlab(id) {
        if (!confirm('Delete this slab?')) return;
        try {
            const res = await fetch(`${API}/config/slabs/${id}`, { method: 'DELETE', headers: authHeaders() });
            const data = await res.json();
            alert(data.message);
            loadSlabs();
        } catch (err) { alert('Error: ' + err.message); }
    }

    // ═══════════════════════════════════════
    // WITHDRAWALS TAB
    // ═══════════════════════════════════════
    async function loadWithdrawals() {
        const status = document.getElementById('withdrawalStatusFilter').value;
        try {
            const params = new URLSearchParams({ limit: 100 });
            if (status) params.set('status', status);
            const res = await fetch(`${API}/withdrawals?${params}`, { headers: authHeaders() });
            const data = await res.json();

            if (!data.withdrawals.length) {
                document.getElementById('withdrawalsTableBody').innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-400">No withdrawals found</td></tr>';
                return;
            }
            document.getElementById('withdrawalsTableBody').innerHTML = data.withdrawals.map(w => `
                <tr>
                    <td class="font-medium">${esc(w.full_name)}</td>
                    <td>${esc(w.phone)}</td>
                    <td class="capitalize">${w.pool}</td>
                    <td class="font-semibold">${parseFloat(w.amount).toFixed(2)}</td>
                    <td><span class="badge badge-${w.status}">${w.status}</span></td>
                    <td>${new Date(w.requested_at).toLocaleDateString()}</td>
                    <td>
                        ${w.status === 'pending' ? `
                            <button onclick="processWithdrawal(${w.id}, 'approve')" class="btn-sm btn-success mr-1">Approve</button>
                            <button onclick="processWithdrawal(${w.id}, 'reject')" class="btn-sm btn-danger">Reject</button>
                        ` : w.status === 'approved' ? `
                            <button onclick="processWithdrawal(${w.id}, 'paid')" class="btn-sm btn-primary">Mark Paid</button>
                        ` : '-'}
                    </td>
                </tr>
            `).join('');
        } catch (err) {
            document.getElementById('withdrawalsTableBody').innerHTML = `<tr><td colspan="7" class="text-center py-4 text-red-500">${err.message}</td></tr>`;
        }
    }

    async function processWithdrawal(id, action) {
        let payRef = '';
        if (action === 'paid') payRef = prompt('Enter payment reference:') || '';
        if (action === 'reject' && !confirm('Reject this withdrawal?')) return;
        if (action === 'approve' && !confirm('Approve this withdrawal? Points will be deducted.')) return;

        try {
            const res = await fetch(`${API}/withdrawals/${id}`, {
                method: 'PUT', headers: authHeaders(),
                body: JSON.stringify({ action, payment_reference: payRef })
            });
            const data = await res.json();
            if (!data.success) throw new Error(data.message);
            alert(`Withdrawal ${action}d`);
            loadWithdrawals();
        } catch (err) { alert('Error: ' + err.message); }
    }

    // ═══════════════════════════════════════
    // REPORTS TAB
    // ═══════════════════════════════════════
    async function loadReportsTab() {
        await loadSummary();
        await loadTopEarners();
        await loadReferrals();
    }

    async function loadSummary() {
        try {
            const res = await fetch(`${API}/reports/summary`, { headers: authHeaders() });
            const data = await res.json();
            const s = data.summary;
            document.getElementById('summaryCards').innerHTML = `
                <div class="stat-card"><div class="stat-value">${s.totalPainters}</div><div class="stat-label">Total Painters (${s.approvedPainters} approved)</div></div>
                <div class="stat-card"><div class="stat-value">${s.pendingPainters}</div><div class="stat-label">Pending Approval</div></div>
                <div class="stat-card"><div class="stat-value">${s.totalPointsIssued.toFixed(0)}</div><div class="stat-label">Total Points Issued</div></div>
                <div class="stat-card"><div class="stat-value">${s.totalPointsRedeemed.toFixed(0)}</div><div class="stat-label">Points Redeemed</div></div>
            `;
        } catch (err) {}
    }

    async function loadTopEarners() {
        try {
            const res = await fetch(`${API}/reports/top-earners?limit=10`, { headers: authHeaders() });
            const data = await res.json();
            if (!data.earners.length) {
                document.getElementById('topEarnersBody').innerHTML = '<p class="text-gray-400 text-sm">No data yet</p>';
                return;
            }
            document.getElementById('topEarnersBody').innerHTML = `
                <div class="space-y-3">
                    ${data.earners.map((e, i) => `
                        <div class="flex items-center justify-between py-2 ${i > 0 ? 'border-t' : ''}">
                            <div class="flex items-center gap-3">
                                <span class="w-6 h-6 flex items-center justify-center rounded-full text-xs font-bold ${i < 3 ? 'bg-yellow-100 text-yellow-700' : 'bg-gray-100 text-gray-500'}">${i + 1}</span>
                                <div><div class="font-medium text-sm">${esc(e.full_name)}</div><div class="text-xs text-gray-400">${esc(e.city || '')}</div></div>
                            </div>
                            <div class="text-right"><div class="font-semibold text-sm">${parseFloat(e.total_earned).toFixed(0)} pts</div><div class="text-xs text-gray-400">R:${parseFloat(e.regular_points).toFixed(0)} A:${parseFloat(e.annual_points).toFixed(0)}</div></div>
                        </div>
                    `).join('')}
                </div>
            `;
        } catch (err) {}
    }

    async function loadReferrals() {
        try {
            const res = await fetch(`${API}/referrals`, { headers: authHeaders() });
            const data = await res.json();
            if (!data.referrals.length) {
                document.getElementById('referralsTableBody').innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-400">No referrals yet</td></tr>';
                return;
            }
            document.getElementById('referralsTableBody').innerHTML = data.referrals.map(r => `
                <tr>
                    <td>${esc(r.referrer_name)}</td>
                    <td>${esc(r.referred_name)}</td>
                    <td>${r.total_bills}</td>
                    <td>${parseFloat(r.current_tier_pct).toFixed(2)}%</td>
                    <td>${parseFloat(r.total_referral_points).toFixed(2)}</td>
                </tr>
            `).join('');
        } catch (err) {}
    }

    // ═══════════════════════════════════════
    // HELPERS
    // ═══════════════════════════════════════
    function authHeaders() {
        return {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + (localStorage.getItem('auth_token') || '')
        };
    }

    function esc(s) {
        if (!s) return '';
        const div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
    }

    // ═══════════════════════════════════════
    // ESTIMATES TAB
    // ═══════════════════════════════════════
    let estDebounce;
    function debounceEstimates() { clearTimeout(estDebounce); estDebounce = setTimeout(loadEstimates, 300); }

    async function loadEstimates(page = 1) {
        const search = document.getElementById('estSearch').value;
        const status = document.getElementById('estStatusFilter').value;
        const billing_type = document.getElementById('estTypeFilter').value;
        try {
            const params = new URLSearchParams({ page, limit: 50 });
            if (search) params.set('painter', search);
            if (status) params.set('status', status);
            if (billing_type) params.set('billing_type', billing_type);
            const res = await fetch(`${API}/estimates?${params}`, { headers: authHeaders() });
            const data = await res.json();
            if (!data.success) throw new Error(data.message);
            renderEstimatesTable(data.estimates);
            renderEstPagination(data.total, data.page, data.pages);
        } catch (err) {
            document.getElementById('estimatesTableBody').innerHTML = `<tr><td colspan="9" class="text-center py-4 text-red-500">${esc(err.message)}</td></tr>`;
        }
    }

    function renderEstimatesTable(estimates) {
        const body = document.getElementById('estimatesTableBody');
        if (!estimates.length) {
            body.innerHTML = '<tr><td colspan="9" class="text-center py-4 text-gray-400">No estimates found</td></tr>';
            return;
        }
        const statusBadge = {
            draft: 'badge-suspended', pending_admin: 'badge-pending', admin_review: 'badge-pending',
            approved: 'badge-approved', sent_to_customer: 'badge-paid', payment_recorded: 'badge-paid',
            pushed_to_zoho: 'badge-approved', rejected: 'badge-rejected', cancelled: 'badge-suspended'
        };
        body.innerHTML = estimates.map(e => {
            const total = e.billing_type === 'customer' && parseFloat(e.markup_grand_total) > 0
                ? '₹' + parseFloat(e.markup_grand_total).toLocaleString('en-IN')
                : '₹' + parseFloat(e.grand_total).toLocaleString('en-IN');
            return `<tr style="cursor:pointer" onclick="viewEstimate(${e.id})">
                <td class="font-medium">${esc(e.estimate_number)}</td>
                <td>${esc(e.painter_name)}<br><span class="text-xs text-gray-400">${esc(e.painter_phone)}</span></td>
                <td><span class="badge ${e.billing_type === 'self' ? 'badge-paid' : 'badge-pending'}">${e.billing_type}</span></td>
                <td>${e.billing_type === 'customer' ? esc(e.customer_name || '-') : '-'}</td>
                <td>${e.item_count || 0}</td>
                <td class="font-semibold">${total}</td>
                <td><span class="badge ${statusBadge[e.status] || ''}">${e.status.replace(/_/g, ' ')}</span></td>
                <td class="text-xs text-gray-500">${new Date(e.created_at).toLocaleDateString()}</td>
                <td><button class="btn-sm btn-outline" onclick="event.stopPropagation();viewEstimate(${e.id})">View</button></td>
            </tr>`;
        }).join('');
    }

    function renderEstPagination(total, page, pages) {
        const container = document.getElementById('estimatesPagination');
        if (pages <= 1) { container.innerHTML = ''; return; }
        let html = '';
        for (let i = 1; i <= pages; i++) {
            html += `<button class="px-3 py-1 rounded text-sm ${i === page ? 'bg-indigo-600 text-white' : 'bg-gray-100'}" onclick="loadEstimates(${i})">${i}</button>`;
        }
        container.innerHTML = html;
    }

    async function viewEstimate(id) {
        try {
            const res = await fetch(`${API}/estimates/${id}`, { headers: authHeaders() });
            const data = await res.json();
            if (!data.success) throw new Error(data.message);
            renderEstimateDetail(data.estimate, data.items);
            document.getElementById('estimateDetailModal').style.display = 'flex';
        } catch (err) {
            alert('Error: ' + err.message);
        }
    }

    function closeEstimateDetail() { document.getElementById('estimateDetailModal').style.display = 'none'; }

    function renderEstimateDetail(est, items) {
        const isCustomer = est.billing_type === 'customer';
        const statusBadge = {
            draft: 'badge-suspended', pending_admin: 'badge-pending', admin_review: 'badge-pending',
            approved: 'badge-approved', sent_to_customer: 'badge-paid', payment_recorded: 'badge-paid',
            pushed_to_zoho: 'badge-approved', rejected: 'badge-rejected', cancelled: 'badge-suspended'
        };

        let actionsHtml = '';
        if (est.status === 'pending_admin') {
            if (isCustomer) {
                actionsHtml = `
                    <button class="btn-sm btn-success" onclick="reviewEstimate(${est.id},'approve')">Approve & Set Markup</button>
                    <button class="btn-sm btn-danger" onclick="reviewEstimate(${est.id},'reject')">Reject</button>`;
            } else {
                actionsHtml = `
                    <button class="btn-sm btn-success" onclick="reviewEstimate(${est.id},'approve')">Approve</button>
                    <button class="btn-sm btn-danger" onclick="reviewEstimate(${est.id},'reject')">Reject</button>`;
            }
        } else if (est.status === 'admin_review') {
            actionsHtml = `<button class="btn-sm btn-primary" onclick="saveMarkupPrices(${est.id})">Save Markup & Approve</button>`;
        } else if (est.status === 'approved' || est.status === 'sent_to_customer') {
            if (isCustomer && est.status === 'approved') {
                actionsHtml += `<button class="btn-sm btn-primary" onclick="shareEstimate(${est.id})">Share with Customer</button> `;
            }
            actionsHtml += `<button class="btn-sm btn-success" onclick="showPaymentForm(${est.id})">Record Payment</button>`;
        } else if (est.status === 'payment_recorded') {
            actionsHtml = `<button class="btn-sm btn-primary" onclick="pushToZoho(${est.id})">Push to Zoho</button>`;
        }

        let itemsHtml = items.map((item, idx) => `
            <tr>
                <td>${esc(item.item_name)}</td>
                <td class="text-xs text-gray-500">${esc(item.brand || '')}</td>
                <td class="text-center">${parseFloat(item.quantity)}</td>
                <td class="text-right">₹${parseFloat(item.unit_price).toLocaleString('en-IN')}</td>
                <td class="text-right">₹${parseFloat(item.line_total).toLocaleString('en-IN')}</td>
                ${isCustomer ? `<td class="text-right">
                    ${est.status === 'admin_review' ? `<input type="number" step="0.01" min="0" class="markup-price-input" data-item-id="${item.id}" value="${parseFloat(item.markup_unit_price) || ''}" style="width:100px;padding:4px 6px;border:1px solid #d1d5db;border-radius:4px;text-align:right;font-size:0.8125rem">` : `₹${parseFloat(item.markup_unit_price || 0).toLocaleString('en-IN')}`}
                </td>` : ''}
            </tr>
        `).join('');

        const content = document.getElementById('estimateDetailContent');
        content.innerHTML = `
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h3 class="text-lg font-bold">${esc(est.estimate_number)}</h3>
                    <span class="badge ${statusBadge[est.status] || ''}">${est.status.replace(/_/g, ' ')}</span>
                </div>
                <button onclick="closeEstimateDetail()" class="text-gray-400 hover:text-gray-600">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
            </div>

            <div class="grid grid-cols-2 gap-4 text-sm mb-4">
                <div><span class="text-gray-500">Painter:</span> <strong>${esc(est.painter_name)}</strong></div>
                <div><span class="text-gray-500">Type:</span> <strong>${est.billing_type === 'self' ? 'Self Billing' : 'Customer Billing'}</strong></div>
                ${isCustomer ? `
                <div><span class="text-gray-500">Customer:</span> <strong>${esc(est.customer_name || '-')}</strong></div>
                <div><span class="text-gray-500">Customer Phone:</span> ${esc(est.customer_phone || '-')}</div>
                ` : ''}
                <div><span class="text-gray-500">Created:</span> ${new Date(est.created_at).toLocaleString()}</div>
                ${est.zoho_invoice_number ? `<div><span class="text-gray-500">Zoho Invoice:</span> <strong>${esc(est.zoho_invoice_number)}</strong></div>` : ''}
                ${est.points_awarded > 0 ? `<div><span class="text-gray-500">Points:</span> <strong>${parseFloat(est.points_awarded).toFixed(2)}</strong> (R:${parseFloat(est.regular_points_awarded).toFixed(2)} A:${parseFloat(est.annual_points_awarded).toFixed(2)})</div>` : ''}
            </div>

            <div class="overflow-x-auto mb-4">
                <table class="data-table">
                    <thead><tr>
                        <th>Product</th><th>Brand</th><th>Qty</th><th>Unit Price</th><th>Line Total</th>
                        ${isCustomer ? '<th>Markup Price</th>' : ''}
                    </tr></thead>
                    <tbody>${itemsHtml}</tbody>
                </table>
            </div>

            <div class="bg-gray-50 rounded-lg p-3 mb-4 text-sm">
                <div class="flex justify-between mb-1"><span>Subtotal (Cost):</span><span>₹${parseFloat(est.subtotal).toLocaleString('en-IN')}</span></div>
                <div class="flex justify-between mb-1"><span>GST:</span><span>₹${parseFloat(est.gst_amount).toLocaleString('en-IN')}</span></div>
                <div class="flex justify-between font-bold border-t pt-1"><span>Grand Total (Cost):</span><span>₹${parseFloat(est.grand_total).toLocaleString('en-IN')}</span></div>
                ${isCustomer && parseFloat(est.markup_grand_total) > 0 ? `
                <div class="flex justify-between mt-2 pt-2 border-t font-bold text-indigo-600"><span>Markup Grand Total:</span><span>₹${parseFloat(est.markup_grand_total).toLocaleString('en-IN')}</span></div>
                ` : ''}
            </div>

            ${est.notes ? `<div class="text-sm mb-2"><span class="text-gray-500">Notes:</span> ${esc(est.notes)}</div>` : ''}
            ${est.admin_notes ? `<div class="text-sm mb-2"><span class="text-gray-500">Admin Notes:</span> ${esc(est.admin_notes)}</div>` : ''}
            ${est.payment_method ? `<div class="text-sm mb-2"><span class="text-gray-500">Payment:</span> ${esc(est.payment_method)} ${est.payment_reference ? '(' + esc(est.payment_reference) + ')' : ''} — ₹${parseFloat(est.payment_amount).toLocaleString('en-IN')}</div>` : ''}

            <!-- Payment Form (hidden) -->
            <div id="paymentFormSection" style="display:none" class="bg-blue-50 rounded-lg p-4 mb-4">
                <h4 class="font-semibold mb-2">Record Payment</h4>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-xs font-medium mb-1">Method *</label>
                        <select id="payMethod" class="w-full px-2 py-1.5 border rounded text-sm"><option value="cash">Cash</option><option value="upi">UPI</option><option value="bank">Bank Transfer</option><option value="cheque">Cheque</option></select></div>
                    <div><label class="block text-xs font-medium mb-1">Reference</label>
                        <input type="text" id="payRef" class="w-full px-2 py-1.5 border rounded text-sm" placeholder="UPI ID / Cheque #"></div>
                    <div><label class="block text-xs font-medium mb-1">Amount</label>
                        <input type="number" id="payAmount" class="w-full px-2 py-1.5 border rounded text-sm" value="${parseFloat(est.grand_total)}"></div>
                </div>
                <button class="btn-sm btn-success mt-3" onclick="confirmPayment(${est.id})">Confirm Payment</button>
            </div>

            <div class="flex gap-2 flex-wrap">${actionsHtml}</div>
        `;
    }

    async function reviewEstimate(id, action) {
        const notes = action === 'reject' ? prompt('Reason for rejection:') : '';
        if (action === 'reject' && notes === null) return;
        try {
            const res = await fetch(`${API}/estimates/${id}/review`, {
                method: 'PUT', headers: authHeaders(),
                body: JSON.stringify({ action, admin_notes: notes })
            });
            const data = await res.json();
            if (!data.success) throw new Error(data.message);
            alert(data.message);
            closeEstimateDetail();
            loadEstimates();
        } catch (err) { alert('Error: ' + err.message); }
    }

    async function saveMarkupPrices(estId) {
        const inputs = document.querySelectorAll('.markup-price-input');
        const items = [];
        inputs.forEach(inp => {
            const val = parseFloat(inp.value);
            if (val > 0) items.push({ id: parseInt(inp.dataset.itemId), markup_unit_price: val });
        });
        if (!items.length) { alert('Enter markup prices for at least one item'); return; }
        try {
            const res = await fetch(`${API}/estimates/${estId}/markup`, {
                method: 'POST', headers: authHeaders(),
                body: JSON.stringify({ items })
            });
            const data = await res.json();
            if (!data.success) throw new Error(data.message);
            alert(data.message);
            closeEstimateDetail();
            loadEstimates();
        } catch (err) { alert('Error: ' + err.message); }
    }

    async function shareEstimate(id) {
        try {
            const res = await fetch(`${API}/estimates/${id}/share`, {
                method: 'POST', headers: authHeaders()
            });
            const data = await res.json();
            if (!data.success) throw new Error(data.message);
            if (data.waLink) {
                window.open(data.waLink, '_blank');
            } else {
                navigator.clipboard.writeText(data.shareUrl);
                alert('Share link copied to clipboard:\n' + data.shareUrl);
            }
            closeEstimateDetail();
            loadEstimates();
        } catch (err) { alert('Error: ' + err.message); }
    }

    function showPaymentForm(id) {
        document.getElementById('paymentFormSection').style.display = 'block';
        document.getElementById('paymentFormSection').scrollIntoView({ behavior: 'smooth' });
    }

    async function confirmPayment(id) {
        const method = document.getElementById('payMethod').value;
        const reference = document.getElementById('payRef').value;
        const amount = document.getElementById('payAmount').value;
        try {
            const res = await fetch(`${API}/estimates/${id}/payment`, {
                method: 'POST', headers: authHeaders(),
                body: JSON.stringify({ payment_method: method, payment_reference: reference, payment_amount: amount })
            });
            const data = await res.json();
            if (!data.success) throw new Error(data.message);
            alert('Payment recorded');
            closeEstimateDetail();
            loadEstimates();
        } catch (err) { alert('Error: ' + err.message); }
    }

    async function pushToZoho(id) {
        if (!confirm('Push this estimate to Zoho Books as an invoice and award points?')) return;
        try {
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'Pushing...';
            const res = await fetch(`${API}/estimates/${id}/push-zoho`, {
                method: 'POST', headers: authHeaders()
            });
            const data = await res.json();
            if (!data.success) throw new Error(data.message);
            alert(`Zoho Invoice: ${data.zohoInvoiceNumber}\nPoints awarded: ${JSON.stringify(data.points)}`);
            closeEstimateDetail();
            loadEstimates();
        } catch (err) {
            alert('Error: ' + err.message);
            event.target.disabled = false;
            event.target.textContent = 'Push to Zoho';
        }
    }

    // ═══════════════════════════════════════
    // INIT
    // ═══════════════════════════════════════
    document.addEventListener('DOMContentLoaded', function() {
        // Check URL tab param
        const urlParams = new URLSearchParams(window.location.search);
        const tab = urlParams.get('tab');
        const tabNames = ['painters', 'points', 'rates', 'withdrawals', 'reports', 'estimates'];
        const activeTab = tab && tabNames.includes(tab) ? tab : 'painters';

        if (activeTab !== 'painters') {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            const tabEl = document.getElementById('tab-' + activeTab);
            if (tabEl) tabEl.classList.add('active');
            const btns = document.querySelectorAll('.tab-btn');
            const idx = tabNames.indexOf(activeTab);
            if (idx >= 0 && btns[idx]) btns[idx].classList.add('active');
        }

        // Load the active tab's data
        if (activeTab === 'painters') loadPainters();
        else if (activeTab === 'points') loadPointsTab();
        else if (activeTab === 'rates') loadRatesTab();
        else if (activeTab === 'withdrawals') loadWithdrawals();
        else if (activeTab === 'reports') loadReportsTab();
        else if (activeTab === 'estimates') loadEstimates();
    });
    </script>
</body>
</html>
