<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192x192.png">
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
    <title>Stock Check - Quality Colours</title>
    <script src="/js/auth-helper.js"></script>
    <script>checkAuthOrRedirect();</script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/css/design-system.css">
    <script src="/universal-nav-loader.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .page-header {
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            color: white;
        }
        .page-header h1 { font-size: 1.25rem; font-weight: 700; }
        .page-header .subtitle { font-size: 0.75rem; opacity: 0.85; }

        /* Tabs */
        .tab-bar {
            display: flex;
            gap: 4px;
            padding: 0 16px 0;
            background: rgba(255,255,255,0.12);
            border-radius: 12px 12px 0 0;
            margin: 0 16px;
        }
        .tab-btn {
            flex: 1;
            padding: 12px 8px;
            border: none;
            border-radius: 10px 10px 0 0;
            font-size: 0.8rem;
            font-weight: 600;
            color: #475569;
            background: #e2e8f0;
            cursor: pointer;
            transition: all 0.2s;
        }
        .tab-btn.active {
            color: #667eea;
            background: white;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.08);
        }

        .container { max-width: 600px; margin: 0 auto; padding: 0 16px 24px; }

        .card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .assignment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .assignment-title { font-size: 0.875rem; font-weight: 600; color: #1e293b; }
        .assignment-meta { font-size: 0.7rem; color: #94a3b8; }

        .status-badge { display: inline-block; font-size: 0.65rem; font-weight: 600; padding: 2px 8px; border-radius: 999px; text-transform: capitalize; }
        .status-pending { background: #fef3c7; color: #92400e; }
        .status-submitted { background: #dbeafe; color: #1e40af; }
        .status-reviewed { background: #d1fae5; color: #065f46; }
        .status-adjusted { background: #ede9fe; color: #5b21b6; }
        .badge-self { background: #fce7f3; color: #9d174d; font-size: 0.6rem; padding: 1px 6px; }

        /* Item card */
        .item-card {
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 10px;
            transition: border-color 0.2s;
        }
        .item-card.filled { border-color: #a5b4fc; background: #f8f7ff; }
        .item-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .item-name { font-size: 0.875rem; font-weight: 600; color: #1e293b; }
        .item-sku { font-size: 0.7rem; color: #94a3b8; }
        .item-system-qty { font-size: 0.75rem; color: #6366f1; font-weight: 500; background: #eef2ff; padding: 2px 8px; border-radius: 6px; }

        .item-input-row { display: flex; gap: 8px; align-items: center; margin-bottom: 8px; }
        .item-input-row label { font-size: 0.75rem; color: #64748b; font-weight: 500; white-space: nowrap; }
        .qty-input {
            flex: 1;
            padding: 10px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            text-align: center;
            outline: none;
            transition: border-color 0.2s;
        }
        .qty-input:focus { border-color: #667eea; }
        .qty-input.has-value { border-color: #a5b4fc; }

        .photo-row { display: flex; gap: 8px; align-items: center; margin-bottom: 8px; }
        .photo-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: #f1f5f9;
            border: 1px dashed #cbd5e1;
            border-radius: 8px;
            font-size: 0.75rem;
            color: #475569;
            cursor: pointer;
            transition: all 0.2s;
        }
        .photo-btn:hover { background: #e2e8f0; }
        .photo-btn.has-photo { background: #ecfdf5; border-color: #6ee7b7; color: #065f46; border-style: solid; }

        .photo-preview { width: 50px; height: 50px; border-radius: 8px; object-fit: cover; border: 1px solid #e2e8f0; }

        .notes-input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.75rem;
            resize: none;
            outline: none;
        }
        .notes-input:focus { border-color: #667eea; }

        .submit-btn {
            width: 100%;
            padding: 16px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 700;
            border: none;
            color: white;
            background: linear-gradient(135deg, #667eea, #764ba2);
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        .submit-btn:active { transform: scale(0.97); }
        .submit-btn:disabled { opacity: 0.6; cursor: not-allowed; }

        .submitted-banner {
            text-align: center;
            padding: 20px;
            background: #ecfdf5;
            border-radius: 12px;
            color: #065f46;
        }
        .submitted-banner .icon { font-size: 2rem; margin-bottom: 8px; }
        .submitted-banner .title { font-size: 1rem; font-weight: 700; }
        .submitted-banner .time { font-size: 0.75rem; opacity: 0.7; margin-top: 4px; }

        .empty-state { text-align: center; padding: 40px 20px; color: rgba(255,255,255,0.8); }
        .empty-state .icon { font-size: 3rem; margin-bottom: 12px; }
        .empty-state h3 { font-size: 1.1rem; font-weight: 600; margin-bottom: 4px; }
        .empty-state p { font-size: 0.8rem; opacity: 0.7; }

        /* Toast */
        .toast { position: fixed; top: 1rem; right: 1rem; z-index: 9999; padding: 0.75rem 1.25rem; border-radius: 8px; color: white; font-weight: 500; font-size: 0.875rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15); transform: translateX(120%); transition: transform 0.3s ease; }
        .toast.show { transform: translateX(0); }
        .toast-success { background: #059669; }
        .toast-error { background: #dc2626; }
        .toast-warning { background: #f59e0b; }
        .toast-info { background: #3b82f6; }

        .hidden-input { display: none; }

        /* History items */
        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #f1f5f9;
        }
        .history-item:last-child { border-bottom: none; }

        /* Self-request product search */
        .search-results {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 0 0 12px 12px;
            max-height: 240px;
            overflow-y: auto;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .search-result-item {
            padding: 10px 14px;
            cursor: pointer;
            font-size: 0.8rem;
            border-bottom: 1px solid #f1f5f9;
        }
        .search-result-item:hover { background: #f0f4ff; }
        .search-result-item:active { background: #e0e7ff; }

        .last-checked-badge {
            display: inline-block;
            font-size: 0.65rem;
            font-weight: 500;
            padding: 1px 6px;
            border-radius: 4px;
        }
        .checked-recent { background: #dcfce7; color: #166534; }
        .checked-old { background: #fef3c7; color: #92400e; }
        .checked-never { background: #fee2e2; color: #991b1b; }

        .selected-product {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 10px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 6px;
            font-size: 0.8rem;
        }
        .remove-btn { background: none; border: none; color: #ef4444; cursor: pointer; font-size: 1.2rem; padding: 0 4px; }

        .diff-positive { color: #059669; font-weight: 600; }
        .diff-negative { color: #dc2626; font-weight: 600; }
        .diff-zero { color: #64748b; }

        /* Progress bar */
        .progress-bar-container {
            background: #e2e8f0;
            border-radius: 99px;
            height: 10px;
            overflow: hidden;
            margin-bottom: 6px;
        }
        .progress-fill {
            height: 100%;
            border-radius: 99px;
            background: linear-gradient(90deg, #667eea, #059669);
            transition: width 0.5s ease;
        }
        .progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
            color: #64748b;
            margin-bottom: 14px;
        }

        /* Filter tabs */
        .filter-tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 14px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        .filter-tab {
            padding: 6px 12px;
            border-radius: 99px;
            font-size: 0.7rem;
            font-weight: 600;
            border: 1.5px solid #e2e8f0;
            background: white;
            color: #64748b;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }
        .filter-tab.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        /* Save progress button */
        .save-progress-btn {
            width: 100%;
            padding: 14px;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 700;
            border: none;
            color: white;
            background: linear-gradient(135deg, #059669, #10b981);
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(5, 150, 105, 0.3);
            margin-bottom: 8px;
        }
        .save-progress-btn:active { transform: scale(0.97); }
        .save-progress-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Resume banner */
        .resume-banner {
            background: #fefce8;
            border: 1px solid #fde68a;
            border-radius: 10px;
            padding: 10px 14px;
            margin-bottom: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.78rem;
            color: #854d0e;
        }
        .resume-banner .icon { font-size: 1.2rem; }

        /* Checked item styling */
        .item-card.checked {
            border-color: #86efac;
            background: #f0fdf4;
        }
        .item-card.checked .check-indicator {
            color: #059669;
            font-weight: 700;
            font-size: 0.75rem;
        }
    </style>
</head>
<body data-page="stock-check">
    <div id="toast" class="toast"></div>

    <!-- Page title -->
    <div class="page-header">
        <div>
            <h1>Stock Check</h1>
            <div class="subtitle" id="headerDate">Your assignments</div>
        </div>
    </div>

    <!-- Tabs -->
    <div class="tab-bar">
        <button class="tab-btn active" onclick="switchTab('assignments')">Assignments</button>
        <button class="tab-btn" onclick="switchTab('history')">History</button>
        <button class="tab-btn" onclick="switchTab('request')">New Request</button>
    </div>

    <!-- Assignments Tab -->
    <div class="container" id="tab-assignments">
        <div class="card" style="text-align:center; padding: 40px;">
            <div style="color:#94a3b8">Loading assignments...</div>
        </div>
    </div>

    <!-- History Tab -->
    <div class="container" id="tab-history" style="display:none">
        <div class="card" id="historyContent" style="text-align:center; padding: 30px; color:#94a3b8;">
            Loading history...
        </div>
    </div>

    <!-- New Request Tab -->
    <div class="container" id="tab-request" style="display:none">
        <div class="card">
            <h3 style="font-size:0.95rem; font-weight:700; color:#1e293b; margin-bottom:4px;">Self-Request Stock Check</h3>
            <p style="font-size:0.7rem; color:#94a3b8; margin-bottom:16px;">Report stock counts for items you want to verify. Admin will review.</p>

            <!-- Location selector (if multiple) -->
            <div id="locationSection" style="display:none; margin-bottom:12px;">
                <label style="font-size:0.75rem; font-weight:600; color:#475569; display:block; margin-bottom:4px;">Location</label>
                <select id="reqLocation" style="width:100%; padding:10px 12px; border:2px solid #e2e8f0; border-radius:10px; font-size:0.85rem; outline:none;">
                    <option value="">Loading...</option>
                </select>
            </div>

            <!-- Product search -->
            <div style="margin-bottom:12px; position:relative;">
                <label style="font-size:0.75rem; font-weight:600; color:#475569; display:block; margin-bottom:4px;">Search Products</label>
                <input type="text" id="reqSearch" placeholder="Type product name or SKU..."
                       style="width:100%; padding:10px 12px; border:2px solid #e2e8f0; border-radius:10px; font-size:0.85rem; outline:none;"
                       oninput="searchRequestProducts()" autocomplete="off">
                <div id="reqSearchResults" class="search-results" style="display:none"></div>
            </div>

            <!-- Selected products -->
            <div id="reqSelectedProducts" style="margin-bottom:12px;"></div>

            <!-- Reason -->
            <div style="margin-bottom:16px;">
                <label style="font-size:0.75rem; font-weight:600; color:#475569; display:block; margin-bottom:4px;">Reason</label>
                <textarea id="reqReason" rows="2" placeholder="Why are you requesting this stock check?"
                          style="width:100%; padding:10px 12px; border:2px solid #e2e8f0; border-radius:10px; font-size:0.8rem; outline:none; resize:none;"></textarea>
            </div>

            <button onclick="submitSelfRequest()" id="reqSubmitBtn" class="submit-btn" disabled>
                Submit Stock Check
            </button>
        </div>
    </div>

<script>
const API = '/api/stock-check';
let assignments = [];
let photoFiles = {}; // { item_zoho_id: File }
let reqSelectedItems = []; // for self-request
let reqPhotoFiles = {}; // for self-request photos
let searchTimeout = null;
let userBranchId = null;

// Partial submission tracking
let dirtyItems = {}; // { assignmentId: Set of zoho_item_ids }
let progressData = {}; // { assignmentId: { total, checked, remaining, progress_pct, checked_items } }
let activeFilters = {}; // { assignmentId: 'all'|'unchecked'|'checked'|'diff' }

function formatCheckDate(dateStr) {
    if (!dateStr) return 'No date';
    try {
        const d = new Date(dateStr + (dateStr.includes('T') ? '' : 'T00:00:00'));
        if (isNaN(d.getTime())) return 'No date';
        const today = new Date(); today.setHours(0,0,0,0);
        if (d.getTime() === today.getTime()) return 'Today';
        return d.toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' });
    } catch(e) { return 'No date'; }
}

function daysAgo(dateStr) {
    if (!dateStr) return null;
    try {
        const d = new Date(dateStr);
        if (isNaN(d.getTime())) return null;
        const diff = Math.floor((Date.now() - d.getTime()) / (1000 * 60 * 60 * 24));
        return diff;
    } catch(e) { return null; }
}

function lastCheckedLabel(dateStr) {
    const days = daysAgo(dateStr);
    if (days === null) return '<span class="last-checked-badge checked-never">Never checked</span>';
    if (days === 0) return '<span class="last-checked-badge checked-recent">Today</span>';
    if (days === 1) return '<span class="last-checked-badge checked-recent">Yesterday</span>';
    if (days <= 7) return '<span class="last-checked-badge checked-recent">' + days + 'd ago</span>';
    if (days <= 30) return '<span class="last-checked-badge checked-old">' + days + 'd ago</span>';
    return '<span class="last-checked-badge checked-never">' + days + 'd ago</span>';
}

function headers() { return getAuthHeaders(); }

function showToast(msg, type = 'success') {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.className = 'toast toast-' + type + ' show';
    setTimeout(() => t.classList.remove('show'), 3000);
}

// ========================================
// TAB SWITCHING
// ========================================
function switchTab(tab) {
    ['assignments', 'history', 'request'].forEach(t => {
        document.getElementById('tab-' + t).style.display = t === tab ? '' : 'none';
    });
    document.querySelectorAll('.tab-btn').forEach((el, i) => {
        el.classList.toggle('active', ['assignments', 'history', 'request'][i] === tab);
    });
    if (tab === 'history') loadHistory();
    if (tab === 'request') initSelfRequest();
}

// ========================================
// ASSIGNMENTS TAB
// ========================================
async function loadAssignments() {
    const container = document.getElementById('tab-assignments');
    try {
        const res = await fetch(API + '/my-assignments?pending=1', { headers: headers() });
        const data = await res.json();

        if (!data.success || !data.data || !data.data.length) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="icon">&#128230;</div>
                    <h3>No Pending Stock Checks</h3>
                    <p>You don't have any stock check assignments right now.</p>
                </div>`;
            return;
        }

        assignments = data.data;
        let html = '';

        for (const a of assignments) {
            if (a.status === 'submitted') {
                html += renderSubmitted(a);
            } else {
                const detailRes = await fetch(API + '/assignments/' + a.id, { headers: headers() });
                const detail = await detailRes.json();
                if (detail.success) {
                    a.items = detail.data.items;
                    a.show_system_qty = detail.data.show_system_qty;
                    a.notes = detail.data.notes;

                    // Fetch progress for this assignment
                    try {
                        const progRes = await fetch(API + '/progress/' + a.id, { headers: headers() });
                        const progData = await progRes.json();
                        if (progData.success) {
                            progressData[a.id] = progData.data;
                        }
                    } catch (e) { /* no progress yet */ }

                    dirtyItems[a.id] = new Set();
                    activeFilters[a.id] = 'all';
                    html += renderAssignment(a);
                }
            }
        }

        container.innerHTML = html;

        // Pre-fill checked items and apply resume state
        for (const a of assignments) {
            if (a.status !== 'pending' || !a.items) continue;
            const prog = progressData[a.id];
            if (prog && prog.checked > 0) {
                applyProgress(a.id, prog);
            }
        }
    } catch (err) {
        container.innerHTML = `<div class="card" style="text-align:center; color:#ef4444;">Failed to load assignments</div>`;
    }
}

function renderSubmitted(a) {
    return `
        <div class="card">
            <div class="assignment-header">
                <div>
                    <div class="assignment-title">${a.branch_name || 'Stock Check'} ${a.request_type === 'self_requested' ? '<span class="badge-self">Self</span>' : ''}</div>
                    <div class="assignment-meta">${a.item_count} items &middot; ${formatCheckDate(a.check_date)}</div>
                </div>
                <span class="status-badge status-submitted">Submitted</span>
            </div>
            <div class="submitted-banner">
                <div class="icon">&#10004;</div>
                <div class="title">Already Submitted</div>
                <div class="time">${a.submitted_at ? new Date(a.submitted_at).toLocaleString() : ''}</div>
            </div>
        </div>`;
}

function renderAssignment(a) {
    const prog = progressData[a.id];
    const total = a.items ? a.items.length : 0;
    const checked = prog ? prog.checked : 0;
    const remaining = total - checked;
    const pct = total > 0 ? Math.round((checked / total) * 100) : 0;
    const discrepancies = prog ? (prog.discrepancies || 0) : 0;

    let html = `
        <div class="card" id="assignment-${a.id}">
            <div class="assignment-header">
                <div>
                    <div class="assignment-title">${a.branch_name || 'Stock Check'}</div>
                    <div class="assignment-meta">${total} items &middot; ${formatCheckDate(a.check_date)}</div>
                </div>
                <span class="status-badge status-pending">Pending</span>
            </div>

            <!-- Progress bar -->
            <div id="progress-section-${a.id}">
                <div class="progress-bar-container">
                    <div class="progress-fill" id="progress-fill-${a.id}" style="width: ${pct}%"></div>
                </div>
                <div class="progress-text">
                    <span id="progress-count-${a.id}">${checked.toLocaleString()}/${total.toLocaleString()}</span>
                    <span id="progress-detail-${a.id}">${pct}% Complete &middot; ${remaining.toLocaleString()} Remaining</span>
                </div>
            </div>`;

    // Resume banner (shown if progress exists)
    html += `<div class="resume-banner" id="resume-banner-${a.id}" style="display:none">
        <span class="icon">&#9888;&#65039;</span>
        <span id="resume-text-${a.id}">Resuming from ${pct}% complete</span>
    </div>`;

    if (a.notes) {
        html += `<div style="background:#fffbeb; border-radius:8px; padding:8px 12px; margin-bottom:12px; font-size:0.75rem; color:#92400e;">
            <strong>Instructions:</strong> ${a.notes}
        </div>`;
    }

    // Filter tabs
    html += `
        <div class="filter-tabs" id="filter-tabs-${a.id}">
            <button class="filter-tab active" data-filter="all" onclick="filterItems(${a.id}, 'all', this)">All (${total})</button>
            <button class="filter-tab" data-filter="unchecked" onclick="filterItems(${a.id}, 'unchecked', this)">Unchecked (<span id="filter-unchecked-${a.id}">${remaining}</span>)</button>
            <button class="filter-tab" data-filter="checked" onclick="filterItems(${a.id}, 'checked', this)">Checked (<span id="filter-checked-${a.id}">${checked}</span>)</button>
            <button class="filter-tab" data-filter="diff" onclick="filterItems(${a.id}, 'diff', this)">Diff (<span id="filter-diff-${a.id}">${discrepancies}</span>)</button>
        </div>`;

    if (a.items) {
        html += `<div id="items-container-${a.id}">`;
        for (const item of a.items) {
            html += `
                <div class="item-card" id="item-${a.id}-${item.zoho_item_id}" data-assignment="${a.id}" data-zoho-id="${item.zoho_item_id}" data-status="unchecked">
                    <div class="item-header">
                        <div>
                            <div class="item-name">${item.item_name}</div>
                            ${item.item_sku ? '<div class="item-sku">' + item.item_sku + '</div>' : ''}
                        </div>
                        <div style="display:flex; align-items:center; gap:6px;">
                            <span class="check-indicator" id="check-ind-${a.id}-${item.zoho_item_id}" style="display:none">&#10003;</span>
                            ${a.show_system_qty ? '<div class="item-system-qty">Expected: ' + item.system_qty + '</div>' : ''}
                        </div>
                    </div>

                    <div class="item-input-row">
                        <label>Count:</label>
                        <input type="number" step="0.01" min="0" class="qty-input" id="qty-${a.id}-${item.zoho_item_id}"
                               data-assignment="${a.id}" data-zoho-id="${item.zoho_item_id}"
                               placeholder="Enter quantity" oninput="onQtyInput(this, ${a.id}, '${item.zoho_item_id}')">
                    </div>

                    <div class="photo-row">
                        <input type="file" accept="image/*" capture="environment" class="hidden-input"
                               id="file-${a.id}-${item.zoho_item_id}" onchange="onPhotoSelect(this, ${a.id}, '${item.zoho_item_id}')">
                        <button class="photo-btn" id="photobtn-${a.id}-${item.zoho_item_id}"
                                onclick="document.getElementById('file-${a.id}-${item.zoho_item_id}').click()">
                            <span>&#128247;</span> <span>Add Photo</span>
                        </button>
                        <img id="preview-${a.id}-${item.zoho_item_id}" class="photo-preview" style="display:none">
                    </div>

                    <textarea class="notes-input" id="notes-${a.id}-${item.zoho_item_id}" rows="1" placeholder="Notes (optional)"></textarea>
                </div>`;
        }
        html += '</div>';

        // Action buttons
        html += `
            <div id="action-buttons-${a.id}">
                <button class="save-progress-btn" id="saveBtn-${a.id}" onclick="saveProgress(${a.id})" disabled>
                    Save Progress
                </button>
                <button class="submit-btn" id="submitBtn-${a.id}" onclick="submitCheck(${a.id})" style="display:none">
                    Submit Final Check
                </button>
            </div>`;
    }

    html += '</div>';
    return html;
}

function onQtyInput(el, assignmentId, zohoItemId) {
    if (el.value !== '') {
        el.classList.add('has-value');
        // Track as dirty (newly entered/changed)
        if (assignmentId && zohoItemId) {
            if (!dirtyItems[assignmentId]) dirtyItems[assignmentId] = new Set();
            dirtyItems[assignmentId].add(zohoItemId);
            updateSaveButton(assignmentId);
        }
    } else {
        el.classList.remove('has-value');
    }
}

function onPhotoSelect(input, assignmentId, itemId) {
    const file = input.files[0];
    if (!file) return;

    const key = `${assignmentId}-${itemId}`;
    photoFiles[key] = file;

    const preview = document.getElementById(`preview-${assignmentId}-${itemId}`);
    const btn = document.getElementById(`photobtn-${assignmentId}-${itemId}`);
    const reader = new FileReader();
    reader.onload = (e) => {
        preview.src = e.target.result;
        preview.style.display = 'block';
        btn.classList.add('has-photo');
        btn.querySelector('span:last-child').textContent = 'Change Photo';
    };
    reader.readAsDataURL(file);
}

// ========================================
// SAVE PROGRESS (PARTIAL)
// ========================================
async function saveProgress(assignmentId) {
    const a = assignments.find(x => x.id === assignmentId);
    if (!a || !a.items) return;

    const dirty = dirtyItems[assignmentId];
    if (!dirty || dirty.size === 0) {
        showToast('No new items to save', 'info');
        return;
    }

    const itemsData = [];
    for (const zohoId of dirty) {
        const qtyInput = document.getElementById(`qty-${assignmentId}-${zohoId}`);
        const notesInput = document.getElementById(`notes-${assignmentId}-${zohoId}`);
        if (!qtyInput || qtyInput.value === '') continue;

        itemsData.push({
            zoho_item_id: zohoId,
            reported_qty: parseFloat(qtyInput.value),
            notes: notesInput ? notesInput.value.trim() : ''
        });
    }

    if (!itemsData.length) {
        showToast('Enter quantities before saving', 'warning');
        return;
    }

    const btn = document.getElementById(`saveBtn-${assignmentId}`);
    btn.disabled = true;
    btn.textContent = 'Saving...';

    const formData = new FormData();
    formData.append('items', JSON.stringify(itemsData));

    // Include photos for dirty items
    for (const zohoId of dirty) {
        const key = `${assignmentId}-${zohoId}`;
        if (photoFiles[key]) {
            formData.append(`photo_${zohoId}`, photoFiles[key]);
        }
    }

    try {
        const res = await fetch(API + '/save-progress/' + assignmentId, {
            method: 'POST',
            headers: { 'Authorization': headers()['Authorization'] },
            body: formData
        });
        const data = await res.json();

        if (data.success) {
            showToast(`Saved ${data.data.saved} items (${data.data.progress_pct}% complete)`);
            // Update progress data
            progressData[assignmentId] = {
                ...progressData[assignmentId],
                total: data.data.total,
                checked: data.data.checked,
                remaining: data.data.remaining,
                progress_pct: data.data.progress_pct
            };

            // Mark saved items as checked
            for (const zohoId of dirty) {
                const qtyInput = document.getElementById(`qty-${assignmentId}-${zohoId}`);
                if (qtyInput && qtyInput.value !== '') {
                    markItemChecked(assignmentId, zohoId);
                }
            }

            // Clear dirty set, update UI
            dirtyItems[assignmentId] = new Set();
            updateProgressUI(assignmentId, data.data);
            updateSaveButton(assignmentId);
            updateFilterCounts(assignmentId);
        } else {
            showToast(data.message || 'Failed to save', 'error');
        }
    } catch (err) {
        showToast('Network error', 'error');
    }

    btn.disabled = false;
    updateSaveButton(assignmentId);
}

// ========================================
// SUBMIT FINAL CHECK
// ========================================
async function submitCheck(assignmentId) {
    const a = assignments.find(x => x.id === assignmentId);
    if (!a || !a.items) return;

    // Check all items have quantities
    const unchecked = [];
    const itemsData = [];
    for (const item of a.items) {
        const qtyInput = document.getElementById(`qty-${assignmentId}-${item.zoho_item_id}`);
        const notesInput = document.getElementById(`notes-${assignmentId}-${item.zoho_item_id}`);

        if (!qtyInput || qtyInput.value === '') {
            unchecked.push(item.item_name);
            continue;
        }

        itemsData.push({
            zoho_item_id: item.zoho_item_id,
            reported_qty: parseFloat(qtyInput.value),
            notes: notesInput ? notesInput.value.trim() : ''
        });
    }

    if (unchecked.length > 0) {
        showToast(`${unchecked.length} items still unchecked`, 'warning');
        return;
    }

    // Confirmation
    if (!confirm(`Submit final stock check?\n\n${itemsData.length} items will be submitted for review.\nThis cannot be undone.`)) {
        return;
    }

    const btn = document.getElementById(`submitBtn-${assignmentId}`);
    btn.disabled = true;
    btn.textContent = 'Submitting...';

    const formData = new FormData();
    formData.append('items', JSON.stringify(itemsData));

    for (const item of a.items) {
        const key = `${assignmentId}-${item.zoho_item_id}`;
        if (photoFiles[key]) {
            formData.append(`photo_${item.zoho_item_id}`, photoFiles[key]);
        }
    }

    try {
        const res = await fetch(API + '/submit/' + assignmentId, {
            method: 'POST',
            headers: { 'Authorization': headers()['Authorization'] },
            body: formData
        });
        const data = await res.json();

        if (data.success) {
            showToast('Stock check submitted!');
            const card = document.getElementById(`assignment-${assignmentId}`);
            if (card) {
                card.innerHTML = `
                    <div class="assignment-header">
                        <div>
                            <div class="assignment-title">${a.branch_name || 'Stock Check'}</div>
                            <div class="assignment-meta">${a.items.length} items</div>
                        </div>
                        <span class="status-badge status-submitted">Submitted</span>
                    </div>
                    <div class="submitted-banner">
                        <div class="icon">&#10004;</div>
                        <div class="title">Submitted Successfully</div>
                        <div class="time">${new Date().toLocaleString()}</div>
                    </div>`;
            }
        } else {
            showToast(data.message || 'Failed to submit', 'error');
            btn.disabled = false;
            btn.textContent = 'Submit Final Check';
        }
    } catch (err) {
        showToast('Network error', 'error');
        btn.disabled = false;
        btn.textContent = 'Submit Final Check';
    }
}

// ========================================
// PROGRESS HELPERS
// ========================================

/** Apply saved progress to items (pre-fill values, mark as checked) */
function applyProgress(assignmentId, prog) {
    if (!prog || !prog.checked_items || !prog.checked_items.length) return;

    // Show resume banner
    const banner = document.getElementById(`resume-banner-${assignmentId}`);
    if (banner) {
        banner.style.display = '';
        const txt = document.getElementById(`resume-text-${assignmentId}`);
        if (txt) txt.textContent = `Resuming from ${prog.progress_pct}% complete (${prog.checked} of ${prog.total} items)`;
    }

    // Pre-fill checked items
    for (const ci of prog.checked_items) {
        const qtyInput = document.getElementById(`qty-${assignmentId}-${ci.zoho_item_id}`);
        if (qtyInput) {
            qtyInput.value = ci.reported_qty;
            qtyInput.classList.add('has-value');
        }
        if (ci.notes) {
            const notesInput = document.getElementById(`notes-${assignmentId}-${ci.zoho_item_id}`);
            if (notesInput) notesInput.value = ci.notes;
        }
        if (ci.photo_url) {
            const preview = document.getElementById(`preview-${assignmentId}-${ci.zoho_item_id}`);
            const btn = document.getElementById(`photobtn-${assignmentId}-${ci.zoho_item_id}`);
            if (preview) { preview.src = ci.photo_url; preview.style.display = 'block'; }
            if (btn) { btn.classList.add('has-photo'); btn.querySelector('span:last-child').textContent = 'Change Photo'; }
        }
        markItemChecked(assignmentId, ci.zoho_item_id);
    }

    // Default to unchecked filter if there's progress
    if (prog.checked > 0 && prog.remaining > 0) {
        filterItems(assignmentId, 'unchecked');
    }

    // Update progress bar and buttons
    updateProgressUI(assignmentId, prog);
    updateFilterCounts(assignmentId);
}

/** Mark a single item as checked visually */
function markItemChecked(assignmentId, zohoItemId) {
    const card = document.getElementById(`item-${assignmentId}-${zohoItemId}`);
    if (card) {
        card.classList.add('checked');
        card.setAttribute('data-status', 'checked');
    }
    const ind = document.getElementById(`check-ind-${assignmentId}-${zohoItemId}`);
    if (ind) ind.style.display = '';
}

/** Update progress bar, text, and button visibility */
function updateProgressUI(assignmentId, data) {
    const fill = document.getElementById(`progress-fill-${assignmentId}`);
    const count = document.getElementById(`progress-count-${assignmentId}`);
    const detail = document.getElementById(`progress-detail-${assignmentId}`);

    if (fill) fill.style.width = data.progress_pct + '%';
    if (count) count.textContent = `${data.checked.toLocaleString()}/${data.total.toLocaleString()}`;
    if (detail) detail.textContent = `${data.progress_pct}% Complete \u00b7 ${data.remaining.toLocaleString()} Remaining`;

    // Show/hide submit button based on completeness
    const submitBtn = document.getElementById(`submitBtn-${assignmentId}`);
    if (submitBtn) {
        submitBtn.style.display = data.remaining === 0 ? '' : 'none';
    }
}

/** Update save button text with dirty count */
function updateSaveButton(assignmentId) {
    const btn = document.getElementById(`saveBtn-${assignmentId}`);
    if (!btn) return;

    const dirty = dirtyItems[assignmentId];
    const count = dirty ? dirty.size : 0;

    if (count > 0) {
        btn.disabled = false;
        btn.textContent = `Save Progress (${count} new)`;
    } else {
        btn.disabled = true;
        btn.textContent = 'Save Progress';
    }
}

/** Update filter tab counts */
function updateFilterCounts(assignmentId) {
    const a = assignments.find(x => x.id === assignmentId);
    if (!a || !a.items) return;

    let checked = 0, unchecked = 0, diff = 0;
    for (const item of a.items) {
        const card = document.getElementById(`item-${assignmentId}-${item.zoho_item_id}`);
        if (!card) continue;
        const status = card.getAttribute('data-status');
        if (status === 'checked') {
            checked++;
            const qtyInput = document.getElementById(`qty-${assignmentId}-${item.zoho_item_id}`);
            if (qtyInput && item.system_qty !== undefined) {
                const reported = parseFloat(qtyInput.value);
                const system = parseFloat(item.system_qty) || 0;
                if (!isNaN(reported) && reported !== system) diff++;
            }
        } else {
            unchecked++;
        }
    }

    const uncheckedEl = document.getElementById(`filter-unchecked-${assignmentId}`);
    const checkedEl = document.getElementById(`filter-checked-${assignmentId}`);
    const diffEl = document.getElementById(`filter-diff-${assignmentId}`);
    if (uncheckedEl) uncheckedEl.textContent = unchecked;
    if (checkedEl) checkedEl.textContent = checked;
    if (diffEl) diffEl.textContent = diff;
}

/** Filter items by status */
function filterItems(assignmentId, filter, clickedBtn) {
    activeFilters[assignmentId] = filter;

    // Update active tab styling
    const tabContainer = document.getElementById(`filter-tabs-${assignmentId}`);
    if (tabContainer) {
        tabContainer.querySelectorAll('.filter-tab').forEach(btn => {
            btn.classList.toggle('active', btn.getAttribute('data-filter') === filter);
        });
    }
    // Also handle when called with a button element directly
    if (clickedBtn) {
        const parent = clickedBtn.parentElement;
        if (parent) {
            parent.querySelectorAll('.filter-tab').forEach(btn => btn.classList.remove('active'));
            clickedBtn.classList.add('active');
        }
    }

    // Show/hide items
    const container = document.getElementById(`items-container-${assignmentId}`);
    if (!container) return;

    const cards = container.querySelectorAll('.item-card');
    cards.forEach(card => {
        const status = card.getAttribute('data-status');
        let show = false;

        switch (filter) {
            case 'all': show = true; break;
            case 'unchecked': show = status === 'unchecked'; break;
            case 'checked': show = status === 'checked'; break;
            case 'diff':
                if (status === 'checked') {
                    const zohoId = card.getAttribute('data-zoho-id');
                    const aid = card.getAttribute('data-assignment');
                    const qtyInput = document.getElementById(`qty-${aid}-${zohoId}`);
                    const a = assignments.find(x => x.id == aid);
                    const item = a && a.items ? a.items.find(i => i.zoho_item_id === zohoId) : null;
                    if (qtyInput && item) {
                        const reported = parseFloat(qtyInput.value);
                        const system = parseFloat(item.system_qty) || 0;
                        show = !isNaN(reported) && reported !== system;
                    }
                }
                break;
        }

        card.style.display = show ? '' : 'none';
    });
}

// ========================================
// HISTORY TAB
// ========================================
let historyPage = 1;

async function loadHistory(page) {
    historyPage = page || 1;
    const el = document.getElementById('historyContent');
    el.innerHTML = '<div style="text-align:center; padding:30px; color:#94a3b8;">Loading...</div>';

    try {
        const res = await fetch(API + '/my-submissions?page=' + historyPage + '&limit=15', { headers: headers() });
        const data = await res.json();

        if (!data.success || !data.data || !data.data.length) {
            el.innerHTML = '<div style="text-align:center; padding:30px; color:#94a3b8;">No submissions yet</div>';
            return;
        }

        let html = '<div style="font-size:0.85rem; font-weight:700; color:#1e293b; margin-bottom:12px;">Your Submissions</div>';

        for (const a of data.data) {
            const dateStr = formatCheckDate(a.check_date);
            const submittedStr = a.submitted_at ? new Date(a.submitted_at).toLocaleDateString('en-IN', { day: 'numeric', month: 'short' }) : '';
            html += `
                <div class="history-item" onclick="viewSubmission(${a.id})" style="cursor:pointer;">
                    <div>
                        <div style="font-size:0.85rem; font-weight:600; color:#1e293b;">
                            ${a.branch_name || 'Stock Check'} #${a.id}
                            ${a.request_type === 'self_requested' ? '<span class="badge-self">Self</span>' : ''}
                        </div>
                        <div style="font-size:0.7rem; color:#94a3b8;">
                            ${dateStr} &middot; ${a.item_count} items
                            ${a.discrepancy_count > 0 ? '&middot; <span class="diff-negative">' + a.discrepancy_count + ' discrepancies</span>' : ''}
                        </div>
                    </div>
                    <div style="text-align:right;">
                        <span class="status-badge status-${a.status}">${a.status}</span>
                        <div style="font-size:0.65rem; color:#94a3b8; margin-top:2px;">${submittedStr}</div>
                    </div>
                </div>`;
        }

        // Pagination
        if (data.pagination) {
            const totalPages = Math.ceil(data.pagination.total / data.pagination.limit);
            if (totalPages > 1) {
                html += '<div style="display:flex; justify-content:center; gap:4px; margin-top:12px;">';
                for (let i = 1; i <= totalPages; i++) {
                    html += `<button onclick="loadHistory(${i})" style="padding:4px 10px; border-radius:6px; border:1px solid ${i === historyPage ? '#667eea' : '#e2e8f0'}; background:${i === historyPage ? '#667eea' : 'white'}; color:${i === historyPage ? 'white' : '#64748b'}; font-size:0.75rem; cursor:pointer;">${i}</button>`;
                }
                html += '</div>';
            }
        }

        el.innerHTML = html;
    } catch (err) {
        el.innerHTML = '<div style="text-align:center; padding:30px; color:#ef4444;">Failed to load history</div>';
    }
}

async function viewSubmission(id) {
    const el = document.getElementById('historyContent');
    el.innerHTML = '<div style="text-align:center; padding:30px; color:#94a3b8;">Loading details...</div>';

    try {
        const res = await fetch(API + '/assignments/' + id, { headers: headers() });
        const data = await res.json();

        if (!data.success) {
            el.innerHTML = '<div style="text-align:center; padding:30px; color:#ef4444;">Failed to load details</div>';
            return;
        }

        const a = data.data;
        let html = `
            <div style="margin-bottom:12px;">
                <button onclick="loadHistory(${historyPage})" style="background:none; border:none; color:#667eea; font-size:0.8rem; cursor:pointer; font-weight:600;">&larr; Back to list</button>
            </div>
            <div style="font-size:0.95rem; font-weight:700; color:#1e293b; margin-bottom:2px;">
                ${a.branch_name || 'Stock Check'} #${a.id}
                ${a.request_type === 'self_requested' ? '<span class="badge-self">Self-Requested</span>' : ''}
            </div>
            <div style="font-size:0.7rem; color:#94a3b8; margin-bottom:16px;">
                ${formatCheckDate(a.check_date)} &middot; <span class="status-badge status-${a.status}">${a.status}</span>
            </div>`;

        if (a.items && a.items.length) {
            for (const item of a.items) {
                const diff = parseFloat(item.difference);
                const diffClass = isNaN(diff) ? '' : diff > 0 ? 'diff-positive' : diff < 0 ? 'diff-negative' : 'diff-zero';
                const diffStr = isNaN(diff) ? '-' : (diff > 0 ? '+' : '') + diff;

                html += `
                    <div class="item-card" style="padding:10px;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:4px;">
                            <div>
                                <div style="font-size:0.8rem; font-weight:600; color:#1e293b;">${item.item_name}</div>
                                ${item.item_sku ? '<div style="font-size:0.65rem; color:#94a3b8;">' + item.item_sku + '</div>' : ''}
                            </div>
                            ${item.photo_url ? '<img src="' + item.photo_url + '" style="width:36px; height:36px; border-radius:6px; object-fit:cover; border:1px solid #e2e8f0;">' : ''}
                        </div>
                        <div style="display:flex; gap:12px; font-size:0.75rem;">
                            <span style="color:#64748b;">System: <strong>${item.system_qty}</strong></span>
                            <span style="color:#64748b;">Reported: <strong>${item.reported_qty !== null ? item.reported_qty : '-'}</strong></span>
                            <span class="${diffClass}">Diff: ${diffStr}</span>
                        </div>
                        ${item.notes ? '<div style="font-size:0.7rem; color:#64748b; margin-top:4px;">' + item.notes + '</div>' : ''}
                    </div>`;
            }
        }

        el.innerHTML = html;
    } catch (err) {
        el.innerHTML = '<div style="text-align:center; padding:30px; color:#ef4444;">Failed to load details</div>';
    }
}

// ========================================
// SELF-REQUEST TAB
// ========================================
let reqInitialized = false;

async function initSelfRequest() {
    if (reqInitialized) return;
    reqInitialized = true;

    try {
        // Get user's branch info
        const userStr = localStorage.getItem('user');
        const user = userStr ? JSON.parse(userStr) : null;

        if (user && user.branch_id) {
            userBranchId = user.branch_id;
        } else {
            // Fetch from API
            const res = await fetch('/api/auth/me', { headers: headers() });
            const data = await res.json();
            if (data.success && data.user) {
                userBranchId = data.user.branch_id;
            }
        }

        if (!userBranchId) {
            document.getElementById('reqSearch').disabled = true;
            document.getElementById('reqSearch').placeholder = 'No branch assigned to your account';
            return;
        }

        // Load locations
        const locRes = await fetch(API + '/locations/' + userBranchId, { headers: headers() });
        const locData = await locRes.json();

        if (locData.success && locData.data && locData.data.length > 1) {
            const locSel = document.getElementById('reqLocation');
            locSel.innerHTML = locData.data.map(l => `<option value="${l.zoho_location_id}">${l.zoho_location_name}</option>`).join('');
            document.getElementById('locationSection').style.display = '';
        }
    } catch (err) {
        console.error('Init self-request error:', err);
    }
}

function searchRequestProducts() {
    clearTimeout(searchTimeout);
    const q = document.getElementById('reqSearch').value.trim();
    const container = document.getElementById('reqSearchResults');
    if (q.length < 2) { container.style.display = 'none'; return; }

    searchTimeout = setTimeout(async () => {
        const locationId = document.getElementById('reqLocation').value;
        let url = API + '/products/search?search=' + encodeURIComponent(q);
        if (locationId) url += '&zoho_location_id=' + encodeURIComponent(locationId);
        if (userBranchId) url += '&branch_id=' + userBranchId;

        try {
            const res = await fetch(url, { headers: headers() });
            const data = await res.json();

            if (data.success && data.data && data.data.length) {
                container.innerHTML = data.data
                    .filter(item => !reqSelectedItems.find(s => s.zoho_item_id === item.zoho_item_id))
                    .map(item => `
                        <div class="search-result-item" onclick="addRequestProduct('${item.zoho_item_id}', '${(item.item_name || '').replace(/'/g, "\\'")}', '${(item.sku || '').replace(/'/g, "\\'")}', ${item.stock_on_hand || 0}, ${item.last_checked ? "'" + item.last_checked + "'" : 'null'})">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <div>
                                    <span style="font-weight:600;">${item.item_name}</span>
                                    <span style="color:#94a3b8; font-size:0.7rem; margin-left:4px;">${item.sku || ''}</span>
                                </div>
                                <span style="font-size:0.7rem; color:#64748b;">Qty: ${item.stock_on_hand || 0}</span>
                            </div>
                            <div style="margin-top:2px;">${lastCheckedLabel(item.last_checked)}</div>
                        </div>
                    `).join('');
                container.style.display = '';
            } else {
                container.innerHTML = '<div style="padding:12px; text-align:center; color:#94a3b8; font-size:0.8rem;">No items found</div>';
                container.style.display = '';
            }
        } catch (err) {
            container.style.display = 'none';
        }
    }, 300);
}

function addRequestProduct(id, name, sku, qty, lastChecked) {
    if (reqSelectedItems.find(s => s.zoho_item_id === id)) return;
    reqSelectedItems.push({ zoho_item_id: id, item_name: name, sku: sku, stock_on_hand: qty, last_checked: lastChecked });
    renderRequestProducts();
    document.getElementById('reqSearch').value = '';
    document.getElementById('reqSearchResults').style.display = 'none';
    updateReqSubmitBtn();
}

function removeRequestProduct(id) {
    reqSelectedItems = reqSelectedItems.filter(s => s.zoho_item_id !== id);
    // Also remove photo
    delete reqPhotoFiles[id];
    renderRequestProducts();
    updateReqSubmitBtn();
}

function renderRequestProducts() {
    const el = document.getElementById('reqSelectedProducts');
    if (!reqSelectedItems.length) {
        el.innerHTML = '<p style="font-size:0.75rem; color:#94a3b8; text-align:center; padding:8px;">No products selected. Search above to add items.</p>';
        return;
    }

    el.innerHTML = reqSelectedItems.map(item => `
        <div class="item-card" style="padding:12px;">
            <div class="item-header">
                <div>
                    <div class="item-name">${item.item_name}</div>
                    <div style="display:flex; gap:8px; align-items:center;">
                        ${item.sku ? '<span class="item-sku">' + item.sku + '</span>' : ''}
                        ${lastCheckedLabel(item.last_checked)}
                    </div>
                </div>
                <div style="display:flex; align-items:center; gap:6px;">
                    <span style="font-size:0.7rem; color:#6366f1;">Sys: ${item.stock_on_hand}</span>
                    <button class="remove-btn" onclick="removeRequestProduct('${item.zoho_item_id}')">&times;</button>
                </div>
            </div>

            <div class="item-input-row">
                <label>Count:</label>
                <input type="number" step="0.01" min="0" class="qty-input" id="req-qty-${item.zoho_item_id}"
                       placeholder="Actual count" oninput="onQtyInput(this); updateReqSubmitBtn();">
            </div>

            <div class="photo-row">
                <input type="file" accept="image/*" capture="environment" class="hidden-input"
                       id="req-file-${item.zoho_item_id}" onchange="onReqPhotoSelect(this, '${item.zoho_item_id}')">
                <button class="photo-btn" id="req-photobtn-${item.zoho_item_id}"
                        onclick="document.getElementById('req-file-${item.zoho_item_id}').click()">
                    <span>&#128247;</span> <span>Add Photo</span>
                </button>
                <img id="req-preview-${item.zoho_item_id}" class="photo-preview" style="display:none">
            </div>

            <textarea class="notes-input" id="req-notes-${item.zoho_item_id}" rows="1" placeholder="Notes (optional)"></textarea>
        </div>
    `).join('');
}
renderRequestProducts();

function onReqPhotoSelect(input, itemId) {
    const file = input.files[0];
    if (!file) return;
    reqPhotoFiles[itemId] = file;

    const preview = document.getElementById('req-preview-' + itemId);
    const btn = document.getElementById('req-photobtn-' + itemId);
    const reader = new FileReader();
    reader.onload = (e) => {
        preview.src = e.target.result;
        preview.style.display = 'block';
        btn.classList.add('has-photo');
        btn.querySelector('span:last-child').textContent = 'Change Photo';
    };
    reader.readAsDataURL(file);
}

function updateReqSubmitBtn() {
    const btn = document.getElementById('reqSubmitBtn');
    const allFilled = reqSelectedItems.length > 0 && reqSelectedItems.every(item => {
        const input = document.getElementById('req-qty-' + item.zoho_item_id);
        return input && input.value !== '';
    });
    btn.disabled = !allFilled;
}

async function submitSelfRequest() {
    if (!reqSelectedItems.length) return;

    const items = [];
    for (const item of reqSelectedItems) {
        const qtyInput = document.getElementById('req-qty-' + item.zoho_item_id);
        const notesInput = document.getElementById('req-notes-' + item.zoho_item_id);
        if (!qtyInput || qtyInput.value === '') {
            showToast('Enter count for all items', 'warning');
            if (qtyInput) qtyInput.focus();
            return;
        }
        items.push({
            zoho_item_id: item.zoho_item_id,
            reported_qty: parseFloat(qtyInput.value),
            notes: notesInput ? notesInput.value.trim() : ''
        });
    }

    const reason = document.getElementById('reqReason').value.trim();
    const btn = document.getElementById('reqSubmitBtn');
    btn.disabled = true;
    btn.textContent = 'Submitting...';

    const formData = new FormData();
    formData.append('items', JSON.stringify(items));
    if (reason) formData.append('reason', reason);

    const locationId = document.getElementById('reqLocation').value;
    if (locationId) formData.append('zoho_location_id', locationId);

    for (const item of reqSelectedItems) {
        if (reqPhotoFiles[item.zoho_item_id]) {
            formData.append(`photo_${item.zoho_item_id}`, reqPhotoFiles[item.zoho_item_id]);
        }
    }

    try {
        const res = await fetch(API + '/self-request', {
            method: 'POST',
            headers: { 'Authorization': headers()['Authorization'] },
            body: formData
        });
        const data = await res.json();

        if (data.success) {
            showToast('Stock check submitted! Admin will review it.');
            reqSelectedItems = [];
            reqPhotoFiles = {};
            renderRequestProducts();
            document.getElementById('reqReason').value = '';
            btn.textContent = 'Submit Stock Check';
            updateReqSubmitBtn();
        } else {
            showToast(data.message || 'Failed to submit', 'error');
            btn.disabled = false;
            btn.textContent = 'Submit Stock Check';
        }
    } catch (err) {
        showToast('Network error', 'error');
        btn.disabled = false;
        btn.textContent = 'Submit Stock Check';
    }
}

// Close search on outside click
document.addEventListener('click', (e) => {
    if (!e.target.closest('#reqSearch') && !e.target.closest('#reqSearchResults')) {
        document.getElementById('reqSearchResults').style.display = 'none';
    }
});

// ========================================
// Real-time stock check alerts
// ========================================
window.addEventListener('qc-notification', function(e) {
    const n = e.detail;
    if (n.type === 'stock_check_assigned') {
        showNewAssignmentAlert(n);
        loadAssignments();
    }
});

function showNewAssignmentAlert(notification) {
    const existing = document.getElementById('newAssignmentAlert');
    if (existing) existing.remove();

    const alert = document.createElement('div');
    alert.id = 'newAssignmentAlert';
    alert.style.cssText = `
        position: fixed; top: 0; left: 0; right: 0; z-index: 9999;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white; padding: 14px 20px;
        display: flex; align-items: center; gap: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        animation: slideDown 0.3s ease;
    `;
    alert.innerHTML = `
        <span style="font-size:1.5rem">&#128230;</span>
        <div style="flex:1">
            <div style="font-weight:700;font-size:0.9rem">${notification.title || 'New Stock Check!'}</div>
            <div style="font-size:0.8rem;opacity:0.9">${notification.body || 'You have a new stock check assignment'}</div>
        </div>
        <button onclick="this.parentElement.remove()" style="background:rgba(255,255,255,0.2);border:none;color:white;width:32px;height:32px;border-radius:50%;font-size:1.1rem;cursor:pointer">&times;</button>
    `;
    document.body.appendChild(alert);
    setTimeout(() => { if (alert.parentElement) alert.remove(); }, 8000);
}

const style = document.createElement('style');
style.textContent = '@keyframes slideDown { from { transform: translateY(-100%); } to { transform: translateY(0); } }';
document.head.appendChild(style);

// ========================================
// INIT
// ========================================
const today = new Date();
document.getElementById('headerDate').textContent = today.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
loadAssignments();
</script>
</body>
</html>
