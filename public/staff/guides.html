<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192x192.png">
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Guides & Help - QC Staff</title>
    <script src="/js/auth-helper.js"></script>
    <script>checkAuthOrRedirect();</script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/css/design-system.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        /* Header Bar */
        .guide-header {
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .guide-header h1 {
            color: white;
            font-size: 1.15rem;
            font-weight: 700;
            text-align: center;
            flex: 1;
        }
        .header-btn {
            background: rgba(255,255,255,0.15);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 12px;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
            flex-shrink: 0;
        }
        .header-btn:active { background: rgba(255,255,255,0.3); }

        /* Content Container */
        .content-container {
            background: #f8f9fb;
            border-radius: 24px 24px 0 0;
            min-height: calc(100vh - 64px);
            padding-bottom: 40px;
        }

        /* Search Bar */
        .search-bar {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
            padding: 0 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .search-bar.open {
            max-height: 70px;
            padding: 0 16px 12px 16px;
        }
        .search-input-wrap {
            position: relative;
            display: flex;
            align-items: center;
        }
        .search-input-wrap svg {
            position: absolute;
            left: 14px;
            width: 18px;
            height: 18px;
            color: #9ca3af;
            pointer-events: none;
        }
        .search-input {
            width: 100%;
            padding: 12px 42px 12px 42px;
            border-radius: 14px;
            border: none;
            background: rgba(255,255,255,0.95);
            font-size: 0.95rem;
            color: #1f2937;
            outline: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .search-input::placeholder { color: #9ca3af; }
        .search-clear {
            position: absolute;
            right: 10px;
            background: none;
            border: none;
            color: #9ca3af;
            font-size: 1.2rem;
            cursor: pointer;
            display: none;
            padding: 4px 8px;
        }
        .search-clear.visible { display: block; }

        /* Category Chips */
        .chips-row {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 16px 16px 8px 16px;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }
        .chips-row::-webkit-scrollbar { display: none; }
        .chip {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border-radius: 20px;
            border: 1.5px solid #e5e7eb;
            background: white;
            color: #6b7280;
            font-size: 0.82rem;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .chip:active { transform: scale(0.95); }
        .chip.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
            box-shadow: 0 2px 8px rgba(102,126,234,0.3);
        }
        .chip-icon { font-size: 1rem; }

        /* Guide Cards */
        .guides-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            padding: 12px 16px;
        }
        @media (min-width: 640px) {
            .guides-grid { grid-template-columns: 1fr 1fr; }
        }
        @media (min-width: 1024px) {
            .guides-grid { grid-template-columns: 1fr 1fr 1fr; }
        }
        .guide-card {
            background: white;
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        .guide-card:active { transform: scale(0.98); }
        .guide-card:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.12); }
        .card-category {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.72rem;
            font-weight: 600;
            color: #667eea;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        .card-category-icon { font-size: 0.85rem; }
        .card-title {
            font-size: 1rem;
            font-weight: 700;
            color: #1f2937;
            line-height: 1.3;
            margin-bottom: 2px;
        }
        .card-title-ta {
            font-size: 0.82rem;
            color: #9ca3af;
            margin-bottom: 8px;
            line-height: 1.3;
        }
        .card-summary {
            font-size: 0.85rem;
            color: #6b7280;
            line-height: 1.45;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            margin-bottom: 12px;
            flex: 1;
        }
        .card-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            flex-wrap: wrap;
        }
        .card-meta {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.72rem;
            color: #9ca3af;
        }
        .card-meta-item {
            display: flex;
            align-items: center;
            gap: 3px;
        }
        .lang-badge {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.68rem;
            font-weight: 700;
            letter-spacing: 0.3px;
        }
        .lang-badge.en { background: #eef2ff; color: #667eea; }
        .lang-badge.ta { background: #fef3c7; color: #d97706; }
        .lang-badge.both { background: #ecfdf5; color: #059669; }
        .fav-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 4px;
            transition: transform 0.2s;
            z-index: 2;
        }
        .fav-btn:active { transform: scale(1.3); }
        .fav-btn .heart-empty { color: #d1d5db; }
        .fav-btn .heart-filled { color: #ef4444; display: none; }
        .fav-btn.favorited .heart-empty { display: none; }
        .fav-btn.favorited .heart-filled { display: inline; }

        /* Loading */
        .loading-spinner {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            color: #9ca3af;
        }
        .spinner {
            width: 36px;
            height: 36px;
            border: 3px solid #e5e7eb;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 12px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 24px;
            text-align: center;
        }
        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        .empty-state-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: #374151;
            margin-bottom: 6px;
        }
        .empty-state-text {
            font-size: 0.88rem;
            color: #9ca3af;
            max-width: 260px;
        }

        /* Reading View Overlay */
        .reading-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 200;
            background: #f8f9fb;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        .reading-overlay.open {
            transform: translateX(0);
        }
        .reading-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: white;
            box-shadow: 0 1px 4px rgba(0,0,0,0.06);
            flex-shrink: 0;
            z-index: 1;
        }
        .reading-back {
            background: none;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            padding: 6px;
            color: #374151;
            display: flex;
            align-items: center;
        }
        .reading-title {
            flex: 1;
            font-size: 0.95rem;
            font-weight: 700;
            color: #1f2937;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .reading-fav {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 6px;
        }
        .reading-close {
            background: none;
            border: none;
            font-size: 1.4rem;
            cursor: pointer;
            padding: 6px;
            color: #6b7280;
        }
        .lang-toggle {
            display: flex;
            gap: 8px;
            padding: 10px 16px;
            background: white;
            border-bottom: 1px solid #f0f0f0;
            flex-shrink: 0;
        }
        .lang-toggle-btn {
            flex: 1;
            padding: 8px;
            border-radius: 10px;
            border: 1.5px solid #e5e7eb;
            background: white;
            color: #6b7280;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }
        .lang-toggle-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
        }
        .reading-body {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        .reading-content {
            padding: 20px 16px 40px 16px;
        }
        .reading-content h1, .reading-content h2, .reading-content h3 {
            color: #1f2937;
            margin-bottom: 12px;
        }
        .reading-content h1 { font-size: 1.4rem; font-weight: 800; }
        .reading-content h2 { font-size: 1.15rem; font-weight: 700; margin-top: 24px; }
        .reading-content h3 { font-size: 1rem; font-weight: 600; margin-top: 16px; }
        .reading-content p {
            color: #4b5563;
            font-size: 0.95rem;
            line-height: 1.7;
            margin-bottom: 12px;
        }
        .reading-content ul, .reading-content ol {
            color: #4b5563;
            font-size: 0.95rem;
            line-height: 1.7;
            margin-bottom: 12px;
            padding-left: 24px;
        }
        .reading-content li { margin-bottom: 4px; }
        .reading-content img {
            max-width: 100%;
            border-radius: 12px;
            margin: 12px 0;
        }
        .reading-content code {
            background: #f3f4f6;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.88rem;
        }
        .reading-content pre {
            background: #1f2937;
            color: #e5e7eb;
            padding: 16px;
            border-radius: 12px;
            overflow-x: auto;
            margin-bottom: 12px;
        }
        .reading-content pre code {
            background: none;
            color: inherit;
            padding: 0;
        }
        .reading-content iframe {
            width: 100%;
            border: none;
            border-radius: 12px;
            min-height: 400px;
        }
        .reading-footer {
            padding: 12px 16px;
            background: white;
            border-top: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: #9ca3af;
            flex-shrink: 0;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #1f2937;
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 0.88rem;
            font-weight: 500;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 999;
            transition: transform 0.3s ease;
            white-space: nowrap;
        }
        .toast.show {
            transform: translateX(-50%) translateY(0);
        }
        .toast.error { background: #dc2626; }
    </style>
</head>
<body>

    <!-- Sidebar Container -->
    <div id="sidebar-container"></div>
    <script>fetch('/components/staff-sidebar.html').then(r=>r.text()).then(h=>{document.getElementById('sidebar-container').innerHTML=h});</script>

    <!-- Header Bar -->
    <div class="guide-header">
        <button class="header-btn" onclick="toggleSidebar()" aria-label="Menu">
            <svg width="22" height="22" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" d="M4 6h16M4 12h16M4 18h16"/>
            </svg>
        </button>
        <h1>Guides & Help</h1>
        <button class="header-btn" onclick="toggleSearch()" aria-label="Search" id="searchToggleBtn">
            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <circle cx="11" cy="11" r="8"/>
                <path stroke-linecap="round" d="M21 21l-4.35-4.35"/>
            </svg>
        </button>
    </div>

    <!-- Search Bar (collapsible) -->
    <div class="search-bar" id="searchBar">
        <div class="search-input-wrap">
            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <circle cx="11" cy="11" r="8"/>
                <path stroke-linecap="round" d="M21 21l-4.35-4.35"/>
            </svg>
            <input type="text" class="search-input" id="searchInput" placeholder="Search guides..." autocomplete="off" oninput="onSearchInput()">
            <button class="search-clear" id="searchClear" onclick="clearSearch()">&#10005;</button>
        </div>
    </div>

    <!-- Content Area -->
    <div class="content-container">
        <!-- Category Chips -->
        <div class="chips-row" id="chipsRow">
            <div class="chip active" data-cat-id="all" onclick="filterByCategory('all')">
                <span class="chip-icon">&#9733;</span>
                <span>All</span>
            </div>
            <!-- dynamically populated -->
        </div>

        <!-- Loading State -->
        <div class="loading-spinner" id="loadingState">
            <div class="spinner"></div>
            <span>Loading guides...</span>
        </div>

        <!-- Guide Cards -->
        <div class="guides-grid" id="guidesGrid" style="display:none;"></div>

        <!-- Empty State -->
        <div class="empty-state" id="emptyState" style="display:none;">
            <div class="empty-state-icon" id="emptyIcon">&#128218;</div>
            <div class="empty-state-title" id="emptyTitle">No guides available yet</div>
            <div class="empty-state-text" id="emptyText">Guides will appear here once your admin publishes them.</div>
        </div>
    </div>

    <!-- Reading View Overlay -->
    <div class="reading-overlay" id="readingOverlay">
        <div class="reading-header">
            <button class="reading-back" onclick="closeGuide()" aria-label="Back">
                <svg width="22" height="22" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/>
                </svg>
            </button>
            <div class="reading-title" id="readingTitle">Guide Title</div>
            <button class="reading-fav" id="readingFavBtn" onclick="toggleReadingFavorite()">
                <span class="heart-empty">&#9825;</span>
                <span class="heart-filled" style="color:#ef4444;">&#9829;</span>
            </button>
            <button class="reading-close" onclick="closeGuide()" aria-label="Close">&#10005;</button>
        </div>
        <div class="lang-toggle" id="langToggle" style="display:none;">
            <button class="lang-toggle-btn active" id="langBtnEn" onclick="switchLang('en')">English</button>
            <button class="lang-toggle-btn" id="langBtnTa" onclick="switchLang('ta')">Tamil</button>
        </div>
        <div class="reading-body" id="readingBody">
            <div class="reading-content" id="readingContent"></div>
        </div>
        <div class="reading-footer">
            <span id="readingUpdated">Last updated: --</span>
            <span id="readingViews">Views: --</span>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

<script>
    const token = localStorage.getItem('auth_token');
    let allGuides = [];
    let allCategories = [];
    let activeCategoryId = 'all';
    let searchQuery = '';
    let searchDebounce = null;
    let currentGuide = null;
    let currentLang = 'en';
    let favorites = new Set();

    // =========== INIT ===========
    document.addEventListener('DOMContentLoaded', () => {
        loadCategories();
        loadGuides();
    });

    // =========== CATEGORIES ===========
    async function loadCategories() {
        try {
            const res = await fetch('/api/guides/categories', {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            if (!res.ok) throw new Error('Failed to load categories');
            const data = await res.json();
            allCategories = data.categories || data || [];
            renderChips();
        } catch (err) {
            console.error('Categories error:', err);
            // Keep the "All" chip even if categories fail
        }
    }

    function renderChips() {
        const row = document.getElementById('chipsRow');
        // Keep the "All" chip
        let html = `<div class="chip ${activeCategoryId === 'all' ? 'active' : ''}" data-cat-id="all" onclick="filterByCategory('all')">
            <span class="chip-icon">&#9733;</span>
            <span>All</span>
        </div>`;

        allCategories.forEach(cat => {
            const isActive = activeCategoryId == cat.id;
            const icon = cat.icon || '&#128196;';
            html += `<div class="chip ${isActive ? 'active' : ''}" data-cat-id="${cat.id}" onclick="filterByCategory('${cat.id}')">
                <span class="chip-icon">${icon}</span>
                <span>${escapeHtml(cat.name)}</span>
            </div>`;
        });

        row.innerHTML = html;
    }

    // =========== GUIDES ===========
    async function loadGuides(categoryId, search) {
        showLoading(true);
        hideEmpty();
        document.getElementById('guidesGrid').style.display = 'none';

        try {
            let url = '/api/guides?staff_view=1';
            if (categoryId && categoryId !== 'all') {
                url += '&category_id=' + encodeURIComponent(categoryId);
            }
            if (search) {
                url += '&search=' + encodeURIComponent(search);
            }

            const res = await fetch(url, {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            if (!res.ok) throw new Error('Failed to load guides');

            const data = await res.json();
            allGuides = data.guides || data || [];

            // Extract favorites
            allGuides.forEach(g => {
                if (g.is_favorited) favorites.add(g.id);
            });

            renderGuides(allGuides);
        } catch (err) {
            console.error('Guides error:', err);
            showToast('Failed to load guides', true);
            showEmpty('error');
        } finally {
            showLoading(false);
        }
    }

    function renderGuides(guides) {
        const grid = document.getElementById('guidesGrid');

        if (!guides || guides.length === 0) {
            grid.style.display = 'none';
            if (searchQuery) {
                showEmpty('search');
            } else {
                showEmpty('none');
            }
            return;
        }

        hideEmpty();
        grid.style.display = 'grid';

        grid.innerHTML = guides.map(g => {
            const isFav = favorites.has(g.id);
            const catName = g.category_name || 'General';
            const catIcon = g.category_icon || '&#128196;';
            const langLabel = getLangLabel(g);
            const langClass = getLangClass(g);
            const viewCount = g.view_count || 0;
            const updatedDate = g.updated_at ? formatDate(g.updated_at) : '';
            const tamilTitle = g.title_ta || '';
            const summary = g.summary || g.description || '';

            return `<div class="guide-card" onclick="openGuide(${g.id})">
                <button class="fav-btn ${isFav ? 'favorited' : ''}" onclick="event.stopPropagation(); toggleFavorite(${g.id}, this)">
                    <span class="heart-empty">&#9825;</span>
                    <span class="heart-filled">&#9829;</span>
                </button>
                <div class="card-category">
                    <span class="card-category-icon">${catIcon}</span>
                    <span>${escapeHtml(catName)}</span>
                </div>
                <div class="card-title">${escapeHtml(g.title)}</div>
                ${tamilTitle ? `<div class="card-title-ta">${escapeHtml(tamilTitle)}</div>` : ''}
                <div class="card-summary">${escapeHtml(summary)}</div>
                <div class="card-footer">
                    <div class="card-meta">
                        <span class="lang-badge ${langClass}">${langLabel}</span>
                        <span class="card-meta-item">
                            <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                            ${viewCount}
                        </span>
                        ${updatedDate ? `<span class="card-meta-item">${updatedDate}</span>` : ''}
                    </div>
                </div>
            </div>`;
        }).join('');
    }

    // =========== OPEN GUIDE (Reading View) ===========
    async function openGuide(guideId) {
        const overlay = document.getElementById('readingOverlay');
        const content = document.getElementById('readingContent');
        const titleEl = document.getElementById('readingTitle');
        const langToggle = document.getElementById('langToggle');

        // Reset
        content.innerHTML = '<div class="loading-spinner"><div class="spinner"></div><span>Loading guide...</span></div>';
        titleEl.textContent = 'Loading...';
        langToggle.style.display = 'none';
        currentGuide = null;
        currentLang = 'en';

        overlay.classList.add('open');
        document.body.style.overflow = 'hidden';

        try {
            const res = await fetch('/api/guides/' + guideId, {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            if (!res.ok) throw new Error('Failed to load guide');

            const data = await res.json();
            currentGuide = data.guide || data;

            titleEl.textContent = currentGuide.title || 'Guide';

            // Update favorite state
            const favBtn = document.getElementById('readingFavBtn');
            if (favorites.has(currentGuide.id)) {
                favBtn.classList.add('favorited');
            } else {
                favBtn.classList.remove('favorited');
            }

            // Show lang toggle if both EN and TA content available
            const hasEn = !!(currentGuide.content_en || currentGuide.content);
            const hasTa = !!currentGuide.content_ta;
            if (hasEn && hasTa) {
                langToggle.style.display = 'flex';
                currentLang = 'en';
                updateLangButtons();
            } else {
                langToggle.style.display = 'none';
                currentLang = hasEn ? 'en' : 'ta';
            }

            renderGuideContent();

            // Update footer
            document.getElementById('readingUpdated').textContent =
                'Last updated: ' + (currentGuide.updated_at ? formatDate(currentGuide.updated_at) : '--');
            document.getElementById('readingViews').textContent =
                'Views: ' + (currentGuide.view_count || 0);

            // Update view count in local list too
            const idx = allGuides.findIndex(g => g.id === currentGuide.id);
            if (idx !== -1) {
                allGuides[idx].view_count = (allGuides[idx].view_count || 0) + 1;
            }

        } catch (err) {
            console.error('Open guide error:', err);
            content.innerHTML = '<div class="empty-state"><div class="empty-state-icon">&#9888;</div><div class="empty-state-title">Failed to load guide</div><div class="empty-state-text">Please try again later.</div></div>';
        }
    }

    function renderGuideContent() {
        if (!currentGuide) return;

        const content = document.getElementById('readingContent');
        const contentType = currentGuide.content_type || 'rich_text';

        let htmlContent = '';
        if (currentLang === 'ta' && currentGuide.content_ta) {
            htmlContent = currentGuide.content_ta;
        } else {
            htmlContent = currentGuide.content_en || currentGuide.content || '';
        }

        if (contentType === 'full_html') {
            // Render in sandboxed iframe
            const iframe = document.createElement('iframe');
            iframe.sandbox = 'allow-same-origin';
            iframe.style.cssText = 'width:100%;border:none;border-radius:12px;min-height:60vh;';
            content.innerHTML = '';
            content.appendChild(iframe);

            iframe.addEventListener('load', () => {
                try {
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    iframeDoc.open();
                    iframeDoc.write(htmlContent);
                    iframeDoc.close();
                    // Auto-resize iframe to content
                    setTimeout(() => {
                        const h = iframeDoc.body.scrollHeight;
                        iframe.style.height = (h + 40) + 'px';
                    }, 200);
                } catch (e) {
                    console.error('iframe render error:', e);
                }
            });

            // Trigger load for blank iframe
            iframe.src = 'about:blank';
        } else {
            // rich_text: render HTML directly
            content.innerHTML = htmlContent;
        }
    }

    function closeGuide() {
        const overlay = document.getElementById('readingOverlay');
        overlay.classList.remove('open');
        document.body.style.overflow = '';
        currentGuide = null;

        // Re-render guides to update view counts
        renderGuides(allGuides);
    }

    // =========== LANGUAGE TOGGLE ===========
    function switchLang(lang) {
        currentLang = lang;
        updateLangButtons();
        renderGuideContent();
    }

    function updateLangButtons() {
        const enBtn = document.getElementById('langBtnEn');
        const taBtn = document.getElementById('langBtnTa');
        enBtn.classList.toggle('active', currentLang === 'en');
        taBtn.classList.toggle('active', currentLang === 'ta');
    }

    // =========== FAVORITES ===========
    async function toggleFavorite(guideId, btnEl) {
        try {
            const res = await fetch('/api/guides/' + guideId + '/favorite', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                }
            });
            if (!res.ok) throw new Error('Failed to toggle favorite');

            const data = await res.json();
            const isFav = data.favorited || data.is_favorited;

            if (isFav) {
                favorites.add(guideId);
            } else {
                favorites.delete(guideId);
            }

            // Update card button
            if (btnEl) {
                btnEl.classList.toggle('favorited', !!isFav);
            }

            showToast(isFav ? 'Added to favorites' : 'Removed from favorites');
        } catch (err) {
            console.error('Favorite error:', err);
            showToast('Failed to update favorite', true);
        }
    }

    function toggleReadingFavorite() {
        if (!currentGuide) return;
        const favBtn = document.getElementById('readingFavBtn');
        const isFavNow = favorites.has(currentGuide.id);

        // Optimistic UI update
        if (isFavNow) {
            favorites.delete(currentGuide.id);
            favBtn.classList.remove('favorited');
        } else {
            favorites.add(currentGuide.id);
            favBtn.classList.add('favorited');
        }

        // API call
        fetch('/api/guides/' + currentGuide.id + '/favorite', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            }
        }).then(res => {
            if (!res.ok) throw new Error('fail');
            return res.json();
        }).then(data => {
            const isFav = data.favorited || data.is_favorited;
            if (isFav) {
                favorites.add(currentGuide.id);
            } else {
                favorites.delete(currentGuide.id);
            }
            favBtn.classList.toggle('favorited', !!isFav);
            showToast(isFav ? 'Added to favorites' : 'Removed from favorites');
        }).catch(() => {
            // Revert
            if (isFavNow) {
                favorites.add(currentGuide.id);
                favBtn.classList.add('favorited');
            } else {
                favorites.delete(currentGuide.id);
                favBtn.classList.remove('favorited');
            }
            showToast('Failed to update favorite', true);
        });
    }

    // =========== SEARCH ===========
    function toggleSearch() {
        const bar = document.getElementById('searchBar');
        const input = document.getElementById('searchInput');
        bar.classList.toggle('open');

        if (bar.classList.contains('open')) {
            setTimeout(() => input.focus(), 300);
        } else {
            input.value = '';
            searchQuery = '';
            document.getElementById('searchClear').classList.remove('visible');
            loadGuides(activeCategoryId);
        }
    }

    function onSearchInput() {
        const val = document.getElementById('searchInput').value.trim();
        const clearBtn = document.getElementById('searchClear');
        clearBtn.classList.toggle('visible', val.length > 0);

        clearTimeout(searchDebounce);
        searchDebounce = setTimeout(() => {
            searchQuery = val;
            searchGuides();
        }, 350);
    }

    function searchGuides() {
        loadGuides(activeCategoryId, searchQuery);
    }

    function clearSearch() {
        const input = document.getElementById('searchInput');
        input.value = '';
        searchQuery = '';
        document.getElementById('searchClear').classList.remove('visible');
        input.focus();
        loadGuides(activeCategoryId);
    }

    // =========== FILTER ===========
    function filterByCategory(catId) {
        activeCategoryId = catId;
        renderChips();
        loadGuides(activeCategoryId, searchQuery);
    }

    // =========== HELPERS ===========
    function showLoading(show) {
        document.getElementById('loadingState').style.display = show ? 'flex' : 'none';
    }

    function showEmpty(type) {
        const el = document.getElementById('emptyState');
        const icon = document.getElementById('emptyIcon');
        const title = document.getElementById('emptyTitle');
        const text = document.getElementById('emptyText');

        if (type === 'search') {
            icon.innerHTML = '&#128269;';
            title.textContent = 'No matching guides found';
            text.textContent = 'Try different search terms or clear the filter.';
        } else if (type === 'error') {
            icon.innerHTML = '&#9888;';
            title.textContent = 'Something went wrong';
            text.textContent = 'Unable to load guides. Please try again later.';
        } else {
            icon.innerHTML = '&#128218;';
            title.textContent = 'No guides available yet';
            text.textContent = 'Guides will appear here once your admin publishes them.';
        }
        el.style.display = 'flex';
    }

    function hideEmpty() {
        document.getElementById('emptyState').style.display = 'none';
    }

    function getLangLabel(guide) {
        const hasEn = !!(guide.content_en || guide.content);
        const hasTa = !!guide.content_ta;
        if (hasEn && hasTa) return 'EN / TA';
        if (hasTa) return 'TA';
        return 'EN';
    }

    function getLangClass(guide) {
        const hasEn = !!(guide.content_en || guide.content);
        const hasTa = !!guide.content_ta;
        if (hasEn && hasTa) return 'both';
        if (hasTa) return 'ta';
        return 'en';
    }

    function formatDate(dateStr) {
        try {
            const d = new Date(dateStr);
            const now = new Date();
            const diffMs = now - d;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return diffDays + 'd ago';
            if (diffDays < 30) return Math.floor(diffDays / 7) + 'w ago';

            return d.toLocaleDateString('en-IN', { day: 'numeric', month: 'short' });
        } catch (e) {
            return '';
        }
    }

    function escapeHtml(str) {
        if (!str) return '';
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    function showToast(msg, isError) {
        const toast = document.getElementById('toast');
        toast.textContent = msg;
        toast.className = 'toast' + (isError ? ' error' : '');

        // Force reflow
        void toast.offsetWidth;
        toast.classList.add('show');

        setTimeout(() => {
            toast.classList.remove('show');
        }, 2500);
    }
</script>

</body>
</html>
