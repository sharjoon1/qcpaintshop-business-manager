<!-- Staff Sidebar Navigation Component -->
<style>
    /* Sidebar Styles (same base as admin) */
    .qc-sidebar { position: fixed; top: 0; left: -320px; width: 320px; height: 100vh; background: linear-gradient(180deg, #0891b2 0%, #06b6d4 100%); box-shadow: 4px 0 20px rgba(0,0,0,0.3); transition: left 0.3s; z-index: 1002; overflow-y: auto; display: flex; flex-direction: column; }
    .qc-sidebar.open { left: 0; }
    
    .qc-sidebar-header { padding: 1.5rem; border-bottom: 1px solid rgba(255,255,255,0.15); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
    .qc-sidebar-brand { color: white; font-size: 1.25rem; font-weight: 700; display: flex; align-items: center; gap: 0.75rem; }
    .qc-sidebar-close { background: rgba(255,255,255,0.1); border: none; color: white; width: 36px; height: 36px; border-radius: 50%; font-size: 1.5rem; cursor: pointer; transition: all 0.2s; }
    .qc-sidebar-close:hover { background: rgba(255,255,255,0.2); transform: rotate(90deg); }
    
    .qc-sidebar-user { padding: 1rem 1.5rem; border-bottom: 1px solid rgba(255,255,255,0.15); color: white; flex-shrink: 0; }
    .qc-sidebar-user-info { display: flex; align-items: center; gap: 1rem; }
    .qc-sidebar-user-avatar { width: 48px; height: 48px; border-radius: 50%; background: white; color: #0891b2; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.25rem; }
    .qc-sidebar-user-avatar img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
    .qc-sidebar-user-details { flex: 1; }
    .qc-sidebar-user-name { font-weight: 600; font-size: 0.95rem; }
    .qc-sidebar-user-role { font-size: 0.75rem; opacity: 0.9; }
    .qc-sidebar-user-branch { font-size: 0.7rem; opacity: 0.8; margin-top: 0.25rem; }
    
    .qc-sidebar-nav { padding: 1rem 0; flex: 1; overflow-y: auto; }
    .qc-nav-section { margin-bottom: 1.5rem; }
    .qc-nav-section-title { padding: 0.5rem 1.5rem; color: rgba(255,255,255,0.7); font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
    
    .qc-nav-item { display: block; padding: 0.85rem 1.5rem; color: rgba(255,255,255,0.9); text-decoration: none; transition: all 0.2s; display: flex; align-items: center; gap: 0.75rem; font-weight: 500; font-size: 0.9rem; }
    .qc-nav-item:hover { background: rgba(255,255,255,0.15); color: white; padding-left: 2rem; }
    .qc-nav-item.active { background: rgba(255,255,255,0.2); color: white; border-left: 4px solid white; padding-left: calc(1.5rem - 4px); }
    .qc-nav-item-icon { font-size: 1.1rem; width: 24px; text-align: center; }
    
    .qc-sidebar-footer { padding: 1rem 1.5rem; border-top: 1px solid rgba(255,255,255,0.15); flex-shrink: 0; }
    .qc-sidebar-logout { display: flex; align-items: center; gap: 0.75rem; padding: 0.85rem 1rem; background: rgba(255,255,255,0.1); border: none; color: white; border-radius: 8px; cursor: pointer; width: 100%; font-weight: 600; transition: all 0.2s; }
    .qc-sidebar-logout:hover { background: rgba(239, 68, 68, 0.8); }
    
    .qc-sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: rgba(0,0,0,0.5); z-index: 1001; }
    .qc-sidebar-overlay.show { display: block; }
    
    @media (max-width: 768px) { .qc-sidebar { width: 85%; max-width: 320px; } }
</style>

<!-- Overlay -->
<div class="qc-sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

<!-- Sidebar -->
<aside class="qc-sidebar" id="mainSidebar">
    <!-- Header -->
    <div class="qc-sidebar-header">
        <div class="qc-sidebar-brand">
            <span>üë§</span>
            <span>Staff Portal</span>
        </div>
        <button class="qc-sidebar-close" onclick="closeSidebar()">√ó</button>
    </div>
    
    <!-- User Info -->
    <div class="qc-sidebar-user">
        <div class="qc-sidebar-user-info">
            <div class="qc-sidebar-user-avatar" id="sidebarAvatar">
                <span id="sidebarInitial">S</span>
            </div>
            <div class="qc-sidebar-user-details">
                <div class="qc-sidebar-user-name" id="sidebarName">Staff Member</div>
                <div class="qc-sidebar-user-role" id="sidebarRole">Employee</div>
                <div class="qc-sidebar-user-branch" id="sidebarBranch">üìç Branch Name</div>
            </div>
        </div>
    </div>
    
    <!-- Navigation -->
    <nav class="qc-sidebar-nav">
        <!-- Main -->
        <div class="qc-nav-section">
            <a href="/staff/dashboard.html" class="qc-nav-item" data-page="dashboard">
                <span class="qc-nav-item-icon">üè†</span>
                <span>My Dashboard</span>
            </a>
            <a href="/dashboard.html" class="qc-nav-item" data-page="main-dashboard">
                <span class="qc-nav-item-icon">üìä</span>
                <span>Main Dashboard</span>
            </a>
        </div>
        
        <!-- My Work -->
        <div class="qc-nav-section">
            <div class="qc-nav-section-title">My Work</div>
            <a href="/staff-estimates.html" class="qc-nav-item" data-page="estimates" data-requires="estimates.view">
                <span class="qc-nav-item-icon">üìã</span>
                <span>My Estimates</span>
            </a>
            <a href="/staff-requests.html" class="qc-nav-item" data-page="requests">
                <span class="qc-nav-item-icon">üìù</span>
                <span>My Requests</span>
            </a>
        </div>
        
        <!-- Attendance -->
        <div class="qc-nav-section">
            <div class="qc-nav-section-title">Attendance</div>
            <a href="/staff/clock-in.html" class="qc-nav-item" data-page="clock-in" data-requires="attendance.view">
                <span class="qc-nav-item-icon">üü¢</span>
                <span>Clock In</span>
            </a>
            <a href="/staff/clock-out.html" class="qc-nav-item" data-page="clock-out" data-requires="attendance.view">
                <span class="qc-nav-item-icon">üî¥</span>
                <span>Clock Out</span>
            </a>
            <a href="/staff/history.html" class="qc-nav-item" data-page="history" data-requires="attendance.view">
                <span class="qc-nav-item-icon">üìú</span>
                <span>My History</span>
            </a>
        </div>
        
        <!-- Permissions -->
        <div class="qc-nav-section">
            <div class="qc-nav-section-title">Permissions</div>
            <a href="/staff/permission-request.html" class="qc-nav-item" data-page="permission" data-requires="attendance.view">
                <span class="qc-nav-item-icon">‚úã</span>
                <span>Request Permission</span>
            </a>
        </div>
        
        <!-- Customers -->
        <div class="qc-nav-section">
            <div class="qc-nav-section-title">Customers</div>
            <a href="/admin-credit-limits.html" class="qc-nav-item" data-page="credit-limits">
                <span class="qc-nav-item-icon">üí≥</span>
                <span>Credit Limits</span>
            </a>
        </div>

        <!-- Inventory -->
        <div class="qc-nav-section">
            <div class="qc-nav-section-title">Inventory</div>
            <a href="/staff/stock-check.html" class="qc-nav-item" data-page="stock-check" data-requires="zoho.stock_check">
                <span class="qc-nav-item-icon">üì¶</span>
                <span>Stock Check</span>
            </a>
            <a href="/staff/collections.html" class="qc-nav-item" data-page="collections" data-requires="zoho.collections">
                <span class="qc-nav-item-icon">üí∞</span>
                <span>Collections</span>
            </a>
        </div>

        <!-- Help & Guides -->
        <div class="qc-nav-section">
            <div class="qc-nav-section-title">Help</div>
            <a href="/staff/guides.html" class="qc-nav-item" data-page="guides">
                <span class="qc-nav-item-icon">üìñ</span>
                <span>Guides & Help</span>
            </a>
        </div>

        <!-- Profile -->
        <div class="qc-nav-section">
            <div class="qc-nav-section-title">Account</div>
            <a href="/admin-profile.html" class="qc-nav-item" data-page="profile">
                <span class="qc-nav-item-icon">üë§</span>
                <span>My Profile</span>
            </a>
        </div>
    </nav>
    
    <!-- Footer -->
    <div class="qc-sidebar-footer">
        <button class="qc-sidebar-logout" onclick="logoutUser()">
            <span>üö™</span>
            <span>Logout</span>
        </button>
    </div>
</aside>

<script>
// Sidebar Controls
function toggleSidebar() {
    document.getElementById('mainSidebar').classList.toggle('open');
    document.getElementById('sidebarOverlay').classList.toggle('show');
}

function closeSidebar() {
    document.getElementById('mainSidebar').classList.remove('open');
    document.getElementById('sidebarOverlay').classList.remove('show');
}

// Load User Info into Sidebar
function loadSidebarUserInfo() {
    const user = JSON.parse(localStorage.getItem('user') || '{}');
    
    const nameEl = document.getElementById('sidebarName');
    if (nameEl && user.full_name) {
        nameEl.textContent = user.full_name;
    }
    
    const roleEl = document.getElementById('sidebarRole');
    if (roleEl && user.role) {
        roleEl.textContent = user.role.charAt(0).toUpperCase() + user.role.slice(1);
    }
    
    const branchEl = document.getElementById('sidebarBranch');
    if (branchEl && user.branch_name) {
        branchEl.textContent = `üìç ${user.branch_name}`;
    }
    
    const avatarEl = document.getElementById('sidebarAvatar');
    const initialEl = document.getElementById('sidebarInitial');
    
    if (user.profile_image_url) {
        avatarEl.innerHTML = `<img src="${user.profile_image_url}" alt="Profile">`;
    } else if (user.full_name && initialEl) {
        initialEl.textContent = user.full_name.charAt(0).toUpperCase();
    }
}

// Highlight Active Page
function highlightActiveSidebarPage() {
    const path = window.location.pathname;
    document.querySelectorAll('.qc-nav-item[data-page]').forEach(item => {
        const page = item.getAttribute('data-page');
        if (path.includes(page)) {
            item.classList.add('active');
        }
    });
}

// Filter sidebar items by user permissions
async function filterSidebarByPermissions() {
    try {
        // Check localStorage cache first (same key as PermissionManager)
        let permData = null;
        const cached = localStorage.getItem('user_permissions');
        if (cached) {
            try {
                const parsed = JSON.parse(cached);
                if (parsed.timestamp && (Date.now() - parsed.timestamp) < 3600000) {
                    permData = parsed;
                }
            } catch(e) {}
        }

        // Fetch from API if no valid cache
        if (!permData) {
            const token = localStorage.getItem('auth_token');
            if (!token) return;
            const resp = await fetch('/api/auth/permissions', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!resp.ok) return;
            permData = await resp.json();
            permData.timestamp = Date.now();
            localStorage.setItem('user_permissions', JSON.stringify(permData));
        }

        // Admin bypass ‚Äî show everything
        if (permData.is_admin) return;

        // Build permission set for fast lookup
        const permSet = new Set();
        if (Array.isArray(permData.permissions)) {
            permData.permissions.forEach(p => permSet.add(`${p.module}.${p.action}`));
        }

        // Hide gated items the user lacks permission for
        document.querySelectorAll('[data-requires]').forEach(el => {
            const required = el.getAttribute('data-requires');
            if (!permSet.has(required)) {
                el.style.display = 'none';
            }
        });

        // Hide sections where all nav items are hidden
        document.querySelectorAll('.qc-nav-section').forEach(section => {
            const items = section.querySelectorAll('.qc-nav-item');
            if (items.length === 0) return;
            const allHidden = Array.from(items).every(item => item.style.display === 'none');
            if (allHidden) {
                section.style.display = 'none';
            }
        });
    } catch(e) {
        // On error, leave sidebar as-is (show all)
    }
}

// Logout
function logoutUser() {
    if (confirm('Are you sure you want to logout?')) {
        localStorage.removeItem('auth_token');
        localStorage.removeItem('user');
        window.location.href = '/login.html';
    }
}

// Initialize on load
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
        loadSidebarUserInfo();
        highlightActiveSidebarPage();
        filterSidebarByPermissions();
    });
} else {
    loadSidebarUserInfo();
    highlightActiveSidebarPage();
    filterSidebarByPermissions();
}
</script>
