<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192x192.png">
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>Zoho Locations - Quality Colours Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/css/design-system.css">
    <link rel="stylesheet" href="/css/zoho-common.css">
    <script src="/universal-nav-loader.js"></script>
    <script src="/js/auth-helper.js"></script>
    <script>requireAdminOrRedirect();</script>
    <style>
        body { background: #f9fafb; }

        .location-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            border: 1px solid #f3f4f6;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .location-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }

        .badge {
            display: inline-block;
            padding: 2px 10px;
            border-radius: 9999px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }
        .badge-active { background: #dcfce7; color: #166534; }
        .badge-inactive { background: #fee2e2; color: #991b1b; }
        .badge-primary { background: #dbeafe; color: #1e40af; }

        .spin { animation: spin 1s linear infinite; }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .branch-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            padding-right: 2.25rem;
        }
    </style>
</head>
<body class="bg-gray-50" data-page="zoho-locations">
    <!-- Toast Container -->
    <div id="toast" class="toast" role="alert"></div>

    <div class="container mx-auto p-4 md:p-6">

        <!-- Page Header -->
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6">
            <div>
                <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Zoho Locations</h1>
                <p class="text-gray-500 text-sm mt-1" id="summaryText">Loading locations...</p>
            </div>
            <div class="mt-3 sm:mt-0 flex items-center gap-2">
                <button id="syncBtn" onclick="syncLocations()" class="inline-flex items-center gap-2 px-4 py-2 text-white text-sm font-semibold rounded-lg transition shadow-sm" style="background: #667eea;" onmouseover="this.style.background='#5a6fd6'" onmouseout="this.style.background='#667eea'">
                    <svg id="syncIcon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    <span id="syncBtnText">Sync Locations</span>
                </button>
            </div>
        </div>

        <!-- Loading Skeleton Grid -->
        <div id="loadingGrid" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div class="location-card">
                <div class="skeleton" style="width: 60%; height: 24px; margin-bottom: 12px;"></div>
                <div class="skeleton" style="width: 40%; height: 16px; margin-bottom: 8px;"></div>
                <div class="skeleton" style="width: 80%; height: 16px; margin-bottom: 16px;"></div>
                <div class="skeleton" style="width: 100%; height: 38px; margin-bottom: 12px;"></div>
                <div class="skeleton" style="width: 30%; height: 14px;"></div>
            </div>
            <div class="location-card">
                <div class="skeleton" style="width: 55%; height: 24px; margin-bottom: 12px;"></div>
                <div class="skeleton" style="width: 35%; height: 16px; margin-bottom: 8px;"></div>
                <div class="skeleton" style="width: 75%; height: 16px; margin-bottom: 16px;"></div>
                <div class="skeleton" style="width: 100%; height: 38px; margin-bottom: 12px;"></div>
                <div class="skeleton" style="width: 30%; height: 14px;"></div>
            </div>
            <div class="location-card">
                <div class="skeleton" style="width: 50%; height: 24px; margin-bottom: 12px;"></div>
                <div class="skeleton" style="width: 45%; height: 16px; margin-bottom: 8px;"></div>
                <div class="skeleton" style="width: 70%; height: 16px; margin-bottom: 16px;"></div>
                <div class="skeleton" style="width: 100%; height: 38px; margin-bottom: 12px;"></div>
                <div class="skeleton" style="width: 30%; height: 14px;"></div>
            </div>
            <div class="location-card">
                <div class="skeleton" style="width: 65%; height: 24px; margin-bottom: 12px;"></div>
                <div class="skeleton" style="width: 38%; height: 16px; margin-bottom: 8px;"></div>
                <div class="skeleton" style="width: 85%; height: 16px; margin-bottom: 16px;"></div>
                <div class="skeleton" style="width: 100%; height: 38px; margin-bottom: 12px;"></div>
                <div class="skeleton" style="width: 30%; height: 14px;"></div>
            </div>
        </div>

        <!-- Locations Grid -->
        <div id="locationsGrid" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 hidden"></div>

        <!-- Empty State -->
        <div id="emptyState" class="hidden">
            <div class="bg-white rounded-lg shadow p-12 text-center">
                <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                <h3 class="text-lg font-bold text-gray-600 mb-2">No Locations Found</h3>
                <p class="text-gray-400 text-sm mb-4">Sync your Zoho Books locations to get started.</p>
                <button onclick="syncLocations()" class="inline-flex items-center gap-2 px-5 py-2.5 text-white text-sm font-semibold rounded-lg transition" style="background: #667eea;" onmouseover="this.style.background='#5a6fd6'" onmouseout="this.style.background='#667eea'">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    Sync Locations Now
                </button>
            </div>
        </div>

    </div>

<script>
    // ========================
    // Toast Notification
    // ========================
    function showToast(message, type) {
        var toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = 'toast toast-' + (type || 'info');
        toast.classList.add('show');
        setTimeout(function() { toast.classList.remove('show'); }, 3500);
    }

    // ========================
    // Utility Functions
    // ========================
    function escapeHtml(text) {
        if (!text) return '';
        var div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function formatDateTime(dateStr) {
        if (!dateStr) return '--';
        try {
            var d = new Date(dateStr);
            if (isNaN(d.getTime())) return '--';
            return d.toLocaleString('en-IN', {
                day: '2-digit', month: 'short', year: 'numeric',
                hour: '2-digit', minute: '2-digit', hour12: true
            });
        } catch (e) {
            return '--';
        }
    }

    // ========================
    // State
    // ========================
    var locations = [];
    var branches = [];

    // ========================
    // API Fetch Helper
    // ========================
    async function zohoFetch(url, options) {
        try { return await apiRequest(url, options); }
        catch (err) { showToast(err.message || 'Network error', 'error'); return null; }
    }

    // ========================
    // Load Branches (for dropdown)
    // ========================
    async function loadBranches() {
        var response = await zohoFetch('/api/branches');
        if (!response) return;
        try {
            var data = await response.json();
            // Handle both array and object with data/branches key
            if (Array.isArray(data)) {
                branches = data;
            } else if (data.data && Array.isArray(data.data)) {
                branches = data.data;
            } else if (data.branches && Array.isArray(data.branches)) {
                branches = data.branches;
            } else {
                branches = [];
            }
        } catch (e) {
            console.error('Failed to parse branches:', e);
            branches = [];
        }
    }

    // ========================
    // Load Locations
    // ========================
    async function loadLocations() {
        var loadingGrid = document.getElementById('loadingGrid');
        var locationsGrid = document.getElementById('locationsGrid');
        var emptyState = document.getElementById('emptyState');

        loadingGrid.classList.remove('hidden');
        locationsGrid.classList.add('hidden');
        emptyState.classList.add('hidden');

        var response = await zohoFetch('/api/zoho/locations?include_inactive=1');
        if (!response) {
            loadingGrid.classList.add('hidden');
            emptyState.classList.remove('hidden');
            document.getElementById('summaryText').textContent = 'Failed to load locations';
            return;
        }

        var data = await response.json();

        // Handle various response shapes
        if (data.success !== undefined && !data.success) {
            loadingGrid.classList.add('hidden');
            emptyState.classList.remove('hidden');
            document.getElementById('summaryText').textContent = data.message || 'Failed to load locations';
            return;
        }

        locations = data.locations || data.data || data || [];
        if (!Array.isArray(locations)) locations = [];

        loadingGrid.classList.add('hidden');

        if (locations.length === 0) {
            emptyState.classList.remove('hidden');
            document.getElementById('summaryText').textContent = '0 locations synced, 0 mapped to branches';
            return;
        }

        locationsGrid.classList.remove('hidden');
        renderLocations();
        updateSummary();
    }

    // ========================
    // Render Location Cards
    // ========================
    function renderLocations() {
        var grid = document.getElementById('locationsGrid');
        grid.innerHTML = '';

        locations.forEach(function(loc) {
            var card = document.createElement('div');
            card.className = 'location-card';
            card.id = 'location-card-' + loc.id;

            // Determine status
            var isActive = loc.status === 'active' || loc.is_active === 1 || loc.is_active === true;
            var isPrimary = loc.is_primary === 1 || loc.is_primary === true;
            var statusBadge = isActive
                ? '<span class="badge badge-active">Active</span>'
                : '<span class="badge badge-inactive">Inactive</span>';
            var primaryBadge = isPrimary
                ? '<span class="badge badge-primary ml-1">Primary</span>'
                : '';

            // Address
            var address = loc.address || loc.street || '';
            if (loc.city) address += (address ? ', ' : '') + loc.city;
            if (loc.state) address += (address ? ', ' : '') + loc.state;
            if (loc.zip || loc.zipcode) address += (address ? ' ' : '') + (loc.zip || loc.zipcode);

            // Branch mapping dropdown
            var currentBranchId = loc.branch_id || loc.mapped_branch_id || '';
            var branchOptions = '<option value="">-- Select Branch --</option>';
            branches.forEach(function(branch) {
                var selected = (String(branch.id) === String(currentBranchId)) ? ' selected' : '';
                branchOptions += '<option value="' + branch.id + '"' + selected + '>' + escapeHtml(branch.name || branch.branch_name || 'Branch #' + branch.id) + '</option>';
            });

            // Last synced
            var lastSynced = formatDateTime(loc.last_synced || loc.synced_at || loc.updated_at);

            card.innerHTML = '' +
                '<div class="flex items-start justify-between mb-3">' +
                    '<div class="flex-1 min-w-0">' +
                        '<h3 class="text-lg font-bold text-gray-800 truncate">' + escapeHtml(loc.name || loc.location_name || 'Unnamed Location') + '</h3>' +
                        '<div class="flex items-center gap-1.5 mt-1 flex-wrap">' +
                            statusBadge +
                            primaryBadge +
                        '</div>' +
                    '</div>' +
                    '<div class="flex-shrink-0 ml-3">' +
                        '<svg class="w-8 h-8 text-gray-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
                            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>' +
                            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>' +
                        '</svg>' +
                    '</div>' +
                '</div>' +
                (address
                    ? '<p class="text-sm text-gray-500 mb-4 flex items-start gap-1.5">' +
                        '<svg class="w-4 h-4 text-gray-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
                            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>' +
                            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>' +
                        '</svg>' +
                        '<span>' + escapeHtml(address) + '</span>' +
                    '</p>'
                    : '<p class="text-sm text-gray-400 italic mb-4">No address available</p>'
                ) +
                '<div class="mb-3">' +
                    '<label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1.5">Mapped Branch</label>' +
                    '<select id="branch-select-' + loc.id + '" class="branch-select w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:border-transparent" style="focus:ring-color: #667eea;" onchange="onBranchChange(' + loc.id + ')">' +
                        branchOptions +
                    '</select>' +
                '</div>' +
                '<div class="flex items-center justify-between">' +
                    '<span class="text-xs text-gray-400">Last synced: ' + lastSynced + '</span>' +
                    '<button id="save-btn-' + loc.id + '" onclick="saveMapping(' + loc.id + ')" class="inline-flex items-center gap-1.5 px-3 py-1.5 text-white text-xs font-semibold rounded-lg transition opacity-50 cursor-not-allowed" style="background: #667eea;" disabled>' +
                        '<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
                            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>' +
                        '</svg>' +
                        '<span>Save Mapping</span>' +
                    '</button>' +
                '</div>';

            grid.appendChild(card);
        });
    }

    // ========================
    // Branch Change Handler
    // ========================
    function onBranchChange(locationId) {
        var btn = document.getElementById('save-btn-' + locationId);
        if (btn) {
            btn.disabled = false;
            btn.classList.remove('opacity-50', 'cursor-not-allowed');
            btn.onmouseover = function() { this.style.background = '#5a6fd6'; };
            btn.onmouseout = function() { this.style.background = '#667eea'; };
        }
    }

    // ========================
    // Save Mapping
    // ========================
    async function saveMapping(locationId) {
        var select = document.getElementById('branch-select-' + locationId);
        var btn = document.getElementById('save-btn-' + locationId);
        var branchId = select ? select.value : '';

        if (!branchId) {
            showToast('Please select a branch to map', 'warning');
            return;
        }

        // Disable button and show loading
        btn.disabled = true;
        var originalHtml = btn.innerHTML;
        btn.innerHTML = '' +
            '<svg class="w-3.5 h-3.5 spin" fill="none" viewBox="0 0 24 24">' +
                '<circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>' +
                '<path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>' +
            '</svg>' +
            '<span>Saving...</span>';
        btn.classList.add('opacity-75');

        var response = await zohoFetch('/api/zoho/locations/' + locationId + '/map', {
            method: 'PUT',
            body: JSON.stringify({ branch_id: parseInt(branchId) })
        });

        if (!response) {
            btn.innerHTML = originalHtml;
            btn.disabled = false;
            btn.classList.remove('opacity-75');
            return;
        }

        var data = await response.json();

        if (response.ok && (data.success !== false)) {
            showToast('Location mapped to branch successfully', 'success');

            // Update local state
            var loc = locations.find(function(l) { return l.id === locationId; });
            if (loc) {
                loc.branch_id = parseInt(branchId);
                loc.mapped_branch_id = parseInt(branchId);
            }

            // Update button to saved state
            btn.innerHTML = '' +
                '<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
                    '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>' +
                '</svg>' +
                '<span>Saved</span>';
            btn.style.background = '#059669';
            btn.classList.remove('opacity-75');
            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed');

            // Reset button after delay
            setTimeout(function() {
                btn.innerHTML = originalHtml;
                btn.style.background = '#667eea';
            }, 2000);

            updateSummary();
        } else {
            showToast(data.message || 'Failed to save mapping', 'error');
            btn.innerHTML = originalHtml;
            btn.disabled = false;
            btn.classList.remove('opacity-75');
        }
    }

    // ========================
    // Sync Locations from Zoho
    // ========================
    async function syncLocations() {
        var btn = document.getElementById('syncBtn');
        var icon = document.getElementById('syncIcon');
        var text = document.getElementById('syncBtnText');

        btn.disabled = true;
        btn.style.opacity = '0.75';
        icon.classList.add('spin');
        text.textContent = 'Syncing...';

        var response = await zohoFetch('/api/zoho/locations/sync', {
            method: 'POST'
        });

        btn.disabled = false;
        btn.style.opacity = '1';
        icon.classList.remove('spin');
        text.textContent = 'Sync Locations';

        if (!response) return;

        var data = await response.json();

        if (response.ok && data.success) {
            var synced = data.data?.synced || 0;
            var toastType = synced > 0 ? 'success' : 'warning';
            showToast(data.message || (synced + ' locations synced'), toastType);
            // Reload locations after sync
            await loadLocations();
        } else {
            showToast(data.message || 'Failed to sync locations from Zoho', 'error');
        }
    }

    // ========================
    // Update Summary
    // ========================
    function updateSummary() {
        var total = locations.length;
        var mapped = 0;
        locations.forEach(function(loc) {
            if (loc.branch_id || loc.mapped_branch_id) {
                mapped++;
            }
        });
        document.getElementById('summaryText').textContent =
            total + ' location' + (total !== 1 ? 's' : '') + ' synced, ' +
            mapped + ' mapped to branches';
    }

    // ========================
    // Initialize
    // ========================
    async function init() {
        // Load branches first (needed for dropdowns), then locations
        await loadBranches();
        await loadLocations();
    }

    init();
</script>
</body>
</html>
