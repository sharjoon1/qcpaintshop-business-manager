<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192x192.png">
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>Zoho Books Dashboard - Quality Colours Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/css/design-system.css">
    <link rel="stylesheet" href="/css/zoho-common.css">
    <script src="/universal-nav-loader.js"></script>
    <script src="/js/auth-helper.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
    <script>requireAdminOrRedirect();</script>
    <style>
        body { background: #f9fafb; }
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 1.25rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            border-left: 4px solid var(--accent, #7c3aed);
            transition: transform 0.2s;
        }
        .stat-card:hover { transform: translateY(-2px); }
        .stat-value { font-size: 1.75rem; font-weight: 800; color: #1f2937; }
        .stat-label { font-size: 0.8rem; color: #6b7280; font-weight: 500; }
        .stat-icon { font-size: 1.5rem; }
        .quick-link {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            background: white;
            border-radius: 10px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.06);
            text-decoration: none;
            color: #1f2937;
            font-weight: 500;
            transition: all 0.2s;
        }
        .quick-link:hover { transform: translateX(4px); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .quick-link-icon { font-size: 1.25rem; }

        /* Status badge styles */
        .badge {
            display: inline-block;
            padding: 0.15rem 0.6rem;
            border-radius: 9999px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }
        .badge-paid { background: #dcfce7; color: #166534; }
        .badge-overdue { background: #fee2e2; color: #991b1b; }
        .badge-sent { background: #dbeafe; color: #1e40af; }
        .badge-partially_paid { background: #fef9c3; color: #854d0e; }
        .badge-draft { background: #f3f4f6; color: #374151; }
        .badge-void { background: #f3f4f6; color: #6b7280; }

        /* Sync log entry */
        .sync-entry {
            padding: 0.5rem 0;
            border-bottom: 1px solid #f3f4f6;
            font-size: 0.8rem;
        }
        .sync-entry:last-child { border-bottom: none; }

        /* Table responsive */
        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        .table-wrapper table {
            min-width: 600px;
        }

        /* Desktop adjustments for pinned sidebar */
        @media (min-width: 768px) {
            .stat-card { padding: 1.5rem; }
            .stat-value { font-size: 2rem; }
            .stat-label { font-size: 0.85rem; }
            .stat-icon { font-size: 1.75rem; }
            .quick-link { padding: 0.85rem 1.25rem; }
        }
        @media (min-width: 1280px) {
            .stat-card { padding: 1.75rem; }
            .stat-value { font-size: 2.25rem; }
            .stat-label { font-size: 0.9rem; }
        }
        /* API Usage Monitor Styles */
        .usage-gauge {
            position: relative;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
        }
        .usage-gauge svg {
            transform: rotate(-90deg);
            position: absolute;
            top: 0; left: 0;
        }
        .usage-gauge-text {
            text-align: center;
            z-index: 1;
        }
        .usage-gauge-text .value {
            font-size: 1.5rem;
            font-weight: 800;
            line-height: 1;
        }
        .usage-gauge-text .label {
            font-size: 0.65rem;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }

        /* Mini bar chart */
        .rate-bar {
            display: flex;
            align-items: flex-end;
            gap: 3px;
            height: 48px;
        }
        .rate-bar-col {
            flex: 1;
            min-width: 0;
            border-radius: 3px 3px 0 0;
            background: linear-gradient(180deg, #667eea, #764ba2);
            transition: height 0.5s ease;
        }

        /* Caller badge */
        .caller-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.3rem 0.6rem;
            border-radius: 8px;
            font-size: 0.7rem;
            font-weight: 600;
            background: #f3f4f6;
            color: #374151;
        }
        .caller-badge .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }

        /* Activity log */
        .activity-entry {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.35rem 0;
            border-bottom: 1px solid #f3f4f6;
            font-size: 0.75rem;
        }
        .activity-entry:last-child { border-bottom: none; }

        /* Sync lock banner */
        .sync-lock-banner {
            background: #fef3c7;
            border: 1px solid #fcd34d;
            border-radius: 8px;
            padding: 0.6rem 1rem;
            font-size: 0.8rem;
            color: #92400e;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .sync-lock-banner.idle {
            background: #ecfdf5;
            border-color: #6ee7b7;
            color: #065f46;
        }

        /* Period filter pills */
        .period-bar {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .period-pill {
            display: inline-flex;
            align-items: center;
            padding: 0.35rem 0.85rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            background: white;
            color: #4b5563;
            border: 1px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .period-pill:hover { border-color: #667eea; color: #667eea; }
        .period-pill.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-color: transparent;
            box-shadow: 0 2px 6px rgba(102, 126, 234, 0.3);
        }
        .period-controls {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-left: auto;
        }
        .compare-toggle {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            font-size: 0.75rem;
            font-weight: 500;
            color: #6b7280;
            cursor: pointer;
        }
        .compare-toggle input { accent-color: #667eea; }
        .export-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.35rem 0.75rem;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            background: white;
            color: #374151;
            border: 1px solid #d1d5db;
            cursor: pointer;
            transition: all 0.2s;
        }
        .export-btn:hover { background: #f9fafb; border-color: #9ca3af; }
        .custom-range-row {
            display: none;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        .custom-range-row.show { display: flex; }
        .custom-range-row input[type="date"] {
            padding: 0.35rem 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 0.8rem;
            color: #374151;
        }
        .custom-range-row .apply-btn {
            padding: 0.35rem 0.85rem;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            cursor: pointer;
        }
        .period-label {
            font-size: 0.7rem;
            color: #9ca3af;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        /* Stat change indicator */
        .stat-change {
            display: inline-flex;
            align-items: center;
            gap: 0.2rem;
            font-size: 0.65rem;
            font-weight: 600;
            margin-top: 0.25rem;
            padding: 0.1rem 0.4rem;
            border-radius: 4px;
        }
        .stat-change.up { color: #059669; background: #ecfdf5; }
        .stat-change.down { color: #dc2626; background: #fef2f2; }
        .stat-change.neutral { color: #6b7280; background: #f3f4f6; }

        /* Trend chart container */
        .trend-chart-container {
            background: white;
            border-radius: 12px;
            padding: 1.25rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            margin-bottom: 1.5rem;
            display: none;
        }
        .trend-chart-container.show { display: block; }
        .trend-chart-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }
        .granularity-select {
            padding: 0.3rem 0.6rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 0.75rem;
            color: #374151;
            background: white;
        }
        @media (max-width: 640px) {
            .period-controls { margin-left: 0; width: 100%; justify-content: flex-start; }
            .period-bar { gap: 0.35rem; }
            .period-pill { padding: 0.3rem 0.65rem; font-size: 0.7rem; }
        }

        /* Drilldown modal */
        .stat-card[onclick] { cursor: pointer; }
        .stat-card[onclick]:hover { transform: translateY(-3px); box-shadow: 0 4px 16px rgba(0,0,0,0.1); }

        .drilldown-overlay {
            position: fixed;
            inset: 0;
            z-index: 9998;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: flex-end;
        }
        .drilldown-overlay.open { display: flex; }

        .drilldown-panel {
            background: white;
            width: 100%;
            max-width: 72rem;
            height: 100%;
            display: flex;
            flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            overflow: hidden;
        }
        .drilldown-overlay.open .drilldown-panel { transform: translateX(0); }

        .drilldown-header {
            position: sticky;
            top: 0;
            z-index: 2;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 1.25rem;
            border-bottom: 1px solid #e5e7eb;
            background: white;
        }
        .drilldown-header h2 { font-size: 1.125rem; font-weight: 700; color: #1f2937; flex: 1; }
        .drilldown-header .period-tag {
            font-size: 0.7rem;
            font-weight: 600;
            padding: 0.2rem 0.6rem;
            border-radius: 9999px;
            background: #f3f4f6;
            color: #6b7280;
        }
        .drilldown-close {
            width: 2rem; height: 2rem;
            display: flex; align-items: center; justify-content: center;
            border-radius: 8px;
            border: none;
            background: #f3f4f6;
            color: #6b7280;
            cursor: pointer;
            font-size: 1.1rem;
            transition: all 0.15s;
        }
        .drilldown-close:hover { background: #e5e7eb; color: #1f2937; }

        .drilldown-toolbar {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            border-bottom: 1px solid #f3f4f6;
            flex-wrap: wrap;
        }
        .drilldown-search {
            flex: 1;
            min-width: 150px;
            padding: 0.4rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 0.8rem;
            outline: none;
            transition: border-color 0.15s;
        }
        .drilldown-search:focus { border-color: #667eea; }
        .drilldown-sort-select {
            padding: 0.4rem 0.6rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 0.75rem;
            color: #374151;
            background: white;
        }
        .drilldown-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.4rem 0.75rem;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            border: 1px solid #d1d5db;
            background: white;
            color: #374151;
            cursor: pointer;
            transition: all 0.15s;
        }
        .drilldown-btn:hover { background: #f9fafb; border-color: #9ca3af; }

        .drilldown-summary {
            padding: 0.5rem 1.25rem;
            font-size: 0.8rem;
            color: #6b7280;
            background: #f9fafb;
            border-bottom: 1px solid #f3f4f6;
        }
        .drilldown-summary strong { color: #1f2937; font-weight: 700; }

        .drilldown-table-wrap {
            flex: 1;
            overflow: auto;
            padding: 0 1.25rem;
        }
        .drilldown-table {
            width: 100%;
            min-width: 600px;
            font-size: 0.8rem;
            border-collapse: collapse;
        }
        .drilldown-table thead { position: sticky; top: 0; z-index: 1; background: white; }
        .drilldown-table th {
            padding: 0.65rem 0.5rem;
            text-align: left;
            font-size: 0.7rem;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            border-bottom: 2px solid #e5e7eb;
            white-space: nowrap;
            cursor: pointer;
            user-select: none;
        }
        .drilldown-table th:hover { color: #374151; }
        .drilldown-table th.sorted { color: #667eea; }
        .drilldown-table th .sort-arrow { font-size: 0.6rem; margin-left: 0.2rem; }
        .drilldown-table td {
            padding: 0.6rem 0.5rem;
            border-bottom: 1px solid #f3f4f6;
            color: #374151;
        }
        .drilldown-table tbody tr:hover { background: #f9fafb; }
        .drilldown-table .text-right { text-align: right; }
        .drilldown-table .link-cell { color: #667eea; font-weight: 600; }
        .drilldown-table .overdue-date { color: #dc2626; }
        .drilldown-table .zoho-link {
            display: inline-flex;
            align-items: center;
            gap: 0.2rem;
            font-size: 0.7rem;
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }
        .drilldown-table .zoho-link:hover { text-decoration: underline; }

        .drilldown-pagination {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.35rem;
            padding: 0.75rem 1.25rem;
            border-top: 1px solid #e5e7eb;
        }
        .drilldown-pagination button {
            padding: 0.3rem 0.65rem;
            border-radius: 6px;
            border: 1px solid #d1d5db;
            background: white;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.15s;
        }
        .drilldown-pagination button:hover { background: #f3f4f6; }
        .drilldown-pagination button.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        .drilldown-pagination button:disabled { opacity: 0.4; cursor: not-allowed; }

        .drilldown-empty {
            display: none;
            text-align: center;
            padding: 3rem 1rem;
            color: #9ca3af;
            font-size: 0.85rem;
        }
        .drilldown-loading {
            display: none;
            text-align: center;
            padding: 3rem 1rem;
            color: #9ca3af;
        }

        @media print {
            body > *:not(.drilldown-overlay) { display: none !important; }
            .drilldown-overlay { position: static !important; background: none !important; display: block !important; }
            .drilldown-panel { transform: none !important; max-width: none !important; height: auto !important; }
            .drilldown-toolbar, .drilldown-pagination, .drilldown-close { display: none !important; }
            .drilldown-table-wrap { overflow: visible !important; }
        }

        /* Live Preview Panel */
        .preview-overlay {
            position: fixed;
            inset: 0;
            z-index: 9999;
            background: rgba(0,0,0,0.6);
            display: none;
            align-items: center;
            justify-content: center;
        }
        .preview-overlay.open { display: flex; }

        .preview-panel {
            background: white;
            width: 95%;
            max-width: 600px;
            max-height: 85vh;
            border-radius: 16px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0,0,0,0.25);
            transform: scale(0.95);
            opacity: 0;
            transition: transform 0.25s ease, opacity 0.25s ease;
        }
        .preview-overlay.open .preview-panel { transform: scale(1); opacity: 1; }

        .preview-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 1.25rem;
            border-bottom: 1px solid #e5e7eb;
            background: linear-gradient(135deg, #667eea08, #764ba208);
        }
        .preview-header h3 { flex: 1; font-size: 1rem; font-weight: 700; color: #1f2937; }
        .preview-header .preview-type-badge {
            font-size: 0.65rem;
            font-weight: 700;
            padding: 0.2rem 0.5rem;
            border-radius: 6px;
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }
        .preview-close {
            width: 2rem; height: 2rem;
            display: flex; align-items: center; justify-content: center;
            border-radius: 8px;
            border: none;
            background: #f3f4f6;
            color: #6b7280;
            cursor: pointer;
            font-size: 1.1rem;
            transition: all 0.15s;
        }
        .preview-close:hover { background: #e5e7eb; color: #1f2937; }

        .preview-body {
            flex: 1;
            overflow-y: auto;
            padding: 1.25rem;
        }

        .preview-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem 1rem;
            gap: 0.75rem;
        }
        .preview-loading .spinner {
            width: 36px; height: 36px;
            border: 3px solid #e5e7eb;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .preview-loading .text { font-size: 0.8rem; color: #9ca3af; }

        .preview-section { margin-bottom: 1.25rem; }
        .preview-section:last-child { margin-bottom: 0; }
        .preview-section-title {
            font-size: 0.7rem;
            font-weight: 600;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }
        .preview-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }
        .preview-field {
            padding: 0.5rem 0.65rem;
            background: #f9fafb;
            border-radius: 8px;
        }
        .preview-field.full { grid-column: 1 / -1; }
        .preview-field-label {
            font-size: 0.65rem;
            font-weight: 600;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            margin-bottom: 0.15rem;
        }
        .preview-field-value {
            font-size: 0.85rem;
            font-weight: 600;
            color: #1f2937;
            word-break: break-word;
        }
        .preview-field-value.amount {
            font-size: 1.1rem;
            color: #7c3aed;
        }
        .preview-field-value.overdue { color: #dc2626; }
        .preview-field-value.paid { color: #059669; }

        .preview-line-items {
            width: 100%;
            font-size: 0.75rem;
            border-collapse: collapse;
        }
        .preview-line-items th {
            text-align: left;
            font-size: 0.65rem;
            font-weight: 600;
            color: #9ca3af;
            text-transform: uppercase;
            padding: 0.4rem 0.5rem;
            border-bottom: 1px solid #e5e7eb;
        }
        .preview-line-items td {
            padding: 0.45rem 0.5rem;
            color: #374151;
            border-bottom: 1px solid #f3f4f6;
        }
        .preview-line-items tr:last-child td { border-bottom: none; }

        .preview-footer {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            border-top: 1px solid #e5e7eb;
            background: #f9fafb;
        }
        .preview-footer a, .preview-footer button {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.45rem 0.85rem;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.15s;
            cursor: pointer;
        }
        .preview-footer .btn-secondary {
            background: white;
            border: 1px solid #d1d5db;
            color: #374151;
        }
        .preview-footer .btn-secondary:hover { background: #f3f4f6; }
        .preview-footer .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            color: white;
        }
        .preview-footer .btn-primary:hover { opacity: 0.9; }
    </style>
</head>
<body class="bg-gray-50" data-page="zoho-dashboard">
<div class="container mx-auto p-4 md:p-6">

    <!-- Toast Notification -->
    <div id="toast" class="toast" role="alert"></div>

    <!-- Connection Status Banner -->
    <div id="connectionBanner" class="hidden mb-4 rounded-lg p-4 border">
        <!-- Populated dynamically -->
    </div>

    <!-- Page Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6">
        <div>
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Zoho Books Dashboard</h1>
            <p class="text-gray-500 text-sm mt-1">Financial overview synced from Zoho Books</p>
        </div>
        <div class="mt-3 sm:mt-0 flex items-center gap-2">
            <span id="lastSyncLabel" class="text-xs text-gray-400 hidden">Last sync: --</span>
            <button id="syncNowBtn" onclick="triggerFullSync()" class="inline-flex items-center gap-2 px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm font-semibold rounded-lg transition shadow-sm">
                <svg id="syncIcon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                <span id="syncBtnText">Sync Now</span>
            </button>
        </div>
    </div>

    <!-- Period Filter Bar -->
    <div class="period-bar" id="periodBar">
        <button class="period-pill active" data-period="today" onclick="setPeriod('today')">Today</button>
        <button class="period-pill" data-period="yesterday" onclick="setPeriod('yesterday')">Yesterday</button>
        <button class="period-pill" data-period="this_week" onclick="setPeriod('this_week')">This Week</button>
        <button class="period-pill" data-period="this_month" onclick="setPeriod('this_month')">This Month</button>
        <button class="period-pill" data-period="prev_month" onclick="setPeriod('prev_month')">Prev Month</button>
        <button class="period-pill" data-period="this_year" onclick="setPeriod('this_year')">This Year</button>
        <button class="period-pill" data-period="custom" onclick="toggleCustomRange()">Custom</button>
        <button class="period-pill" data-period="all" onclick="setPeriod('all')">All Time</button>
        <div class="period-controls">
            <label class="compare-toggle">
                <input type="checkbox" id="compareToggle" onchange="toggleCompare()">
                Compare
            </label>
            <button class="export-btn" onclick="exportDashboardCSV()" title="Export CSV">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                Export
            </button>
        </div>
    </div>

    <!-- Custom Date Range Row -->
    <div class="custom-range-row" id="customRangeRow">
        <label class="text-xs text-gray-500 font-medium">From:</label>
        <input type="date" id="customFromDate">
        <label class="text-xs text-gray-500 font-medium">To:</label>
        <input type="date" id="customToDate">
        <button class="apply-btn" onclick="applyCustomRange()">Apply</button>
    </div>

    <!-- Active Period Label -->
    <div id="activePeriodLabel" class="period-label" style="display: none;"></div>

    <!-- KPI Stats Grid - Row 1 -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4 mb-4">
        <!-- Total Revenue -->
        <div class="stat-card" style="border-left-color: #7c3aed;" onclick="openDrilldown('revenue')" title="Click to see invoices">
            <div class="flex justify-between items-start">
                <div>
                    <div id="statRevenue" class="stat-value">
                        <div class="skeleton" style="width: 80px; height: 28px;"></div>
                    </div>
                    <div class="stat-label">Total Revenue</div>
                    <div id="changeRevenue" class="stat-change" style="display:none;"></div>
                </div>
                <span class="stat-icon">
                    <svg class="w-6 h-6 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </span>
            </div>
        </div>

        <!-- Outstanding -->
        <div class="stat-card" style="border-left-color: #f59e0b;" onclick="openDrilldown('outstanding')" title="Click to see outstanding invoices">
            <div class="flex justify-between items-start">
                <div>
                    <div id="statOutstanding" class="stat-value">
                        <div class="skeleton" style="width: 80px; height: 28px;"></div>
                    </div>
                    <div class="stat-label">Outstanding</div>
                    <div id="changeOutstanding" class="stat-change" style="display:none;"></div>
                </div>
                <span class="stat-icon">
                    <svg class="w-6 h-6 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </span>
            </div>
        </div>

        <!-- Overdue Amount -->
        <div class="stat-card" style="border-left-color: #ef4444;" onclick="openDrilldown('overdue')" title="Click to see overdue invoices">
            <div class="flex justify-between items-start">
                <div>
                    <div id="statOverdue" class="stat-value">
                        <div class="skeleton" style="width: 80px; height: 28px;"></div>
                    </div>
                    <div class="stat-label">Overdue Amount</div>
                    <div id="changeOverdue" class="stat-change" style="display:none;"></div>
                </div>
                <span class="stat-icon">
                    <svg class="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.34 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                    </svg>
                </span>
            </div>
        </div>

        <!-- Collected -->
        <div class="stat-card" style="border-left-color: #10b981;" onclick="openDrilldown('collected')" title="Click to see payments">
            <div class="flex justify-between items-start">
                <div>
                    <div id="statCollected" class="stat-value">
                        <div class="skeleton" style="width: 80px; height: 28px;"></div>
                    </div>
                    <div class="stat-label">Collected</div>
                    <div id="changeCollected" class="stat-change" style="display:none;"></div>
                </div>
                <span class="stat-icon">
                    <svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </span>
            </div>
        </div>
    </div>

    <!-- KPI Stats Grid - Row 2 -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4 mb-6">
        <!-- Total Invoices -->
        <div class="card stat-card" style="border-left-color: #6366f1;" onclick="openDrilldown('total_invoices')" title="Click to see all invoices">
            <div class="flex justify-between items-start">
                <div>
                    <div class="stat-card-number" id="statTotalInvoices">
                        <div class="skeleton" style="width: 50px; height: 24px;"></div>
                    </div>
                    <div class="stat-card-label">Total Invoices</div>
                    <div id="changeTotalInvoices" class="stat-change" style="display:none;"></div>
                </div>
                <span class="stat-icon">
                    <svg class="w-6 h-6 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                </span>
            </div>
        </div>

        <!-- Overdue Invoices -->
        <div class="card stat-card stat-card-danger" onclick="openDrilldown('overdue_invoices')" title="Click to see overdue invoices">
            <div class="flex justify-between items-start">
                <div>
                    <div class="stat-card-number" id="statOverdueInvoices">
                        <div class="skeleton" style="width: 50px; height: 24px;"></div>
                    </div>
                    <div class="stat-card-label">Overdue Invoices</div>
                    <div id="changeOverdueInvoices" class="stat-change" style="display:none;"></div>
                </div>
                <span class="stat-icon">
                    <svg class="w-6 h-6 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path>
                    </svg>
                </span>
            </div>
        </div>

        <!-- Unpaid Invoices -->
        <div class="card stat-card stat-card-warning" onclick="openDrilldown('unpaid_invoices')" title="Click to see unpaid invoices">
            <div class="flex justify-between items-start">
                <div>
                    <div class="stat-card-number" id="statUnpaidInvoices">
                        <div class="skeleton" style="width: 50px; height: 24px;"></div>
                    </div>
                    <div class="stat-card-label">Unpaid Invoices</div>
                    <div id="changeUnpaidInvoices" class="stat-change" style="display:none;"></div>
                </div>
                <span class="stat-icon">
                    <svg class="w-6 h-6 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </span>
            </div>
        </div>

        <!-- Zoho Customers -->
        <div class="card stat-card stat-card-info">
            <div class="flex justify-between items-start">
                <div>
                    <div class="stat-card-number" id="statZohoCustomers">
                        <div class="skeleton" style="width: 50px; height: 24px;"></div>
                    </div>
                    <div class="stat-card-label">Zoho Customers</div>
                </div>
                <span class="stat-icon">
                    <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                </span>
            </div>
        </div>
    </div>

    <!-- Trend Chart -->
    <div class="trend-chart-container" id="trendChartContainer">
        <div class="trend-chart-header">
            <h3 class="text-lg font-bold text-gray-800">Financial Trend</h3>
            <select class="granularity-select" id="granularitySelect" onchange="loadTrendData()">
                <option value="day">Daily</option>
                <option value="week">Weekly</option>
                <option value="month">Monthly</option>
            </select>
        </div>
        <canvas id="trendChart" height="100"></canvas>
    </div>

    <!-- Main Content Grid: Recent Invoices + Sidebar -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">

        <!-- Recent Invoices Table -->
        <div class="lg:col-span-2 bg-white rounded-lg shadow p-5">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-gray-800">Recent Invoices</h3>
                <a href="/admin-zoho-invoices.html" class="text-sm text-indigo-600 hover:text-indigo-800 font-medium">View All &rarr;</a>
            </div>

            <div id="invoicesLoading" class="space-y-3">
                <div class="skeleton" style="width: 100%; height: 40px;"></div>
                <div class="skeleton" style="width: 100%; height: 32px;"></div>
                <div class="skeleton" style="width: 100%; height: 32px;"></div>
                <div class="skeleton" style="width: 100%; height: 32px;"></div>
                <div class="skeleton" style="width: 100%; height: 32px;"></div>
            </div>

            <div id="invoicesContent" class="hidden">
                <div class="table-wrapper">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="border-b border-gray-200 text-left">
                                <th class="pb-3 font-semibold text-gray-600 text-xs uppercase tracking-wide">Invoice #</th>
                                <th class="pb-3 font-semibold text-gray-600 text-xs uppercase tracking-wide">Customer</th>
                                <th class="pb-3 font-semibold text-gray-600 text-xs uppercase tracking-wide hidden sm:table-cell">Date</th>
                                <th class="pb-3 font-semibold text-gray-600 text-xs uppercase tracking-wide text-right">Amount</th>
                                <th class="pb-3 font-semibold text-gray-600 text-xs uppercase tracking-wide text-right hidden sm:table-cell">Balance</th>
                                <th class="pb-3 font-semibold text-gray-600 text-xs uppercase tracking-wide text-center">Status</th>
                            </tr>
                        </thead>
                        <tbody id="invoicesTableBody">
                            <!-- Rows populated by JS -->
                        </tbody>
                    </table>
                </div>
                <div id="noInvoices" class="hidden text-center py-8 text-gray-400 text-sm">
                    No invoices found. Sync with Zoho to load data.
                </div>
            </div>
        </div>

        <!-- Right Sidebar: Sync Status + Quick Actions -->
        <div class="space-y-6">

            <!-- Sync Status Card -->
            <div class="bg-white rounded-lg shadow p-5">
                <h3 class="text-lg font-bold text-gray-800 mb-4">Sync Status</h3>

                <div class="space-y-3 mb-4">
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-600">Last Full Sync</span>
                        <span id="syncLastTime" class="text-sm font-medium text-gray-800">--</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-600">Auto-Sync</span>
                        <span id="syncAutoStatus" class="text-sm font-medium">
                            <div class="skeleton" style="width: 60px; height: 18px;"></div>
                        </span>
                    </div>
                </div>

                <div class="border-t border-gray-100 pt-3">
                    <h4 class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">Recent Sync Log</h4>
                    <div id="syncLogLoading">
                        <div class="skeleton mb-2" style="width: 100%; height: 20px;"></div>
                        <div class="skeleton mb-2" style="width: 90%; height: 20px;"></div>
                        <div class="skeleton" style="width: 85%; height: 20px;"></div>
                    </div>
                    <div id="syncLogContent" class="hidden">
                        <div id="syncLogEntries">
                            <!-- Populated by JS -->
                        </div>
                        <div id="noSyncLog" class="hidden text-xs text-gray-400 text-center py-2">
                            No sync history available
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="bg-white rounded-lg shadow p-5">
                <h3 class="text-lg font-bold text-gray-800 mb-4">Quick Actions</h3>
                <div class="grid grid-cols-1 gap-3">
                    <a href="/admin-zoho-invoices.html" class="quick-link">
                        <span class="quick-link-icon">
                            <svg class="w-5 h-5 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                        </span>
                        <span>View Invoices</span>
                    </a>
                    <a href="/admin-zoho-reports.html" class="quick-link">
                        <span class="quick-link-icon">
                            <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                        </span>
                        <span>Financial Reports</span>
                    </a>
                    <a href="/admin-zoho-settings.html" class="quick-link">
                        <span class="quick-link-icon">
                            <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                        </span>
                        <span>Zoho Settings</span>
                    </a>
                    <button onclick="syncCustomers()" class="quick-link text-left w-full" id="syncCustomersBtn">
                        <span class="quick-link-icon">
                            <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                        </span>
                        <span id="syncCustomersText">Sync Customers</span>
                    </button>
                </div>
            </div>

        </div>
    </div>

    <!-- ============================== -->
    <!-- API USAGE MONITOR -->
    <!-- ============================== -->
    <div class="mb-6">
        <div class="flex items-center justify-between mb-4">
            <div>
                <h2 class="text-xl font-bold text-gray-800">API Usage Monitor</h2>
                <p class="text-xs text-gray-500 mt-0.5">Real-time Zoho Books API call tracking (10,000/day limit)</p>
            </div>
            <button onclick="loadApiUsage()" id="usageRefreshBtn" class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-semibold text-gray-700 bg-white border border-gray-300 hover:bg-gray-50 rounded-lg transition shadow-sm">
                <svg id="usageRefreshIcon" class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                Refresh
            </button>
        </div>

        <!-- Sync Lock Status -->
        <div id="syncLockBanner" class="sync-lock-banner idle mb-4 hidden">
            <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
            </svg>
            <span id="syncLockText">No active sync operations</span>
        </div>

        <!-- Row 1: Daily Quota + Rate Gauge + Quick Stats -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">

            <!-- Daily Quota Gauge -->
            <div class="bg-white rounded-xl shadow-sm p-5 flex flex-col items-center justify-center">
                <div class="usage-gauge mb-2">
                    <svg width="120" height="120">
                        <circle cx="60" cy="60" r="52" fill="none" stroke="#e5e7eb" stroke-width="8"/>
                        <circle id="quotaArc" cx="60" cy="60" r="52" fill="none" stroke="#667eea" stroke-width="8"
                            stroke-dasharray="326.7" stroke-dashoffset="326.7" stroke-linecap="round"/>
                    </svg>
                    <div class="usage-gauge-text">
                        <div class="value" id="quotaPercent">--%</div>
                        <div class="label">used today</div>
                    </div>
                </div>
                <div class="text-center">
                    <div class="text-sm font-bold text-gray-800"><span id="quotaUsed">--</span> / <span id="quotaLimit">10,000</span></div>
                    <div class="text-xs text-gray-500">API calls today</div>
                </div>
            </div>

            <!-- Remaining + Rate -->
            <div class="bg-white rounded-xl shadow-sm p-5">
                <div class="text-xs font-semibold text-gray-500 uppercase mb-3">Quota Status</div>
                <div class="space-y-3">
                    <div>
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-xs text-gray-600">Remaining</span>
                            <span class="text-sm font-bold" id="quotaRemaining">--</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="quotaBar" class="h-2 rounded-full bg-green-500 transition-all" style="width: 100%"></div>
                        </div>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-xs text-gray-600">Rate Tokens</span>
                        <span class="text-sm font-bold" id="rateTokens">--/80</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-xs text-gray-600">Queued Requests</span>
                        <span class="text-sm font-bold" id="rateQueued">0</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-xs text-gray-600">Last 5 Minutes</span>
                        <span class="text-sm font-bold" id="rateLast5">--</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-xs text-gray-600">Last Hour</span>
                        <span class="text-sm font-bold" id="rateLastHour">--</span>
                    </div>
                </div>
            </div>

            <!-- Calls Per Minute Chart -->
            <div class="bg-white rounded-xl shadow-sm p-5">
                <div class="text-xs font-semibold text-gray-500 uppercase mb-3">Calls/Minute (Last 5 min)</div>
                <div class="rate-bar mb-2" id="rateBarChart">
                    <div class="rate-bar-col" style="height: 0%"></div>
                    <div class="rate-bar-col" style="height: 0%"></div>
                    <div class="rate-bar-col" style="height: 0%"></div>
                    <div class="rate-bar-col" style="height: 0%"></div>
                    <div class="rate-bar-col" style="height: 0%"></div>
                </div>
                <div class="flex justify-between text-[10px] text-gray-400" id="rateBarLabels">
                    <span>--</span><span>--</span><span>--</span><span>--</span><span>--</span>
                </div>
                <div class="mt-3 pt-3 border-t border-gray-100">
                    <div class="text-xs font-semibold text-gray-500 uppercase mb-2">Hourly Trend</div>
                    <div class="rate-bar" id="hourlyBarChart" style="height: 36px;"></div>
                </div>
            </div>

            <!-- Active Operations -->
            <div class="bg-white rounded-xl shadow-sm p-5">
                <div class="text-xs font-semibold text-gray-500 uppercase mb-3">Active Operations</div>
                <div id="activeOpsContent" class="space-y-2">
                    <div class="text-xs text-gray-400 text-center py-4">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Row 2: Top Callers + Recent Activity -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">

            <!-- Top API Callers -->
            <div class="bg-white rounded-xl shadow-sm p-5">
                <div class="text-xs font-semibold text-gray-500 uppercase mb-3">Top API Consumers</div>
                <div id="topCallersContent">
                    <div class="skeleton" style="width: 100%; height: 120px;"></div>
                </div>
            </div>

            <!-- Recent Activity Log -->
            <div class="bg-white rounded-xl shadow-sm p-5">
                <div class="text-xs font-semibold text-gray-500 uppercase mb-3">Recent API Activity</div>
                <div id="recentActivityContent" style="max-height: 240px; overflow-y: auto;">
                    <div class="skeleton" style="width: 100%; height: 120px;"></div>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- Drilldown Modal -->
<div class="drilldown-overlay" id="drilldownModal">
    <div class="drilldown-panel">
        <div class="drilldown-header">
            <svg class="w-5 h-5 text-indigo-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            <h2 id="drilldownTitle">Drilldown</h2>
            <span class="period-tag" id="drilldownPeriodTag">All Time</span>
            <button class="drilldown-close" onclick="closeDrilldown()" title="Close">&times;</button>
        </div>
        <div class="drilldown-toolbar">
            <input type="text" class="drilldown-search" id="drilldownSearch" placeholder="Search customer or number..." oninput="debouncedDrilldownSearch()">
            <select class="drilldown-sort-select" id="drilldownSortSelect" onchange="onDrilldownSortChange()">
                <!-- Populated dynamically -->
            </select>
            <button class="drilldown-btn" onclick="toggleDrilldownOrder()" id="drilldownOrderBtn" title="Toggle sort direction">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path></svg>
                <span id="drilldownOrderLabel">DESC</span>
            </button>
            <button class="drilldown-btn" onclick="exportDrilldownCSV()" title="Export CSV">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                Export
            </button>
            <button class="drilldown-btn" onclick="printDrilldown()" title="Print">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
                Print
            </button>
        </div>
        <div class="drilldown-summary" id="drilldownSummary"></div>
        <div class="drilldown-loading" id="drilldownLoading">
            <div class="skeleton" style="width: 100%; height: 200px; margin: 0 auto;"></div>
        </div>
        <div class="drilldown-table-wrap" id="drilldownTableWrap">
            <table class="drilldown-table">
                <thead id="drilldownThead"></thead>
                <tbody id="drilldownTbody"></tbody>
            </table>
        </div>
        <div class="drilldown-empty" id="drilldownEmpty">No transactions found for this metric and period.</div>
        <div class="drilldown-pagination" id="drilldownPagination"></div>
    </div>
</div>

<!-- Live Preview Modal -->
<div class="preview-overlay" id="previewModal">
    <div class="preview-panel">
        <div class="preview-header">
            <svg class="w-5 h-5 text-indigo-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
            </svg>
            <h3 id="previewTitle">Transaction Details</h3>
            <span class="preview-type-badge" id="previewTypeBadge"></span>
            <button class="preview-close" onclick="closePreview()" title="Close">&times;</button>
        </div>
        <div class="preview-body" id="previewBody">
            <div class="preview-loading" id="previewLoading">
                <div class="spinner"></div>
                <div class="text">Loading transaction details...</div>
            </div>
            <div id="previewContent" style="display:none;"></div>
        </div>
        <div class="preview-footer" id="previewFooter" style="display:none;">
            <button class="btn-secondary" onclick="closePreview()">Close</button>
            <a class="btn-primary" id="previewZohoLink" href="#" target="_blank" rel="noopener">
                View in Zoho
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
            </a>
        </div>
    </div>
</div>

<script>
    // Currency formatting helper
    function formatCurrency(amount) {
        const num = parseFloat(amount || 0);
        if (num >= 10000000) return '\u20B9' + (num / 10000000).toFixed(2) + 'Cr';
        if (num >= 100000) return '\u20B9' + (num / 100000).toFixed(2) + 'L';
        if (num >= 1000) return '\u20B9' + (num / 1000).toFixed(1) + 'K';
        return '\u20B9' + num.toFixed(0);
    }

    // Format date for display
    function formatDate(dateStr) {
        if (!dateStr) return '--';
        const d = new Date(dateStr);
        if (isNaN(d.getTime())) return dateStr;
        return d.toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });
    }

    // Format relative time for sync timestamps
    function formatRelativeTime(dateStr) {
        if (!dateStr) return 'Never';
        const d = new Date(dateStr);
        if (isNaN(d.getTime())) return dateStr;
        const now = new Date();
        const diffMs = now - d;
        const diffMin = Math.floor(diffMs / 60000);
        const diffHr = Math.floor(diffMs / 3600000);
        const diffDay = Math.floor(diffMs / 86400000);

        if (diffMin < 1) return 'Just now';
        if (diffMin < 60) return diffMin + 'm ago';
        if (diffHr < 24) return diffHr + 'h ago';
        if (diffDay < 7) return diffDay + 'd ago';
        return formatDate(dateStr);
    }

    // Toast notification
    function showToast(message, type) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = 'toast toast-' + (type || 'info') + ' show';
        setTimeout(function() {
            toast.classList.remove('show');
        }, 3500);
    }

    // Get status badge HTML
    function getStatusBadge(status) {
        const s = (status || 'draft').toLowerCase().replace(/\s+/g, '_');
        const labels = {
            paid: 'Paid',
            overdue: 'Overdue',
            sent: 'Sent',
            partially_paid: 'Partial',
            draft: 'Draft',
            void: 'Void'
        };
        const label = labels[s] || status;
        return '<span class="badge badge-' + s + '">' + label + '</span>';
    }

    // Load connection status
    async function loadConnectionStatus() {
        try {
            const response = await fetch('/api/zoho/status', {
                headers: getAuthHeaders()
            });

            if (response.status === 401) {
                window.location.href = '/login.html';
                return;
            }

            const result = await response.json();

            if (result.success && result.data) {
                const data = result.data;
                const banner = document.getElementById('connectionBanner');
                const connection = data.connection || {};

                if (!connection.connected) {
                    banner.className = 'mb-4 rounded-lg p-4 border bg-yellow-50 border-yellow-300';
                    banner.innerHTML = '<div class="flex items-center gap-3">' +
                        '<svg class="w-5 h-5 text-yellow-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
                        '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.34 16.5c-.77.833.192 2.5 1.732 2.5z"></path>' +
                        '</svg>' +
                        '<div class="flex-1">' +
                        '<p class="text-sm font-semibold text-yellow-800">Zoho Books not connected</p>' +
                        '<p class="text-xs text-yellow-700 mt-0.5">Connect your Zoho Books account to sync invoices and financial data.</p>' +
                        '</div>' +
                        '<a href="/admin-zoho-settings.html" class="text-sm font-medium text-yellow-800 hover:text-yellow-900 underline flex-shrink-0">Go to Settings</a>' +
                        '</div>';
                    banner.classList.remove('hidden');
                } else {
                    banner.className = 'mb-4 rounded-lg p-4 border bg-green-50 border-green-300';
                    banner.innerHTML = '<div class="flex items-center gap-3">' +
                        '<svg class="w-5 h-5 text-green-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
                        '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>' +
                        '</svg>' +
                        '<p class="text-sm font-medium text-green-800">Zoho Books connected' +
                        (connection.organization_name ? ' - ' + connection.organization_name : '') +
                        '</p>' +
                        '</div>';
                    banner.classList.remove('hidden');
                }

                // Update sync status card
                updateSyncStatus(data);

                // Extract zoho org ID (for "View in Zoho" links)
                if (data.zoho_org_id) {
                    zohoOrgId = data.zoho_org_id;
                }
            }
        } catch (error) {
            console.error('Failed to load connection status:', error);
            var banner = document.getElementById('connectionBanner');
            banner.className = 'mb-4 rounded-lg p-4 border bg-red-50 border-red-300';
            banner.innerHTML = '<div class="flex items-center gap-3">' +
                '<svg class="w-5 h-5 text-red-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
                '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>' +
                '</svg>' +
                '<p class="text-sm font-medium text-red-800">Failed to check Zoho connection: ' + error.message + '</p>' +
                '</div>';
            banner.classList.remove('hidden');
        }
    }

    // Update sync status card
    function updateSyncStatus(data) {
        // Last sync time
        const lastSync = data.last_full_sync;
        const syncTimeEl = document.getElementById('syncLastTime');
        syncTimeEl.textContent = formatRelativeTime(lastSync);

        // Update header label too
        const lastSyncLabel = document.getElementById('lastSyncLabel');
        if (lastSync) {
            lastSyncLabel.textContent = 'Last sync: ' + formatRelativeTime(lastSync);
            lastSyncLabel.classList.remove('hidden');
        }

        // Auto-sync status
        const autoEl = document.getElementById('syncAutoStatus');
        if (data.sync_enabled) {
            autoEl.innerHTML = '<span class="inline-flex items-center gap-1 text-green-700"><span class="w-2 h-2 bg-green-500 rounded-full"></span> Enabled</span>';
        } else {
            autoEl.innerHTML = '<span class="inline-flex items-center gap-1 text-gray-500"><span class="w-2 h-2 bg-gray-400 rounded-full"></span> Disabled</span>';
        }

        // Sync log
        const logLoading = document.getElementById('syncLogLoading');
        const logContent = document.getElementById('syncLogContent');
        const logEntries = document.getElementById('syncLogEntries');
        const noLog = document.getElementById('noSyncLog');

        logLoading.classList.add('hidden');
        logContent.classList.remove('hidden');

        const recentSyncs = data.recent_syncs || [];

        if (recentSyncs.length === 0) {
            noLog.classList.remove('hidden');
        } else {
            noLog.classList.add('hidden');
            logEntries.innerHTML = '';
            // Show last 5 entries
            const entries = recentSyncs.slice(0, 5);
            entries.forEach(function(sync) {
                const statusColor = sync.status === 'success' ? 'text-green-600' : (sync.status === 'error' ? 'text-red-600' : 'text-yellow-600');
                const statusIcon = sync.status === 'success' ? '&#10003;' : (sync.status === 'error' ? '&#10007;' : '&#8635;');
                const entry = document.createElement('div');
                entry.className = 'sync-entry flex items-center justify-between';
                entry.innerHTML = '<div class="flex items-center gap-2">' +
                    '<span class="' + statusColor + ' font-bold text-xs">' + statusIcon + '</span>' +
                    '<span class="text-gray-700">' + (sync.type || 'Full sync') + '</span>' +
                    '</div>' +
                    '<span class="text-gray-400">' + formatRelativeTime(sync.timestamp || sync.created_at) + '</span>';
                logEntries.appendChild(entry);
            });
        }
    }

    // ============================
    // PERIOD FILTER STATE
    // ============================
    var currentPeriod = 'today';
    var currentFromDate = null;
    var currentToDate = null;
    var isCompareMode = false;
    var lastDashboardData = null;
    var trendChartInstance = null;

    function calcPeriodDates(period) {
        var today = new Date();
        var y = today.getFullYear(), m = today.getMonth(), d = today.getDate();
        var from, to;

        switch (period) {
            case 'today':
                from = to = new Date(y, m, d);
                break;
            case 'yesterday':
                from = to = new Date(y, m, d - 1);
                break;
            case 'this_week':
                var dow = today.getDay() || 7; // Mon=1
                from = new Date(y, m, d - dow + 1);
                to = today;
                break;
            case 'this_month':
                from = new Date(y, m, 1);
                to = today;
                break;
            case 'prev_month':
                from = new Date(y, m - 1, 1);
                to = new Date(y, m, 0); // last day of prev month
                break;
            case 'this_year':
                from = new Date(y, 0, 1);
                to = today;
                break;
            default:
                return { from: null, to: null };
        }

        function toLocalISO(dt) {
            var yy = dt.getFullYear();
            var mm = String(dt.getMonth() + 1).padStart(2, '0');
            var dd = String(dt.getDate()).padStart(2, '0');
            return yy + '-' + mm + '-' + dd;
        }
        return { from: toLocalISO(from), to: toLocalISO(to) };
    }

    function setPeriod(period) {
        currentPeriod = period;

        // Update pill active state
        document.querySelectorAll('.period-pill').forEach(function(pill) {
            pill.classList.toggle('active', pill.dataset.period === period);
        });

        // Hide custom range if not custom
        if (period !== 'custom') {
            document.getElementById('customRangeRow').classList.remove('show');
        }

        var dates = calcPeriodDates(period);
        currentFromDate = dates.from;
        currentToDate = dates.to;

        // Update period label
        var labelEl = document.getElementById('activePeriodLabel');
        if (period === 'all') {
            labelEl.style.display = 'none';
        } else {
            var periodNames = { today: 'Today', yesterday: 'Yesterday', this_week: 'This Week', this_month: 'This Month', prev_month: 'Previous Month', this_year: 'This Year', custom: 'Custom Range' };
            var label = periodNames[period] || period;
            if (currentFromDate && currentToDate) {
                label += ': ' + currentFromDate + ' to ' + currentToDate;
            }
            labelEl.textContent = label;
            labelEl.style.display = 'block';
        }

        // Auto-select granularity
        autoSelectGranularity(period);

        // Reload data
        loadDashboardData();
        if (period !== 'all') {
            loadTrendData();
        } else {
            hideTrendChart();
        }
    }

    function toggleCustomRange() {
        var row = document.getElementById('customRangeRow');
        row.classList.toggle('show');

        // Update pill state
        document.querySelectorAll('.period-pill').forEach(function(pill) {
            pill.classList.toggle('active', pill.dataset.period === 'custom');
        });
    }

    function applyCustomRange() {
        var fromEl = document.getElementById('customFromDate');
        var toEl = document.getElementById('customToDate');
        if (!fromEl.value || !toEl.value) {
            showToast('Please select both From and To dates', 'error');
            return;
        }
        if (fromEl.value > toEl.value) {
            showToast('From date must be before To date', 'error');
            return;
        }
        currentPeriod = 'custom';
        currentFromDate = fromEl.value;
        currentToDate = toEl.value;

        var labelEl = document.getElementById('activePeriodLabel');
        labelEl.textContent = 'Custom: ' + currentFromDate + ' to ' + currentToDate;
        labelEl.style.display = 'block';

        autoSelectGranularity('custom');
        loadDashboardData();
        loadTrendData();
    }

    function toggleCompare() {
        isCompareMode = document.getElementById('compareToggle').checked;
        loadDashboardData();
    }

    function autoSelectGranularity(period) {
        var sel = document.getElementById('granularitySelect');
        if (period === 'today' || period === 'yesterday') {
            sel.value = 'day';
        } else if (period === 'this_week') {
            sel.value = 'day';
        } else if (period === 'this_month' || period === 'prev_month') {
            sel.value = 'day';
        } else if (period === 'this_year') {
            sel.value = 'month';
        } else if (period === 'custom' && currentFromDate && currentToDate) {
            var diffDays = Math.ceil((new Date(currentToDate) - new Date(currentFromDate)) / 86400000);
            if (diffDays <= 31) sel.value = 'day';
            else if (diffDays <= 90) sel.value = 'week';
            else sel.value = 'month';
        }
    }

    function calcChange(current, previous) {
        var cur = parseFloat(current) || 0;
        var prev = parseFloat(previous) || 0;
        if (prev === 0 && cur === 0) return { pct: 0, direction: 'neutral' };
        if (prev === 0) return { pct: 100, direction: 'up' };
        var pct = ((cur - prev) / Math.abs(prev)) * 100;
        return {
            pct: Math.abs(pct).toFixed(1),
            direction: pct > 0.5 ? 'up' : pct < -0.5 ? 'down' : 'neutral'
        };
    }

    function renderChangeIndicator(elementId, current, previous, invertColor) {
        var el = document.getElementById(elementId);
        if (!el) return;

        if (!isCompareMode || currentPeriod === 'all' || previous === undefined) {
            el.style.display = 'none';
            return;
        }

        var change = calcChange(current, previous);
        var arrow = change.direction === 'up' ? '\u25B2' : change.direction === 'down' ? '\u25BC' : '\u25AC';

        // For overdue/outstanding, up is bad (red), down is good (green)
        var dirClass = change.direction;
        if (invertColor && change.direction !== 'neutral') {
            dirClass = change.direction === 'up' ? 'down' : 'up';
        }

        el.className = 'stat-change ' + dirClass;
        el.innerHTML = arrow + ' ' + change.pct + '%';
        el.style.display = 'inline-flex';
    }

    // Load dashboard KPI data
    async function loadDashboardData() {
        try {
            var url = '/api/zoho/dashboard';
            var params = [];
            if (currentFromDate) params.push('from_date=' + currentFromDate);
            if (currentToDate) params.push('to_date=' + currentToDate);
            if (isCompareMode && currentPeriod !== 'all') params.push('compare=true');
            if (params.length > 0) url += '?' + params.join('&');

            const response = await fetch(url, {
                headers: getAuthHeaders()
            });

            if (response.status === 401) {
                window.location.href = '/login.html';
                return;
            }

            const result = await response.json();

            if (result.success && result.data) {
                const data = result.data;
                lastDashboardData = data;
                const inv = data.invoices || {};
                const pay = data.payments || {};
                const cust = data.customers || {};

                // Row 1 - Currency KPIs
                document.getElementById('statRevenue').textContent = formatCurrency(inv.total_revenue);
                document.getElementById('statOutstanding').textContent = formatCurrency(inv.total_outstanding);
                document.getElementById('statOverdue').textContent = formatCurrency(inv.overdue_amount);
                document.getElementById('statCollected').textContent = formatCurrency(pay.total_collected);

                // Row 2 - Count KPIs
                document.getElementById('statTotalInvoices').textContent = inv.total_invoices || 0;
                document.getElementById('statOverdueInvoices').textContent = inv.overdue_count || 0;
                document.getElementById('statUnpaidInvoices').textContent = inv.unpaid_count || 0;
                document.getElementById('statZohoCustomers').textContent = cust.total || 0;

                // Comparison indicators
                if (data.previous) {
                    var prevInv = data.previous.invoices || {};
                    var prevPay = data.previous.payments || {};

                    renderChangeIndicator('changeRevenue', inv.total_revenue, prevInv.total_revenue, false);
                    renderChangeIndicator('changeOutstanding', inv.total_outstanding, prevInv.total_outstanding, true);
                    renderChangeIndicator('changeOverdue', inv.overdue_amount, prevInv.overdue_amount, true);
                    renderChangeIndicator('changeCollected', pay.total_collected, prevPay.total_collected, false);
                    renderChangeIndicator('changeTotalInvoices', inv.total_invoices, prevInv.total_invoices, false);
                    renderChangeIndicator('changeOverdueInvoices', inv.overdue_count, prevInv.overdue_count, true);
                    renderChangeIndicator('changeUnpaidInvoices', inv.unpaid_count, prevInv.unpaid_count, true);
                } else {
                    // Hide all change indicators
                    ['changeRevenue', 'changeOutstanding', 'changeOverdue', 'changeCollected',
                     'changeTotalInvoices', 'changeOverdueInvoices', 'changeUnpaidInvoices'].forEach(function(id) {
                        var el = document.getElementById(id);
                        if (el) el.style.display = 'none';
                    });
                }
            } else {
                // Set defaults when no data
                document.getElementById('statRevenue').textContent = '\u20B90';
                document.getElementById('statOutstanding').textContent = '\u20B90';
                document.getElementById('statOverdue').textContent = '\u20B90';
                document.getElementById('statCollected').textContent = '\u20B90';
                document.getElementById('statTotalInvoices').textContent = '0';
                document.getElementById('statOverdueInvoices').textContent = '0';
                document.getElementById('statUnpaidInvoices').textContent = '0';
                document.getElementById('statZohoCustomers').textContent = '0';
            }
        } catch (error) {
            console.error('Failed to load dashboard data:', error);
            // Show zeros on error
            ['statRevenue', 'statOutstanding', 'statOverdue', 'statCollected'].forEach(function(id) {
                document.getElementById(id).textContent = '\u20B90';
            });
            ['statTotalInvoices', 'statOverdueInvoices', 'statUnpaidInvoices', 'statZohoCustomers'].forEach(function(id) {
                document.getElementById(id).textContent = '0';
            });
        }
    }

    // Load trend chart data
    async function loadTrendData() {
        if (!currentFromDate || !currentToDate) return;

        var granularity = document.getElementById('granularitySelect').value;

        try {
            var url = '/api/zoho/dashboard/trend?from_date=' + currentFromDate + '&to_date=' + currentToDate + '&granularity=' + granularity;
            var response = await fetch(url, { headers: getAuthHeaders() });
            if (!response.ok) throw new Error('HTTP ' + response.status);

            var result = await response.json();
            if (result.success && result.data) {
                renderTrendChart(result.data.trend, granularity);
                document.getElementById('trendChartContainer').classList.add('show');
            }
        } catch (error) {
            console.error('Failed to load trend data:', error);
        }
    }

    function hideTrendChart() {
        document.getElementById('trendChartContainer').classList.remove('show');
        if (trendChartInstance) {
            trendChartInstance.destroy();
            trendChartInstance = null;
        }
    }

    function renderTrendChart(data, granularity) {
        if (trendChartInstance) {
            trendChartInstance.destroy();
            trendChartInstance = null;
        }

        if (!data || data.length === 0) {
            hideTrendChart();
            return;
        }

        var ctx = document.getElementById('trendChart').getContext('2d');
        var labels = data.map(function(d) {
            if (granularity === 'month') {
                var parts = d.period.split('-');
                var monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
                return monthNames[parseInt(parts[1]) - 1] + ' ' + parts[0].slice(2);
            }
            return d.period.slice(5); // MM-DD
        });

        trendChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Revenue',
                        data: data.map(function(d) { return d.revenue; }),
                        borderColor: '#7c3aed',
                        backgroundColor: 'rgba(124, 58, 237, 0.08)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3,
                        pointRadius: data.length > 30 ? 0 : 3,
                        pointHoverRadius: 5
                    },
                    {
                        label: 'Collected',
                        data: data.map(function(d) { return d.collected; }),
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.08)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3,
                        pointRadius: data.length > 30 ? 0 : 3,
                        pointHoverRadius: 5
                    },
                    {
                        label: 'Overdue',
                        data: data.map(function(d) { return d.overdue; }),
                        borderColor: '#ef4444',
                        borderWidth: 2,
                        borderDash: [5, 3],
                        fill: false,
                        tension: 0.3,
                        pointRadius: data.length > 30 ? 0 : 3,
                        pointHoverRadius: 5
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { usePointStyle: true, padding: 16, font: { size: 12 } }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(ctx) {
                                return ctx.dataset.label + ': ' + formatCurrency(ctx.parsed.y);
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: { display: false },
                        ticks: { maxRotation: 45, font: { size: 11 } }
                    },
                    y: {
                        grid: { color: '#f3f4f6' },
                        ticks: {
                            font: { size: 11 },
                            callback: function(val) { return formatCurrency(val); }
                        }
                    }
                }
            }
        });
    }

    // Export dashboard data as CSV
    function exportDashboardCSV() {
        var url = '/api/zoho/dashboard/export';
        var params = [];
        if (currentFromDate) params.push('from_date=' + currentFromDate);
        if (currentToDate) params.push('to_date=' + currentToDate);
        if (params.length > 0) url += '?' + params.join('&');

        // Fetch with auth and trigger download
        fetch(url, { headers: getAuthHeaders() })
            .then(function(response) {
                if (!response.ok) throw new Error('Export failed');
                return response.blob();
            })
            .then(function(blob) {
                var a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = 'zoho-dashboard-' + (currentFromDate || 'all') + '-to-' + (currentToDate || 'all') + '.csv';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(a.href);
                showToast('CSV exported successfully', 'success');
            })
            .catch(function(err) {
                console.error('Export error:', err);
                showToast('Failed to export CSV', 'error');
            });
    }

    // Load recent invoices
    async function loadRecentInvoices() {
        try {
            const response = await fetch('/api/zoho/invoices?limit=10&sort=invoice_date&order=DESC', {
                headers: getAuthHeaders()
            });

            if (response.status === 401) {
                window.location.href = '/login.html';
                return;
            }

            const result = await response.json();

            document.getElementById('invoicesLoading').classList.add('hidden');
            document.getElementById('invoicesContent').classList.remove('hidden');

            if (result.success && result.data && result.data.length > 0) {
                const tbody = document.getElementById('invoicesTableBody');
                tbody.innerHTML = '';

                result.data.forEach(function(inv) {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-100 hover:bg-gray-50 transition';
                    row.innerHTML = '<td class="py-3 pr-3 font-medium text-indigo-700">' + (inv.invoice_number || '--') + '</td>' +
                        '<td class="py-3 pr-3 text-gray-700 max-w-[150px] truncate">' + (inv.customer_name || '--') + '</td>' +
                        '<td class="py-3 pr-3 text-gray-500 hidden sm:table-cell">' + formatDate(inv.invoice_date || inv.date) + '</td>' +
                        '<td class="py-3 pr-3 text-right font-medium text-gray-800">' + formatCurrency(inv.total || inv.amount) + '</td>' +
                        '<td class="py-3 pr-3 text-right text-gray-600 hidden sm:table-cell">' + formatCurrency(inv.balance) + '</td>' +
                        '<td class="py-3 text-center">' + getStatusBadge(inv.status) + '</td>';
                    tbody.appendChild(row);
                });
            } else {
                document.getElementById('noInvoices').classList.remove('hidden');
            }
        } catch (error) {
            console.error('Failed to load invoices:', error);
            document.getElementById('invoicesLoading').classList.add('hidden');
            document.getElementById('invoicesContent').classList.remove('hidden');
            document.getElementById('noInvoices').classList.remove('hidden');
        }
    }

    // Trigger full sync
    async function triggerFullSync() {
        const btn = document.getElementById('syncNowBtn');
        const icon = document.getElementById('syncIcon');
        const text = document.getElementById('syncBtnText');

        btn.disabled = true;
        btn.classList.add('opacity-75');
        icon.classList.add('animate-spin');
        text.textContent = 'Syncing...';

        try {
            const response = await fetch('/api/zoho/sync/full', {
                method: 'POST',
                headers: getAuthHeaders()
            });

            if (response.status === 401) {
                window.location.href = '/login.html';
                return;
            }

            const result = await response.json();

            if (result.success) {
                showToast(result.message || 'Full sync started successfully', 'success');
                // Reload data after a brief delay to allow sync to begin
                setTimeout(function() {
                    loadAll();
                }, 2000);
            } else {
                showToast(result.message || 'Sync failed. Please try again.', 'error');
            }
        } catch (error) {
            console.error('Sync error:', error);
            showToast('Failed to start sync. Check your connection.', 'error');
        } finally {
            btn.disabled = false;
            btn.classList.remove('opacity-75');
            icon.classList.remove('animate-spin');
            text.textContent = 'Sync Now';
        }
    }

    // Sync customers only
    async function syncCustomers() {
        const btn = document.getElementById('syncCustomersBtn');
        const text = document.getElementById('syncCustomersText');

        btn.disabled = true;
        btn.style.opacity = '0.75';
        text.textContent = 'Syncing...';

        try {
            const response = await fetch('/api/zoho/sync/customers', {
                method: 'POST',
                headers: getAuthHeaders()
            });

            if (response.status === 401) {
                window.location.href = '/login.html';
                return;
            }

            const result = await response.json();

            if (result.success) {
                showToast(result.message || 'Customer sync started', 'success');
                setTimeout(function() {
                    loadAll();
                }, 2000);
            } else {
                showToast(result.message || 'Customer sync failed', 'error');
            }
        } catch (error) {
            console.error('Customer sync error:', error);
            showToast('Failed to sync customers', 'error');
        } finally {
            btn.disabled = false;
            btn.style.opacity = '1';
            text.textContent = 'Sync Customers';
        }
    }

    // ============================
    // API USAGE MONITOR
    // ============================

    const callerColors = [
        '#667eea', '#764ba2', '#f59e0b', '#10b981', '#ef4444',
        '#6366f1', '#ec4899', '#14b8a6', '#f97316', '#8b5cf6',
        '#06b6d4', '#84cc16', '#e11d48', '#0ea5e9', '#a855f7'
    ];

    function getCallerColor(index) {
        return callerColors[index % callerColors.length];
    }

    function getCallerLabel(name) {
        const labels = {
            'syncItems': 'Sync Items',
            'getItemDetails': 'Item Details',
            'bulkUpdateItem': 'Bulk Update',
            'getInvoiceDetail': 'Invoice Detail',
            'getItemDetail': 'Item Detail',
            'dailyReport.invoices': 'Report: Invoices',
            'dailyReport.bills': 'Report: Bills',
            'dailyReport.salesOrders': 'Report: Sales Orders',
            'dailyReport.purchaseOrders': 'Report: PO',
            'inventoryAdjustment': 'Stock Adjustment',
            'unknown': 'Other'
        };
        return labels[name] || name;
    }

    async function loadApiUsage() {
        var refreshIcon = document.getElementById('usageRefreshIcon');
        refreshIcon.classList.add('animate-spin');

        try {
            var response = await fetch('/api/zoho/api-usage', {
                headers: getAuthHeaders()
            });

            if (response.status === 401) {
                window.location.href = '/login.html';
                return;
            }

            if (!response.ok) throw new Error('Failed to load API usage (HTTP ' + response.status + ')');

            var result = await response.json();

            if (result.success && result.data) {
                renderApiUsage(result.data);
            } else {
                console.warn('API usage returned no data:', result.message || 'Unknown');
                // Show defaults so UI isn't stuck
                renderApiUsage({ daily: {}, rate: {}, top_callers: [], recent_activity: [], sync_lock: {}, hourly_breakdown: [], recent_syncs: [], active_bulk_jobs: [] });
            }
        } catch (error) {
            console.error('Failed to load API usage:', error);
        } finally {
            refreshIcon.classList.remove('animate-spin');
        }
    }

    function renderApiUsage(data) {
        var daily = data.daily || {};
        var rate = data.rate || {};
        var topCallers = data.top_callers || [];
        var recentActivity = data.recent_activity || [];
        var syncLock = data.sync_lock || {};
        var hourly = data.hourly_breakdown || [];
        var recentSyncs = data.recent_syncs || [];
        var activeBulkJobs = data.active_bulk_jobs || [];

        // === Quota Gauge ===
        var percent = daily.percentage || 0;
        var circumference = 2 * Math.PI * 52; // 326.7
        var offset = circumference - (percent / 100) * circumference;

        var arc = document.getElementById('quotaArc');
        arc.style.strokeDasharray = circumference;
        arc.style.strokeDashoffset = offset;

        // Color based on usage level
        if (percent >= 90) {
            arc.style.stroke = '#ef4444';
        } else if (percent >= 70) {
            arc.style.stroke = '#f59e0b';
        } else {
            arc.style.stroke = '#667eea';
        }

        document.getElementById('quotaPercent').textContent = percent + '%';
        document.getElementById('quotaPercent').style.color = percent >= 90 ? '#ef4444' : percent >= 70 ? '#f59e0b' : '#1f2937';
        document.getElementById('quotaUsed').textContent = (daily.used || 0).toLocaleString();
        document.getElementById('quotaLimit').textContent = (daily.limit || 10000).toLocaleString();
        document.getElementById('quotaRemaining').textContent = (daily.remaining || 0).toLocaleString();

        // Quota bar color
        var quotaBar = document.getElementById('quotaBar');
        var remainPct = Math.max(0, 100 - percent);
        quotaBar.style.width = remainPct + '%';
        quotaBar.className = 'h-2 rounded-full transition-all ' + (percent >= 90 ? 'bg-red-500' : percent >= 70 ? 'bg-yellow-500' : 'bg-green-500');

        // Rate info
        document.getElementById('rateTokens').textContent = (rate.current_tokens || 0) + '/80';
        document.getElementById('rateQueued').textContent = rate.queued || 0;
        document.getElementById('rateLast5').textContent = (rate.calls_last_5_min || 0) + ' calls';
        document.getElementById('rateLastHour').textContent = (rate.calls_last_hour || 0) + ' calls';

        // === Calls Per Minute Bar Chart ===
        var cpm = rate.calls_per_minute || [];
        var maxCount = cpm.length > 0 ? Math.max(1, ...cpm.map(function(c) { return c.count; })) : 1;
        var barChart = document.getElementById('rateBarChart');
        var barLabels = document.getElementById('rateBarLabels');

        barChart.innerHTML = '';
        barLabels.innerHTML = '';
        cpm.forEach(function(item) {
            var heightPct = Math.max(2, (item.count / maxCount) * 100);
            var bar = document.createElement('div');
            bar.className = 'rate-bar-col';
            bar.style.height = heightPct + '%';
            bar.title = item.minute + ': ' + item.count + ' calls';
            barChart.appendChild(bar);

            var label = document.createElement('span');
            label.textContent = item.minute;
            barLabels.appendChild(label);
        });

        // === Hourly Breakdown Chart ===
        var hourlyChart = document.getElementById('hourlyBarChart');
        hourlyChart.innerHTML = '';
        if (hourly.length > 0) {
            var maxHourly = Math.max(1, ...hourly.map(function(h) { return h.count; }));
            hourly.forEach(function(h) {
                var heightPct = Math.max(2, (h.count / maxHourly) * 100);
                var bar = document.createElement('div');
                bar.className = 'rate-bar-col';
                bar.style.height = heightPct + '%';
                bar.style.background = h.count > 0 ? 'linear-gradient(180deg, #10b981, #059669)' : '#e5e7eb';
                bar.title = h.hour + ': ' + h.count + ' calls';
                hourlyChart.appendChild(bar);
            });
        }

        // === Sync Lock Banner ===
        var banner = document.getElementById('syncLockBanner');
        var bannerText = document.getElementById('syncLockText');
        banner.classList.remove('hidden');
        if (syncLock.locked) {
            var durationMin = Math.round((syncLock.duration_ms || 0) / 60000);
            banner.className = 'sync-lock-banner mb-4';
            bannerText.innerHTML = '<strong>' + (syncLock.operation || 'Unknown') + '</strong> in progress (' + durationMin + ' min) - Bulk jobs paused';
        } else {
            banner.className = 'sync-lock-banner idle mb-4';
            bannerText.textContent = 'No active sync operations - all systems idle';
        }

        // === Active Operations ===
        var opsContent = document.getElementById('activeOpsContent');
        var opsHtml = '';

        if (activeBulkJobs.length > 0) {
            activeBulkJobs.forEach(function(job) {
                var jobPct = job.total_items > 0 ? Math.round(((job.processed_items || 0) / job.total_items) * 100) : 0;
                opsHtml += '<div class="p-2 rounded-lg bg-blue-50 border border-blue-200">';
                opsHtml += '<div class="flex items-center justify-between mb-1">';
                opsHtml += '<span class="text-xs font-semibold text-blue-800">Bulk Job #' + job.id + '</span>';
                opsHtml += '<span class="text-xs text-blue-600">' + jobPct + '%</span>';
                opsHtml += '</div>';
                opsHtml += '<div class="w-full bg-blue-200 rounded-full h-1.5">';
                opsHtml += '<div class="h-1.5 rounded-full bg-blue-600" style="width: ' + jobPct + '%"></div>';
                opsHtml += '</div>';
                opsHtml += '<div class="text-[10px] text-blue-600 mt-1">' + (job.processed_items || 0) + '/' + job.total_items + ' items</div>';
                opsHtml += '</div>';
            });
        }

        if (recentSyncs.length > 0) {
            var activeSync = recentSyncs.find(function(s) { return s.status === 'started' || s.status === 'in_progress'; });
            if (activeSync) {
                opsHtml += '<div class="p-2 rounded-lg bg-green-50 border border-green-200">';
                opsHtml += '<div class="flex items-center gap-2">';
                opsHtml += '<span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>';
                opsHtml += '<span class="text-xs font-semibold text-green-800">' + (activeSync.sync_type || 'Sync') + ' in progress</span>';
                opsHtml += '</div>';
                opsHtml += '</div>';
            }
        }

        if (daily.paused) {
            opsHtml += '<div class="p-2 rounded-lg bg-red-50 border border-red-200">';
            opsHtml += '<div class="flex items-center gap-2">';
            opsHtml += '<svg class="w-4 h-4 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">';
            opsHtml += '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.34 16.5c-.77.833.192 2.5 1.732 2.5z"></path>';
            opsHtml += '</svg>';
            opsHtml += '<span class="text-xs font-semibold text-red-800">Daily quota paused!</span>';
            opsHtml += '</div>';
            opsHtml += '<div class="text-[10px] text-red-600 mt-1">Non-essential API operations are paused until tomorrow to preserve quota.</div>';
            opsHtml += '</div>';
        }

        if (!opsHtml) {
            opsHtml = '<div class="text-xs text-gray-400 text-center py-4">No active operations</div>';
        }

        opsContent.innerHTML = opsHtml;

        // === Top Callers ===
        var callersHtml = '';
        if (topCallers.length > 0) {
            var maxCallerCount = topCallers[0].count || 1;
            topCallers.forEach(function(caller, index) {
                var barWidth = Math.max(4, Math.round((caller.count / maxCallerCount) * 100));
                var color = getCallerColor(index);
                callersHtml += '<div class="flex items-center gap-3 mb-2">';
                callersHtml += '<div class="w-28 flex-shrink-0 text-xs font-medium text-gray-700 truncate" title="' + caller.name + '">' + getCallerLabel(caller.name) + '</div>';
                callersHtml += '<div class="flex-1">';
                callersHtml += '<div class="flex items-center gap-2">';
                callersHtml += '<div class="flex-1 bg-gray-100 rounded-full h-3 overflow-hidden">';
                callersHtml += '<div class="h-full rounded-full" style="width: ' + barWidth + '%; background: ' + color + ';"></div>';
                callersHtml += '</div>';
                callersHtml += '<span class="text-xs font-bold text-gray-700 w-12 text-right">' + caller.count + '</span>';
                callersHtml += '<span class="text-[10px] text-gray-400 w-8 text-right">' + caller.percentage + '%</span>';
                callersHtml += '</div>';
                callersHtml += '</div>';
                callersHtml += '</div>';
            });
        } else {
            callersHtml = '<div class="text-xs text-gray-400 text-center py-6">No API calls recorded today</div>';
        }
        document.getElementById('topCallersContent').innerHTML = callersHtml;

        // === Recent Activity ===
        var activityHtml = '';
        if (recentActivity.length > 0) {
            recentActivity.forEach(function(entry) {
                activityHtml += '<div class="activity-entry">';
                activityHtml += '<span class="text-gray-700">' + getCallerLabel(entry.caller) + '</span>';
                activityHtml += '<span class="text-gray-400">' + entry.time + '</span>';
                activityHtml += '</div>';
            });
        } else {
            activityHtml = '<div class="text-xs text-gray-400 text-center py-6">No recent activity</div>';
        }
        document.getElementById('recentActivityContent').innerHTML = activityHtml;
    }

    // === Auto-refresh API usage every 30 seconds ===
    var usageRefreshInterval = null;

    function startUsageAutoRefresh() {
        if (usageRefreshInterval) return;
        usageRefreshInterval = setInterval(loadApiUsage, 30000);
    }

    function stopUsageAutoRefresh() {
        if (usageRefreshInterval) {
            clearInterval(usageRefreshInterval);
            usageRefreshInterval = null;
        }
    }

    // Stop auto-refresh when tab is not visible
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            stopUsageAutoRefresh();
        } else {
            loadApiUsage();
            startUsageAutoRefresh();
        }
    });

    // ============================
    // DRILLDOWN MODAL
    // ============================
    var drilldownMetric = null;
    var drilldownPage = 1;
    var drilldownSort = null;
    var drilldownOrder = 'DESC';
    var drilldownSearch = '';
    var zohoOrgId = null;
    var _drilldownSearchTimer = null;

    var DRILLDOWN_TITLES = {
        revenue: 'Total Revenue',
        outstanding: 'Outstanding Invoices',
        overdue: 'Overdue Invoices',
        collected: 'Payments Collected',
        total_invoices: 'All Invoices',
        overdue_invoices: 'Overdue Invoices',
        unpaid_invoices: 'Unpaid Invoices'
    };

    var INVOICE_SORT_OPTIONS = [
        { value: 'invoice_date', label: 'Date' },
        { value: 'due_date', label: 'Due Date' },
        { value: 'total', label: 'Total' },
        { value: 'balance', label: 'Balance' },
        { value: 'customer_name', label: 'Customer' },
        { value: 'invoice_number', label: 'Invoice #' },
        { value: 'status', label: 'Status' }
    ];

    var PAYMENT_SORT_OPTIONS = [
        { value: 'payment_date', label: 'Date' },
        { value: 'amount', label: 'Amount' },
        { value: 'customer_name', label: 'Customer' },
        { value: 'payment_number', label: 'Payment #' },
        { value: 'payment_mode', label: 'Mode' }
    ];

    function openDrilldown(metric) {
        drilldownMetric = metric;
        drilldownPage = 1;
        drilldownSort = null;
        drilldownOrder = 'DESC';
        drilldownSearch = '';

        // UI
        document.getElementById('drilldownTitle').textContent = DRILLDOWN_TITLES[metric] || metric;

        // Period tag
        var periodNames = { all: 'All Time', today: 'Today', yesterday: 'Yesterday', this_week: 'This Week', this_month: 'This Month', prev_month: 'Prev Month', this_year: 'This Year', custom: 'Custom' };
        var tag = document.getElementById('drilldownPeriodTag');
        tag.textContent = periodNames[currentPeriod] || currentPeriod;
        if (currentFromDate && currentToDate && currentPeriod !== 'all') {
            tag.textContent += ' (' + currentFromDate + ' \u2192 ' + currentToDate + ')';
        }

        // Populate sort select
        var isPayment = metric === 'collected';
        var sortOpts = isPayment ? PAYMENT_SORT_OPTIONS : INVOICE_SORT_OPTIONS;
        var sortSel = document.getElementById('drilldownSortSelect');
        sortSel.innerHTML = '';
        sortOpts.forEach(function(opt) {
            var o = document.createElement('option');
            o.value = opt.value;
            o.textContent = 'Sort: ' + opt.label;
            sortSel.appendChild(o);
        });

        // Clear search
        document.getElementById('drilldownSearch').value = '';
        document.getElementById('drilldownOrderLabel').textContent = 'DESC';

        // Show modal
        var modal = document.getElementById('drilldownModal');
        modal.classList.add('open');
        document.body.style.overflow = 'hidden';

        loadDrilldownData();
    }

    function closeDrilldown() {
        var modal = document.getElementById('drilldownModal');
        modal.classList.remove('open');
        document.body.style.overflow = '';
        drilldownMetric = null;
    }

    // Close on backdrop click
    document.addEventListener('click', function(e) {
        var modal = document.getElementById('drilldownModal');
        if (e.target === modal) closeDrilldown();
    });

    // Close on Escape
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && drilldownMetric) closeDrilldown();
    });

    async function loadDrilldownData() {
        if (!drilldownMetric) return;

        // Show loading
        document.getElementById('drilldownLoading').style.display = 'block';
        document.getElementById('drilldownTableWrap').style.display = 'none';
        document.getElementById('drilldownEmpty').style.display = 'none';
        document.getElementById('drilldownPagination').innerHTML = '';

        var url = '/api/zoho/dashboard/drilldown?metric=' + drilldownMetric;
        if (currentFromDate) url += '&from_date=' + currentFromDate;
        if (currentToDate) url += '&to_date=' + currentToDate;
        if (drilldownSearch) url += '&search=' + encodeURIComponent(drilldownSearch);
        if (drilldownSort) url += '&sort=' + drilldownSort;
        url += '&order=' + drilldownOrder;
        url += '&page=' + drilldownPage + '&limit=25';

        try {
            var response = await fetch(url, { headers: getAuthHeaders() });
            if (response.status === 401) { window.location.href = '/login.html'; return; }
            if (!response.ok) throw new Error('HTTP ' + response.status);

            var result = await response.json();
            document.getElementById('drilldownLoading').style.display = 'none';

            if (result.success && result.data && result.data.length > 0) {
                renderDrilldownTable(result);
                renderDrilldownPagination(result.pagination);
                document.getElementById('drilldownTableWrap').style.display = 'block';

                // Summary
                var summary = result.summary || {};
                var summaryEl = document.getElementById('drilldownSummary');
                summaryEl.innerHTML = '<strong>' + (summary.count || 0) + '</strong> ' +
                    (result.type === 'payments' ? 'payments' : 'invoices') +
                    ' totaling <strong>' + formatCurrency(summary.total_amount) + '</strong>';
            } else {
                document.getElementById('drilldownEmpty').style.display = 'block';
                document.getElementById('drilldownSummary').innerHTML = '<strong>0</strong> results found';
            }
        } catch (error) {
            console.error('Drilldown fetch error:', error);
            document.getElementById('drilldownLoading').style.display = 'none';
            document.getElementById('drilldownEmpty').style.display = 'block';
            document.getElementById('drilldownEmpty').textContent = 'Error loading data: ' + error.message;
        }
    }

    function renderDrilldownTable(result) {
        var thead = document.getElementById('drilldownThead');
        var tbody = document.getElementById('drilldownTbody');
        var isPayment = result.type === 'payments';

        // Build headers
        var headers = [];
        if (isPayment) {
            headers = [
                { key: 'payment_number', label: 'Payment #', cls: 'link-cell' },
                { key: 'customer_name', label: 'Customer' },
                { key: 'payment_date', label: 'Date' },
                { key: 'amount', label: 'Amount', cls: 'text-right' },
                { key: 'payment_mode', label: 'Mode' },
                { key: 'reference_number', label: 'Reference' },
                { key: '_actions', label: 'Actions' }
            ];
        } else {
            headers = [
                { key: 'invoice_number', label: 'Invoice #', cls: 'link-cell' },
                { key: 'customer_name', label: 'Customer' },
                { key: 'invoice_date', label: 'Date' },
                { key: 'due_date', label: 'Due Date' },
                { key: 'total', label: 'Total', cls: 'text-right' },
                { key: 'balance', label: 'Balance', cls: 'text-right' },
                { key: 'status', label: 'Status' },
                { key: '_actions', label: 'Actions' }
            ];
        }

        thead.innerHTML = '<tr>' + headers.map(function(h) {
            var isSorted = drilldownSort === h.key;
            var sortedClass = isSorted ? ' sorted' : '';
            var arrow = '';
            if (isSorted) arrow = '<span class="sort-arrow">' + (drilldownOrder === 'ASC' ? '\u25B2' : '\u25BC') + '</span>';
            if (h.key === '_actions') return '<th>' + h.label + '</th>';
            return '<th class="' + sortedClass + '" onclick="setDrilldownSort(\'' + h.key + '\')">' + h.label + arrow + '</th>';
        }).join('') + '</tr>';

        // Build rows
        tbody.innerHTML = '';
        result.data.forEach(function(row) {
            var tr = document.createElement('tr');
            var cells = '';

            if (isPayment) {
                cells += '<td class="link-cell"><a href="#" onclick="openPreview(\'payment\',' + row.id + ',\'' + (row.zoho_payment_id || '') + '\');return false;" style="cursor:pointer;text-decoration:none;color:#667eea;" title="Click to preview">' + (row.payment_number || '--') + '</a></td>';
                cells += '<td style="max-width:180px" class="truncate">' + (row.customer_name || '--') + '</td>';
                cells += '<td>' + formatDate(row.payment_date) + '</td>';
                cells += '<td class="text-right" style="font-weight:600">' + formatCurrency(row.amount) + '</td>';
                cells += '<td>' + getPaymentModeBadge(row.payment_mode) + '</td>';
                cells += '<td>' + (row.reference_number || '--') + '</td>';
                cells += '<td>' + getZohoLink(row.zoho_payment_id, 'payments') + '</td>';
            } else {
                cells += '<td class="link-cell"><a href="#" onclick="openPreview(\'invoice\',' + row.id + ',\'' + (row.zoho_invoice_id || '') + '\');return false;" style="cursor:pointer;text-decoration:none;color:#667eea;" title="Click to preview">' + (row.invoice_number || '--') + '</a></td>';
                cells += '<td style="max-width:180px" class="truncate">' + (row.customer_name || '--') + '</td>';
                cells += '<td>' + formatDate(row.invoice_date) + '</td>';
                var dueDateClass = row.status === 'overdue' ? ' overdue-date' : '';
                cells += '<td class="' + dueDateClass + '">' + formatDate(row.due_date) + '</td>';
                cells += '<td class="text-right" style="font-weight:600">' + formatCurrency(row.total) + '</td>';
                var balStr = parseFloat(row.balance) > 0 ? formatCurrency(row.balance) : '<span style="color:#9ca3af">--</span>';
                cells += '<td class="text-right">' + balStr + '</td>';
                cells += '<td>' + getStatusBadge(row.status) + '</td>';
                cells += '<td>' + getZohoLink(row.zoho_invoice_id, 'invoices') + '</td>';
            }

            tr.innerHTML = cells;
            tbody.appendChild(tr);
        });
    }

    function getPaymentModeBadge(mode) {
        if (!mode) return '--';
        var colors = {
            cash: 'background:#ecfdf5;color:#065f46',
            bank_transfer: 'background:#dbeafe;color:#1e40af',
            check: 'background:#fef9c3;color:#854d0e',
            credit_card: 'background:#f3e8ff;color:#6b21a8'
        };
        var style = colors[mode.toLowerCase()] || 'background:#f3f4f6;color:#374151';
        return '<span class="badge" style="' + style + '">' + mode.replace(/_/g, ' ') + '</span>';
    }

    function getZohoLink(zohoId, type) {
        if (!zohoOrgId || !zohoId) return '';
        var url = 'https://books.zoho.in/app/' + zohoOrgId + '#/' + type + '/' + zohoId;
        return '<a href="' + url + '" target="_blank" rel="noopener" class="zoho-link">View <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg></a>';
    }

    function renderDrilldownPagination(pagination) {
        var container = document.getElementById('drilldownPagination');
        if (!pagination || pagination.pages <= 1) {
            container.innerHTML = '';
            return;
        }

        var html = '';
        // Prev button
        html += '<button ' + (pagination.page <= 1 ? 'disabled' : '') + ' onclick="setDrilldownPage(' + (pagination.page - 1) + ')">&laquo;</button>';

        // Page buttons (show max 7)
        var startPage = Math.max(1, pagination.page - 3);
        var endPage = Math.min(pagination.pages, startPage + 6);
        if (endPage - startPage < 6) startPage = Math.max(1, endPage - 6);

        for (var i = startPage; i <= endPage; i++) {
            html += '<button class="' + (i === pagination.page ? 'active' : '') + '" onclick="setDrilldownPage(' + i + ')">' + i + '</button>';
        }

        // Next button
        html += '<button ' + (pagination.page >= pagination.pages ? 'disabled' : '') + ' onclick="setDrilldownPage(' + (pagination.page + 1) + ')">&raquo;</button>';

        container.innerHTML = html;
    }

    function setDrilldownSort(col) {
        if (drilldownSort === col) {
            // Toggle direction
            drilldownOrder = drilldownOrder === 'ASC' ? 'DESC' : 'ASC';
        } else {
            drilldownSort = col;
            drilldownOrder = 'DESC';
        }
        // Update select
        var sel = document.getElementById('drilldownSortSelect');
        if (sel.querySelector('option[value="' + col + '"]')) sel.value = col;
        document.getElementById('drilldownOrderLabel').textContent = drilldownOrder;
        drilldownPage = 1;
        loadDrilldownData();
    }

    function onDrilldownSortChange() {
        var sel = document.getElementById('drilldownSortSelect');
        drilldownSort = sel.value;
        drilldownPage = 1;
        loadDrilldownData();
    }

    function toggleDrilldownOrder() {
        drilldownOrder = drilldownOrder === 'ASC' ? 'DESC' : 'ASC';
        document.getElementById('drilldownOrderLabel').textContent = drilldownOrder;
        drilldownPage = 1;
        loadDrilldownData();
    }

    function setDrilldownPage(p) {
        drilldownPage = p;
        loadDrilldownData();
    }

    function debouncedDrilldownSearch() {
        if (_drilldownSearchTimer) clearTimeout(_drilldownSearchTimer);
        _drilldownSearchTimer = setTimeout(function() {
            drilldownSearch = document.getElementById('drilldownSearch').value.trim();
            drilldownPage = 1;
            loadDrilldownData();
        }, 400);
    }

    function exportDrilldownCSV() {
        var url = '/api/zoho/dashboard/drilldown/export?metric=' + drilldownMetric;
        if (currentFromDate) url += '&from_date=' + currentFromDate;
        if (currentToDate) url += '&to_date=' + currentToDate;
        if (drilldownSearch) url += '&search=' + encodeURIComponent(drilldownSearch);
        if (drilldownSort) url += '&sort=' + drilldownSort;
        url += '&order=' + drilldownOrder;

        fetch(url, { headers: getAuthHeaders() })
            .then(function(response) {
                if (!response.ok) throw new Error('Export failed');
                return response.blob();
            })
            .then(function(blob) {
                var a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = 'zoho-drilldown-' + drilldownMetric + '.csv';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(a.href);
                showToast('CSV exported', 'success');
            })
            .catch(function(err) {
                showToast('Export failed: ' + err.message, 'error');
            });
    }

    function printDrilldown() {
        window.print();
    }

    // ============================
    // LIVE PREVIEW MODAL
    // ============================
    function openPreview(type, id, zohoId) {
        var modal = document.getElementById('previewModal');
        var loading = document.getElementById('previewLoading');
        var content = document.getElementById('previewContent');
        var footer = document.getElementById('previewFooter');

        // Reset
        loading.style.display = 'flex';
        content.style.display = 'none';
        content.innerHTML = '';
        footer.style.display = 'none';

        // Set header
        document.getElementById('previewTitle').textContent = type === 'invoice' ? 'Invoice Details' : 'Payment Details';
        var badge = document.getElementById('previewTypeBadge');
        badge.textContent = type === 'invoice' ? 'Invoice' : 'Payment';
        badge.style.background = type === 'invoice' ? '#eef2ff' : '#ecfdf5';
        badge.style.color = type === 'invoice' ? '#4338ca' : '#065f46';

        modal.classList.add('open');

        // Fetch data
        if (type === 'invoice') {
            fetchInvoicePreview(id, zohoId);
        } else {
            fetchPaymentPreview(id, zohoId);
        }
    }

    function closePreview() {
        document.getElementById('previewModal').classList.remove('open');
    }

    // Close preview on backdrop click
    document.getElementById('previewModal').addEventListener('click', function(e) {
        if (e.target === this) closePreview();
    });

    // Close preview on Escape (only if preview is open)
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && document.getElementById('previewModal').classList.contains('open')) {
            closePreview();
        }
    });

    async function fetchInvoicePreview(id, zohoId) {
        try {
            var response = await fetch('/api/zoho/invoices/' + id, { headers: getAuthHeaders() });
            if (!response.ok) throw new Error('HTTP ' + response.status);
            var result = await response.json();
            if (result.success && result.data) {
                renderInvoicePreview(result.data);
            } else {
                showPreviewError(result.message || 'Invoice not found');
            }
        } catch (err) {
            showPreviewError(err.message);
        }
    }

    async function fetchPaymentPreview(id, zohoId) {
        try {
            var response = await fetch('/api/zoho/payments/' + id, { headers: getAuthHeaders() });
            if (!response.ok) throw new Error('HTTP ' + response.status);
            var result = await response.json();
            if (result.success && result.data) {
                renderPaymentPreview(result.data);
            } else {
                showPreviewError(result.message || 'Payment not found');
            }
        } catch (err) {
            showPreviewError(err.message);
        }
    }

    function showPreviewError(message) {
        document.getElementById('previewLoading').style.display = 'none';
        var content = document.getElementById('previewContent');
        content.style.display = 'block';
        content.innerHTML = '<div style="text-align:center;padding:2rem;color:#dc2626;"><svg class="w-8 h-8 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:2rem;height:2rem;margin:0 auto 0.5rem;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.34 16.5c-.77.833.192 2.5 1.732 2.5z"></path></svg><div style="font-weight:600;">Error loading details</div><div style="font-size:0.8rem;color:#9ca3af;margin-top:0.25rem;">' + message + '</div></div>';
    }

    function formatCurrencyFull(amount) {
        var num = parseFloat(amount || 0);
        return '\u20B9' + num.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function renderInvoicePreview(data) {
        document.getElementById('previewLoading').style.display = 'none';
        var content = document.getElementById('previewContent');
        var footer = document.getElementById('previewFooter');
        content.style.display = 'block';
        footer.style.display = 'flex';

        var statusColorMap = {
            paid: 'paid', overdue: 'overdue', sent: '', partially_paid: '', draft: '', void: ''
        };
        var statusClass = statusColorMap[data.status] || '';

        var html = '';

        // Transaction info section
        html += '<div class="preview-section">';
        html += '<div class="preview-section-title">Transaction Info</div>';
        html += '<div class="preview-grid">';
        html += '<div class="preview-field"><div class="preview-field-label">Invoice #</div><div class="preview-field-value">' + (data.invoice_number || '--') + '</div></div>';
        html += '<div class="preview-field"><div class="preview-field-label">Status</div><div class="preview-field-value">' + getStatusBadge(data.status) + '</div></div>';
        html += '<div class="preview-field"><div class="preview-field-label">Invoice Date</div><div class="preview-field-value">' + formatDate(data.invoice_date) + '</div></div>';
        var dueDateVal = formatDate(data.due_date);
        var dueDateClass = data.status === 'overdue' ? ' overdue' : '';
        html += '<div class="preview-field"><div class="preview-field-label">Due Date</div><div class="preview-field-value' + dueDateClass + '">' + dueDateVal + '</div></div>';
        html += '</div>';
        html += '</div>';

        // Customer section
        html += '<div class="preview-section">';
        html += '<div class="preview-section-title">Customer</div>';
        html += '<div class="preview-grid">';
        html += '<div class="preview-field full"><div class="preview-field-label">Customer Name</div><div class="preview-field-value">' + (data.customer_name || '--') + '</div></div>';
        if (data.reference_number) {
            html += '<div class="preview-field full"><div class="preview-field-label">Reference #</div><div class="preview-field-value">' + data.reference_number + '</div></div>';
        }
        html += '</div>';
        html += '</div>';

        // Financial section
        html += '<div class="preview-section">';
        html += '<div class="preview-section-title">Financial Summary</div>';
        html += '<div class="preview-grid">';
        html += '<div class="preview-field"><div class="preview-field-label">Sub Total</div><div class="preview-field-value">' + formatCurrencyFull(data.sub_total) + '</div></div>';
        html += '<div class="preview-field"><div class="preview-field-label">Tax</div><div class="preview-field-value">' + formatCurrencyFull(data.tax_total) + '</div></div>';
        html += '<div class="preview-field"><div class="preview-field-label">Total</div><div class="preview-field-value amount">' + formatCurrencyFull(data.total) + '</div></div>';
        var balanceClass = parseFloat(data.balance) > 0 ? (data.status === 'overdue' ? ' overdue' : '') : ' paid';
        html += '<div class="preview-field"><div class="preview-field-label">Balance Due</div><div class="preview-field-value' + balanceClass + '">' + formatCurrencyFull(data.balance) + '</div></div>';
        html += '</div>';
        html += '</div>';

        // Line items (if available)
        var lineItems = data.line_items;
        if (typeof lineItems === 'string') {
            try { lineItems = JSON.parse(lineItems); } catch(e) { lineItems = null; }
        }
        if (lineItems && Array.isArray(lineItems) && lineItems.length > 0) {
            html += '<div class="preview-section">';
            html += '<div class="preview-section-title">Line Items (' + lineItems.length + ')</div>';
            html += '<div style="overflow-x:auto;">';
            html += '<table class="preview-line-items">';
            html += '<thead><tr><th>Item</th><th style="text-align:right">Qty</th><th style="text-align:right">Rate</th><th style="text-align:right">Amount</th></tr></thead>';
            html += '<tbody>';
            lineItems.forEach(function(item) {
                html += '<tr>';
                html += '<td>' + (item.name || item.description || '--') + '</td>';
                html += '<td style="text-align:right">' + (item.quantity || 1) + '</td>';
                html += '<td style="text-align:right">' + formatCurrencyFull(item.rate || item.price) + '</td>';
                html += '<td style="text-align:right;font-weight:600">' + formatCurrencyFull(item.item_total || item.amount) + '</td>';
                html += '</tr>';
            });
            html += '</tbody></table></div>';
            html += '</div>';
        }

        // Notes / Terms
        if (data.notes) {
            html += '<div class="preview-section">';
            html += '<div class="preview-section-title">Notes</div>';
            html += '<div class="preview-field full"><div class="preview-field-value" style="font-weight:400;font-size:0.8rem;color:#6b7280;">' + data.notes + '</div></div>';
            html += '</div>';
        }

        content.innerHTML = html;

        // Set Zoho link
        var zohoLink = document.getElementById('previewZohoLink');
        if (zohoOrgId && data.zoho_invoice_id) {
            zohoLink.href = 'https://books.zoho.in/app/' + zohoOrgId + '#/invoices/' + data.zoho_invoice_id;
            zohoLink.style.display = 'inline-flex';
        } else {
            zohoLink.style.display = 'none';
        }
    }

    function renderPaymentPreview(data) {
        document.getElementById('previewLoading').style.display = 'none';
        var content = document.getElementById('previewContent');
        var footer = document.getElementById('previewFooter');
        content.style.display = 'block';
        footer.style.display = 'flex';

        var html = '';

        // Payment info
        html += '<div class="preview-section">';
        html += '<div class="preview-section-title">Payment Info</div>';
        html += '<div class="preview-grid">';
        html += '<div class="preview-field"><div class="preview-field-label">Payment #</div><div class="preview-field-value">' + (data.payment_number || '--') + '</div></div>';
        html += '<div class="preview-field"><div class="preview-field-label">Payment Date</div><div class="preview-field-value">' + formatDate(data.payment_date) + '</div></div>';
        html += '<div class="preview-field"><div class="preview-field-label">Amount</div><div class="preview-field-value amount">' + formatCurrencyFull(data.amount) + '</div></div>';
        html += '<div class="preview-field"><div class="preview-field-label">Payment Mode</div><div class="preview-field-value">' + getPaymentModeBadge(data.payment_mode) + '</div></div>';
        html += '</div>';
        html += '</div>';

        // Customer
        html += '<div class="preview-section">';
        html += '<div class="preview-section-title">Customer</div>';
        html += '<div class="preview-grid">';
        html += '<div class="preview-field full"><div class="preview-field-label">Customer Name</div><div class="preview-field-value">' + (data.customer_name || '--') + '</div></div>';
        if (data.reference_number) {
            html += '<div class="preview-field full"><div class="preview-field-label">Reference #</div><div class="preview-field-value">' + data.reference_number + '</div></div>';
        }
        html += '</div>';
        html += '</div>';

        // Additional details
        html += '<div class="preview-section">';
        html += '<div class="preview-section-title">Additional Details</div>';
        html += '<div class="preview-grid">';
        if (parseFloat(data.unused_amount) > 0) {
            html += '<div class="preview-field"><div class="preview-field-label">Unused Amount</div><div class="preview-field-value">' + formatCurrencyFull(data.unused_amount) + '</div></div>';
        }
        if (parseFloat(data.bank_charges) > 0) {
            html += '<div class="preview-field"><div class="preview-field-label">Bank Charges</div><div class="preview-field-value">' + formatCurrencyFull(data.bank_charges) + '</div></div>';
        }
        html += '</div>';
        html += '</div>';

        // Related invoice
        if (data.related_invoice) {
            var inv = data.related_invoice;
            html += '<div class="preview-section">';
            html += '<div class="preview-section-title">Related Invoice</div>';
            html += '<div class="preview-grid">';
            html += '<div class="preview-field"><div class="preview-field-label">Invoice #</div><div class="preview-field-value">' + (inv.invoice_number || '--') + '</div></div>';
            html += '<div class="preview-field"><div class="preview-field-label">Status</div><div class="preview-field-value">' + getStatusBadge(inv.status) + '</div></div>';
            html += '<div class="preview-field"><div class="preview-field-label">Invoice Total</div><div class="preview-field-value">' + formatCurrencyFull(inv.total) + '</div></div>';
            html += '<div class="preview-field"><div class="preview-field-label">Balance</div><div class="preview-field-value">' + formatCurrencyFull(inv.balance) + '</div></div>';
            html += '</div>';
            html += '</div>';
        }

        // Description
        if (data.description) {
            html += '<div class="preview-section">';
            html += '<div class="preview-section-title">Description</div>';
            html += '<div class="preview-field full"><div class="preview-field-value" style="font-weight:400;font-size:0.8rem;color:#6b7280;">' + data.description + '</div></div>';
            html += '</div>';
        }

        content.innerHTML = html;

        // Set Zoho link
        var zohoLink = document.getElementById('previewZohoLink');
        if (zohoOrgId && data.zoho_payment_id) {
            zohoLink.href = 'https://books.zoho.in/app/' + zohoOrgId + '#/payments/' + data.zoho_payment_id;
            zohoLink.style.display = 'inline-flex';
        } else {
            zohoLink.style.display = 'none';
        }
    }

    // Load all data
    function loadAll() {
        loadConnectionStatus();
        loadDashboardData();
        loadRecentInvoices();
        loadApiUsage();
        startUsageAutoRefresh();
    }

    // Initialize  set "Today" as default period with dates
    (function initDefaultPeriod() {
        var dates = calcPeriodDates('today');
        currentFromDate = dates.from;
        currentToDate = dates.to;
    })();
    loadAll();
</script>
</body>
</html>
