<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192x192.png">
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>WhatsApp Sessions - Quality Colours Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/css/design-system.css">
    <link rel="stylesheet" href="/css/zoho-common.css">
    <script src="/universal-nav-loader.js"></script>
    <script src="/js/auth-helper.js"></script>
    <script>checkAuthOrRedirect();</script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/js/socket-helper.js"></script>
    <style>
        body { background: #f9fafb; }
        .spinner { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .branch-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            padding: 20px;
            position: relative;
            overflow: hidden;
        }
        .branch-card .status-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
        }
        .status-bar.connected { background: #22c55e; }
        .status-bar.qr_pending { background: #f59e0b; }
        .status-bar.connecting { background: #3b82f6; }
        .status-bar.disconnected { background: #94a3b8; }
        .status-bar.failed { background: #ef4444; }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
        }
        .status-dot.connected { background: #22c55e; box-shadow: 0 0 6px rgba(34,197,94,0.5); }
        .status-dot.qr_pending { background: #f59e0b; animation: pulse 1.5s infinite; }
        .status-dot.connecting { background: #3b82f6; animation: pulse 1.5s infinite; }
        .status-dot.disconnected { background: #94a3b8; }
        .status-dot.failed { background: #ef4444; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .qr-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 200px;
            background: #f8fafc;
            border-radius: 8px;
            margin: 12px 0;
        }
        .qr-container canvas {
            border-radius: 8px;
        }

        .btn-connect {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            padding: 8px 20px;
            border-radius: 8px;
            font-size: 0.8125rem;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-connect:hover { box-shadow: 0 2px 8px rgba(34,197,94,0.3); transform: translateY(-1px); }
        .btn-connect:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        .btn-disconnect {
            background: #fee2e2;
            color: #991b1b;
            padding: 8px 20px;
            border-radius: 8px;
            font-size: 0.8125rem;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-disconnect:hover { background: #fecaca; }

        .btn-test {
            background: #f0f4ff;
            color: #667eea;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.8125rem;
            font-weight: 500;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-test:hover { background: #e0e7ff; }

        /* Modal */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: rgba(0,0,0,0.4); z-index: 9997; }
        .modal-overlay.show { display: flex; align-items: center; justify-content: center; }
        .modal-box { background: white; border-radius: 12px; padding: 24px; max-width: 420px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
    </style>
</head>
<body data-page="zoho-whatsapp-sessions" class="bg-gray-50">
    <div id="toast" class="toast"></div>

    <div class="container mx-auto p-4 md:p-6">

        <!-- Header -->
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-5">
            <div>
                <h2 class="text-xl md:text-2xl font-bold text-gray-800">WhatsApp Sessions</h2>
                <p class="text-gray-500 mt-0.5 text-xs">Connect branch WhatsApp numbers for sending payment reminders and notifications.</p>
            </div>
            <button onclick="loadSessions()" class="px-4 py-2 bg-gray-100 text-gray-600 rounded-lg text-sm hover:bg-gray-200 flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                Refresh
            </button>
        </div>

        <!-- Info banner -->
        <div class="bg-amber-50 border border-amber-200 rounded-lg p-3 mb-5 text-xs text-amber-800">
            <strong>Important:</strong> Each branch can connect one WhatsApp number. Messages sent from Collections will route through the branch's connected session.
            Each session uses ~300-500MB RAM. Recommended max: 4 branches.
        </div>

        <!-- Branch Cards Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4" id="sessionsGrid">
            <div class="text-center py-12 text-gray-400 col-span-full">
                <svg class="w-8 h-8 mx-auto mb-2 spinner" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                Loading sessions...
            </div>
        </div>
    </div>

    <!-- Test Message Modal -->
    <div class="modal-overlay" id="testModal">
        <div class="modal-box">
            <h3 class="text-lg font-bold text-gray-800 mb-3">Send Test Message</h3>
            <input type="hidden" id="testBranchId">
            <div class="mb-3">
                <label class="block text-xs font-medium text-gray-600 mb-1">Phone Number</label>
                <input type="text" id="testPhone" placeholder="e.g. 9876543210" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-300">
            </div>
            <div class="mb-4">
                <label class="block text-xs font-medium text-gray-600 mb-1">Message (optional)</label>
                <textarea id="testMessage" rows="3" placeholder="Test message from QC Paint Shop" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-300"></textarea>
            </div>
            <div class="flex gap-2 justify-end">
                <button onclick="closeTestModal()" class="px-4 py-2 bg-gray-100 text-gray-600 rounded-lg text-sm hover:bg-gray-200">Cancel</button>
                <button onclick="sendTestMessage()" class="btn-connect">Send Test</button>
            </div>
        </div>
    </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
<script>
const API_BASE = '/api/zoho/whatsapp-sessions';
let sessionsData = [];

// ========================================
// LOAD SESSIONS
// ========================================

async function loadSessions() {
    try {
        const resp = await apiRequest(`${API_BASE}/`);
        if (!resp) return;
        const data = await resp.json();
        if (!data.success) throw new Error(data.message);

        sessionsData = data.data;
        renderCards();
    } catch (err) {
        console.error('Load sessions error:', err);
        showToast('Failed to load sessions', 'error');
    }
}

function renderCards() {
    const grid = document.getElementById('sessionsGrid');
    if (sessionsData.length === 0) {
        grid.innerHTML = '<div class="text-center py-12 text-gray-400 col-span-full">No branches found.</div>';
        return;
    }

    grid.innerHTML = sessionsData.map(s => {
        const status = s.status || 'disconnected';
        const statusLabel = {
            connected: 'Connected',
            qr_pending: 'Scan QR Code',
            connecting: 'Connecting...',
            disconnected: 'Disconnected',
            failed: 'Failed'
        }[status] || 'Unknown';

        const connectedInfo = status === 'connected' && s.phone_number
            ? `<div class="text-sm text-green-700 font-medium mt-1">+${s.phone_number}</div>
               ${s.connected_at ? `<div class="text-xs text-gray-400 mt-0.5">Connected since ${formatDate(s.connected_at)}</div>` : ''}`
            : '';

        const errorInfo = status === 'failed' && s.last_error
            ? `<div class="text-xs text-red-500 mt-1 truncate" title="${escHtml(s.last_error)}">${escHtml(s.last_error.substring(0, 80))}</div>`
            : '';

        const buttons = status === 'connected'
            ? `<div class="flex gap-2 mt-3">
                   <button onclick="openTestModal(${s.branch_id})" class="btn-test flex-1">Test Message</button>
                   <button onclick="disconnectBranch(${s.branch_id})" class="btn-disconnect flex-1">Disconnect</button>
               </div>`
            : status === 'connecting' || status === 'qr_pending'
            ? `<button onclick="disconnectBranch(${s.branch_id})" class="btn-disconnect w-full mt-3">Cancel</button>`
            : `<button onclick="connectBranch(${s.branch_id})" class="btn-connect w-full mt-3">Connect WhatsApp</button>`;

        return `
            <div class="branch-card" id="card-${s.branch_id}">
                <div class="status-bar ${status}"></div>
                <div class="flex items-center gap-3 mb-2">
                    <span class="status-dot ${status}"></span>
                    <div class="flex-1">
                        <div class="font-semibold text-gray-800">${escHtml(s.branch_name)}</div>
                        <div class="text-xs text-gray-400">${statusLabel}</div>
                    </div>
                </div>
                ${connectedInfo}
                ${errorInfo}
                <div class="qr-container" id="qr-${s.branch_id}" style="display:${status === 'qr_pending' || s.has_qr ? 'flex' : 'none'}">
                    <div class="text-center text-gray-400 text-xs">
                        ${status === 'qr_pending' ? '<div class="spinner w-6 h-6 border-2 border-indigo-300 border-t-indigo-600 rounded-full mx-auto mb-2"></div>Loading QR...' : ''}
                    </div>
                </div>
                ${buttons}
            </div>
        `;
    }).join('');

    // Load QR codes for pending sessions
    sessionsData.filter(s => s.has_qr || s.status === 'qr_pending').forEach(s => {
        fetchQR(s.branch_id);
    });
}

// ========================================
// CONNECT / DISCONNECT
// ========================================

async function connectBranch(branchId) {
    try {
        const resp = await apiRequest(`${API_BASE}/${branchId}/connect`, { method: 'POST' });
        if (!resp) return;
        const data = await resp.json();
        showToast(data.message || 'Connecting...', data.success ? 'success' : 'error');
        if (data.success) {
            // Update local state
            const s = sessionsData.find(x => x.branch_id === branchId);
            if (s) { s.status = 'connecting'; renderCards(); }
        }
    } catch (err) {
        showToast('Connection failed: ' + err.message, 'error');
    }
}

async function disconnectBranch(branchId) {
    if (!confirm('Disconnect this branch\'s WhatsApp session?')) return;
    try {
        const resp = await apiRequest(`${API_BASE}/${branchId}/disconnect`, { method: 'POST' });
        if (!resp) return;
        const data = await resp.json();
        showToast(data.message || 'Disconnected', data.success ? 'success' : 'error');
        loadSessions();
    } catch (err) {
        showToast('Disconnect failed: ' + err.message, 'error');
    }
}

// ========================================
// QR CODE
// ========================================

async function fetchQR(branchId) {
    try {
        const resp = await apiRequest(`${API_BASE}/${branchId}/qr`);
        if (!resp) return;
        const data = await resp.json();
        if (data.success && data.data.qr) {
            renderQR(branchId, data.data.qr);
        }
    } catch (err) {
        console.error('Fetch QR error:', err);
    }
}

function renderQR(branchId, qrData) {
    const container = document.getElementById(`qr-${branchId}`);
    if (!container) return;

    container.style.display = 'flex';
    container.innerHTML = '';

    try {
        // Use qrcode-generator library
        const qr = qrcode(0, 'M');
        qr.addData(qrData);
        qr.make();

        const canvas = document.createElement('canvas');
        const size = 220;
        const cellSize = size / qr.getModuleCount();
        canvas.width = size;
        canvas.height = size;
        const ctx = canvas.getContext('2d');

        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, size, size);

        ctx.fillStyle = '#000000';
        for (let row = 0; row < qr.getModuleCount(); row++) {
            for (let col = 0; col < qr.getModuleCount(); col++) {
                if (qr.isDark(row, col)) {
                    ctx.fillRect(col * cellSize, row * cellSize, cellSize + 0.5, cellSize + 0.5);
                }
            }
        }

        container.appendChild(canvas);
    } catch (err) {
        container.innerHTML = `<div class="text-xs text-red-500">Failed to render QR: ${err.message}</div>`;
    }
}

// ========================================
// SOCKET.IO REAL-TIME
// ========================================

function setupSocketListeners() {
    const socket = getSocket();
    if (!socket) {
        setTimeout(setupSocketListeners, 2000);
        return;
    }

    // Join admin room
    socket.emit('join_whatsapp_admin');

    socket.on('whatsapp_qr', (data) => {
        console.log('QR received for branch', data.branch_id);
        const s = sessionsData.find(x => x.branch_id === data.branch_id);
        if (s) {
            s.status = 'qr_pending';
            s.has_qr = true;
            renderCards();
        }
        renderQR(data.branch_id, data.qr);
    });

    socket.on('whatsapp_status', (data) => {
        console.log('Status update for branch', data.branch_id, ':', data.status);
        const s = sessionsData.find(x => x.branch_id === data.branch_id);
        if (s) {
            s.status = data.status;
            if (data.phone_number) s.phone_number = data.phone_number;
            if (data.status === 'connected') s.has_qr = false;
            renderCards();
        } else {
            // Reload all
            loadSessions();
        }
    });
}

// ========================================
// TEST MESSAGE MODAL
// ========================================

function openTestModal(branchId) {
    document.getElementById('testBranchId').value = branchId;
    document.getElementById('testPhone').value = '';
    document.getElementById('testMessage').value = '';
    document.getElementById('testModal').classList.add('show');
}

function closeTestModal() {
    document.getElementById('testModal').classList.remove('show');
}

async function sendTestMessage() {
    const branchId = document.getElementById('testBranchId').value;
    const phone = document.getElementById('testPhone').value.trim();
    const message = document.getElementById('testMessage').value.trim();

    if (!phone) {
        showToast('Please enter a phone number', 'error');
        return;
    }

    try {
        const resp = await apiRequest(`${API_BASE}/${branchId}/test`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ phone, message: message || undefined })
        });
        if (!resp) return;
        const data = await resp.json();
        showToast(data.message, data.success ? 'success' : 'error');
        if (data.success) closeTestModal();
    } catch (err) {
        showToast('Test failed: ' + err.message, 'error');
    }
}

// ========================================
// HELPERS
// ========================================

function formatDate(d) {
    if (!d) return '';
    const dt = new Date(d);
    return dt.toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
}

function escHtml(s) {
    if (!s) return '';
    return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

function showToast(msg, type = 'info') {
    const t = document.getElementById('toast');
    if (!t) return;
    t.textContent = msg;
    t.className = 'toast show ' + (type === 'error' ? 'toast-error' : type === 'success' ? 'toast-success' : '');
    setTimeout(() => { t.className = 'toast'; }, 3500);
}

// ========================================
// INIT
// ========================================

document.addEventListener('DOMContentLoaded', () => {
    loadSessions();
    setupSocketListeners();
});
</script>
</body>
</html>
