<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192x192.png">
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
    <title>Credit Limits - Quality Colours Business Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/css/design-system.css">
    <script src="/universal-nav-loader.js"></script>
    <script src="/js/auth-helper.js"></script>
    <script src="/js/permissions.js"></script>
    <script>checkAuthOrRedirect();</script>
    <style>
        body { background: #f9fafb; }
        .util-bar { height: 6px; border-radius: 999px; background: #e5e7eb; overflow: hidden; }
        .util-fill { height: 100%; border-radius: 999px; transition: width 0.3s; }
        .util-green { background: #22c55e; }
        .util-yellow { background: #f59e0b; }
        .util-red { background: #ef4444; }

        .ov-card { background: white; border-radius: 12px; padding: 1.25rem; box-shadow: 0 1px 4px rgba(0,0,0,0.06); text-align: center; }
        .ov-value { font-size: 1.5rem; font-weight: 700; margin-bottom: 0.25rem; }
        .ov-label { font-size: 0.75rem; color: #6b7280; }

        .cust-table { width: 100%; border-collapse: collapse; font-size: 0.8125rem; }
        .cust-table thead { background: white; }
        .cust-table th { text-align: left; padding: 0.625rem 0.75rem; font-size: 0.6875rem; color: #6b7280; text-transform: uppercase; font-weight: 600; border-bottom: 2px solid #e5e7eb; white-space: nowrap; user-select: none; background: white; }
        .cust-table th.sortable { cursor: pointer; }
        .cust-table th.sortable:hover { color: #667eea; }
        .cust-table th.sortable .sort-arrow { display: inline-block; margin-left: 3px; font-size: 0.625rem; opacity: 0.3; }
        .cust-table th.sortable.sort-active .sort-arrow { opacity: 1; color: #667eea; }
        .cust-table td { padding: 0.625rem 0.75rem; border-bottom: 1px solid #f3f4f6; }
        .cust-table tbody tr:hover { background: #f9fafb; }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal-overlay.open { display: flex; }
        .modal-box { background: white; border-radius: 16px; padding: 1.5rem; width: 100%; max-width: 520px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.2); }
        .modal-box-lg { max-width: 800px; }

        .btn-primary { padding: 0.5rem 1.25rem; border-radius: 8px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; font-weight: 600; font-size: 0.8125rem; cursor: pointer; }
        .btn-primary:hover { opacity: 0.9; }
        .btn-outline { padding: 0.5rem 1rem; border-radius: 8px; border: 1px solid #d1d5db; background: white; color: #374151; font-weight: 600; font-size: 0.8125rem; cursor: pointer; }
        .btn-outline:hover { border-color: #667eea; color: #667eea; }
        .btn-sm { padding: 0.25rem 0.625rem; font-size: 0.6875rem; border-radius: 6px; }

        .filter-input { padding: 0.5rem 0.75rem; border-radius: 8px; border: 1px solid #d1d5db; font-size: 0.8125rem; outline: none; }
        .filter-input:focus { border-color: #667eea; box-shadow: 0 0 0 3px rgba(102,126,234,0.1); }

        .sync-indicator { font-size: 0.6875rem; color: #9ca3af; display: inline-flex; align-items: center; gap: 0.25rem; }
        .sync-indicator .dot { width: 6px; height: 6px; border-radius: 50%; background: #22c55e; }

        @media (max-width: 768px) {
            .overview-grid { grid-template-columns: repeat(2, 1fr) !important; }
            .filter-bar { flex-direction: column; }
            .cust-table { font-size: 0.75rem; }
            .cust-table th, .cust-table td { padding: 0.5rem; }
            .hide-mobile { display: none; }
        }
    </style>
</head>
<body data-page="credit-limits">

<div id="nav-placeholder"></div>
<div id="subnav-placeholder"></div>

<main style="max-width: 1400px; margin: 0 auto; padding: 1rem;">
    <!-- Header -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 0.75rem;">
        <div>
            <h1 style="font-size: 1.375rem; font-weight: 700; color: #1f2937; display: flex; align-items: center; gap: 0.5rem;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#667eea" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1v22M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg>
                Customer Credit Limits
            </h1>
            <p style="font-size: 0.8125rem; color: #6b7280;">Manage credit limits for Zoho customers <span class="sync-indicator" id="lastSyncedIndicator"></span></p>
        </div>
        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;" id="headerButtons">
            <button class="btn-primary request-only" onclick="openCreateCustomerModal()">+ Create Customer</button>
            <button class="btn-outline request-only" onclick="openRequestsPanel()" id="requestsBtn" style="position:relative;">
                Requests <span id="requestsBadge" style="display:none;position:absolute;top:-6px;right:-6px;background:#ef4444;color:white;font-size:0.625rem;font-weight:700;min-width:18px;height:18px;border-radius:50%;display:none;align-items:center;justify-content:center;">0</span>
            </button>
            <button class="btn-outline admin-only" onclick="syncFromZoho()" id="syncBtn">Sync from Zoho</button>
            <button class="btn-outline admin-only" onclick="showBulkModal()">Bulk Update</button>
            <button class="btn-outline" onclick="exportCSV()">Export CSV</button>
        </div>
    </div>

    <!-- Overview Cards -->
    <div class="overview-grid" style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
        <div class="ov-card">
            <div class="ov-value" style="color: #3b82f6;" id="ovTotalCust">--</div>
            <div class="ov-label">Total Customers</div>
        </div>
        <div class="ov-card">
            <div class="ov-value" style="color: #667eea;" id="ovTotalLimit">--</div>
            <div class="ov-label">Total Credit Limit</div>
        </div>
        <div class="ov-card">
            <div class="ov-value" style="color: #ef4444;" id="ovTotalUsed">--</div>
            <div class="ov-label">Total Outstanding</div>
        </div>
        <div class="ov-card">
            <div class="ov-value" style="color: #22c55e;" id="ovTotalAvail">--</div>
            <div class="ov-label">Total Available</div>
        </div>
        <div class="ov-card">
            <div class="ov-value" style="color: #8b5cf6;" id="ovWithLimit">--</div>
            <div class="ov-label">With Limit Set</div>
        </div>
        <div class="ov-card">
            <div class="ov-value" style="color: #ef4444;" id="ovOverLimit">--</div>
            <div class="ov-label">Over Limit</div>
        </div>
    </div>

    <!-- Filters -->
    <div class="filter-bar" style="display: flex; gap: 0.75rem; margin-bottom: 1rem; flex-wrap: wrap; align-items: center;">
        <input type="text" class="filter-input" id="searchInput" placeholder="Search name, phone, email..." style="flex: 1; min-width: 200px;" oninput="debounceLoad()">
        <select class="filter-input" id="branchFilter" onchange="loadCustomers()">
            <option value="">All Branches</option>
        </select>
        <select class="filter-input" id="statusFilter" onchange="loadCustomers()">
            <option value="all">All Customers</option>
            <option value="no_limit">No Limit Set</option>
            <option value="under_50">Under 50% Used</option>
            <option value="50_to_80">50-80% Used</option>
            <option value="over_80">Over 80% Used</option>
            <option value="exceeded">Limit Exceeded</option>
        </select>
    </div>

    <!-- Customers Table -->
    <div style="background: white; border-radius: 12px; box-shadow: 0 1px 4px rgba(0,0,0,0.06); overflow-x: auto;">
        <table class="cust-table">
            <thead>
                <tr>
                    <th class="sortable sort-active" data-sort="name" onclick="sortBy('name')">Customer <span class="sort-arrow">&#9650;</span></th>
                    <th class="hide-mobile sortable" data-sort="gst_no" onclick="sortBy('gst_no')">GST <span class="sort-arrow">&#9650;</span></th>
                    <th class="sortable" data-sort="credit_limit" style="text-align:right" onclick="sortBy('credit_limit')">Credit Limit <span class="sort-arrow">&#9650;</span></th>
                    <th class="sortable" data-sort="credit_used" style="text-align:right" onclick="sortBy('credit_used')">Outstanding <span class="sort-arrow">&#9650;</span></th>
                    <th class="sortable" data-sort="available" style="text-align:right" onclick="sortBy('available')">Available <span class="sort-arrow">&#9650;</span></th>
                    <th class="sortable" data-sort="utilization" style="width:140px" onclick="sortBy('utilization')">Utilization <span class="sort-arrow">&#9650;</span></th>
                    <th class="hide-mobile sortable" data-sort="branch_name" onclick="sortBy('branch_name')">Branch <span class="sort-arrow">&#9650;</span></th>
                    <th style="text-align:center">Actions</th>
                </tr>
            </thead>
            <tbody id="custTableBody">
                <tr><td colspan="8" style="text-align:center; padding:3rem; color:#9ca3af;">Loading...</td></tr>
            </tbody>
        </table>
    </div>
</main>

<!-- Edit Credit Limit Modal -->
<div class="modal-overlay" id="editModal">
    <div class="modal-box">
        <h3 style="font-size: 1.125rem; font-weight: 700; color: #1f2937; margin-bottom: 1.25rem;">Update Credit Limit</h3>
        <input type="hidden" id="editCustomerId">
        <div style="margin-bottom: 1rem;">
            <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.25rem;">Customer</div>
            <div style="font-weight: 600; font-size: 1rem;" id="editCustName"></div>
            <div style="font-size: 0.6875rem; color: #9ca3af;" id="editCustInfo"></div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
            <div>
                <div style="font-size: 0.75rem; color: #6b7280;">Current Limit</div>
                <div style="font-weight: 600;" id="editCurrentLimit"></div>
            </div>
            <div>
                <div style="font-size: 0.75rem; color: #6b7280;">Zoho Outstanding</div>
                <div style="font-weight: 600;" id="editCurrentUsed"></div>
            </div>
        </div>
        <div style="margin-bottom: 1rem;">
            <label style="font-size: 0.8125rem; font-weight: 600; display: block; margin-bottom: 0.375rem;">New Credit Limit</label>
            <input type="number" id="editNewLimit" class="filter-input" style="width: 100%;" min="0" step="1000" placeholder="Enter amount...">
        </div>
        <div style="margin-bottom: 1.25rem;">
            <label style="font-size: 0.8125rem; font-weight: 600; display: block; margin-bottom: 0.375rem;">Reason (optional)</label>
            <textarea id="editReason" class="filter-input" style="width: 100%; resize: vertical; min-height: 60px;" placeholder="Why is this limit being changed?"></textarea>
        </div>
        <div style="display: flex; justify-content: flex-end; gap: 0.5rem;">
            <button class="btn-outline" onclick="closeEditModal()">Cancel</button>
            <button class="btn-primary" onclick="saveCreditLimit()">Save</button>
        </div>
    </div>
</div>

<!-- Details Modal -->
<div class="modal-overlay" id="detailsModal">
    <div class="modal-box modal-box-lg">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.25rem;">
            <h3 style="font-size: 1.125rem; font-weight: 700; color: #1f2937;">Credit Details</h3>
            <button onclick="closeDetailsModal()" style="border:none;background:none;font-size:1.25rem;cursor:pointer;color:#9ca3af;">&times;</button>
        </div>
        <div id="detailsContent">Loading...</div>
    </div>
</div>

<!-- Bulk Update Modal -->
<div class="modal-overlay" id="bulkModal">
    <div class="modal-box">
        <h3 style="font-size: 1.125rem; font-weight: 700; color: #1f2937; margin-bottom: 1.25rem;">Bulk Update Credit Limits</h3>
        <div style="margin-bottom: 1rem;">
            <label style="font-size: 0.8125rem; font-weight: 600; display: block; margin-bottom: 0.375rem;">Apply to</label>
            <select class="filter-input" id="bulkTarget" style="width: 100%;">
                <option value="no_limit">All customers without a limit</option>
                <option value="all">All customers</option>
            </select>
        </div>
        <div style="margin-bottom: 1rem;">
            <label style="font-size: 0.8125rem; font-weight: 600; display: block; margin-bottom: 0.375rem;">Credit Limit Amount</label>
            <input type="number" id="bulkAmount" class="filter-input" style="width: 100%;" min="0" step="10000" placeholder="e.g. 100000">
        </div>
        <div style="margin-bottom: 1.25rem;">
            <label style="font-size: 0.8125rem; font-weight: 600; display: block; margin-bottom: 0.375rem;">Reason</label>
            <input type="text" id="bulkReason" class="filter-input" style="width: 100%;" placeholder="e.g. Initial credit limit setup">
        </div>
        <div id="bulkPreview" style="font-size: 0.8125rem; color: #6b7280; margin-bottom: 1rem;"></div>
        <div style="display: flex; justify-content: flex-end; gap: 0.5rem;">
            <button class="btn-outline" onclick="closeBulkModal()">Cancel</button>
            <button class="btn-primary" onclick="executeBulk()">Apply</button>
        </div>
    </div>
</div>

<!-- Create Customer Modal -->
<div class="modal-overlay" id="createCustModal">
    <div class="modal-box">
        <h3 style="font-size: 1.125rem; font-weight: 700; color: #1f2937; margin-bottom: 1.25rem;">Create New Customer</h3>
        <div style="background:#eef2ff;border-radius:8px;padding:0.625rem 0.75rem;margin-bottom:1rem;font-size:0.8125rem;color:#4338ca;">
            Default credit limit of <b>&#8377;100</b> will be set and synced to Zoho immediately.
        </div>
        <div style="margin-bottom: 0.875rem;">
            <label style="font-size: 0.8125rem; font-weight: 600; display: block; margin-bottom: 0.375rem;">Customer Name <span style="color:#ef4444">*</span></label>
            <input type="text" id="newCustName" class="filter-input" style="width: 100%;" placeholder="Full name">
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 0.875rem;">
            <div>
                <label style="font-size: 0.8125rem; font-weight: 600; display: block; margin-bottom: 0.375rem;">Phone</label>
                <input type="tel" id="newCustPhone" class="filter-input" style="width: 100%;" placeholder="e.g. 9876543210">
            </div>
            <div>
                <label style="font-size: 0.8125rem; font-weight: 600; display: block; margin-bottom: 0.375rem;">Email</label>
                <input type="email" id="newCustEmail" class="filter-input" style="width: 100%;" placeholder="email@example.com">
            </div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 1.25rem;">
            <div>
                <label style="font-size: 0.8125rem; font-weight: 600; display: block; margin-bottom: 0.375rem;">GST No.</label>
                <input type="text" id="newCustGST" class="filter-input" style="width: 100%;" placeholder="Optional">
            </div>
            <div>
                <label style="font-size: 0.8125rem; font-weight: 600; display: block; margin-bottom: 0.375rem;">Branch</label>
                <select class="filter-input" id="newCustBranch" style="width: 100%;">
                    <option value="">Select branch...</option>
                </select>
            </div>
        </div>
        <div style="display: flex; justify-content: flex-end; gap: 0.5rem;">
            <button class="btn-outline" onclick="closeCreateCustomerModal()">Cancel</button>
            <button class="btn-primary" onclick="createCustomer()" id="createCustBtn">Create & Sync to Zoho</button>
        </div>
    </div>
</div>

<!-- Credit Limit Request Modal (staff submits) -->
<div class="modal-overlay" id="requestModal">
    <div class="modal-box">
        <h3 style="font-size: 1.125rem; font-weight: 700; color: #1f2937; margin-bottom: 1.25rem;">Request Credit Limit</h3>
        <div style="margin-bottom: 1rem;">
            <label style="font-size: 0.8125rem; font-weight: 600; display: block; margin-bottom: 0.375rem;">Customer</label>
            <select class="filter-input" id="reqCustomerSelect" style="width: 100%;" onchange="onReqCustomerChange()">
                <option value="">Select a customer without limit...</option>
            </select>
        </div>
        <div id="reqCustomerInfo" style="display:none; background:#f9fafb; border-radius:8px; padding:0.75rem; margin-bottom:1rem; font-size:0.8125rem;">
            <div id="reqCustDetails"></div>
        </div>
        <div style="margin-bottom: 1rem;">
            <label style="font-size: 0.8125rem; font-weight: 600; display: block; margin-bottom: 0.375rem;">Requested Amount</label>
            <input type="number" id="reqAmount" class="filter-input" style="width: 100%;" min="1000" step="1000" placeholder="e.g. 50000">
        </div>
        <div style="margin-bottom: 1.25rem;">
            <label style="font-size: 0.8125rem; font-weight: 600; display: block; margin-bottom: 0.375rem;">Reason</label>
            <textarea id="reqReason" class="filter-input" style="width: 100%; resize: vertical; min-height: 60px;" placeholder="Why does this customer need a credit limit?"></textarea>
        </div>
        <div style="display: flex; justify-content: flex-end; gap: 0.5rem;">
            <button class="btn-outline" onclick="closeRequestModal()">Cancel</button>
            <button class="btn-primary" onclick="submitRequest()">Submit Request</button>
        </div>
    </div>
</div>

<!-- Requests Panel (admin reviews) -->
<div class="modal-overlay" id="requestsPanel">
    <div class="modal-box modal-box-lg">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.25rem;">
            <h3 style="font-size: 1.125rem; font-weight: 700; color: #1f2937;">Credit Limit Requests</h3>
            <div style="display:flex; gap:0.5rem; align-items:center;">
                <select class="filter-input btn-sm" id="reqStatusFilter" onchange="loadRequests()" style="padding:0.25rem 0.5rem;">
                    <option value="all">All</option>
                    <option value="pending" selected>Pending</option>
                    <option value="approved">Approved</option>
                    <option value="rejected">Rejected</option>
                </select>
                <button class="btn-outline btn-sm" onclick="openNewRequestModal()">+ New Request</button>
                <button onclick="closeRequestsPanel()" style="border:none;background:none;font-size:1.25rem;cursor:pointer;color:#9ca3af;">&times;</button>
            </div>
        </div>
        <div id="requestsList" style="max-height: 65vh; overflow-y: auto;">
            <div style="text-align:center;padding:2rem;color:#9ca3af;">Loading...</div>
        </div>
    </div>
</div>

<!-- Approve Modal -->
<div class="modal-overlay" id="approveModal">
    <div class="modal-box">
        <h3 style="font-size: 1.125rem; font-weight: 700; color: #1f2937; margin-bottom: 1.25rem;">Approve Credit Limit Request</h3>
        <input type="hidden" id="approveReqId">
        <div style="background:#f9fafb; border-radius:8px; padding:0.75rem; margin-bottom:1rem; font-size:0.8125rem;" id="approveInfo"></div>
        <div style="margin-bottom: 1rem;">
            <label style="font-size: 0.8125rem; font-weight: 600; display: block; margin-bottom: 0.375rem;">Approved Amount</label>
            <input type="number" id="approveAmount" class="filter-input" style="width: 100%;" min="0" step="1000">
            <div style="font-size:0.6875rem;color:#6b7280;margin-top:0.25rem;">You can adjust the amount. Leave as-is to approve the requested amount.</div>
        </div>
        <div style="margin-bottom: 1.25rem;">
            <label style="font-size: 0.8125rem; font-weight: 600; display: block; margin-bottom: 0.375rem;">Notes (optional)</label>
            <textarea id="approveNotes" class="filter-input" style="width: 100%; resize: vertical; min-height: 50px;" placeholder="Optional notes..."></textarea>
        </div>
        <div style="display: flex; justify-content: flex-end; gap: 0.5rem;">
            <button class="btn-outline" onclick="closeApproveModal()">Cancel</button>
            <button class="btn-primary" onclick="confirmApprove()">Approve</button>
        </div>
    </div>
</div>

<!-- Reject Modal -->
<div class="modal-overlay" id="rejectModal">
    <div class="modal-box">
        <h3 style="font-size: 1.125rem; font-weight: 700; color: #ef4444; margin-bottom: 1.25rem;">Reject Credit Limit Request</h3>
        <input type="hidden" id="rejectReqId">
        <div style="background:#fef2f2; border-radius:8px; padding:0.75rem; margin-bottom:1rem; font-size:0.8125rem;" id="rejectInfo"></div>
        <div style="margin-bottom: 1.25rem;">
            <label style="font-size: 0.8125rem; font-weight: 600; display: block; margin-bottom: 0.375rem;">Reason for Rejection (required)</label>
            <textarea id="rejectNotes" class="filter-input" style="width: 100%; resize: vertical; min-height: 60px;" placeholder="Explain why this request is being rejected..."></textarea>
        </div>
        <div style="display: flex; justify-content: flex-end; gap: 0.5rem;">
            <button class="btn-outline" onclick="closeRejectModal()">Cancel</button>
            <button style="padding:0.5rem 1.25rem;border-radius:8px;background:#ef4444;color:white;border:none;font-weight:600;font-size:0.8125rem;cursor:pointer;" onclick="confirmReject()">Reject</button>
        </div>
    </div>
</div>

<script>
const token = localStorage.getItem('auth_token');
const user = JSON.parse(localStorage.getItem('user') || '{}');
const isAdmin = ['admin', 'super_admin', 'manager'].includes(user.role);
const headers = { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token };
let allCustomers = [];
let debounceTimer = null;
let currentSort = 'name';
let sortAsc = true;
let permManager = null;
let canManage = false;
let canRequest = false;

// Permission-based UI control (replaces simple role check)
async function checkPagePermissions() {
    permManager = new PermissionManager();
    await permManager.loadPermissions();

    // If user doesn't have credit_limits.view, redirect away
    if (!permManager.can('credit_limits', 'view')) {
        alert('You do not have permission to access Credit Limits. Contact your admin.');
        window.location.href = user.role === 'admin' ? '/dashboard.html' : '/staff/dashboard.html';
        return false;
    }

    // Determine permission tiers
    canManage = permManager.can('credit_limits', 'manage');
    canRequest = permManager.can('credit_limits', 'request');

    // Hide manage-only elements (edit limits, bulk-set, sync, approve/reject)
    if (!canManage) {
        document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
    }

    // Hide request-only elements (create customer, request buttons)
    if (!canRequest && !canManage) {
        document.querySelectorAll('.request-only').forEach(el => el.style.display = 'none');
    }

    return true;
}

function formatINR(n) {
    n = Number(n) || 0;
    if (n >= 10000000) return '\u20B9' + (n/10000000).toFixed(1) + 'Cr';
    if (n >= 100000) return '\u20B9' + (n/100000).toFixed(1) + 'L';
    if (n >= 1000) return '\u20B9' + (n/1000).toFixed(1) + 'K';
    return '\u20B9' + n.toLocaleString('en-IN');
}

function escHtml(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

function debounceLoad() {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(loadCustomers, 300);
}

function timeAgo(dateStr) {
    if (!dateStr) return 'Never';
    const diff = Date.now() - new Date(dateStr).getTime();
    const mins = Math.floor(diff / 60000);
    if (mins < 1) return 'Just now';
    if (mins < 60) return mins + 'm ago';
    const hrs = Math.floor(mins / 60);
    if (hrs < 24) return hrs + 'h ago';
    return Math.floor(hrs / 24) + 'd ago';
}

// ═══════════════════════════════════════════════════════════════
// LOAD DATA
// ═══════════════════════════════════════════════════════════════
async function loadCustomers() {
    try {
        const search = document.getElementById('searchInput').value.trim();
        const status = document.getElementById('statusFilter').value;
        const branch = document.getElementById('branchFilter').value;

        const params = new URLSearchParams();
        if (search) params.set('search', search);
        if (status !== 'all') params.set('status', status);
        if (branch) params.set('branch', branch);

        const resp = await fetch('/api/credit-limits/customers?' + params, { headers });
        const json = await resp.json();
        allCustomers = json.data || [];
        applySortAndRender();
        populateBranchFilter();
    } catch (e) {
        console.error('Load error:', e);
    }
}

function sortBy(col) {
    if (currentSort === col) {
        sortAsc = !sortAsc;
    } else {
        currentSort = col;
        // Default descending for numeric columns, ascending for text
        sortAsc = ['name', 'gst_no', 'branch_name'].includes(col);
    }
    applySortAndRender();
}

function applySortAndRender() {
    // Update header arrows
    document.querySelectorAll('.cust-table th.sortable').forEach(th => {
        const isActive = th.dataset.sort === currentSort;
        th.classList.toggle('sort-active', isActive);
        const arrow = th.querySelector('.sort-arrow');
        if (arrow) arrow.innerHTML = isActive ? (sortAsc ? '&#9650;' : '&#9660;') : '&#9650;';
    });

    // Sort allCustomers in-place
    allCustomers.sort((a, b) => {
        let va, vb;
        switch (currentSort) {
            case 'name':
                va = (a.name || '').toLowerCase();
                vb = (b.name || '').toLowerCase();
                return sortAsc ? va.localeCompare(vb) : vb.localeCompare(va);
            case 'gst_no':
                va = (a.gst_no || '').toLowerCase();
                vb = (b.gst_no || '').toLowerCase();
                return sortAsc ? va.localeCompare(vb) : vb.localeCompare(va);
            case 'branch_name':
                va = (a.branch_name || '').toLowerCase();
                vb = (b.branch_name || '').toLowerCase();
                return sortAsc ? va.localeCompare(vb) : vb.localeCompare(va);
            case 'credit_limit':
                va = Number(a.credit_limit) || 0;
                vb = Number(b.credit_limit) || 0;
                return sortAsc ? va - vb : vb - va;
            case 'credit_used':
                va = Number(a.credit_used) || 0;
                vb = Number(b.credit_used) || 0;
                return sortAsc ? va - vb : vb - va;
            case 'available':
                va = (Number(a.credit_limit) || 0) - (Number(a.credit_used) || 0);
                vb = (Number(b.credit_limit) || 0) - (Number(b.credit_used) || 0);
                return sortAsc ? va - vb : vb - va;
            case 'utilization':
                va = Number(a.utilization) || 0;
                vb = Number(b.utilization) || 0;
                return sortAsc ? va - vb : vb - va;
            default:
                return 0;
        }
    });

    renderTable();
}

function populateBranchFilter() {
    const select = document.getElementById('branchFilter');
    const current = select.value;
    // Only populate once (check option count)
    if (select.options.length > 1) return;

    const branches = new Map();
    allCustomers.forEach(c => {
        if (c.branch_id && c.branch_name) branches.set(c.branch_id, c.branch_name);
    });

    branches.forEach((name, id) => {
        const opt = document.createElement('option');
        opt.value = id;
        opt.textContent = name;
        select.appendChild(opt);
    });
    if (current) select.value = current;
}

async function loadOverview() {
    try {
        const resp = await fetch('/api/credit-limits/overview/summary', { headers });
        const json = await resp.json();
        if (!json.success) return;
        const s = json.summary;
        document.getElementById('ovTotalCust').textContent = Number(s.total_customers).toLocaleString();
        document.getElementById('ovTotalLimit').textContent = formatINR(s.total_limit);
        document.getElementById('ovTotalUsed').textContent = formatINR(s.total_used);
        document.getElementById('ovTotalAvail').textContent = formatINR(s.total_available);
        document.getElementById('ovWithLimit').textContent = s.customers_with_limit;
        document.getElementById('ovOverLimit').textContent = s.over_limit_count;

        // Last synced indicator
        const indicator = document.getElementById('lastSyncedIndicator');
        if (s.last_synced) {
            indicator.innerHTML = '<span class="dot"></span> Synced ' + timeAgo(s.last_synced);
        }
    } catch (e) { /* ignore */ }
}

// ═══════════════════════════════════════════════════════════════
// RENDER TABLE
// ═══════════════════════════════════════════════════════════════
function renderTable() {
    const tbody = document.getElementById('custTableBody');
    if (!allCustomers.length) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:2rem; color:#9ca3af;">No customers found</td></tr>';
        return;
    }

    tbody.innerHTML = allCustomers.map(c => {
        const limit = Number(c.credit_limit) || 0;
        const used = Number(c.credit_used) || 0;
        const available = limit - used;
        const util = limit > 0 ? Math.min((used / limit) * 100, 150) : 0;
        const utilDisplay = limit > 0 ? util.toFixed(1) + '%' : '--';

        let utilColor = 'util-green';
        let utilTextColor = '#22c55e';
        if (util > 100) { utilColor = 'util-red'; utilTextColor = '#ef4444'; }
        else if (util > 80) { utilColor = 'util-red'; utilTextColor = '#ef4444'; }
        else if (util > 50) { utilColor = 'util-yellow'; utilTextColor = '#f59e0b'; }

        return `<tr>
            <td>
                <div style="font-weight:600;color:#1f2937">${escHtml(c.name || '')}</div>
                <div style="font-size:0.6875rem;color:#9ca3af">${escHtml(c.phone || '')}${c.email ? ' &middot; ' + escHtml(c.email) : ''}</div>
            </td>
            <td class="hide-mobile" style="font-size:0.6875rem;color:#6b7280">${escHtml(c.gst_no || '--')}</td>
            <td style="text-align:right;font-weight:600">${limit > 0 ? formatINR(limit) : '<span style="color:#9ca3af">Not set</span>'}</td>
            <td style="text-align:right;font-weight:600;color:${used > limit && limit > 0 ? '#ef4444' : '#1f2937'}">${formatINR(used)}</td>
            <td style="text-align:right;font-weight:600;color:${available < 0 ? '#ef4444' : '#22c55e'}">${limit > 0 ? formatINR(available) : '--'}</td>
            <td>
                ${limit > 0 ? `
                <div style="display:flex;align-items:center;gap:0.5rem;">
                    <div class="util-bar" style="flex:1"><div class="util-fill ${utilColor}" style="width:${Math.min(util, 100)}%"></div></div>
                    <span style="font-size:0.6875rem;font-weight:600;color:${utilTextColor};min-width:40px;text-align:right">${utilDisplay}</span>
                </div>` : '<span style="color:#9ca3af;font-size:0.6875rem">--</span>'}
            </td>
            <td class="hide-mobile" style="font-size:0.6875rem;color:#6b7280">${escHtml(c.branch_name || '')}</td>
            <td style="text-align:center;white-space:nowrap">
                ${canManage ? `<button class="btn-outline btn-sm" onclick="openEditModal(${c.id})">Edit</button>` : ''}
                <button class="btn-outline btn-sm" onclick="openDetailsModal(${c.id})" style="margin-left:2px">Details</button>
                ${!canManage && (canRequest) && limit === 0 ? `<button class="btn-outline btn-sm" onclick="quickRequest(${c.id})" style="margin-left:2px;color:#667eea;border-color:#667eea;">Request</button>` : ''}
            </td>
        </tr>`;
    }).join('');
}

// ═══════════════════════════════════════════════════════════════
// EDIT MODAL
// ═══════════════════════════════════════════════════════════════
function openEditModal(id) {
    const c = allCustomers.find(x => x.id === id);
    if (!c) return;
    document.getElementById('editCustomerId').value = id;
    document.getElementById('editCustName').textContent = c.name || '';
    document.getElementById('editCustInfo').textContent = [c.phone, c.email, c.gst_no].filter(Boolean).join(' | ');
    document.getElementById('editCurrentLimit').textContent = formatINR(c.credit_limit);
    document.getElementById('editCurrentUsed').textContent = formatINR(c.credit_used);
    document.getElementById('editNewLimit').value = Number(c.credit_limit) || '';
    document.getElementById('editReason').value = '';
    document.getElementById('editModal').classList.add('open');
}

function closeEditModal() {
    document.getElementById('editModal').classList.remove('open');
}

async function saveCreditLimit() {
    const id = document.getElementById('editCustomerId').value;
    const newLimit = parseFloat(document.getElementById('editNewLimit').value);
    const reason = document.getElementById('editReason').value.trim();

    if (isNaN(newLimit) || newLimit < 0) { showToast('Enter a valid credit limit', 'error'); return; }

    try {
        const resp = await fetch(`/api/credit-limits/${id}/set-limit`, {
            method: 'POST', headers,
            body: JSON.stringify({ credit_limit: newLimit, reason })
        });
        const json = await resp.json();
        if (!json.success) throw new Error(json.error);

        showToast('Credit limit updated' + (json.zoho_synced ? ' & synced to Zoho' : ' (Zoho sync pending)'));
        closeEditModal();
        loadCustomers();
        loadOverview();
    } catch (e) {
        showToast('Failed: ' + e.message, 'error');
    }
}

// ═══════════════════════════════════════════════════════════════
// DETAILS MODAL
// ═══════════════════════════════════════════════════════════════
async function openDetailsModal(id) {
    document.getElementById('detailsContent').innerHTML = '<div style="text-align:center;padding:2rem;color:#9ca3af">Loading...</div>';
    document.getElementById('detailsModal').classList.add('open');

    try {
        const [infoResp, histResp] = await Promise.all([
            fetch(`/api/credit-limits/${id}`, { headers }),
            fetch(`/api/credit-limits/${id}/history`, { headers })
        ]);
        const info = await infoResp.json();
        const hist = await histResp.json();

        if (!info.success) throw new Error(info.error);
        const c = info.customer;
        const invoices = info.outstanding_invoices || [];
        const history = (hist.data || []);

        let html = `
        <!-- Customer Info -->
        <div style="background:#f9fafb;border-radius:10px;padding:0.75rem 1rem;margin-bottom:1rem;display:flex;flex-wrap:wrap;gap:1.5rem;font-size:0.8125rem;">
            <div><span style="color:#6b7280">Phone:</span> <b>${escHtml(c.phone || '--')}</b></div>
            <div><span style="color:#6b7280">Email:</span> <b>${escHtml(c.email || '--')}</b></div>
            <div><span style="color:#6b7280">GST:</span> <b>${escHtml(c.gst_no || '--')}</b></div>
            <div><span style="color:#6b7280">Branch:</span> <b>${escHtml(c.branch_name || '--')}</b></div>
            <div><span style="color:#6b7280">Zoho ID:</span> <b style="font-size:0.6875rem">${escHtml(c.zoho_contact_id || '--')}</b></div>
            <div><span style="color:#6b7280">Last synced:</span> <b>${timeAgo(c.last_synced_at)}</b></div>
        </div>

        <!-- Summary Cards -->
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:0.75rem;margin-bottom:1.5rem;">
            <div style="background:#eef2ff;padding:0.75rem;border-radius:10px;text-align:center">
                <div style="font-size:1.25rem;font-weight:700;color:#667eea">${formatINR(c.credit_limit)}</div>
                <div style="font-size:0.6875rem;color:#6b7280">Credit Limit</div>
            </div>
            <div style="background:#fef2f2;padding:0.75rem;border-radius:10px;text-align:center">
                <div style="font-size:1.25rem;font-weight:700;color:#ef4444">${formatINR(c.credit_used)}</div>
                <div style="font-size:0.6875rem;color:#6b7280">Outstanding</div>
            </div>
            <div style="background:#f0fdf4;padding:0.75rem;border-radius:10px;text-align:center">
                <div style="font-size:1.25rem;font-weight:700;color:#22c55e">${formatINR(c.credit_available)}</div>
                <div style="font-size:0.6875rem;color:#6b7280">Available</div>
            </div>
            <div style="background:#fefce8;padding:0.75rem;border-radius:10px;text-align:center">
                <div style="font-size:1.25rem;font-weight:700;color:#f59e0b">${c.utilization}%</div>
                <div style="font-size:0.6875rem;color:#6b7280">Utilization</div>
            </div>
        </div>`;

        if (Number(c.unused_credits) > 0) {
            html += `<div style="background:#dbeafe;border-radius:8px;padding:0.5rem 0.75rem;margin-bottom:1rem;font-size:0.8125rem;color:#1e40af;">
                Unused credits: <b>${formatINR(c.unused_credits)}</b>
            </div>`;
        }

        // Outstanding Invoices
        html += '<h4 style="font-weight:700;font-size:0.9375rem;margin-bottom:0.5rem;">Outstanding Invoices (' + invoices.length + ')</h4>';
        if (invoices.length) {
            html += '<table style="width:100%;border-collapse:collapse;font-size:0.8125rem;margin-bottom:1.25rem;"><thead><tr>' +
                '<th style="text-align:left;padding:0.5rem;border-bottom:1px solid #e5e7eb;font-size:0.6875rem;color:#6b7280">Invoice</th>' +
                '<th style="text-align:left;padding:0.5rem;border-bottom:1px solid #e5e7eb;font-size:0.6875rem;color:#6b7280">Date</th>' +
                '<th style="text-align:left;padding:0.5rem;border-bottom:1px solid #e5e7eb;font-size:0.6875rem;color:#6b7280">Due</th>' +
                '<th style="text-align:right;padding:0.5rem;border-bottom:1px solid #e5e7eb;font-size:0.6875rem;color:#6b7280">Total</th>' +
                '<th style="text-align:right;padding:0.5rem;border-bottom:1px solid #e5e7eb;font-size:0.6875rem;color:#6b7280">Balance</th>' +
                '<th style="padding:0.5rem;border-bottom:1px solid #e5e7eb;font-size:0.6875rem;color:#6b7280">Status</th>' +
                '</tr></thead><tbody>';
            invoices.forEach(inv => {
                const statusColor = inv.status === 'overdue' ? '#ef4444' : inv.status === 'partially_paid' ? '#f59e0b' : '#3b82f6';
                html += '<tr>' +
                    '<td style="padding:0.375rem 0.5rem;border-bottom:1px solid #f3f4f6;font-weight:500">' + escHtml(inv.invoice_number || '') + '</td>' +
                    '<td style="padding:0.375rem 0.5rem;border-bottom:1px solid #f3f4f6">' + (inv.invoice_date ? new Date(inv.invoice_date).toLocaleDateString('en-IN') : '') + '</td>' +
                    '<td style="padding:0.375rem 0.5rem;border-bottom:1px solid #f3f4f6">' + (inv.due_date ? new Date(inv.due_date).toLocaleDateString('en-IN') : '') + '</td>' +
                    '<td style="padding:0.375rem 0.5rem;border-bottom:1px solid #f3f4f6;text-align:right">' + formatINR(inv.total) + '</td>' +
                    '<td style="padding:0.375rem 0.5rem;border-bottom:1px solid #f3f4f6;text-align:right;font-weight:600;color:#ef4444">' + formatINR(inv.balance) + '</td>' +
                    '<td style="padding:0.375rem 0.5rem;border-bottom:1px solid #f3f4f6"><span style="font-size:0.6875rem;font-weight:600;color:' + statusColor + '">' + escHtml(inv.status) + '</span></td>' +
                    '</tr>';
            });
            html += '</tbody></table>';
        } else {
            html += '<p style="color:#9ca3af;font-size:0.8125rem;margin-bottom:1.25rem;">No outstanding invoices</p>';
        }

        // Credit History
        html += '<h4 style="font-weight:700;font-size:0.9375rem;margin-bottom:0.5rem;">Credit Limit History</h4>';
        if (history.length) {
            html += '<div style="max-height:200px;overflow-y:auto;">';
            history.forEach(h => {
                const arrow = Number(h.new_limit) > Number(h.previous_limit) ? '<span style="color:#22c55e">&#x2191;</span>' : Number(h.new_limit) < Number(h.previous_limit) ? '<span style="color:#ef4444">&#x2193;</span>' : '';
                html += '<div style="display:flex;justify-content:space-between;align-items:center;padding:0.375rem 0;border-bottom:1px solid #f3f4f6;font-size:0.8125rem;">' +
                    '<div>' + arrow + ' ' + formatINR(h.previous_limit) + ' &rarr; ' + formatINR(h.new_limit) +
                    (h.reason ? '<span style="color:#6b7280;font-size:0.6875rem;margin-left:0.5rem">' + escHtml(h.reason) + '</span>' : '') + '</div>' +
                    '<div style="font-size:0.6875rem;color:#9ca3af">' + escHtml(h.changed_by_name || '') + ' &middot; ' + new Date(h.created_at).toLocaleDateString('en-IN') + '</div>' +
                    '</div>';
            });
            html += '</div>';
        } else {
            html += '<p style="color:#9ca3af;font-size:0.8125rem;">No history yet</p>';
        }

        document.getElementById('detailsContent').innerHTML = html;
    } catch (e) {
        document.getElementById('detailsContent').innerHTML = '<div style="color:#ef4444">Error: ' + escHtml(e.message) + '</div>';
    }
}

function closeDetailsModal() {
    document.getElementById('detailsModal').classList.remove('open');
}

// ═══════════════════════════════════════════════════════════════
// BULK UPDATE
// ═══════════════════════════════════════════════════════════════
function showBulkModal() {
    document.getElementById('bulkAmount').value = '';
    document.getElementById('bulkReason').value = '';
    updateBulkPreview();
    document.getElementById('bulkModal').classList.add('open');
}
function closeBulkModal() { document.getElementById('bulkModal').classList.remove('open'); }

function updateBulkPreview() {
    const target = document.getElementById('bulkTarget').value;
    const count = target === 'no_limit'
        ? allCustomers.filter(c => Number(c.credit_limit) === 0).length
        : allCustomers.length;
    document.getElementById('bulkPreview').textContent = 'This will update ' + count + ' customer(s)';
}

document.getElementById('bulkTarget').addEventListener('change', updateBulkPreview);

async function executeBulk() {
    const target = document.getElementById('bulkTarget').value;
    const amount = parseFloat(document.getElementById('bulkAmount').value);
    const reason = document.getElementById('bulkReason').value.trim();

    if (isNaN(amount) || amount < 0) { showToast('Enter a valid amount', 'error'); return; }

    const customers = (target === 'no_limit'
        ? allCustomers.filter(c => Number(c.credit_limit) === 0)
        : allCustomers
    ).map(c => ({ id: c.id, credit_limit: amount }));

    if (!customers.length) { showToast('No customers to update', 'error'); return; }
    if (!confirm('Update credit limit to ' + formatINR(amount) + ' for ' + customers.length + ' customers?')) return;

    try {
        const resp = await fetch('/api/credit-limits/bulk-set', {
            method: 'POST', headers,
            body: JSON.stringify({ customers, reason })
        });
        const json = await resp.json();
        if (!json.success) throw new Error(json.error);

        showToast('Updated ' + json.updated + ' customers');
        closeBulkModal();
        loadCustomers();
        loadOverview();
    } catch (e) {
        showToast('Failed: ' + e.message, 'error');
    }
}

// ═══════════════════════════════════════════════════════════════
// SYNC FROM ZOHO
// ═══════════════════════════════════════════════════════════════
async function syncFromZoho() {
    const btn = document.getElementById('syncBtn');
    if (!confirm('Sync customer data from Zoho? This will update outstanding amounts.')) return;

    btn.disabled = true;
    btn.textContent = 'Syncing...';
    try {
        const resp = await fetch('/api/credit-limits/sync', { method: 'POST', headers, body: '{}' });
        const json = await resp.json();
        if (!json.success) throw new Error(json.error);
        showToast('Synced ' + json.synced + ' customers from Zoho');
        loadCustomers();
        loadOverview();
    } catch (e) {
        showToast('Sync failed: ' + e.message, 'error');
    } finally {
        btn.disabled = false;
        btn.textContent = 'Sync from Zoho';
    }
}

// ═══════════════════════════════════════════════════════════════
// EXPORT CSV
// ═══════════════════════════════════════════════════════════════
function exportCSV() {
    if (!allCustomers.length) { showToast('No data to export', 'error'); return; }
    let csv = 'Customer,Phone,Email,GST,Branch,Credit Limit,Outstanding,Available,Utilization %\n';
    allCustomers.forEach(c => {
        const limit = Number(c.credit_limit) || 0;
        const used = Number(c.credit_used) || 0;
        csv += '"' + (c.name||'').replace(/"/g,'""') + '","' + (c.phone||'') + '","' + (c.email||'') + '","' + (c.gst_no||'') + '","' + (c.branch_name||'') + '",' +
               limit + ',' + used + ',' + (limit - used) + ',' + (limit > 0 ? ((used/limit)*100).toFixed(1) : 0) + '\n';
    });
    const blob = new Blob([csv], { type: 'text/csv' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'credit-limits-' + new Date().toISOString().split('T')[0] + '.csv';
    a.click();
    showToast('CSV exported');
}

// ═══════════════════════════════════════════════════════════════
// UTILITIES
// ═══════════════════════════════════════════════════════════════
function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.style.cssText = 'position:fixed;bottom:2rem;right:2rem;padding:0.75rem 1.25rem;border-radius:10px;font-size:0.8125rem;font-weight:600;z-index:10000;color:white;background:' + (type==='error'?'#ef4444':'#10b981') + ';box-shadow:0 4px 12px rgba(0,0,0,0.15);';
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => { toast.style.opacity='0'; toast.style.transition='opacity 0.3s'; setTimeout(() => toast.remove(), 300); }, 2500);
}

// ═══════════════════════════════════════════════════════════════
// CREATE CUSTOMER
// ═══════════════════════════════════════════════════════════════
function openCreateCustomerModal() {
    document.getElementById('newCustName').value = '';
    document.getElementById('newCustPhone').value = '';
    document.getElementById('newCustEmail').value = '';
    document.getElementById('newCustGST').value = '';
    // Populate branch dropdown
    const select = document.getElementById('newCustBranch');
    select.innerHTML = '<option value="">Select branch...</option>';
    const branches = new Map();
    allCustomers.forEach(c => { if (c.branch_id && c.branch_name) branches.set(c.branch_id, c.branch_name); });
    branches.forEach((name, id) => { select.innerHTML += `<option value="${id}">${escHtml(name)}</option>`; });
    // Pre-select staff's branch if available
    if (user.branch_id) select.value = user.branch_id;
    document.getElementById('createCustModal').classList.add('open');
}
function closeCreateCustomerModal() { document.getElementById('createCustModal').classList.remove('open'); }

async function createCustomer() {
    const name = document.getElementById('newCustName').value.trim();
    const phone = document.getElementById('newCustPhone').value.trim();
    const email = document.getElementById('newCustEmail').value.trim();
    const gst_no = document.getElementById('newCustGST').value.trim();
    const branch_id = document.getElementById('newCustBranch').value;

    if (!name) { showToast('Customer name is required', 'error'); return; }

    const btn = document.getElementById('createCustBtn');
    btn.disabled = true;
    btn.textContent = 'Creating...';

    try {
        const resp = await fetch('/api/credit-limits/create-customer', {
            method: 'POST', headers,
            body: JSON.stringify({ customer_name: name, phone, email, gst_no, branch_id: branch_id ? Number(branch_id) : null })
        });
        const json = await resp.json();
        if (json.error) throw new Error(json.error);

        showToast(json.message + (json.zoho_synced ? ' — synced to Zoho' : ''));
        closeCreateCustomerModal();
        loadCustomers();
        loadOverview();
    } catch (e) {
        showToast('Failed: ' + e.message, 'error');
    } finally {
        btn.disabled = false;
        btn.textContent = 'Create & Sync to Zoho';
    }
}

// Quick request shortcut for staff on no-limit customers
function quickRequest(custId) {
    const c = allCustomers.find(x => x.id === custId);
    if (!c) return;
    // Open request modal pre-filled
    closeRequestsPanel();
    const select = document.getElementById('reqCustomerSelect');
    select.innerHTML = '<option value="">Select a customer without limit...</option>';
    allCustomers.filter(x => Number(x.credit_limit) === 0).forEach(x => {
        select.innerHTML += `<option value="${x.id}" data-outstanding="${x.credit_used||0}" data-name="${escHtml(x.name||'')}" data-phone="${escHtml(x.phone||'')}">${escHtml(x.name||'')} (${escHtml(x.phone||'')})</option>`;
    });
    select.value = custId;
    onReqCustomerChange();
    document.getElementById('reqAmount').value = '';
    document.getElementById('reqReason').value = '';
    document.getElementById('requestModal').classList.add('open');
}

// ═══════════════════════════════════════════════════════════════
// CREDIT LIMIT REQUESTS (F4)
// ═══════════════════════════════════════════════════════════════

// --- Requests Panel ---
async function openRequestsPanel() {
    document.getElementById('requestsPanel').classList.add('open');
    await loadRequests();
}
function closeRequestsPanel() { document.getElementById('requestsPanel').classList.remove('open'); }

async function loadRequests() {
    const statusFilter = document.getElementById('reqStatusFilter').value;
    const container = document.getElementById('requestsList');
    container.innerHTML = '<div style="text-align:center;padding:2rem;color:#9ca3af;">Loading...</div>';

    try {
        const resp = await fetch('/api/credit-limits/requests?status=' + statusFilter, { headers });
        const json = await resp.json();
        if (!json.success) throw new Error(json.error);

        updateRequestBadge(json.pending_count);

        if (!json.data.length) {
            container.innerHTML = '<div style="text-align:center;padding:2rem;color:#9ca3af;">No requests found</div>';
            return;
        }

        container.innerHTML = json.data.map(r => {
            const statusColors = { pending: '#f59e0b', approved: '#22c55e', rejected: '#ef4444' };
            const statusBg = { pending: '#fef3c7', approved: '#d1fae5', rejected: '#fee2e2' };
            return `<div style="border:1px solid #e5e7eb;border-radius:10px;padding:1rem;margin-bottom:0.75rem;${r.status==='pending'?'border-left:3px solid #f59e0b;':''}">
                <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:0.5rem;">
                    <div>
                        <div style="font-weight:700;font-size:0.9375rem;color:#1f2937;">${escHtml(r.customer_name || '')}</div>
                        <div style="font-size:0.6875rem;color:#6b7280;">by ${escHtml(r.requested_by_name || '')} &middot; ${new Date(r.created_at).toLocaleDateString('en-IN')} ${new Date(r.created_at).toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'})}</div>
                    </div>
                    <span style="font-size:0.6875rem;font-weight:600;padding:2px 8px;border-radius:999px;background:${statusBg[r.status]||'#f3f4f6'};color:${statusColors[r.status]||'#6b7280'};text-transform:capitalize;">${r.status}</span>
                </div>
                <div style="display:flex;gap:1.5rem;font-size:0.8125rem;margin-bottom:0.5rem;">
                    <div><span style="color:#6b7280">Requested:</span> <b style="color:#667eea">${formatINR(r.requested_amount)}</b></div>
                    <div><span style="color:#6b7280">Current Limit:</span> <b>${r.current_limit > 0 ? formatINR(r.current_limit) : 'None'}</b></div>
                    <div><span style="color:#6b7280">Outstanding:</span> <b>${formatINR(r.zoho_outstanding)}</b></div>
                </div>
                ${r.reason ? `<div style="font-size:0.8125rem;color:#374151;margin-bottom:0.5rem;"><span style="color:#6b7280">Reason:</span> ${escHtml(r.reason)}</div>` : ''}
                ${r.status === 'approved' ? `<div style="font-size:0.8125rem;color:#065f46;">Approved: <b>${formatINR(r.approved_amount)}</b> by ${escHtml(r.reviewed_by_name||'')}${r.review_notes ? ' — ' + escHtml(r.review_notes) : ''}</div>` : ''}
                ${r.status === 'rejected' ? `<div style="font-size:0.8125rem;color:#991b1b;">Rejected by ${escHtml(r.reviewed_by_name||'')}${r.review_notes ? ': ' + escHtml(r.review_notes) : ''}</div>` : ''}
                ${r.status === 'pending' && canManage ? `
                <div style="display:flex;gap:0.5rem;margin-top:0.5rem;">
                    <button class="btn-primary btn-sm" onclick="openApproveModal(${r.id}, '${escHtml(r.customer_name)}', ${r.requested_amount}, ${r.current_limit||0}, ${r.zoho_outstanding||0})">Approve</button>
                    <button class="btn-outline btn-sm" style="color:#ef4444;border-color:#fca5a5;" onclick="openRejectModal(${r.id}, '${escHtml(r.customer_name)}', ${r.requested_amount})">Reject</button>
                </div>` : ''}
            </div>`;
        }).join('');
    } catch (e) {
        container.innerHTML = '<div style="color:#ef4444;text-align:center;padding:1rem;">Error: ' + escHtml(e.message) + '</div>';
    }
}

function updateRequestBadge(count) {
    const badge = document.getElementById('requestsBadge');
    if (count > 0) {
        badge.textContent = count;
        badge.style.display = 'flex';
    } else {
        badge.style.display = 'none';
    }
}

// --- New Request Modal ---
function openNewRequestModal() {
    closeRequestsPanel();
    // Populate customer select with no-limit customers
    const select = document.getElementById('reqCustomerSelect');
    select.innerHTML = '<option value="">Select a customer without limit...</option>';
    allCustomers.filter(c => Number(c.credit_limit) === 0).forEach(c => {
        select.innerHTML += `<option value="${c.id}" data-outstanding="${c.credit_used||0}" data-name="${escHtml(c.name||'')}" data-phone="${escHtml(c.phone||'')}">${escHtml(c.name||'')} (${escHtml(c.phone||'')})</option>`;
    });
    document.getElementById('reqAmount').value = '';
    document.getElementById('reqReason').value = '';
    document.getElementById('reqCustomerInfo').style.display = 'none';
    document.getElementById('requestModal').classList.add('open');
}
function closeRequestModal() { document.getElementById('requestModal').classList.remove('open'); }

function onReqCustomerChange() {
    const select = document.getElementById('reqCustomerSelect');
    const opt = select.selectedOptions[0];
    if (!opt || !opt.value) {
        document.getElementById('reqCustomerInfo').style.display = 'none';
        return;
    }
    document.getElementById('reqCustomerInfo').style.display = 'block';
    document.getElementById('reqCustDetails').innerHTML = `
        <b>${opt.dataset.name}</b> &middot; ${opt.dataset.phone || 'No phone'}<br>
        <span style="color:#6b7280">Outstanding: <b style="color:#ef4444">${formatINR(opt.dataset.outstanding)}</b> &middot; Credit Limit: <b>Not set</b></span>
    `;
}

async function submitRequest() {
    const zoho_customer_map_id = document.getElementById('reqCustomerSelect').value;
    const requested_amount = parseFloat(document.getElementById('reqAmount').value);
    const reason = document.getElementById('reqReason').value.trim();

    if (!zoho_customer_map_id) { showToast('Select a customer', 'error'); return; }
    if (isNaN(requested_amount) || requested_amount <= 0) { showToast('Enter a valid amount', 'error'); return; }

    try {
        const resp = await fetch('/api/credit-limits/requests', {
            method: 'POST', headers,
            body: JSON.stringify({ zoho_customer_map_id: Number(zoho_customer_map_id), requested_amount, reason })
        });
        const json = await resp.json();
        if (json.error) throw new Error(json.error);
        showToast('Credit limit request submitted');
        closeRequestModal();
        openRequestsPanel();
    } catch (e) {
        showToast('Failed: ' + e.message, 'error');
    }
}

// --- Approve Modal ---
function openApproveModal(id, name, amount, currentLimit, outstanding) {
    document.getElementById('approveReqId').value = id;
    document.getElementById('approveAmount').value = amount;
    document.getElementById('approveNotes').value = '';
    document.getElementById('approveInfo').innerHTML = `
        <b>${escHtml(name)}</b><br>
        <span style="color:#6b7280">Requested: <b style="color:#667eea">${formatINR(amount)}</b> &middot; Current Limit: <b>${currentLimit > 0 ? formatINR(currentLimit) : 'None'}</b> &middot; Outstanding: <b>${formatINR(outstanding)}</b></span>
    `;
    document.getElementById('approveModal').classList.add('open');
}
function closeApproveModal() { document.getElementById('approveModal').classList.remove('open'); }

async function confirmApprove() {
    const id = document.getElementById('approveReqId').value;
    const approved_amount = parseFloat(document.getElementById('approveAmount').value);
    const review_notes = document.getElementById('approveNotes').value.trim();

    if (isNaN(approved_amount) || approved_amount < 0) { showToast('Enter a valid amount', 'error'); return; }

    try {
        const resp = await fetch(`/api/credit-limits/requests/${id}/approve`, {
            method: 'PUT', headers,
            body: JSON.stringify({ approved_amount, review_notes })
        });
        const json = await resp.json();
        if (json.error) throw new Error(json.error);
        showToast('Request approved — credit limit set' + (json.zoho_synced ? ' & synced to Zoho' : ''));
        closeApproveModal();
        loadRequests();
        loadCustomers();
        loadOverview();
    } catch (e) {
        showToast('Failed: ' + e.message, 'error');
    }
}

// --- Reject Modal ---
function openRejectModal(id, name, amount) {
    document.getElementById('rejectReqId').value = id;
    document.getElementById('rejectNotes').value = '';
    document.getElementById('rejectInfo').innerHTML = `<b>${escHtml(name)}</b> — Requested: <b>${formatINR(amount)}</b>`;
    document.getElementById('rejectModal').classList.add('open');
}
function closeRejectModal() { document.getElementById('rejectModal').classList.remove('open'); }

async function confirmReject() {
    const id = document.getElementById('rejectReqId').value;
    const review_notes = document.getElementById('rejectNotes').value.trim();

    if (!review_notes) { showToast('Rejection reason is required', 'error'); return; }

    try {
        const resp = await fetch(`/api/credit-limits/requests/${id}/reject`, {
            method: 'PUT', headers,
            body: JSON.stringify({ review_notes })
        });
        const json = await resp.json();
        if (json.error) throw new Error(json.error);
        showToast('Request rejected');
        closeRejectModal();
        loadRequests();
    } catch (e) {
        showToast('Failed: ' + e.message, 'error');
    }
}

// --- Socket.io listeners ---
function initRequestSocket() {
    if (typeof window.qcSocket === 'undefined') return;
    const socket = window.qcSocket;
    socket.on('credit_limit_request_new', (data) => {
        showToast('New credit limit request: ' + (data.customer_name || ''));
        // Refresh badge
        loadRequestBadge();
    });
    socket.on('credit_limit_request_resolved', (data) => {
        showToast('Credit request ' + data.status + ': ' + (data.customer_name || ''));
        loadRequestBadge();
        loadCustomers();
        loadOverview();
    });
}

async function loadRequestBadge() {
    try {
        const resp = await fetch('/api/credit-limits/requests?status=pending', { headers });
        const json = await resp.json();
        if (json.success) updateRequestBadge(json.pending_count);
    } catch (e) { /* ignore */ }
}

// ═══════════════════════════════════════════════════════════════
// INIT — check permissions first, then load data
// ═══════════════════════════════════════════════════════════════
(async function init() {
    const allowed = await checkPagePermissions();
    if (!allowed) return;

    loadCustomers();
    loadOverview();
    loadRequestBadge();
    setTimeout(initRequestSocket, 1000);
})();
</script>
</body>
</html>
