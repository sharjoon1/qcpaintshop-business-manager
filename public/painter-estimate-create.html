<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1B5E3B">
    <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192x192.png">
    <title>Create Estimate - Quality Colours</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #f9fafb; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        *, *::before, *::after { box-sizing: border-box; }
        html, body { max-width: 100vw; overflow-x: hidden; }
        .header { background: linear-gradient(135deg, #1B5E3B, #D4A24E); color: #fff; }
        .step { display: none; }
        .step.active { display: block; }
        .type-card { background: #fff; border: 2px solid #e2e8f0; border-radius: 16px; padding: 1.5rem; cursor: pointer; transition: all 0.2s; text-align: center; }
        .type-card:hover { border-color: #1B5E3B; box-shadow: 0 4px 12px rgba(27,94,59,0.15); }
        .type-card.selected { border-color: #1B5E3B; background: linear-gradient(135deg, #f0fdf4, #fefce8); }
        .product-card { background: #fff; border: 1px solid #e8ecf1; border-radius: 12px; padding: 0.75rem; display: flex; align-items: center; gap: 0.75rem; transition: all 0.15s; }
        .product-card:hover { border-color: #1B5E3B; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid #f1f5f9; }
        .cart-item:last-child { border-bottom: none; }
        .btn-primary { background: linear-gradient(135deg, #1B5E3B, #D4A24E); color: #fff; border: none; padding: 0.75rem 1.5rem; border-radius: 10px; font-weight: 600; cursor: pointer; font-size: 0.9375rem; }
        .btn-primary:hover { opacity: 0.95; }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-outline { background: #fff; border: 1px solid #d1d5db; color: #374151; padding: 0.75rem 1.5rem; border-radius: 10px; font-weight: 500; cursor: pointer; }
        .qty-btn { width: 32px; height: 32px; border-radius: 8px; border: 1px solid #d1d5db; background: #fff; font-size: 1.125rem; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .qty-btn:hover { background: #f3f4f6; }
        .search-input { width: 100%; padding: 0.625rem 0.75rem 0.625rem 2.5rem; border: 1px solid #d1d5db; border-radius: 10px; font-size: 0.875rem; }
        .search-input:focus { outline: none; border-color: #1B5E3B; box-shadow: 0 0 0 3px rgba(27,94,59,0.1); }
        .filter-select { padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 8px; font-size: 0.8125rem; background: #fff; }
        .badge { display: inline-flex; padding: 2px 8px; border-radius: 9999px; font-size: 0.6875rem; font-weight: 600; }
        .badge-stock { background: #d1fae5; color: #065f46; }
        .badge-low { background: #fef3c7; color: #92400e; }
        .badge-out { background: #fee2e2; color: #991b1b; }
        .stepper { display: flex; gap: 0.5rem; align-items: center; }
        .stepper-dot { width: 8px; height: 8px; border-radius: 50%; background: rgba(255,255,255,0.4); }
        .stepper-dot.active { background: #fff; width: 24px; border-radius: 4px; }
        .stepper-dot.done { background: rgba(255,255,255,0.8); }
        .floating-cart { position: fixed; bottom: 0; left: 0; right: 0; background: #fff; border-top: 1px solid #e8ecf1; padding: 0.75rem 1rem; box-shadow: 0 -4px 12px rgba(0,0,0,0.08); z-index: 50; }
        .type-tab { padding: 0.375rem 0.75rem; border-radius: 8px; font-size: 0.75rem; font-weight: 600; border: 1px solid #d1d5db; background: #fff; color: #6b7280; cursor: pointer; transition: all 0.15s; white-space: nowrap; }
        .type-tab.active { background: #1B5E3B; color: #fff; border-color: #1B5E3B; }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="max-w-lg mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <a href="/painter-dashboard.html" class="opacity-80 hover:opacity-100">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
                    </a>
                    <div>
                        <h1 class="text-lg font-bold">Create Estimate</h1>
                        <div class="stepper mt-1" id="stepper">
                            <div class="stepper-dot active" data-step="1"></div>
                            <div class="stepper-dot" data-step="2"></div>
                            <div class="stepper-dot" data-step="3"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-lg mx-auto px-4 py-4 pb-32">
        <!-- Step 1: Billing Type -->
        <div class="step active" id="step1">
            <h2 class="text-lg font-semibold text-gray-800 mb-2">Choose Billing Type</h2>
            <p class="text-sm text-gray-500 mb-4">Who is this estimate for?</p>
            <div class="grid grid-cols-1 gap-4">
                <div class="type-card" onclick="selectBillingType('self', this)">
                    <div style="width:48px;height:48px;border-radius:12px;background:linear-gradient(135deg,#dbeafe,#e0e7ff);display:flex;align-items:center;justify-content:center;margin:0 auto 0.75rem;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#4f46e5" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                    </div>
                    <h3 class="font-semibold text-gray-800">Self Billing</h3>
                    <p class="text-sm text-gray-500 mt-1">Buying paint for yourself</p>
                    <p class="text-xs text-emerald-700 mt-2 font-medium">You'll see dealer prices</p>
                </div>
                <div class="type-card" onclick="selectBillingType('customer', this)">
                    <div style="width:48px;height:48px;border-radius:12px;background:linear-gradient(135deg,#fef3c7,#fde68a);display:flex;align-items:center;justify-content:center;margin:0 auto 0.75rem;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#d97706" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>
                    </div>
                    <h3 class="font-semibold text-gray-800">Customer Billing</h3>
                    <p class="text-sm text-gray-500 mt-1">Buying paint for your customer</p>
                    <p class="text-xs text-amber-600 mt-2 font-medium">Prices set by admin</p>
                </div>
            </div>
        </div>

        <!-- Step 2: Customer Details (customer billing only) -->
        <div class="step" id="step2">
            <h2 class="text-lg font-semibold text-gray-800 mb-2">Customer Details</h2>
            <p class="text-sm text-gray-500 mb-4">Enter your customer's information</p>
            <div class="bg-white rounded-xl border border-gray-200 p-4 space-y-3">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Customer Name *</label>
                    <input type="text" id="customerName" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="Full name">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                    <input type="tel" id="customerPhone" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="10-digit number">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Address</label>
                    <textarea id="customerAddress" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="Delivery address"></textarea>
                </div>
            </div>
            <div class="flex gap-3 mt-4">
                <button class="btn-outline flex-1" onclick="goToStep(1)">Back</button>
                <button class="btn-primary flex-1" onclick="goToStep(3)">Next: Add Products</button>
            </div>
        </div>

        <!-- Step 3: Product Picker -->
        <div class="step" id="step3">
            <div class="flex items-center justify-between mb-3">
                <h2 class="text-lg font-semibold text-gray-800">Select Products</h2>
                <span class="text-sm text-gray-500" id="cartCount">0 items</span>
            </div>

            <!-- Search & Filters -->
            <div class="mb-3">
                <div class="relative mb-2">
                    <svg class="absolute left-3 top-1/2 -translate-y-1/2" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#9ca3af" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                    <input type="text" id="productSearch" class="search-input" placeholder="Search products..." oninput="debounceSearch()">
                </div>
                <div class="flex gap-2 mb-2">
                    <button type="button" class="type-tab active" onclick="filterByType(this, '')">All</button>
                    <button type="button" class="type-tab" onclick="filterByType(this, 'unit_wise')">Unit Wise</button>
                    <button type="button" class="type-tab" onclick="filterByType(this, 'area_wise')">Area Wise</button>
                </div>
                <div class="flex gap-2">
                    <select id="brandFilter" class="filter-select flex-1 min-w-0" onchange="loadProducts()">
                        <option value="">All Brands</option>
                    </select>
                    <select id="categoryFilter" class="filter-select flex-1 min-w-0" onchange="loadProducts()">
                        <option value="">All Categories</option>
                    </select>
                </div>
            </div>

            <!-- Product List -->
            <div id="productList" class="space-y-2">
                <div class="text-center py-8 text-gray-400 text-sm">Loading products...</div>
            </div>

            <div class="mt-3">
                <button class="btn-outline w-full" onclick="billingType === 'customer' ? goToStep(2) : goToStep(1)">
                    <svg class="inline mr-1" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
                    Back
                </button>
            </div>
        </div>

        <!-- Cart Summary (shown as a section below products when items exist) -->
        <div id="cartSection" class="mt-4" style="display:none">
            <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
                <div class="px-4 py-3 border-b border-gray-100 flex justify-between items-center">
                    <h3 class="font-semibold text-gray-800">Cart Summary</h3>
                    <button class="text-sm text-red-500 font-medium" onclick="clearCart()">Clear All</button>
                </div>
                <div id="cartItems" class="px-4"></div>
                <div class="px-4 py-3 bg-gray-50 border-t border-gray-100">
                    <div id="cartTotals"></div>
                </div>
            </div>
            <div class="mt-3">
                <label class="block text-sm font-medium text-gray-700 mb-1">Notes (optional)</label>
                <textarea id="estimateNotes" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" placeholder="Any special notes..."></textarea>
            </div>
        </div>
    </div>

    <!-- Floating Cart Bar -->
    <div class="floating-cart" id="floatingCart" style="display:none">
        <div class="max-w-lg mx-auto flex items-center justify-between">
            <div>
                <span class="font-semibold text-gray-800" id="floatingCartCount">0 items</span>
                <span class="text-sm text-gray-500 ml-2" id="floatingCartTotal"></span>
            </div>
            <button class="btn-primary" onclick="submitEstimate()" id="submitBtn">Submit Estimate</button>
        </div>
    </div>

    <script>
    const API = '/api/painters';
    let billingType = '';
    let cart = {}; // { "productId_packSizeId": { ...details, quantity } }
    let selectedType = '';
    let allProducts = [];
    let searchTimer;

    function painterHeaders() {
        return {
            'Content-Type': 'application/json',
            'X-Painter-Token': localStorage.getItem('painter_token') || ''
        };
    }

    if (!localStorage.getItem('painter_token')) {
        window.location.href = '/painter-login.html';
    }

    function esc(s) {
        if (!s) return '';
        const d = document.createElement('div');
        d.textContent = s;
        return d.innerHTML;
    }

    // Step navigation
    function goToStep(step) {
        // Validate step 2 if going forward from customer details
        if (step === 3 && billingType === 'customer') {
            const name = document.getElementById('customerName').value.trim();
            if (!name) { alert('Customer name is required'); return; }
        }

        document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
        document.getElementById('step' + step).classList.add('active');

        // Update stepper
        document.querySelectorAll('.stepper-dot').forEach(dot => {
            const s = parseInt(dot.dataset.step);
            dot.className = 'stepper-dot' + (s === step ? ' active' : s < step ? ' done' : '');
        });

        if (step === 3) loadProducts();
        window.scrollTo(0, 0);
    }

    function selectBillingType(type, el) {
        billingType = type;
        document.querySelectorAll('.type-card').forEach(c => c.classList.remove('selected'));
        if (el) el.classList.add('selected');

        setTimeout(() => {
            if (type === 'customer') {
                goToStep(2);
            } else {
                goToStep(3);
            }
        }, 200);
    }

    // Products
    function debounceSearch() {
        clearTimeout(searchTimer);
        searchTimer = setTimeout(loadProducts, 300);
    }

    function filterByType(el, type) {
        selectedType = type;
        document.querySelectorAll('.type-tab').forEach(t => t.classList.remove('active'));
        el.classList.add('active');
        loadProducts();
    }

    async function loadProducts() {
        const search = document.getElementById('productSearch').value;
        const brand = document.getElementById('brandFilter').value;
        const category = document.getElementById('categoryFilter').value;

        try {
            const params = new URLSearchParams({ billing_type: billingType });
            if (search) params.set('search', search);
            if (brand) params.set('brand', brand);
            if (category) params.set('category', category);
            if (selectedType) params.set('product_type', selectedType);

            const res = await fetch(`${API}/me/estimates/products?${params}`, { headers: painterHeaders() });
            if (res.status === 401) { window.location.href = '/painter-login.html'; return; }
            const data = await res.json();
            if (!data.success) throw new Error(data.message);

            allProducts = data.products;

            const brandSelect = document.getElementById('brandFilter');
            if (brandSelect.options.length <= 1 && data.brands && data.brands.length) {
                data.brands.forEach(b => {
                    const opt = document.createElement('option');
                    opt.value = b.id; opt.textContent = b.name;
                    brandSelect.appendChild(opt);
                });
            }
            const catSelect = document.getElementById('categoryFilter');
            if (catSelect.options.length <= 1 && data.categories && data.categories.length) {
                data.categories.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.id; opt.textContent = c.name;
                    catSelect.appendChild(opt);
                });
            }

            renderProducts(data.products);
        } catch (err) {
            console.error('Load products error:', err);
            document.getElementById('productList').innerHTML = '<div class="text-center py-4 text-red-500 text-sm">Failed to load products</div>';
        }
    }

    function renderProducts(products) {
        const container = document.getElementById('productList');
        if (!products.length) {
            container.innerHTML = '<div class="text-center py-8 text-gray-400 text-sm">No products found</div>';
            return;
        }

        container.innerHTML = products.map(p => {
            const typeLabel = p.product_type === 'area_wise' ? 'Area' : 'Unit';
            const typeBg = p.product_type === 'area_wise' ? 'background:#dbeafe;color:#1d4ed8' : 'background:#d1fae5;color:#065f46';

            return `
            <div class="product-card" style="flex-direction:column;align-items:stretch;gap:0.5rem;">
                <div class="flex items-start justify-between gap-2">
                    <div class="flex-1 min-w-0">
                        <div class="text-sm font-semibold text-gray-800">${esc(p.name)}</div>
                        <div class="flex items-center gap-2 mt-0.5 flex-wrap">
                            ${p.brand ? '<span class="text-xs text-gray-500">' + esc(p.brand) + '</span>' : ''}
                            <span class="badge" style="${typeBg};font-size:0.625rem;padding:1px 6px;border-radius:9999px;font-weight:600">${typeLabel}</span>
                            ${p.area_coverage ? '<span class="text-xs text-gray-400">' + p.area_coverage + ' sq ft/L</span>' : ''}
                        </div>
                    </div>
                </div>
                <div class="flex flex-wrap gap-1.5">
                    ${p.pack_sizes.map(ps => {
                        const key = p.id + '_' + ps.pack_size_id;
                        const inCart = cart[key];
                        if (inCart) {
                            return '<div class="flex items-center gap-1 bg-emerald-50 border border-emerald-200 rounded-lg px-2 py-1">' +
                                '<button class="qty-btn" style="width:24px;height:24px;font-size:0.875rem;" onclick="updateQty(\'' + key + '\', -1)">−</button>' +
                                '<span class="text-xs font-semibold w-5 text-center">' + inCart.quantity + '</span>' +
                                '<button class="qty-btn" style="width:24px;height:24px;font-size:0.875rem;" onclick="updateQty(\'' + key + '\', 1)">+</button>' +
                                '<span class="text-xs font-medium text-emerald-700 ml-1">' + ps.size + ps.unit + '</span>' +
                                (ps.rate !== null ? '<span class="text-xs text-gray-500">₹' + ps.rate.toLocaleString('en-IN') + '</span>' : '') +
                                '</div>';
                        }
                        return '<button onclick="addToCart(\'' + key + '\', ' + p.id + ', ' + ps.pack_size_id + ')"' +
                            ' class="px-2.5 py-1.5 rounded-lg text-xs font-medium border transition-colors ' +
                            (ps.stock > 0 ? 'text-emerald-700 border-emerald-200 hover:bg-emerald-50' : 'text-gray-400 border-gray-200') + '">' +
                            ps.size + ps.unit + (ps.rate !== null ? ' • ₹' + ps.rate.toLocaleString('en-IN') : '') +
                            '</button>';
                    }).join('')}
                </div>
            </div>`;
        }).join('');
    }

    function addToCart(key, productId, packSizeId) {
        const product = allProducts.find(p => p.id === productId);
        if (!product) return;
        const ps = product.pack_sizes.find(s => s.pack_size_id === packSizeId);
        if (!ps) return;
        cart[key] = {
            product_id: productId,
            pack_size_id: packSizeId,
            zoho_item_id: ps.zoho_item_id,
            name: product.name,
            brand: product.brand,
            size: ps.size,
            unit: ps.unit,
            rate: ps.rate,
            stock: ps.stock,
            quantity: 1
        };
        renderProducts(allProducts);
        updateCartUI();
    }

    function updateQty(key, delta) {
        if (!cart[key]) return;
        cart[key].quantity += delta;
        if (cart[key].quantity <= 0) delete cart[key];
        renderProducts(allProducts);
        updateCartUI();
    }

    function clearCart() {
        cart = {};
        renderProducts(allProducts);
        updateCartUI();
    }

    function updateCartUI() {
        const items = Object.values(cart);
        const count = items.length;
        const totalQty = items.reduce((s, i) => s + i.quantity, 0);

        document.getElementById('cartCount').textContent = count + ' items';
        document.getElementById('floatingCartCount').textContent = count + ' items (' + totalQty + ' qty)';

        if (count === 0) {
            document.getElementById('floatingCart').style.display = 'none';
            document.getElementById('cartSection').style.display = 'none';
            return;
        }

        document.getElementById('floatingCart').style.display = 'block';
        document.getElementById('cartSection').style.display = 'block';

        document.getElementById('cartItems').innerHTML = items.map(i =>
            '<div class="cart-item">' +
                '<div class="flex-1 min-w-0">' +
                    '<div class="text-sm font-medium truncate">' + esc(i.name) + ' — ' + i.size + i.unit + '</div>' +
                    '<div class="text-xs text-gray-400">' + esc(i.brand || '') + ' • Qty: ' + i.quantity + '</div>' +
                '</div>' +
                '<div class="text-right flex-shrink-0">' +
                    (i.rate !== null ? '<div class="text-sm font-semibold">₹' + (i.rate * i.quantity).toLocaleString('en-IN') + '</div>' : '<div class="text-xs text-gray-400">Price by admin</div>') +
                '</div>' +
                '<button class="ml-2 text-gray-400 hover:text-red-500" onclick="delete cart[\'' + i.product_id + '_' + i.pack_size_id + '\'];renderProducts(allProducts);updateCartUI();">' +
                    '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>' +
                '</button>' +
            '</div>'
        ).join('');

        if (billingType === 'self') {
            const subtotal = items.reduce((s, i) => s + (i.rate || 0) * i.quantity, 0);
            document.getElementById('cartTotals').innerHTML =
                '<div class="flex justify-between text-sm text-gray-600 mb-1"><span>Subtotal</span><span>₹' + subtotal.toLocaleString('en-IN') + '</span></div>' +
                '<div class="flex justify-between text-sm text-gray-600 mb-1"><span>GST (18%)</span><span>₹' + (subtotal * 0.18).toLocaleString('en-IN') + '</span></div>' +
                '<div class="flex justify-between font-semibold text-gray-800 pt-1 border-t border-gray-200"><span>Grand Total</span><span>₹' + (subtotal * 1.18).toLocaleString('en-IN') + '</span></div>';
            document.getElementById('floatingCartTotal').textContent = '₹' + (subtotal * 1.18).toLocaleString('en-IN');
        } else {
            document.getElementById('cartTotals').innerHTML = '<div class="text-sm text-gray-500 text-center">Prices will be set by admin after review</div>';
            document.getElementById('floatingCartTotal').textContent = '';
        }
    }

    async function submitEstimate() {
        const items = Object.values(cart);
        if (!items.length) { alert('Add at least one product'); return; }

        const btn = document.getElementById('submitBtn');
        btn.disabled = true;
        btn.textContent = 'Submitting...';

        try {
            const body = {
                billing_type: billingType,
                items: items.map(i => ({ pack_size_id: i.pack_size_id, quantity: i.quantity })),
                notes: document.getElementById('estimateNotes').value || '',
                submit: true
            };

            if (billingType === 'customer') {
                body.customer_name = document.getElementById('customerName').value.trim();
                body.customer_phone = document.getElementById('customerPhone').value.trim();
                body.customer_address = document.getElementById('customerAddress').value.trim();
            }

            const res = await fetch(`${API}/me/estimates`, {
                method: 'POST',
                headers: painterHeaders(),
                body: JSON.stringify(body)
            });

            const data = await res.json();
            if (!data.success) throw new Error(data.message);

            alert(`Estimate ${data.estimateNumber} submitted successfully! Our team will review it shortly.`);
            window.location.href = '/painter-dashboard.html';
        } catch (err) {
            alert('Error: ' + err.message);
            btn.disabled = false;
            btn.textContent = 'Submit Estimate';
        }
    }
    </script>
</body>
</html>
