<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192x192.png">
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
    <title>Create Estimate - Quality Colors</title>
    <script src="/js/auth-helper.js"></script>
    <script>checkAuthOrRedirect();</script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/universal-nav-loader.js"></script>
    <style>
        /* Searchable Dropdown */
        .searchable-dropdown { position: relative; }
        .sd-display {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem 1rem;
            border: 2px solid #d1d5db;
            border-radius: 0.5rem;
            background: white;
            cursor: pointer;
            min-height: 42px;
            transition: border-color 0.2s;
        }
        .sd-display:hover { border-color: #7c3aed; }
        .sd-display.open { border-color: #7c3aed; }
        .sd-text {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: 0.9rem;
        }
        .sd-text.placeholder { color: #6b7280; }
        .sd-arrow {
            flex-shrink: 0;
            color: #6b7280;
            margin-left: 8px;
            transition: transform 0.2s;
        }
        .sd-display.open .sd-arrow { transform: rotate(180deg); }
        .sd-panel {
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #d1d5db;
            border-radius: 0.5rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            z-index: 50;
            overflow: hidden;
        }
        .sd-search {
            width: 100%;
            padding: 0.6rem 0.75rem;
            border: none;
            border-bottom: 1px solid #e5e7eb;
            outline: none;
            font-size: 0.875rem;
            box-sizing: border-box;
        }
        .sd-search:focus { background: #faf5ff; }
        .sd-options {
            max-height: 200px;
            overflow-y: auto;
        }
        .sd-option {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            font-size: 0.875rem;
            border-bottom: 1px solid #f3f4f6;
        }
        .sd-option:last-child { border-bottom: none; }
        .sd-option:hover { background: #f3e8ff; }
        .sd-option.selected { background: #ede9fe; font-weight: 600; color: #6d28d9; }
        .sd-no-results {
            padding: 0.75rem;
            text-align: center;
            color: #9ca3af;
            font-size: 0.875rem;
        }
    </style>
</head>
<body class="bg-gray-50">
<div class="max-w-7xl mx-auto p-4">
        <!-- Step 1: Customer Selection -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <h2 class="text-lg font-bold text-gray-800 mb-4">Step 1: Select Customer</h2>

            <div class="flex gap-3 mb-4">
                <div class="searchable-dropdown flex-1" id="customerDropdown"></div>
                <button onclick="openNewCustomerModal()" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold whitespace-nowrap">
                    + New Customer
                </button>
            </div>

            <!-- Customer Details Display -->
            <div id="customerDetails" class="hidden p-4 bg-gray-50 rounded-lg">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-sm">
                    <div><strong>Name:</strong> <span id="custName"></span></div>
                    <div><strong>Phone:</strong> <span id="custPhone"></span></div>
                    <div><strong>Email:</strong> <span id="custEmail"></span></div>
                    <div class="md:col-span-3"><strong>Address:</strong> <span id="custAddress"></span></div>
                </div>
            </div>
        </div>

        <!-- Step 2: Add Products -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <h2 class="text-lg font-bold text-gray-800 mb-4">Step 2: Add Products</h2>

            <!-- Brand → Category → Product Selection -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Brand *</label>
                    <div class="searchable-dropdown" id="brandDropdown"></div>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Category *</label>
                    <div class="searchable-dropdown" id="categoryDropdown"></div>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Product *</label>
                    <div class="searchable-dropdown" id="productDropdown"></div>
                </div>
            </div>

            <!-- Product Type Selection -->
            <div id="productTypeSection" class="hidden mb-4">
                <label class="block text-sm font-semibold text-gray-700 mb-2">Product Type *</label>
                <div class="flex gap-4">
                    <label class="flex items-center cursor-pointer">
                        <input type="radio" name="productType" value="unit" checked onchange="switchProductType()" class="mr-2">
                        <span class="font-semibold">Unit Type (Pack Size)</span>
                    </label>
                    <label id="areaTypeOption" class="flex items-center cursor-pointer hidden">
                        <input type="radio" name="productType" value="area" onchange="switchProductType()" class="mr-2">
                        <span class="font-semibold">Area Type (Square Feet)</span>
                    </label>
                </div>
            </div>

            <!-- Unit Type Inputs -->
            <div id="unitTypeInputs" class="hidden grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Pack Size *</label>
                    <select id="packSizeSelect" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-purple-600 focus:outline-none">
                        <option value="">-- Select Pack Size --</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Quantity *</label>
                    <input type="number" id="unitQuantity" min="1" value="1" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-purple-600 focus:outline-none">
                </div>
            </div>

            <!-- Area Type Inputs -->
            <div id="areaTypeInputs" class="hidden grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Square Feet Required *</label>
                    <input type="number" id="squareFeet" min="1" step="0.01" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-purple-600 focus:outline-none" oninput="calculateAreaWise()">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Number of Coats *</label>
                    <input type="number" id="coatsNumber" min="1" value="2" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-purple-600 focus:outline-none" oninput="calculateAreaWise()">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Coverage (sq.ft/L)</label>
                    <input type="number" id="areaCoverage" disabled class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg bg-gray-100">
                </div>
            </div>

            <!-- Area Calculation Result -->
            <div id="areaCalculation" class="hidden p-4 bg-blue-50 rounded-lg mb-4">
                <h3 class="font-bold text-blue-900 mb-2">Calculation Result:</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-2 text-sm">
                    <div><strong>Total Liters Needed:</strong> <span id="totalLiters" class="text-blue-600"></span></div>
                    <div><strong>Pack Combination:</strong> <span id="packCombo" class="text-blue-600"></span></div>
                    <div><strong>Total Price:</strong> <span id="areaPrice" class="text-blue-600 text-lg font-bold"></span></div>
                </div>
            </div>

            <button onclick="addProductToEstimate()" class="w-full bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 font-semibold">
                + Add Product to Estimate
            </button>
        </div>

        <!-- Products Table -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <h2 class="text-lg font-bold text-gray-800 mb-4">Estimate Items</h2>

            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-800 text-white">
                        <tr>
                            <th class="px-4 py-3 text-left">#</th>
                            <th class="px-4 py-3 text-left">Product</th>
                            <th class="px-4 py-3 text-left">Type</th>
                            <th class="px-4 py-3 text-left">Details</th>
                            <th class="px-4 py-3 text-right">Quantity</th>
                            <th class="px-4 py-3 text-right">Unit Price</th>
                            <th class="px-4 py-3 text-right">Total</th>
                            <th class="px-4 py-3 text-center">Action</th>
                        </tr>
                    </thead>
                    <tbody id="itemsTableBody">
                        <tr>
                            <td colspan="8" class="text-center py-8 text-gray-500">No items added yet</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Total Section -->
            <div class="mt-6 border-t pt-4">
                <div class="flex justify-end">
                    <div class="w-64 space-y-2">
                        <div class="flex justify-between">
                            <span class="font-semibold">Subtotal:</span>
                            <span id="subtotal">₹0.00</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-semibold">GST (18%):</span>
                            <span id="gstAmount">₹0.00</span>
                        </div>
                        <div class="flex justify-between text-lg font-bold border-t pt-2">
                            <span>Grand Total:</span>
                            <span id="grandTotal">₹0.00</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Save Estimate -->
        <div class="flex gap-3">
            <button onclick="history.back()" class="flex-1 px-6 py-3 border-2 border-gray-300 rounded-lg hover:bg-gray-50 font-semibold">
                Cancel
            </button>
            <button onclick="saveEstimate()" class="flex-1 bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 font-semibold">
                Save Estimate
            </button>
        </div>
    </div>

    <!-- New Customer Modal -->
    <div id="newCustomerModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Add New Customer</h3>
                <button onclick="closeNewCustomerModal()" class="text-gray-500 hover:text-gray-700 text-2xl">×</button>
            </div>
            <form onsubmit="createCustomer(event)">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
                    <div>
                        <label class="block text-sm font-semibold mb-1">Name *</label>
                        <input type="text" id="newCustName" required class="w-full px-3 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-1">Phone *</label>
                        <input type="tel" id="newCustPhone" required class="w-full px-3 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-1">Email</label>
                        <input type="email" id="newCustEmail" class="w-full px-3 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-1">Branch *</label>
                        <select id="newCustBranch" required class="w-full px-3 py-2 border rounded-lg">
                            <option value="">-- Select --</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-semibold mb-1">Address</label>
                        <textarea id="newCustAddress" rows="2" class="w-full px-3 py-2 border rounded-lg"></textarea>
                    </div>
                </div>
                <div class="flex gap-3">
                    <button type="button" onclick="closeNewCustomerModal()" class="flex-1 px-4 py-2 border rounded-lg">Cancel</button>
                    <button type="submit" class="flex-1 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">Create Customer</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ========================================
        // SEARCHABLE DROPDOWN COMPONENT
        // ========================================
        class SearchableDropdown {
            constructor(containerId, config = {}) {
                this.container = document.getElementById(containerId);
                this.placeholder = config.placeholder || '-- Select --';
                this.searchPlaceholder = config.searchPlaceholder || 'Type to search...';
                this.onSelect = config.onSelect || (() => {});
                this.options = [];
                this.selectedValue = '';
                this.selectedData = null;
                this.isOpen = false;
                this._render();
                this._bind();
            }

            _render() {
                this.container.innerHTML = `
                    <div class="sd-display">
                        <span class="sd-text placeholder">${this.placeholder}</span>
                        <svg class="sd-arrow" width="12" height="12" viewBox="0 0 12 12"><path d="M2 4l4 4 4-4" stroke="currentColor" stroke-width="2" fill="none"/></svg>
                    </div>
                    <div class="sd-panel" style="display:none;">
                        <input type="text" class="sd-search" placeholder="${this.searchPlaceholder}">
                        <div class="sd-options"></div>
                    </div>
                `;
                this.displayEl = this.container.querySelector('.sd-display');
                this.textEl = this.container.querySelector('.sd-text');
                this.panelEl = this.container.querySelector('.sd-panel');
                this.searchEl = this.container.querySelector('.sd-search');
                this.optionsEl = this.container.querySelector('.sd-options');
            }

            _bind() {
                this.displayEl.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.toggle();
                });
                this.searchEl.addEventListener('input', () => this._filter());
                this.panelEl.addEventListener('click', (e) => e.stopPropagation());
            }

            toggle() {
                this.isOpen ? this.close() : this.open();
            }

            open() {
                // Close all other dropdowns
                document.querySelectorAll('.searchable-dropdown').forEach(el => {
                    if (el !== this.container && el._sdInstance) {
                        el._sdInstance.close();
                    }
                });
                this.panelEl.style.display = '';
                this.displayEl.classList.add('open');
                this.searchEl.value = '';
                this._filter();
                this.isOpen = true;
                // Focus search after a tick so the panel is visible
                setTimeout(() => this.searchEl.focus(), 10);
            }

            close() {
                this.panelEl.style.display = 'none';
                this.displayEl.classList.remove('open');
                this.isOpen = false;
            }

            setOptions(options) {
                this.options = options;
                if (this.isOpen) this._filter();
            }

            _filter() {
                const q = this.searchEl.value.toLowerCase();
                const filtered = q
                    ? this.options.filter(o => o.label.toLowerCase().includes(q))
                    : this.options;

                if (filtered.length === 0) {
                    this.optionsEl.innerHTML = '<div class="sd-no-results">No results found</div>';
                    return;
                }

                this.optionsEl.innerHTML = filtered.map(o =>
                    `<div class="sd-option${String(o.value) === String(this.selectedValue) ? ' selected' : ''}" data-value="${o.value}">${o.label}</div>`
                ).join('');

                this.optionsEl.querySelectorAll('.sd-option').forEach(el => {
                    el.addEventListener('click', () => {
                        const opt = this.options.find(o => String(o.value) === el.dataset.value);
                        this._select(opt);
                    });
                });
            }

            _select(option) {
                if (option) {
                    this.selectedValue = option.value;
                    this.selectedData = option.data;
                    this.textEl.textContent = option.label;
                    this.textEl.classList.remove('placeholder');
                } else {
                    this.selectedValue = '';
                    this.selectedData = null;
                    this.textEl.textContent = this.placeholder;
                    this.textEl.classList.add('placeholder');
                }
                this.close();
                this.onSelect(this.selectedValue, this.selectedData);
            }

            getValue() { return this.selectedValue; }
            getData() { return this.selectedData; }

            setValue(value) {
                const opt = this.options.find(o => String(o.value) === String(value));
                if (opt) this._select(opt);
            }

            reset() { this._select(null); }
        }

        // Close all dropdowns when clicking outside
        document.addEventListener('click', () => {
            document.querySelectorAll('.searchable-dropdown').forEach(el => {
                if (el._sdInstance) el._sdInstance.close();
            });
        });

        // ========================================
        // APP STATE
        // ========================================
        let customers = [];
        let brands = [];
        let categories = [];
        let products = [];
        let allProducts = [];
        let selectedCustomer = null;
        let selectedProduct = null;
        let estimateItems = [];
        let itemIdCounter = 1;

        // Dropdown instances
        let customerDD, brandDD, categoryDD, productDD;

        // ========================================
        // INIT SEARCHABLE DROPDOWNS
        // ========================================
        function initDropdowns() {
            customerDD = new SearchableDropdown('customerDropdown', {
                placeholder: '-- Select Customer --',
                searchPlaceholder: 'Search by name or phone...',
                onSelect: onCustomerSelected
            });
            document.getElementById('customerDropdown')._sdInstance = customerDD;

            brandDD = new SearchableDropdown('brandDropdown', {
                placeholder: '-- Select Brand --',
                searchPlaceholder: 'Search brands...',
                onSelect: onBrandSelected
            });
            document.getElementById('brandDropdown')._sdInstance = brandDD;

            categoryDD = new SearchableDropdown('categoryDropdown', {
                placeholder: '-- Select Category --',
                searchPlaceholder: 'Search categories...',
                onSelect: onCategorySelected
            });
            document.getElementById('categoryDropdown')._sdInstance = categoryDD;

            productDD = new SearchableDropdown('productDropdown', {
                placeholder: '-- Select Product --',
                searchPlaceholder: 'Search products...',
                onSelect: onProductSelected
            });
            document.getElementById('productDropdown')._sdInstance = productDD;
        }

        // ========================================
        // DROPDOWN CALLBACKS
        // ========================================
        function onCustomerSelected(value, data) {
            if (value && data) {
                selectedCustomer = data;
                document.getElementById('custName').textContent = data.name;
                document.getElementById('custPhone').textContent = data.phone || '-';
                document.getElementById('custEmail').textContent = data.email || '-';
                document.getElementById('custAddress').textContent = data.address || '-';
                document.getElementById('customerDetails').classList.remove('hidden');
            } else {
                selectedCustomer = null;
                document.getElementById('customerDetails').classList.add('hidden');
            }
        }

        function onBrandSelected(value, data) {
            // Reset dependent dropdowns
            categoryDD.setOptions([]);
            categoryDD.reset();
            productDD.setOptions([]);
            productDD.reset();
            selectedProduct = null;
            document.getElementById('productTypeSection').classList.add('hidden');
            document.getElementById('unitTypeInputs').classList.add('hidden');
            document.getElementById('areaTypeInputs').classList.add('hidden');
            document.getElementById('areaCalculation').classList.add('hidden');

            if (!value) return;
            loadCategories();
        }

        function onCategorySelected(value, data) {
            // Reset product dropdown
            productDD.setOptions([]);
            productDD.reset();
            selectedProduct = null;
            document.getElementById('productTypeSection').classList.add('hidden');
            document.getElementById('unitTypeInputs').classList.add('hidden');
            document.getElementById('areaTypeInputs').classList.add('hidden');
            document.getElementById('areaCalculation').classList.add('hidden');

            if (!value) return;
            loadProducts();
        }

        function onProductSelected(value, data) {
            document.getElementById('productTypeSection').classList.add('hidden');
            document.getElementById('unitTypeInputs').classList.add('hidden');
            document.getElementById('areaTypeInputs').classList.add('hidden');
            document.getElementById('areaCalculation').classList.add('hidden');

            if (!value || !data) {
                selectedProduct = null;
                return;
            }
            selectedProduct = data;
            loadProductDetails();
        }

        // ========================================
        // DATA LOADING
        // ========================================
        async function loadInitialData() {
            try {
                const [custRes, branchRes, brandRes, prodRes] = await Promise.all([
                    apiRequest('/api/customers'),
                    apiRequest('/api/branches/list'),
                    apiRequest('/api/brands'),
                    apiRequest('/api/products')
                ]);

                // Customers
                customers = await custRes.json();
                customerDD.setOptions(customers.map(c => ({
                    value: c.id,
                    label: `${c.name} (${c.phone || 'No phone'})`,
                    data: c
                })));

                // Branches for new customer modal
                const branchData = await branchRes.json();
                const branches = branchData.data || branchData;
                document.getElementById('newCustBranch').innerHTML = '<option value="">-- Select --</option>' +
                    branches.map(b => `<option value="${b.id}">${b.name}</option>`).join('');

                // Brands
                brands = await brandRes.json();
                brandDD.setOptions(brands.map(b => ({
                    value: b.id,
                    label: b.name,
                    data: b
                })));

                // All products (for filtering by brand+category)
                allProducts = await prodRes.json();
            } catch (error) {
                console.error('Error loading data:', error);
                alert('Failed to load data. Please ensure you are logged in.');
            }
        }

        // Load categories (uses apiRequest for auth)
        async function loadCategories() {
            const brandId = brandDD.getValue();
            if (!brandId) {
                categoryDD.setOptions([]);
                return;
            }

            try {
                const res = await apiRequest('/api/categories');
                categories = await res.json();
                categoryDD.setOptions(categories.map(c => ({
                    value: c.id,
                    label: c.name,
                    data: c
                })));
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        // Load products based on brand + category (filter from cached list)
        function loadProducts() {
            const brandId = brandDD.getValue();
            const categoryId = categoryDD.getValue();

            if (!brandId || !categoryId) {
                productDD.setOptions([]);
                return;
            }

            products = allProducts.filter(p =>
                p.brand_id == brandId && p.category_id == categoryId
            );

            productDD.setOptions(products.map(p => ({
                value: p.id,
                label: p.name,
                data: p
            })));
        }

        // Show product type section and pack sizes
        function loadProductDetails() {
            if (!selectedProduct) return;

            document.getElementById('productTypeSection').classList.remove('hidden');

            if (selectedProduct.product_type === 'area_wise' && selectedProduct.area_coverage > 0) {
                document.getElementById('areaTypeOption').classList.remove('hidden');
            } else {
                document.getElementById('areaTypeOption').classList.add('hidden');
                document.querySelector('input[name="productType"][value="unit"]').checked = true;
            }

            switchProductType();
        }

        // Switch between unit and area type
        function switchProductType() {
            const type = document.querySelector('input[name="productType"]:checked').value;

            if (type === 'unit') {
                document.getElementById('unitTypeInputs').classList.remove('hidden');
                document.getElementById('areaTypeInputs').classList.add('hidden');
                document.getElementById('areaCalculation').classList.add('hidden');
                loadPackSizes();
            } else {
                document.getElementById('unitTypeInputs').classList.add('hidden');
                document.getElementById('areaTypeInputs').classList.remove('hidden');
                document.getElementById('areaCoverage').value = selectedProduct.area_coverage || 0;
                calculateAreaWise();
            }
        }

        // Load pack sizes into regular select
        function loadPackSizes() {
            if (!selectedProduct || !selectedProduct.available_sizes) return;

            try {
                const packSizes = JSON.parse(selectedProduct.available_sizes);
                document.getElementById('packSizeSelect').innerHTML = '<option value="">-- Select Pack Size --</option>' +
                    packSizes.map((ps, idx) =>
                        `<option value="${idx}" data-pack='${JSON.stringify(ps)}'>${ps.size}L - ₹${parseFloat(ps.price).toFixed(2)}</option>`
                    ).join('');
            } catch (e) {
                console.error('Error parsing pack sizes:', e);
            }
        }

        // ========================================
        // AREA CALCULATION
        // ========================================
        function calculateAreaWise() {
            const squareFeet = parseFloat(document.getElementById('squareFeet').value) || 0;
            const coats = parseFloat(document.getElementById('coatsNumber').value) || 1;
            const coverage = parseFloat(selectedProduct.area_coverage) || 0;

            if (squareFeet <= 0 || coverage <= 0) {
                document.getElementById('areaCalculation').classList.add('hidden');
                return;
            }

            const totalLiters = (squareFeet * coats) / coverage;
            const packSizes = JSON.parse(selectedProduct.available_sizes || '[]');
            if (packSizes.length === 0) return;

            const result = findOptimalPackCombination(totalLiters, packSizes);

            document.getElementById('totalLiters').textContent = totalLiters.toFixed(2) + 'L';
            document.getElementById('packCombo').textContent = result.breakdown;
            document.getElementById('areaPrice').textContent = '₹' + result.totalPrice.toFixed(2);
            document.getElementById('areaCalculation').classList.remove('hidden');
        }

        function findOptimalPackCombination(litersNeeded, packSizes) {
            const sorted = [...packSizes].sort((a, b) => b.size - a.size);

            let remaining = litersNeeded;
            let combination = [];
            let totalPrice = 0;

            for (let pack of sorted) {
                if (remaining >= pack.size) {
                    const quantity = Math.floor(remaining / pack.size);
                    combination.push({ size: pack.size, quantity, price: pack.price });
                    totalPrice += quantity * pack.price;
                    remaining -= quantity * pack.size;
                }
            }

            if (remaining > 0) {
                const smallestPack = sorted[sorted.length - 1];
                const additionalPacks = Math.ceil(remaining / smallestPack.size);
                combination.push({ size: smallestPack.size, quantity: additionalPacks, price: smallestPack.price });
                totalPrice += additionalPacks * smallestPack.price;
            }

            return {
                combination,
                breakdown: combination.map(c => `${c.quantity}×${c.size}L`).join(' + '),
                totalPrice
            };
        }

        // ========================================
        // ADD / REMOVE ITEMS
        // ========================================
        function addProductToEstimate() {
            if (!selectedCustomer) {
                alert('Please select a customer first');
                return;
            }
            if (!selectedProduct) {
                alert('Please select a product');
                return;
            }

            const type = document.querySelector('input[name="productType"]:checked').value;
            let item = {
                id: itemIdCounter++,
                product_id: selectedProduct.id,
                product_name: selectedProduct.name,
                type: type
            };

            if (type === 'unit') {
                const packIdx = document.getElementById('packSizeSelect').value;
                const quantity = parseFloat(document.getElementById('unitQuantity').value) || 1;

                if (packIdx === '') {
                    alert('Please select pack size');
                    return;
                }

                const packSizes = JSON.parse(selectedProduct.available_sizes);
                const pack = packSizes[packIdx];

                item.details = `${pack.size}L pack`;
                item.quantity = quantity;
                item.unit_price = pack.price;
                item.total = quantity * pack.price;
            } else {
                const squareFeet = parseFloat(document.getElementById('squareFeet').value);
                const coats = parseFloat(document.getElementById('coatsNumber').value);
                const totalLiters = parseFloat(document.getElementById('totalLiters').textContent);
                const packCombo = document.getElementById('packCombo').textContent;
                const totalPrice = parseFloat(document.getElementById('areaPrice').textContent.replace('₹', '').replace(',', ''));

                item.details = `${squareFeet} sq.ft × ${coats} coats = ${totalLiters}L (${packCombo})`;
                item.quantity = totalLiters;
                item.unit_price = totalPrice / totalLiters;
                item.total = totalPrice;
            }

            estimateItems.push(item);
            renderEstimateTable();

            // Reset product selection
            productDD.reset();
            selectedProduct = null;
            document.getElementById('productTypeSection').classList.add('hidden');
            document.getElementById('unitTypeInputs').classList.add('hidden');
            document.getElementById('areaTypeInputs').classList.add('hidden');
            document.getElementById('areaCalculation').classList.add('hidden');
        }

        function renderEstimateTable() {
            const tbody = document.getElementById('itemsTableBody');

            if (estimateItems.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-gray-500">No items added yet</td></tr>';
                updateTotals();
                return;
            }

            tbody.innerHTML = estimateItems.map((item, idx) => `
                <tr>
                    <td class="px-4 py-3">${idx + 1}</td>
                    <td class="px-4 py-3 font-semibold">${item.product_name}</td>
                    <td class="px-4 py-3">${item.type === 'unit' ? 'Unit' : 'Area'}</td>
                    <td class="px-4 py-3 text-sm">${item.details}</td>
                    <td class="px-4 py-3 text-right">${item.quantity.toFixed(2)}</td>
                    <td class="px-4 py-3 text-right">₹${item.unit_price.toFixed(2)}</td>
                    <td class="px-4 py-3 text-right font-semibold">₹${item.total.toFixed(2)}</td>
                    <td class="px-4 py-3 text-center">
                        <button onclick="removeItem(${item.id})" class="text-red-600 hover:text-red-800">Remove</button>
                    </td>
                </tr>
            `).join('');

            updateTotals();
        }

        function removeItem(itemId) {
            estimateItems = estimateItems.filter(item => item.id !== itemId);
            renderEstimateTable();
        }

        function updateTotals() {
            const grandTotal = estimateItems.reduce((sum, item) => sum + item.total, 0);
            const gst = grandTotal - (grandTotal / 1.18);
            const subtotal = grandTotal - gst;

            document.getElementById('subtotal').textContent = '₹' + subtotal.toFixed(2);
            document.getElementById('gstAmount').textContent = '₹' + gst.toFixed(2);
            document.getElementById('grandTotal').textContent = '₹' + grandTotal.toFixed(2);
        }

        // ========================================
        // SAVE ESTIMATE
        // ========================================
        async function saveEstimate() {
            if (!selectedCustomer) {
                alert('❌ Please select a customer');
                return;
            }

            if (estimateItems.length === 0) {
                alert('❌ Please add at least one product');
                return;
            }

            const grandTotal = estimateItems.reduce((sum, item) => sum + item.total, 0);
            const gst = grandTotal - (grandTotal / 1.18);
            const subtotal = grandTotal - gst;

            const apiItems = estimateItems.map((item, idx) => ({
                product_id: item.product_id,
                item_description: item.product_name,
                quantity: item.quantity,
                area: item.type === 'area' ? item.quantity : null,
                mix_info: item.details,
                unit_price: item.unit_price,
                price_breakdown: item.type,
                color_cost: 0,
                line_total: item.total,
                display_order: idx + 1
            }));

            const estimateData = {
                customer_name: selectedCustomer.name,
                customer_phone: selectedCustomer.phone,
                customer_address: selectedCustomer.address,
                estimate_date: new Date().toISOString().split('T')[0],
                subtotal: subtotal,
                gst_amount: gst,
                grand_total: grandTotal,
                show_gst_breakdown: true,
                notes: '',
                status: 'draft',
                items: apiItems
            };

            try {
                const response = await apiRequest('/api/estimates', {
                    method: 'POST',
                    body: JSON.stringify(estimateData)
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    const urlParams = new URLSearchParams(window.location.search);
                    const requestId = urlParams.get('from_request');

                    if (requestId) {
                        await markRequestAsConverted(requestId, result.id || result.estimate_id);
                    }

                    alert('✅ Estimate created successfully! Estimate #' + (result.estimate_number || result.id));
                    window.location.href = 'estimates.html';
                } else {
                    const errorMsg = result.message || result.error || 'Unknown error occurred';
                    console.error('Save estimate error:', result);
                    alert(`❌ Failed to save estimate: ${errorMsg}`);
                }
            } catch (error) {
                console.error('Error saving estimate:', error);
                alert(`❌ Error saving estimate: ${error.message}`);
            }
        }

        // ========================================
        // NEW CUSTOMER MODAL
        // ========================================
        function openNewCustomerModal() {
            document.getElementById('newCustomerModal').classList.remove('hidden');
        }

        function closeNewCustomerModal() {
            document.getElementById('newCustomerModal').classList.add('hidden');
        }

        async function createCustomer(event) {
            event.preventDefault();

            const customerData = {
                name: document.getElementById('newCustName').value,
                phone: document.getElementById('newCustPhone').value,
                email: document.getElementById('newCustEmail').value || null,
                address: document.getElementById('newCustAddress').value || null,
                branch_id: document.getElementById('newCustBranch').value,
                status: 'approved'
            };

            try {
                const response = await apiRequest('/api/customers', {
                    method: 'POST',
                    body: JSON.stringify(customerData)
                });

                if (response.ok) {
                    const result = await response.json();
                    alert('Customer created successfully!');
                    closeNewCustomerModal();

                    // Clear modal form
                    document.getElementById('newCustName').value = '';
                    document.getElementById('newCustPhone').value = '';
                    document.getElementById('newCustEmail').value = '';
                    document.getElementById('newCustAddress').value = '';

                    // Reload customers into dropdown and auto-select the new one
                    const custRes = await apiRequest('/api/customers');
                    customers = await custRes.json();
                    customerDD.setOptions(customers.map(c => ({
                        value: c.id,
                        label: `${c.name} (${c.phone || 'No phone'})`,
                        data: c
                    })));

                    const newId = result.id || result.customer_id;
                    if (newId) customerDD.setValue(String(newId));
                } else {
                    const err = await response.json();
                    alert('Failed to create customer: ' + (err.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error creating customer');
            }
        }

        // ========================================
        // PRE-FILL FROM REQUEST
        // ========================================
        async function markRequestAsConverted(requestId, estimateId) {
            try {
                console.log('Marking request as converted:', requestId, '→', estimateId);

                const response = await apiRequest(`/api/estimate-requests/${requestId}`, {
                    method: 'PATCH',
                    body: JSON.stringify({
                        status: 'quote_sent',
                        estimate_id: estimateId
                    })
                });

                if (response.ok) {
                    console.log('Request marked as converted');
                } else {
                    console.warn('Could not update request status');
                }
            } catch (error) {
                console.error('Error marking request:', error);
            }
        }

        async function prefillFromRequest() {
            const urlParams = new URLSearchParams(window.location.search);
            const requestId = urlParams.get('from_request');

            if (!requestId) return;

            try {
                console.log('Pre-filling from request ID:', requestId);

                const loadingDiv = document.createElement('div');
                loadingDiv.id = 'prefillLoading';
                loadingDiv.className = 'fixed top-20 right-4 bg-blue-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
                loadingDiv.textContent = 'Loading request data...';
                document.body.appendChild(loadingDiv);

                const reqRes = await apiRequest(`/api/estimate-requests/${requestId}`);
                const reqResult = await reqRes.json();

                if (!reqResult.success) {
                    throw new Error('Failed to load request');
                }

                const request = reqResult.data;
                console.log('Request data loaded:', request);

                let customer = await findOrCreateCustomer(request);
                console.log('Customer ready:', customer);

                // Reload customers to include any new one
                const custRes = await apiRequest('/api/customers');
                customers = await custRes.json();
                customerDD.setOptions(customers.map(c => ({
                    value: c.id,
                    label: `${c.name} (${c.phone || 'No phone'})`,
                    data: c
                })));

                await new Promise(resolve => setTimeout(resolve, 300));
                customerDD.setValue(String(customer.id));

                // Pre-fill products
                if (request.products_json) {
                    loadingDiv.textContent = 'Adding products...';
                    const productsData = JSON.parse(request.products_json);

                    for (const item of productsData.items) {
                        await addProductFromRequest(item);
                        await new Promise(resolve => setTimeout(resolve, 300));
                    }

                    console.log(`Added ${productsData.items.length} products`);
                }

                loadingDiv.className = 'fixed top-20 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
                loadingDiv.textContent = `Pre-filled from request ${request.request_number}`;
                setTimeout(() => loadingDiv.remove(), 3000);

            } catch (error) {
                console.error('Error pre-filling:', error);
                const loadingDiv = document.getElementById('prefillLoading');
                if (loadingDiv) {
                    loadingDiv.className = 'fixed top-20 right-4 bg-red-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
                    loadingDiv.textContent = 'Error loading request data';
                    setTimeout(() => loadingDiv.remove(), 3000);
                }
            }
        }

        async function findOrCreateCustomer(request) {
            const searchRes = await apiRequest(`/api/customers?search=${request.phone}`);
            const custList = await searchRes.json();
            const existing = custList.find(c => c.phone === request.phone);

            if (existing) {
                console.log('Found existing customer:', existing.name);
                return existing;
            }

            console.log('Creating new customer:', request.customer_name);

            const customerData = {
                name: request.customer_name,
                phone: request.phone,
                email: request.email || null,
                address: request.location || null,
                branch_id: 1,
                status: 'approved'
            };

            const createRes = await apiRequest('/api/customers', {
                method: 'POST',
                body: JSON.stringify(customerData)
            });

            const result = await createRes.json();

            return {
                id: result.id || result.customer_id,
                name: request.customer_name,
                phone: request.phone,
                email: request.email,
                address: request.location
            };
        }

        async function addProductFromRequest(item) {
            try {
                console.log('Adding product:', item.product_name);

                const prodRes = await apiRequest(`/api/products/${item.product_id}`);
                const product = await prodRes.json();

                if (!product || !product.id) {
                    console.warn('Product not found:', item.product_id);
                    return;
                }

                selectedProduct = product;

                let estimateItem = {
                    id: itemIdCounter++,
                    product_id: product.id,
                    product_name: product.name,
                    type: item.type
                };

                if (item.type === 'unit') {
                    const packSizes = JSON.parse(product.available_sizes);
                    const packIdx = packSizes.findIndex(p => parseFloat(p.size) === parseFloat(item.pack_size));
                    const pack = packSizes[packIdx >= 0 ? packIdx : 0];

                    estimateItem.details = `${pack.size}L pack`;
                    estimateItem.quantity = item.quantity;
                    estimateItem.unit_price = pack.price;
                    estimateItem.total = item.quantity * pack.price;
                } else {
                    const coverage = parseFloat(product.area_coverage) || 120;
                    const liters = item.liters || (item.sqft * item.coats) / coverage;
                    const packSizes = JSON.parse(product.available_sizes);
                    const result = findOptimalPackCombination(liters, packSizes);

                    estimateItem.details = `${item.sqft} sq.ft × ${item.coats} coats = ${liters.toFixed(2)}L (${result.breakdown})`;
                    estimateItem.quantity = liters;
                    estimateItem.unit_price = result.totalPrice / liters;
                    estimateItem.total = result.totalPrice;
                }

                estimateItems.push(estimateItem);
                console.log('Product added to estimate');

            } catch (error) {
                console.error('Error adding product:', error);
            }
        }

        // ========================================
        // INITIALIZE
        // ========================================
        async function init() {
            initDropdowns();
            await loadInitialData();
            await prefillFromRequest();

            if (estimateItems.length > 0) {
                renderEstimateTable();
            }
        }

        init();
    </script>
</body>
</html>
