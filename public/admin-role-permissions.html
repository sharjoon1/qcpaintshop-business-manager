<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Role Permissions - Quality Colours</title>
    <script src="/js/auth-helper.js"></script>
    <script>checkAuthOrRedirect();</script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/universal-nav-loader.js"></script>
</head>
<body class="bg-gray-50">
    <!-- Simplified Header for this page -->
    <div class="bg-gradient-to-r from-purple-600 to-indigo-600 shadow-lg">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <a href="/admin-roles.html" class="text-white hover:text-purple-200 transition">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                        </svg>
                    </a>
                    <div>
                        <h1 class="text-white text-xl font-bold">Edit Role Permissions</h1>
                        <p class="text-purple-100 text-sm" id="roleName">Loading...</p>
                    </div>
                </div>
                <button onclick="savePermissions()" class="bg-white text-purple-600 px-6 py-2 rounded-lg hover:bg-purple-50 transition shadow-lg font-semibold">
                    Save Permissions
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 py-6">
        
        <!-- Permission Summary -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-lg font-bold text-gray-800">Permission Summary</h2>
                    <p class="text-sm text-gray-600">Total Permissions: <span id="totalPermissions" class="font-semibold">0</span></p>
                </div>
                <div>
                    <p class="text-sm text-gray-600">Selected: <span id="selectedCount" class="font-semibold text-purple-600">0</span> / <span id="availableCount">0</span></p>
                </div>
            </div>
        </div>

        <!-- Search and Filters -->
        <div class="bg-white rounded-lg shadow-md p-4 mb-6">
            <div class="flex gap-4 items-center">
                <input type="text" id="searchPermissions" placeholder="Search permissions..." class="flex-1 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600">
                <button onclick="selectAll()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                    Select All
                </button>
                <button onclick="deselectAll()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition">
                    Deselect All
                </button>
            </div>
        </div>

        <!-- Permissions by Module -->
        <div id="permissionsContainer" class="space-y-4">
            <!-- Loading state -->
            <div class="text-center py-12">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mx-auto"></div>
                <p class="text-gray-600 mt-4">Loading permissions...</p>
            </div>
        </div>

    </div>

    <script>
// Get role ID from URL (check both 'role' and 'role_id' parameters)
const urlParams = new URLSearchParams(window.location.search);
const roleId = urlParams.get('role_id') || urlParams.get('role');

if (!roleId) {
    alert('âŒ No role specified');
    window.location.href = '/admin-roles.html';
    throw new Error('No role ID provided');
}

// Global state
let allPermissions = {};
let rolePermissions = [];
let selectedPermissions = new Set();

// Module icons
const moduleIcons = {
    'estimates': 'ðŸ“',
    'products': 'ðŸ“¦',
    'customers': 'ðŸ‘¥',
    'staff': 'ðŸ‘¨â€ðŸ’¼',
    'branches': 'ðŸª',
    'brands': 'ðŸ·ï¸',
    'categories': 'ðŸ“‚',
    'reports': 'ðŸ“Š',
    'settings': 'âš™ï¸',
    'roles': 'ðŸ”',
    'leads': 'ðŸŽ¯',
    'marketing': 'ðŸ“¢'
};

// Load role details and permissions
async function loadRoleDetails() {
    try {
        const response = await fetch(`/api/roles/${roleId}`);
        const data = await response.json();
        
        if (data.success) {
            const role = data.data;
            document.getElementById('roleName').textContent = role.display_name;
            document.title = `Permissions: ${role.display_name} - Quality Colours`;
            
            // Store current permissions
            rolePermissions = role.permissions.map(p => p.id);
            selectedPermissions = new Set(rolePermissions);
        } else {
            showNotification('Failed to load role details', 'error');
        }
    } catch (error) {
        console.error('Error loading role:', error);
        showNotification('Error loading role: ' + error.message, 'error');
    }
}

// Load all permissions
async function loadAllPermissions() {
    try {
        const response = await fetch('/api/roles/permissions/by-module');
        const data = await response.json();
        
        if (data.success) {
            allPermissions = data.data;
            displayPermissions();
        } else {
            showNotification('Failed to load permissions', 'error');
        }
    } catch (error) {
        console.error('Error loading permissions:', error);
        showNotification('Error loading permissions: ' + error.message, 'error');
    }
}

// Display permissions grouped by module
function displayPermissions() {
    const container = document.getElementById('permissionsContainer');
    const modules = Object.keys(allPermissions).sort();
    
    let totalPerms = 0;
    modules.forEach(module => {
        totalPerms += allPermissions[module].length;
    });
    
    document.getElementById('totalPermissions').textContent = totalPerms;
    document.getElementById('availableCount').textContent = totalPerms;
    updateSelectedCount();
    
    container.innerHTML = modules.map(module => {
        const permissions = allPermissions[module];
        const icon = moduleIcons[module] || 'ðŸ“‹';
        const moduleName = module.charAt(0).toUpperCase() + module.slice(1).replace(/_/g, ' ');
        
        return `
            <div class="bg-white rounded-lg shadow-md overflow-hidden module-section" data-module="${module}">
                <div class="bg-gradient-to-r from-purple-50 to-indigo-50 p-4 border-b border-purple-200">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                            <span>${icon}</span>
                            <span>${moduleName}</span>
                            <span class="text-sm font-normal text-gray-600">(${permissions.length} permissions)</span>
                        </h3>
                        <div class="flex gap-2">
                            <button onclick="selectModule('${module}')" class="text-sm text-purple-600 hover:text-purple-700 font-semibold">
                                Select All
                            </button>
                            <span class="text-gray-400">|</span>
                            <button onclick="deselectModule('${module}')" class="text-sm text-gray-600 hover:text-gray-700 font-semibold">
                                Deselect All
                            </button>
                        </div>
                    </div>
                </div>
                <div class="p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    ${permissions.map(perm => `
                        <label class="flex items-start gap-3 p-3 rounded-lg hover:bg-gray-50 cursor-pointer permission-item" data-permission-id="${perm.id}" data-search-text="${perm.display_name.toLowerCase()} ${perm.description.toLowerCase()}">
                            <input type="checkbox" 
                                   class="permission-checkbox mt-1" 
                                   data-permission-id="${perm.id}"
                                   data-module="${module}"
                                   ${selectedPermissions.has(perm.id) ? 'checked' : ''}
                                   onchange="togglePermission(${perm.id}, this.checked)">
                            <div class="flex-1">
                                <p class="font-semibold text-gray-800 text-sm">${perm.display_name}</p>
                                <p class="text-xs text-gray-600 mt-1">${perm.description}</p>
                            </div>
                        </label>
                    `).join('')}
                </div>
            </div>
        `;
    }).join('');
}

// Toggle permission
function togglePermission(permId, checked) {
    if (checked) {
        selectedPermissions.add(permId);
    } else {
        selectedPermissions.delete(permId);
    }
    updateSelectedCount();
}

// Update selected count
function updateSelectedCount() {
    document.getElementById('selectedCount').textContent = selectedPermissions.size;
}

// Select module
function selectModule(module) {
    const perms = allPermissions[module];
    perms.forEach(perm => {
        selectedPermissions.add(perm.id);
        const checkbox = document.querySelector(`input[data-permission-id="${perm.id}"]`);
        if (checkbox) checkbox.checked = true;
    });
    updateSelectedCount();
}

// Deselect module
function deselectModule(module) {
    const perms = allPermissions[module];
    perms.forEach(perm => {
        selectedPermissions.delete(perm.id);
        const checkbox = document.querySelector(`input[data-permission-id="${perm.id}"]`);
        if (checkbox) checkbox.checked = false;
    });
    updateSelectedCount();
}

// Select all
function selectAll() {
    Object.values(allPermissions).flat().forEach(perm => {
        selectedPermissions.add(perm.id);
        const checkbox = document.querySelector(`input[data-permission-id="${perm.id}"]`);
        if (checkbox) checkbox.checked = true;
    });
    updateSelectedCount();
}

// Deselect all
function deselectAll() {
    selectedPermissions.clear();
    document.querySelectorAll('.permission-checkbox').forEach(checkbox => {
        checkbox.checked = false;
    });
    updateSelectedCount();
}

// Search permissions
document.addEventListener('DOMContentLoaded', () => {
    const searchInput = document.getElementById('searchPermissions');
    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            
            document.querySelectorAll('.permission-item').forEach(item => {
                const searchText = item.getAttribute('data-search-text');
                if (searchText.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
            
            // Hide modules with no visible permissions
            document.querySelectorAll('.module-section').forEach(section => {
                const visibleItems = section.querySelectorAll('.permission-item[style*="display: flex"], .permission-item:not([style*="display: none"])');
                if (visibleItems.length === 0 && searchTerm) {
                    section.style.display = 'none';
                } else {
                    section.style.display = 'block';
                }
            });
        });
    }
});

// Save permissions
async function savePermissions() {
    const permissionIds = Array.from(selectedPermissions);
    
    // Show loading
    const saveButton = document.querySelector('button[onclick="savePermissions()"]');
    const originalText = saveButton.textContent;
    saveButton.textContent = 'Saving...';
    saveButton.disabled = true;
    
    try {
        const response = await fetch(`/api/roles/${roleId}/permissions`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ permission_ids: permissionIds })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification(`Permissions saved successfully! (${permissionIds.length} permissions assigned)`, 'success');
            
            // Redirect back after 1.5 seconds
            setTimeout(() => {
                window.location.href = '/admin-roles.html';
            }, 1500);
        } else {
            showNotification(result.error || 'Failed to save permissions', 'error');
            saveButton.textContent = originalText;
            saveButton.disabled = false;
        }
    } catch (error) {
        console.error('Error saving permissions:', error);
        showNotification('Error saving permissions: ' + error.message, 'error');
        saveButton.textContent = originalText;
        saveButton.disabled = false;
    }
}

// Show notification
function showNotification(message, type = 'info') {
    const colors = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        info: 'bg-blue-500'
    };
    
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-opacity`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// Initialize
async function init() {
    await loadRoleDetails();
    await loadAllPermissions();
}

init();
    </script>
</body>
</html>
