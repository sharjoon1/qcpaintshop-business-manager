<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1B5E3B">
    <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192x192.png">
    <title>Edit Profile - Quality Colours</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/js/painter-i18n.js"></script>
    <style>
        *, *::before, *::after { box-sizing: border-box; }
        html, body { max-width: 100vw; overflow-x: hidden; }
        body { background: #f9fafb; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; padding-bottom: 160px; }
        .header { background: linear-gradient(135deg, #1B5E3B, #D4A24E); color: #fff; }
        .section-card { background: #fff; border-radius: 12px; border: 1px solid #e8ecf1; overflow: hidden; }
        .section-header { padding: 1rem 1.25rem; border-bottom: 1px solid #f1f5f9; font-weight: 600; font-size: 0.9375rem; display: flex; align-items: center; gap: 0.5rem; }
        .section-header svg { width: 18px; height: 18px; stroke: #1B5E3B; fill: none; stroke-width: 2; }
        .section-body { padding: 1rem 1.25rem; }
        .form-group { margin-bottom: 1rem; }
        .form-group:last-child { margin-bottom: 0; }
        .form-label { display: block; font-size: 0.8125rem; font-weight: 500; color: #374151; margin-bottom: 0.375rem; }
        .form-input {
            width: 100%; padding: 0.625rem 0.875rem; border: 1px solid #e5e7eb; border-radius: 0.5rem;
            font-size: 0.9375rem; color: #111827; background: #fff; transition: all 0.2s;
            outline: none; -webkit-appearance: none;
        }
        .form-input:focus { border-color: #1B5E3B; box-shadow: 0 0 0 2px rgba(27,94,59,0.15); }
        .form-input[readonly], .form-input[disabled] {
            background: #f9fafb; color: #6b7280; cursor: not-allowed; border-color: #e5e7eb;
        }
        .form-input[readonly]:focus, .form-input[disabled]:focus { box-shadow: none; border-color: #e5e7eb; }
        textarea.form-input { resize: vertical; min-height: 80px; }
        select.form-input { cursor: pointer; }

        /* Avatar */
        .avatar-wrapper { position: relative; width: 88px; height: 88px; margin: 0 auto; }
        .avatar-circle {
            width: 88px; height: 88px; border-radius: 50%; overflow: hidden;
            border: 3px solid rgba(255,255,255,0.5); cursor: pointer; transition: transform 0.2s;
            display: flex; align-items: center; justify-content: center;
        }
        .avatar-circle:hover { transform: scale(1.05); }
        .avatar-circle img { width: 100%; height: 100%; object-fit: cover; }
        .avatar-initials {
            width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;
            background: #D4A24E; color: #fff; font-size: 1.75rem; font-weight: 700;
        }
        .avatar-camera {
            position: absolute; bottom: 0; right: 0; width: 28px; height: 28px; border-radius: 50%;
            background: #D4A24E; border: 2px solid #fff; display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: transform 0.2s; box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        .avatar-camera:hover { transform: scale(1.1); }
        .avatar-camera svg { width: 14px; height: 14px; stroke: #fff; fill: none; stroke-width: 2; }

        /* Referral code display */
        .referral-display {
            background: linear-gradient(135deg, #f0fdf4, #fefce8); border: 2px dashed #1B5E3B;
            border-radius: 10px; padding: 0.875rem; text-align: center;
        }
        .referral-display code { font-size: 1.25rem; font-weight: 800; color: #1B5E3B; letter-spacing: 2px; }

        /* Save button */
        .save-bar {
            position: fixed; bottom: 64px; left: 0; right: 0; z-index: 40;
            padding: 0.75rem 1rem; background: #fff; border-top: 1px solid #e5e7eb;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }
        .save-btn {
            width: 100%; max-width: 480px; margin: 0 auto; display: block;
            padding: 0.75rem; border-radius: 0.75rem; border: none; cursor: pointer;
            font-size: 1rem; font-weight: 600; color: #fff; background: #D4A24E;
            transition: all 0.2s; box-shadow: 0 2px 8px rgba(212,162,78,0.3);
        }
        .save-btn:hover { background: #c89540; transform: translateY(-1px); }
        .save-btn:active { transform: translateY(0); }
        .save-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

        /* Bottom nav */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: #fff; border-top: 1px solid #e5e7eb; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 50; }
        .bottom-nav a { display: flex; flex-direction: column; align-items: center; padding: 6px 0; text-decoration: none; transition: color 0.15s; min-width: 0; }
        .bottom-nav a svg { width: 24px; height: 24px; stroke-width: 1.5; fill: none; }
        .bottom-nav a span { font-size: 0.625rem; margin-top: 2px; font-weight: 500; white-space: nowrap; }
        .bottom-nav a.active { color: #1B5E3B; }
        .bottom-nav a:not(.active) { color: #9ca3af; }
        .bottom-nav a:not(.active):hover { color: #6b7280; }

        /* Upload spinner overlay */
        .avatar-loading {
            position: absolute; inset: 0; border-radius: 50%; background: rgba(0,0,0,0.4);
            display: flex; align-items: center; justify-content: center;
        }
        .spinner { width: 24px; height: 24px; border: 3px solid rgba(255,255,255,0.3); border-top-color: #fff; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="max-w-lg mx-auto px-4 pt-4 pb-16">
            <div class="flex items-center gap-3 mb-6">
                <a href="/painter-dashboard.html" class="p-1 hover:bg-white/20 rounded-lg transition-colors">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M19 12H5"/><polyline points="12 19 5 12 12 5"/>
                    </svg>
                </a>
                <h1 class="text-lg font-bold" data-i18n="profile.edit_profile">Edit Profile</h1>
                <div class="flex-1"></div>
                <button id="langToggle" onclick="painterI18n.toggleLanguage()" class="text-sm font-semibold bg-white/20 hover:bg-white/30 rounded-lg px-2.5 py-1 transition-colors backdrop-blur-sm">
                    EN
                </button>
            </div>

            <!-- Avatar -->
            <div class="avatar-wrapper" id="avatarWrapper">
                <div class="avatar-circle" onclick="document.getElementById('photoInput').click()">
                    <div class="avatar-initials" id="avatarInitials">?</div>
                    <img id="avatarImg" src="" alt="" style="display:none" onerror="this.style.display='none'; document.getElementById('avatarInitials').style.display='flex';">
                </div>
                <div class="avatar-camera" onclick="document.getElementById('photoInput').click()">
                    <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/>
                        <circle cx="12" cy="13" r="4"/>
                    </svg>
                </div>
                <input type="file" id="photoInput" accept="image/*" style="display:none">
            </div>
            <p class="text-center text-sm opacity-80 mt-2" id="painterNameHeader">Painter</p>
        </div>
    </div>

    <!-- Main Content (overlaps header slightly) -->
    <div class="max-w-lg mx-auto px-4 -mt-8">

        <!-- Personal Info -->
        <div class="section-card mb-4">
            <div class="section-header">
                <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/>
                    <circle cx="12" cy="7" r="4"/>
                </svg>
                <span data-i18n="profile.personal_info">Personal Information</span>
            </div>
            <div class="section-body">
                <div class="form-group">
                    <label class="form-label" data-i18n="profile.full_name">Full Name</label>
                    <input type="text" id="fieldName" class="form-input" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label" data-i18n="profile.phone">Phone</label>
                    <input type="text" id="fieldPhone" class="form-input" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label" data-i18n="profile.email">Email</label>
                    <input type="email" id="fieldEmail" class="form-input" placeholder="your@email.com">
                </div>
            </div>
        </div>

        <!-- Work Info -->
        <div class="section-card mb-4">
            <div class="section-header">
                <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="2" y="7" width="20" height="14" rx="2" ry="2"/>
                    <path d="M16 21V5a2 2 0 00-2-2h-4a2 2 0 00-2 2v16"/>
                </svg>
                <span data-i18n="profile.work_info">Work Information</span>
            </div>
            <div class="section-body">
                <div class="form-group">
                    <label class="form-label" data-i18n="profile.experience_years">Experience (Years)</label>
                    <input type="number" id="fieldExperience" class="form-input" min="0" max="60" placeholder="e.g. 5">
                </div>
                <div class="form-group">
                    <label class="form-label" data-i18n="profile.specialization">Specialization</label>
                    <select id="fieldSpecialization" class="form-input">
                        <option value="">Select...</option>
                        <option value="Interior" data-i18n="profile.interior">Interior</option>
                        <option value="Exterior" data-i18n="profile.exterior">Exterior</option>
                        <option value="Both" data-i18n="profile.both">Both</option>
                        <option value="Industrial" data-i18n="profile.industrial">Industrial</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Location -->
        <div class="section-card mb-4">
            <div class="section-header">
                <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/>
                    <circle cx="12" cy="10" r="3"/>
                </svg>
                <span data-i18n="profile.location">Location</span>
            </div>
            <div class="section-body">
                <div class="form-group">
                    <label class="form-label" data-i18n="profile.city">City</label>
                    <input type="text" id="fieldCity" class="form-input" placeholder="Enter city">
                </div>
                <div class="form-group">
                    <label class="form-label" data-i18n="profile.district">District</label>
                    <input type="text" id="fieldDistrict" class="form-input" placeholder="Enter district">
                </div>
                <div class="form-group">
                    <label class="form-label" data-i18n="profile.pincode">Pincode</label>
                    <input type="text" id="fieldPincode" class="form-input" placeholder="Enter pincode" maxlength="6" inputmode="numeric">
                </div>
                <div class="form-group">
                    <label class="form-label" data-i18n="profile.address">Address</label>
                    <textarea id="fieldAddress" class="form-input" placeholder="Enter full address" rows="3"></textarea>
                </div>
            </div>
        </div>

        <!-- Account Info (read-only) -->
        <div class="section-card mb-4">
            <div class="section-header">
                <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                </svg>
                <span data-i18n="profile.account_info">Account Information</span>
            </div>
            <div class="section-body">
                <div class="form-group">
                    <label class="form-label" data-i18n="profile.referral_code">Referral Code</label>
                    <div class="referral-display">
                        <code id="fieldReferralCode">---</code>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label" data-i18n="profile.member_since">Member Since</label>
                    <input type="text" id="fieldMemberSince" class="form-input" readonly>
                </div>
            </div>
        </div>

    </div>

    <!-- Save Button Bar -->
    <div class="save-bar">
        <button class="save-btn" id="saveBtn" onclick="saveProfile()" disabled>
            <span id="saveBtnText" data-i18n="profile.save_changes">Save Changes</span>
        </button>
    </div>

    <!-- Bottom Navigation Bar -->
    <nav class="bottom-nav" id="bottomNav">
        <div class="flex justify-around items-center h-16 max-w-lg mx-auto">
            <a href="/painter-dashboard.html">
                <svg viewBox="0 0 24 24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-4 0a1 1 0 01-1-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 01-1 1h-2z"/>
                </svg>
                <span data-i18n="common.home">Home</span>
            </a>
            <a href="/painter-catalog.html">
                <svg viewBox="0 0 24 24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M4 5a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1H5a1 1 0 01-1-1V5zm10 0a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1V5zM4 15a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1H5a1 1 0 01-1-1v-4zm10 0a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"/>
                </svg>
                <span data-i18n="common.catalog">Catalog</span>
            </a>
            <a href="/painter-estimate-create.html">
                <svg viewBox="0 0 24 24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                <span data-i18n="common.estimate">Estimate</span>
            </a>
            <a href="/painter-training.html">
                <svg viewBox="0 0 24 24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 14l9-5-9-5-9 5 9 5z"/>
                    <path d="M12 14l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14z"/>
                    <path d="M12 14l9-5-9-5-9 5 9 5zm0 0v6"/>
                </svg>
                <span data-i18n="common.training">Training</span>
            </a>
            <a href="/painter-attendance.html">
                <svg viewBox="0 0 24 24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                    <path d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
                <span data-i18n="common.attendance">Attendance</span>
            </a>
        </div>
    </nav>

    <script>
    const API = '/api/painters';
    let originalData = {};
    let uploading = false;

    function painterHeaders() {
        return {
            'Content-Type': 'application/json',
            'X-Painter-Token': localStorage.getItem('painter_token') || ''
        };
    }

    // Check auth
    if (!localStorage.getItem('painter_token')) {
        window.location.href = '/painter-login.html';
    }

    // ============ Toast ============
    function showToast(msg, type) {
        const toast = document.createElement('div');
        toast.className = 'fixed top-4 left-1/2 -translate-x-1/2 px-4 py-2.5 rounded-lg text-sm font-medium z-[200] '
            + (type === 'error' ? 'bg-red-600' : 'bg-emerald-600') + ' text-white shadow-lg';
        toast.style.transform = 'translateX(-50%)';
        toast.textContent = msg;
        document.body.appendChild(toast);
        setTimeout(function() { toast.style.opacity = '0'; toast.style.transition = 'opacity 0.3s'; }, 2500);
        setTimeout(function() { toast.remove(); }, 3000);
    }

    // ============ Avatar Helpers ============
    function getInitials(name) {
        if (!name) return '?';
        const parts = name.trim().split(/\s+/);
        if (parts.length >= 2) return (parts[0][0] + parts[1][0]).toUpperCase();
        return parts[0].substring(0, 2).toUpperCase();
    }

    function setAvatar(photoUrl, name) {
        const img = document.getElementById('avatarImg');
        const initials = document.getElementById('avatarInitials');
        if (photoUrl) {
            img.src = photoUrl;
            img.style.display = 'block';
            initials.style.display = 'none';
            img.onerror = function() {
                this.style.display = 'none';
                initials.style.display = 'flex';
            };
        } else {
            img.style.display = 'none';
            initials.style.display = 'flex';
            initials.textContent = getInitials(name);
        }
    }

    // ============ Load Profile ============
    async function loadProfile() {
        try {
            const res = await fetch(`${API}/me`, { headers: painterHeaders() });
            if (res.status === 401) {
                localStorage.removeItem('painter_token');
                localStorage.removeItem('painter');
                window.location.href = '/painter-login.html';
                return;
            }
            const data = await res.json();
            if (!data.success) throw new Error(data.message);

            const p = data.painter;
            originalData = {
                email: p.email || '',
                experience_years: p.experience_years != null ? String(p.experience_years) : '',
                specialization: p.specialization || '',
                city: p.city || '',
                district: p.district || '',
                pincode: p.pincode || '',
                address: p.address || ''
            };

            // Read-only fields
            document.getElementById('fieldName').value = p.full_name || '';
            document.getElementById('fieldPhone').value = p.phone || '';

            // Editable fields
            document.getElementById('fieldEmail').value = originalData.email;
            document.getElementById('fieldExperience').value = originalData.experience_years;
            document.getElementById('fieldSpecialization').value = originalData.specialization;
            document.getElementById('fieldCity').value = originalData.city;
            document.getElementById('fieldDistrict').value = originalData.district;
            document.getElementById('fieldPincode').value = originalData.pincode;
            document.getElementById('fieldAddress').value = originalData.address;

            // Account info
            document.getElementById('fieldReferralCode').textContent = p.referral_code || '---';
            if (p.created_at) {
                const d = new Date(p.created_at);
                document.getElementById('fieldMemberSince').value = d.toLocaleDateString('en-IN', { year: 'numeric', month: 'long', day: 'numeric' });
            }

            // Avatar
            setAvatar(p.profile_photo, p.full_name);

            // Header name
            document.getElementById('painterNameHeader').textContent = p.full_name || 'Painter';

            // Enable save tracking
            trackChanges();
        } catch (err) {
            console.error('Load profile error:', err);
            showToast('Failed to load profile', 'error');
        }
    }

    // ============ Track Changes ============
    function getCurrentData() {
        return {
            email: document.getElementById('fieldEmail').value.trim(),
            experience_years: document.getElementById('fieldExperience').value.trim(),
            specialization: document.getElementById('fieldSpecialization').value,
            city: document.getElementById('fieldCity').value.trim(),
            district: document.getElementById('fieldDistrict').value.trim(),
            pincode: document.getElementById('fieldPincode').value.trim(),
            address: document.getElementById('fieldAddress').value.trim()
        };
    }

    function getChangedFields() {
        const current = getCurrentData();
        const changed = {};
        for (const key of Object.keys(current)) {
            if (current[key] !== originalData[key]) {
                changed[key] = current[key];
            }
        }
        // Convert experience_years to number if present
        if (changed.experience_years !== undefined) {
            changed.experience_years = changed.experience_years ? parseInt(changed.experience_years, 10) : null;
        }
        return changed;
    }

    function checkDirty() {
        const changed = getChangedFields();
        const hasChanges = Object.keys(changed).length > 0;
        document.getElementById('saveBtn').disabled = !hasChanges;
    }

    function trackChanges() {
        const editableIds = ['fieldEmail', 'fieldExperience', 'fieldSpecialization', 'fieldCity', 'fieldDistrict', 'fieldPincode', 'fieldAddress'];
        editableIds.forEach(function(id) {
            const el = document.getElementById(id);
            el.addEventListener('input', checkDirty);
            el.addEventListener('change', checkDirty);
        });
    }

    // ============ Save Profile ============
    async function saveProfile() {
        const changed = getChangedFields();
        if (Object.keys(changed).length === 0) return;

        const btn = document.getElementById('saveBtn');
        const btnText = document.getElementById('saveBtnText');
        btn.disabled = true;
        btnText.textContent = 'Saving...';

        try {
            const res = await fetch(`${API}/me`, {
                method: 'PUT',
                headers: painterHeaders(),
                body: JSON.stringify(changed)
            });
            const data = await res.json();
            if (!data.success) throw new Error(data.message);

            // Update originalData with saved values
            const current = getCurrentData();
            Object.assign(originalData, current);

            showToast('Profile updated successfully!');
            btn.disabled = true;
        } catch (err) {
            console.error('Save profile error:', err);
            showToast('Failed to save: ' + (err.message || 'Unknown error'), 'error');
            btn.disabled = false;
        } finally {
            btnText.textContent = 'Save Changes';
            // Re-apply i18n
            if (window.painterI18n) painterI18n.applyTranslations();
        }
    }

    // ============ Photo Upload ============
    document.getElementById('photoInput').addEventListener('change', async function(e) {
        const file = e.target.files[0];
        if (!file) return;

        // Validate file type
        if (!file.type.startsWith('image/')) {
            showToast('Please select an image file', 'error');
            return;
        }

        // Validate file size (5MB max)
        if (file.size > 5 * 1024 * 1024) {
            showToast('Image must be under 5MB', 'error');
            return;
        }

        // Show loading overlay
        const wrapper = document.getElementById('avatarWrapper');
        const loadingEl = document.createElement('div');
        loadingEl.className = 'avatar-loading';
        loadingEl.innerHTML = '<div class="spinner"></div>';
        wrapper.appendChild(loadingEl);

        try {
            const formData = new FormData();
            formData.append('photo', file);

            const res = await fetch(`${API}/me/profile-photo`, {
                method: 'PUT',
                headers: { 'X-Painter-Token': localStorage.getItem('painter_token') || '' },
                body: formData
            });
            const data = await res.json();
            if (!data.success) throw new Error(data.message);

            // Update avatar display
            setAvatar(data.photo_url, document.getElementById('fieldName').value);
            showToast('Photo updated!');
        } catch (err) {
            console.error('Photo upload error:', err);
            showToast('Failed to upload photo', 'error');
        } finally {
            loadingEl.remove();
            // Reset file input for re-selection
            e.target.value = '';
        }
    });

    // ============ Init ============
    loadProfile();
    </script>
</body>
</html>
