<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Request Estimate - Quality Colours</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .request-type-btn { transition: all 0.3s; }
        .request-type-btn.active { border-color: #667eea; background-color: #ede9fe; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <div class="gradient-bg text-white py-6 shadow-lg">
        <div class="container mx-auto px-4">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold">Quality Colours</h1>
                    <p class="text-sm opacity-90">‡Æï‡ØÅ‡Æµ‡Ææ‡Æ≤‡Æø‡Æü‡Øç‡Æü‡Æø ‡Æï‡Æ≤‡Æ∞‡Øç‡Æ∏‡Øç - Paint Experts</p>
                </div>
                <a href="/business-manager/customer-login.html" class="bg-white text-purple-600 px-4 py-2 rounded-lg font-semibold hover:bg-gray-100">
                    Customer Login
                </a>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- Success Message -->
        <div id="successMessage" class="hidden bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
            <div class="flex items-center">
                <svg class="w-6 h-6 text-green-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <div>
                    <p class="font-semibold text-green-800">Request Submitted Successfully!</p>
                    <p class="text-sm text-green-700">Request #<span id="requestNumber"></span> created. We'll contact you soon.</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-6">
            <h2 class="text-3xl font-bold text-gray-800 mb-2 text-center">Request Free Estimate</h2>
            <p class="text-gray-600 text-center mb-8">‡Æá‡Æ≤‡Æµ‡Æö ‡ÆÆ‡Æ§‡Æø‡Æ™‡Øç‡Æ™‡ØÄ‡Æü‡ØÅ ‡Æï‡Øã‡Æ∞‡Æø‡Æï‡Øç‡Æï‡Øà</p>

            <form id="estimateForm">
                <!-- Step 1: Contact Information -->
                <div class="mb-8 pb-6 border-b">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">üìû Step 1: Contact Information</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Full Name *</label>
                            <input type="text" id="customerName" required 
                                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-600 focus:outline-none">
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Mobile Number *</label>
                                <input type="tel" id="phone" required pattern="[6-9][0-9]{9}" 
                                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-600 focus:outline-none"
                                    placeholder="9876543210">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Email (Optional)</label>
                                <input type="email" id="email" 
                                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-600 focus:outline-none">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Request Type -->
                <div class="mb-8 pb-6 border-b">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">üéØ Step 2: Request Type</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <button type="button" onclick="setRequestType('available')" id="typeAvailable" 
                            class="request-type-btn active p-6 border-2 border-gray-300 rounded-lg text-left hover:border-purple-400">
                            <div class="flex items-start">
                                <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center mr-3 flex-shrink-0">
                                    <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                                <div>
                                    <h4 class="font-bold text-gray-800">Currently Available Products</h4>
                                    <p class="text-sm text-gray-600 mt-1">Choose from our catalog</p>
                                    <p class="text-xs text-purple-600 mt-2">‚úì Browse products ‚úì Select quantities</p>
                                </div>
                            </div>
                        </button>
                        <button type="button" onclick="setRequestType('custom')" id="typeCustom" 
                            class="request-type-btn p-6 border-2 border-gray-300 rounded-lg text-left hover:border-purple-400">
                            <div class="flex items-start">
                                <div class="w-8 h-8 bg-orange-100 rounded-full flex items-center justify-center mr-3 flex-shrink-0">
                                    <svg class="w-5 h-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                    </svg>
                                </div>
                                <div>
                                    <h4 class="font-bold text-gray-800">Custom / Should Produce</h4>
                                    <p class="text-sm text-gray-600 mt-1">Special requirements</p>
                                    <p class="text-xs text-orange-600 mt-2">‚úì Describe needs ‚úì Consultation required</p>
                                </div>
                            </div>
                        </button>
                    </div>
                </div>

                <!-- Step 3A: Product Selection (for "Currently Available") -->
                <div id="productSelectionSection" class="mb-8 pb-6 border-b">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">üé® Step 3: Select Products</h3>
                    
                    <!-- Brand ‚Üí Category ‚Üí Product -->
                    <div class="mb-4">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Brand *</label>
                                <select id="brandSelect" onchange="loadGuestCategories()" 
                                    class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-purple-600 focus:outline-none">
                                    <option value="">-- Select Brand --</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Category *</label>
                                <select id="categorySelect" onchange="loadGuestProducts()" 
                                    class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-purple-600 focus:outline-none">
                                    <option value="">-- Select Category --</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Product *</label>
                                <select id="productSelect" onchange="loadGuestProductDetails()" 
                                    class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-purple-600 focus:outline-none">
                                    <option value="">-- Select Product --</option>
                                </select>
                            </div>
                        </div>

                        <!-- Product Type -->
                        <div id="productTypeSection" class="hidden mb-4">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Product Type *</label>
                            <div class="flex gap-4">
                                <label class="flex items-center cursor-pointer">
                                    <input type="radio" name="guestProductType" value="unit" checked onchange="switchGuestType()" class="mr-2">
                                    <span>Unit Type (Packs)</span>
                                </label>
                                <label id="guestAreaOption" class="hidden flex items-center cursor-pointer">
                                    <input type="radio" name="guestProductType" value="area" onchange="switchGuestType()" class="mr-2">
                                    <span>Square Feet Type</span>
                                </label>
                            </div>
                        </div>

                        <!-- Unit Type Inputs -->
                        <div id="guestUnitInputs" class="hidden grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Pack Size *</label>
                                <select id="guestPackSize" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg">
                                    <option value="">-- Select Size --</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Quantity *</label>
                                <input type="number" id="guestQuantity" min="1" value="1" 
                                    class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg">
                            </div>
                        </div>

                        <!-- Area Type Inputs -->
                        <div id="guestAreaInputs" class="hidden grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Square Feet Required *</label>
                                <input type="number" id="guestSqft" min="1" step="0.01" 
                                    class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Number of Coats *</label>
                                <input type="number" id="guestCoats" min="1" value="2" 
                                    class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg">
                            </div>
                        </div>

                        <button type="button" onclick="addGuestProduct()" 
                            class="w-full bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 font-semibold">
                            + Add Product to Request
                        </button>
                    </div>

                    <!-- Products Table (NO PRICING) -->
                    <div class="mt-6">
                        <h4 class="font-bold text-gray-700 mb-3">Selected Products:</h4>
                        <div class="overflow-x-auto">
                            <table class="w-full border">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-sm font-semibold">#</th>
                                        <th class="px-4 py-2 text-left text-sm font-semibold">Product</th>
                                        <th class="px-4 py-2 text-left text-sm font-semibold">Brand</th>
                                        <th class="px-4 py-2 text-left text-sm font-semibold">Type</th>
                                        <th class="px-4 py-2 text-left text-sm font-semibold">Details</th>
                                        <th class="px-4 py-2 text-center text-sm font-semibold">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="guestProductsTable">
                                    <tr>
                                        <td colspan="6" class="text-center py-8 text-gray-500 text-sm">No products added yet</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Step 3B: Simple Request Form (for "Custom") -->
                <div id="simpleRequestSection" class="hidden mb-8 pb-6 border-b">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">üè† Step 3: Project Details</h3>
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Project Type *</label>
                                <select id="projectType" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg">
                                    <option value="">Select type</option>
                                    <option value="interior">Interior</option>
                                    <option value="exterior">Exterior</option>
                                    <option value="both">Both</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Property Type *</label>
                                <select id="propertyType" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg">
                                    <option value="">Select property</option>
                                    <option value="house">House</option>
                                    <option value="apartment">Apartment</option>
                                    <option value="villa">Villa</option>
                                    <option value="office">Office</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Project Location *</label>
                            <textarea id="location" rows="2" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg"></textarea>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Area (Sq.Ft) *</label>
                                <input type="number" id="area" min="100" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Rooms</label>
                                <input type="number" id="rooms" min="1" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Requirements</label>
                            <textarea id="additionalNotes" rows="4" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg" 
                                placeholder="Describe your requirements, preferred colors, etc."></textarea>
                        </div>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="flex gap-3">
                    <button type="button" onclick="window.location.href='/'" 
                        class="flex-1 px-6 py-3 border-2 border-gray-300 rounded-lg hover:bg-gray-50 font-semibold">
                        Cancel
                    </button>
                    <button type="submit" 
                        class="flex-1 bg-gradient-to-r from-purple-600 to-purple-700 text-white px-6 py-3 rounded-lg hover:from-purple-700 hover:to-purple-800 font-semibold shadow-lg">
                        Submit Request
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let requestType = 'available';
        let allBrands = [];
        let allCategories = [];
        let allProducts = [];
        let guestProducts = [];
        let selectedProduct = null;
        let productCounter = 1;

        // Set request type
        function setRequestType(type) {
            requestType = type;
            
            // Update button states
            document.getElementById('typeAvailable').classList.toggle('active', type === 'available');
            document.getElementById('typeCustom').classList.toggle('active', type === 'custom');
            
            // Show/hide sections
            document.getElementById('productSelectionSection').classList.toggle('hidden', type !== 'available');
            document.getElementById('simpleRequestSection').classList.toggle('hidden', type !== 'custom');
        }

        // Load public products
        async function loadPublicProducts() {
            try {
                // Load brands
                const brandRes = await fetch('/business-manager/api/brands');
                allBrands = await brandRes.json();
                
                // Load categories
                const catRes = await fetch('/business-manager/api/categories');
                allCategories = await catRes.json();
                
                // Load all products (filter for visible_to_guest on frontend)
                const prodRes = await fetch('/business-manager/api/products');
                const allProds = await prodRes.json();
                allProducts = allProds.filter(p => p.visible_to_guest === 1 && p.status === 'active');
                
                // Populate brands that have visible products
                const brandsWithProducts = [...new Set(allProducts.map(p => p.brand_id))];
                const visibleBrands = allBrands.filter(b => brandsWithProducts.includes(b.id));
                
                document.getElementById('brandSelect').innerHTML = '<option value="">-- Select Brand --</option>' +
                    visibleBrands.map(b => `<option value="${b.id}">${b.name}</option>`).join('');
                    
            } catch (error) {
                console.error('Error loading products:', error);
            }
        }

        // Load categories for selected brand
        function loadGuestCategories() {
            const brandId = parseInt(document.getElementById('brandSelect').value);
            if (!brandId) {
                document.getElementById('categorySelect').innerHTML = '<option value="">-- Select Category --</option>';
                return;
            }
            
            // Get categories that have products in this brand
            const catsWithProducts = [...new Set(allProducts.filter(p => p.brand_id === brandId).map(p => p.category_id))];
            const visibleCats = allCategories.filter(c => catsWithProducts.includes(c.id));
            
            document.getElementById('categorySelect').innerHTML = '<option value="">-- Select Category --</option>' +
                visibleCats.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        }

        // Load products for selected brand + category
        function loadGuestProducts() {
            const brandId = parseInt(document.getElementById('brandSelect').value);
            const categoryId = parseInt(document.getElementById('categorySelect').value);
            
            if (!brandId || !categoryId) {
                document.getElementById('productSelect').innerHTML = '<option value="">-- Select Product --</option>';
                return;
            }
            
            const filteredProducts = allProducts.filter(p => p.brand_id === brandId && p.category_id === categoryId);
            
            document.getElementById('productSelect').innerHTML = '<option value="">-- Select Product --</option>' +
                filteredProducts.map(p => `<option value="${p.id}" data-product='${JSON.stringify(p).replace(/'/g, "&apos;")}'>${p.name}</option>`).join('');
        }

        // Load product details
        function loadGuestProductDetails() {
            const select = document.getElementById('productSelect');
            const option = select.options[select.selectedIndex];
            
            if (!option.value) {
                document.getElementById('productTypeSection').classList.add('hidden');
                return;
            }
            
            selectedProduct = JSON.parse(option.dataset.product);
            
            // Show type section
            document.getElementById('productTypeSection').classList.remove('hidden');
            
            // Show/hide area option based on product type
            if (selectedProduct.product_type === 'area_wise' && parseFloat(selectedProduct.area_coverage) > 0) {
                document.getElementById('guestAreaOption').classList.remove('hidden');
            } else {
                document.getElementById('guestAreaOption').classList.add('hidden');
                document.querySelector('input[name="guestProductType"][value="unit"]').checked = true;
            }
            
            switchGuestType();
        }

        // Switch product type
        function switchGuestType() {
            const type = document.querySelector('input[name="guestProductType"]:checked').value;
            
            if (type === 'unit') {
                document.getElementById('guestUnitInputs').classList.remove('hidden');
                document.getElementById('guestAreaInputs').classList.add('hidden');
                loadGuestPackSizes();
            } else {
                document.getElementById('guestUnitInputs').classList.add('hidden');
                document.getElementById('guestAreaInputs').classList.remove('hidden');
            }
        }

        // Load pack sizes
        function loadGuestPackSizes() {
            if (!selectedProduct || !selectedProduct.available_sizes) return;
            
            try {
                const sizes = JSON.parse(selectedProduct.available_sizes);
                document.getElementById('guestPackSize').innerHTML = '<option value="">-- Select Size --</option>' +
                    sizes.map((s, idx) => `<option value="${idx}" data-size='${JSON.stringify(s)}'>${s.size}L</option>`).join('');
            } catch (e) {
                console.error('Error parsing pack sizes:', e);
            }
        }

        // Add product to guest request
        function addGuestProduct() {
            if (!selectedProduct) {
                alert('Please select a product');
                return;
            }
            
            const type = document.querySelector('input[name="guestProductType"]:checked').value;
            const brand = allBrands.find(b => b.id === selectedProduct.brand_id);
            
            let product = {
                id: productCounter++,
                product_id: selectedProduct.id,
                product_name: selectedProduct.name,
                brand_name: brand ? brand.name : 'Unknown',
                type: type
            };
            
            if (type === 'unit') {
                const packIdx = document.getElementById('guestPackSize').value;
                const quantity = parseInt(document.getElementById('guestQuantity').value) || 1;
                
                if (!packIdx) {
                    alert('Please select pack size');
                    return;
                }
                
                const sizes = JSON.parse(selectedProduct.available_sizes);
                const pack = sizes[packIdx];
                
                product.pack_size = pack.size;
                product.quantity = quantity;
                product.details = `${quantity} √ó ${pack.size}L pack`;
            } else {
                const sqft = parseFloat(document.getElementById('guestSqft').value);
                const coats = parseInt(document.getElementById('guestCoats').value);
                
                if (!sqft || !coats) {
                    alert('Please enter square feet and number of coats');
                    return;
                }
                
                product.sqft = sqft;
                product.coats = coats;
                product.coverage = selectedProduct.area_coverage;
                product.liters = (sqft * coats) / selectedProduct.area_coverage;
                product.details = `${sqft} sq.ft √ó ${coats} coats ‚âà ${product.liters.toFixed(2)}L`;
            }
            
            guestProducts.push(product);
            renderGuestProductsTable();
            
            // Reset
            document.getElementById('productSelect').value = '';
            document.getElementById('productTypeSection').classList.add('hidden');
        }

        // Render products table
        function renderGuestProductsTable() {
            const tbody = document.getElementById('guestProductsTable');
            
            if (guestProducts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500 text-sm">No products added yet</td></tr>';
                return;
            }
            
            tbody.innerHTML = guestProducts.map((p, idx) => `
                <tr class="border-t">
                    <td class="px-4 py-3 text-sm">${idx + 1}</td>
                    <td class="px-4 py-3 text-sm font-semibold">${p.product_name}</td>
                    <td class="px-4 py-3 text-sm">${p.brand_name}</td>
                    <td class="px-4 py-3 text-sm">${p.type === 'unit' ? 'Unit' : 'Area'}</td>
                    <td class="px-4 py-3 text-sm">${p.details}</td>
                    <td class="px-4 py-3 text-center">
                        <button type="button" onclick="removeGuestProduct(${p.id})" class="text-red-600 hover:text-red-800 text-sm">Remove</button>
                    </td>
                </tr>
            `).join('');
        }

        // Remove product
        function removeGuestProduct(id) {
            guestProducts = guestProducts.filter(p => p.id !== id);
            renderGuestProductsTable();
        }

        // Submit form
        document.getElementById('estimateForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const customerName = document.getElementById('customerName').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const email = document.getElementById('email').value.trim();
            
            if (!customerName || !phone) {
                alert('Please fill in required fields');
                return;
            }
            
            let requestData = {
                customer_name: customerName,
                phone: phone,
                email: email || null,
                request_method: requestType === 'available' ? 'product_available' : 'product_custom',
                source: 'website'
            };
            
            if (requestType === 'available') {
                if (guestProducts.length === 0) {
                    alert('Please add at least one product');
                    return;
                }
                
                requestData.products_json = JSON.stringify({ items: guestProducts });
                requestData.project_type = 'interior'; // Default
                requestData.property_type = 'house'; // Default
                requestData.location = 'To be confirmed';
                requestData.area_sqft = 0;
                requestData.additional_notes = `Product-based request with ${guestProducts.length} products`;
            } else {
                // Custom request
                const projectType = document.getElementById('projectType').value;
                const propertyType = document.getElementById('propertyType').value;
                const location = document.getElementById('location').value.trim();
                const area = parseInt(document.getElementById('area').value);
                const rooms = parseInt(document.getElementById('rooms').value) || null;
                const notes = document.getElementById('additionalNotes').value.trim();
                
                if (!projectType || !propertyType || !location || !area) {
                    alert('Please fill in all required project details');
                    return;
                }
                
                requestData.project_type = projectType;
                requestData.property_type = propertyType;
                requestData.location = location;
                requestData.area_sqft = area;
                requestData.rooms = rooms;
                requestData.additional_notes = notes;
            }
            
            try {
                const response = await fetch('/business-manager/api/estimate-requests', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    document.getElementById('requestNumber').textContent = result.request_number;
                    document.getElementById('successMessage').classList.remove('hidden');
                    document.getElementById('estimateForm').classList.add('hidden');
                    window.scrollTo(0, 0);
                } else {
                    alert('Error: ' + (result.message || 'Failed to submit request'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error submitting request. Please try again.');
            }
        });

        // Initialize
        loadPublicProducts();
    </script>
</body>
</html>
