// Estimates Management JavaScript

// Check authentication (DISABLED for now)
// const authToken = localStorage.getItem('auth_token');
// if (!authToken) {
//     window.location.href = '/business-manager/login.html';
// }

// Logout function
function logout() {
    localStorage.removeItem('auth_token');
    localStorage.removeItem('user');
    window.location.href = '/business-manager/login.html';
}

// Global variables
let allEstimates = [];
let filteredEstimates = [];
let currentFilter = 'all';

// Load estimates
async function loadEstimates() {
    console.log('üîÑ Loading estimates...');
    try {
        const response = await fetch('/business-manager/api/estimates');
        console.log('üì° API Response:', response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        allEstimates = await response.json();
        console.log('‚úÖ Estimates loaded:', allEstimates.length);
        
        // Ensure it's an array
        if (!Array.isArray(allEstimates)) {
            console.warn('‚ö†Ô∏è API did not return an array');
            allEstimates = [];
        }
        
        // Update counts
        updateStatusCounts();
        
        // Apply current filter
        applyFilter();
        
    } catch (error) {
        console.error('‚ùå Error loading estimates:', error);
        allEstimates = [];
        // Hide loading state even on error
        const loadingState = document.getElementById('loadingState');
        const emptyState = document.getElementById('emptyState');
        if (loadingState) loadingState.classList.add('hidden');
        if (emptyState) emptyState.classList.remove('hidden');
    }
}

// Update status counts
function updateStatusCounts() {
    const counts = {
        all: allEstimates.length,
        draft: allEstimates.filter(e => e.status === 'draft').length,
        sent: allEstimates.filter(e => e.status === 'sent').length,
        pending_approval: allEstimates.filter(e => e.status === 'pending_approval').length,
        approved: allEstimates.filter(e => e.status === 'approved').length,
        rejected: allEstimates.filter(e => e.status === 'rejected').length,
        converted: allEstimates.filter(e => e.status === 'converted').length,
        expired: allEstimates.filter(e => e.status === 'expired').length
    };
    
    // Update count badges
    Object.keys(counts).forEach(status => {
        const badge = document.getElementById(`count-${status}`);
        if (badge) {
            badge.textContent = counts[status];
        }
    });
}

// Filter by status
function filterByStatus(status) {
    currentFilter = status;
    
    // Update active button
    document.querySelectorAll('.status-filter').forEach(btn => {
        btn.classList.remove('active', 'bg-purple-600', 'text-white');
        btn.classList.add('bg-gray-100', 'text-gray-700', 'hover:bg-gray-200');
    });
    
    const activeBtn = document.querySelector(`[data-status="${status}"]`);
    if (activeBtn) {
        activeBtn.classList.add('active', 'bg-purple-600', 'text-white');
        activeBtn.classList.remove('bg-gray-100', 'text-gray-700', 'hover:bg-gray-200');
    }
    
    applyFilter();
}

// Apply current filter
function applyFilter() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    
    // Filter by status
    filteredEstimates = currentFilter === 'all' 
        ? allEstimates 
        : allEstimates.filter(e => e.status === currentFilter);
    
    // Filter by search term
    if (searchTerm) {
        filteredEstimates = filteredEstimates.filter(e => 
            e.estimate_number.toLowerCase().includes(searchTerm) ||
            e.customer_name.toLowerCase().includes(searchTerm) ||
            (e.customer_phone && e.customer_phone.includes(searchTerm))
        );
    }
    
    // Display results
    displayEstimates();
}

// Search functionality
document.getElementById('searchInput').addEventListener('input', () => {
    applyFilter();
});

// Display estimates
function displayEstimates() {
    console.log('üìä displayEstimates called, filteredEstimates:', filteredEstimates.length);
    
    const loadingState = document.getElementById('loadingState');
    const emptyState = document.getElementById('emptyState');
    const desktopTable = document.getElementById('desktopTable');
    const mobileCards = document.getElementById('mobileCards');
    
    // Hide loading
    if (loadingState) loadingState.classList.add('hidden');
    
    // Check if empty
    if (filteredEstimates.length === 0) {
        console.log('üì≠ No estimates to display');
        if (emptyState) emptyState.classList.remove('hidden');
        if (desktopTable) desktopTable.classList.add('hidden');
        if (mobileCards) mobileCards.innerHTML = '';
        return;
    }
    
    console.log('üé® Rendering estimates...');
    
    // Show results
    if (emptyState) emptyState.classList.add('hidden');
    if (desktopTable) desktopTable.classList.remove('hidden');
    
    // Render both views (CSS will handle which one displays based on screen size)
    renderDesktopTable();
    renderMobileCards();
    
    console.log('‚úÖ Rendering complete');
}

// Render desktop table
function renderDesktopTable() {
    console.log('renderDesktopTable called');
    const tbody = document.getElementById('desktopTableBody');
    
    if (!tbody) {
        console.error('desktopTableBody element not found!');
        return;
    }
    
    console.log('Rendering', filteredEstimates.length, 'estimates to table');
    
    tbody.innerHTML = filteredEstimates.map(est => `
        <tr class="hover:bg-gray-50 cursor-pointer" onclick="viewEstimate('${est.id}')">
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm font-medium text-gray-900">#${est.estimate_number}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm font-medium text-gray-900">${est.customer_name}</div>
                <div class="text-sm text-gray-500">${est.customer_address || ''}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                ${est.customer_phone || '-'}
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm font-bold text-gray-900">‚Çπ${parseFloat(est.grand_total).toLocaleString('en-IN')}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                ${getStatusBadge(est.status)}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                ${formatDate(est.estimate_date)}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm space-x-2">
                <button onclick="event.stopPropagation(); viewEstimate('${est.id}')" class="text-purple-600 hover:text-purple-900 font-semibold">
                    View
                </button>
                <button onclick="event.stopPropagation(); editEstimate('${est.id}')" class="text-blue-600 hover:text-blue-900 font-semibold">
                    Edit
                </button>
                <button onclick="event.stopPropagation(); showActions('${est.id}')" class="text-gray-600 hover:text-gray-900">
                    ‚ãÆ
                </button>
            </td>
        </tr>
    `).join('');
}

// Render mobile cards
function renderMobileCards() {
    console.log('renderMobileCards called');
    const container = document.getElementById('mobileCards');
    
    if (!container) {
        console.error('mobileCards element not found!');
        return;
    }
    
    console.log('Rendering', filteredEstimates.length, 'estimates to cards');
    
    container.innerHTML = filteredEstimates.map(est => `
        <div class="bg-white rounded-xl shadow-lg p-4 hover:shadow-xl transition cursor-pointer" onclick="viewEstimate('${est.id}')">
            <div class="flex items-start justify-between mb-3">
                <div>
                    <div class="text-lg font-bold text-gray-900">#${est.estimate_number}</div>
                    <div class="text-sm text-gray-500">${formatDate(est.estimate_date)}</div>
                </div>
                ${getStatusBadge(est.status)}
            </div>
            
            <div class="space-y-2 mb-4">
                <div class="flex items-center text-sm">
                    <svg class="w-4 h-4 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                    <span class="font-medium text-gray-900">${est.customer_name}</span>
                </div>
                
                ${est.customer_phone ? `
                <div class="flex items-center text-sm">
                    <svg class="w-4 h-4 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                    </svg>
                    <span class="text-gray-600">${est.customer_phone}</span>
                </div>
                ` : ''}
                
                <div class="flex items-center text-sm">
                    <svg class="w-4 h-4 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span class="font-bold text-gray-900">‚Çπ${parseFloat(est.grand_total).toLocaleString('en-IN')}</span>
                </div>
            </div>
            
            <div class="flex gap-2 pt-3 border-t border-gray-100">
                <button onclick="event.stopPropagation(); viewEstimate('${est.id}')" class="flex-1 bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-purple-700 transition">
                    View
                </button>
                <button onclick="event.stopPropagation(); editEstimate('${est.id}')" class="flex-1 bg-gray-100 text-gray-700 px-4 py-2 rounded-lg text-sm font-semibold hover:bg-gray-200 transition">
                    Edit
                </button>
                <button onclick="event.stopPropagation(); showActions('${est.id}')" class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg text-sm font-semibold hover:bg-gray-200 transition">
                    ‚ãÆ
                </button>
            </div>
        </div>
    `).join('');
}

// Get status badge
function getStatusBadge(status) {
    const badges = {
        'draft': '<span class="px-3 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">üÜï Draft</span>',
        'sent': '<span class="px-3 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">üìß Sent</span>',
        'pending_approval': '<span class="px-3 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">‚è≥ Pending</span>',
        'approved': '<span class="px-3 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">‚úÖ Approved</span>',
        'rejected': '<span class="px-3 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">‚ùå Rejected</span>',
        'converted': '<span class="px-3 py-1 text-xs font-semibold rounded-full bg-purple-100 text-purple-800">üìÑ Converted</span>',
        'expired': '<span class="px-3 py-1 text-xs font-semibold rounded-full bg-orange-100 text-orange-800">‚åõ Expired</span>'
    };
    return badges[status] || badges['draft'];
}

// Format date
function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-IN', { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric' 
    });
}

// Show error
function showError(message) {
    alert(message); // TODO: Replace with better error UI
}

// View estimate
function viewEstimate(id) {
    window.location.href = `/business-manager/estimate-view.html?id=${id}`;
}

// Edit estimate
function editEstimate(id) {
    window.location.href = `/business-manager/estimate-edit.html?id=${id}`;
}

// Create new estimate
function createNewEstimate() {
    window.location.href = '/business-manager/estimate-create-new.html';
}

// Store current estimate ID for actions
let currentActionEstimateId = null;

// Show actions menu
function showActions(id) {
    const estimate = allEstimates.find(e => e.id == id);
    if (!estimate) return;
    
    // Store ID globally for action handlers
    currentActionEstimateId = id;
    
    const actions = [
        { label: 'üëÅÔ∏è View Details', action: 'viewEstimate' },
        { label: '‚úèÔ∏è Edit Estimate', action: 'editEstimate' },
        { label: 'üìß Send to Customer', action: 'sendEstimate' },
        { label: 'üì• Download PDF', action: 'downloadPDF' },
        { label: '‚úÖ Mark as Approved', action: 'approveEstimate', show: estimate.status !== 'approved' },
        { label: 'üì® Mark as Sent', action: 'markAsSent', show: estimate.status === 'draft' },
        { label: '‚ùå Mark as Rejected', action: 'rejectEstimate', show: estimate.status !== 'rejected' },
        { label: 'üìã Duplicate Estimate', action: 'duplicateEstimate' },
        { label: 'üóëÔ∏è Delete Estimate', action: 'deleteEstimate', danger: true }
    ].filter(a => a.show !== false);
    
    // Set modal title
    document.getElementById('actionsModalTitle').textContent = `Actions: ${estimate.estimate_number}`;
    
    // Build actions list
    const actionsBody = document.getElementById('actionsModalBody');
    actionsBody.innerHTML = actions.map(action => `
        <button 
            onclick="handleAction('${action.action}')" 
            class="w-full px-6 py-4 text-left hover:bg-gray-50 transition ${action.danger ? 'text-red-600 hover:bg-red-50' : 'text-gray-700'} font-medium flex items-center"
        >
            <span class="text-xl mr-3">${action.label.split(' ')[0]}</span>
            <span>${action.label.substring(action.label.indexOf(' ') + 1)}</span>
        </button>
    `).join('');
    
    // Show modal
    document.getElementById('actionsModal').classList.remove('hidden');
}

// Handle action click
function handleAction(actionName) {
    closeActionsModal();
    
    const id = currentActionEstimateId;
    if (!id) return;
    
    switch(actionName) {
        case 'viewEstimate':
            viewEstimate(id);
            break;
        case 'editEstimate':
            editEstimate(id);
            break;
        case 'sendEstimate':
            sendEstimate(id);
            break;
        case 'downloadPDF':
            downloadPDF(id);
            break;
        case 'approveEstimate':
            changeStatus(id, 'approved');
            break;
        case 'markAsSent':
            changeStatus(id, 'sent');
            break;
        case 'rejectEstimate':
            changeStatus(id, 'rejected');
            break;
        case 'duplicateEstimate':
            duplicateEstimate(id);
            break;
        case 'deleteEstimate':
            deleteEstimate(id);
            break;
    }
}

// Close actions modal
function closeActionsModal() {
    document.getElementById('actionsModal').classList.add('hidden');
}

// Action functions
function sendEstimate(id) {
    // TODO: Implement send via WhatsApp/Email
    alert('üìß Send estimate via WhatsApp/Email - Coming in Day 3!');
}

function downloadPDF(id) {
    // Open estimate in new tab for printing/PDF
    window.open(`/business-manager/estimate-view.html?id=${id}`, '_blank');
}

async function changeStatus(id, newStatus) {
    const statusNames = {
        'approved': 'Approved',
        'rejected': 'Rejected',
        'sent': 'Sent'
    };
    
    if (!confirm(`Mark this estimate as ${statusNames[newStatus]}?`)) return;
    
    try {
        const response = await fetch(`/business-manager/api/estimates/${id}/status`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                status: newStatus,
                reason: 'Status changed from estimates list',
                notes: ''
            })
        });
        
        if (response.ok) {
            alert(`‚úÖ Estimate marked as ${statusNames[newStatus]}!`);
            loadEstimates(); // Reload list
        } else {
            alert('‚ùå Failed to update status');
        }
    } catch (error) {
        console.error('Error updating status:', error);
        alert('‚ùå Error updating status');
    }
}

function assignToStaff(id) {
    alert('üë§ Assign to staff - Coming in Phase 2!');
}

async function duplicateEstimate(id) {
    if (!confirm('üìã Create a copy of this estimate?')) return;
    
    try {
        // Load the original estimate
        const response = await fetch(`/business-manager/api/estimates/${id}`);
        const original = await response.json();
        
        if (!original) {
            alert('‚ùå Failed to load original estimate');
            return;
        }
        
        // Create new estimate with same data
        const newEstimate = {
            customer_name: original.customer_name,
            customer_phone: original.customer_phone,
            customer_address: original.customer_address,
            estimate_date: new Date().toISOString().split('T')[0],
            valid_until: null,
            subtotal: original.subtotal,
            gst_amount: original.gst_amount,
            grand_total: original.grand_total,
            show_gst_breakdown: original.show_gst_breakdown,
            column_visibility: original.column_visibility,
            notes: original.notes ? `Copy of ${original.estimate_number}: ${original.notes}` : `Copy of ${original.estimate_number}`,
            status: 'draft',
            items: original.items.map(item => ({
                product_id: item.product_id,
                item_description: item.item_description,
                quantity: item.quantity,
                area: item.area,
                mix_info: item.mix_info,
                unit_price: item.unit_price,
                breakdown_cost: item.breakdown_cost,
                color_cost: item.color_cost,
                line_total: item.line_total,
                display_order: item.display_order
            }))
        };
        
        const createResponse = await fetch('/business-manager/api/estimates', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(newEstimate)
        });
        
        if (createResponse.ok) {
            const result = await createResponse.json();
            alert(`‚úÖ Duplicate created: ${result.estimate_number}`);
            loadEstimates(); // Reload list
        } else {
            alert('‚ùå Failed to create duplicate');
        }
    } catch (error) {
        console.error('Error duplicating estimate:', error);
        alert('‚ùå Error duplicating estimate');
    }
}

async function deleteEstimate(id) {
    const estimate = allEstimates.find(e => e.id == id);
    if (!estimate) return;
    
    if (!confirm(`üóëÔ∏è Are you sure you want to delete estimate ${estimate.estimate_number}?\n\nThis action cannot be undone!`)) return;
    
    try {
        const response = await fetch(`/business-manager/api/estimates/${id}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            alert('‚úÖ Estimate deleted successfully!');
            loadEstimates(); // Reload list
        } else {
            alert('‚ùå Failed to delete estimate');
        }
    } catch (error) {
        console.error('Error deleting estimate:', error);
        alert('‚ùå Error deleting estimate');
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    console.log('üöÄ Estimates page initialized');
    console.log('üìç Elements check:', {
        loadingState: !!document.getElementById('loadingState'),
        emptyState: !!document.getElementById('emptyState'),
        desktopTable: !!document.getElementById('desktopTable'),
        desktopTableBody: !!document.getElementById('desktopTableBody'),
        mobileCards: !!document.getElementById('mobileCards')
    });
    loadEstimates();
});
