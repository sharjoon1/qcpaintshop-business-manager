<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192x192.png">
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
    <title>AI Dashboard - Quality Colours Business Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="/css/design-system.css">
    <script src="/universal-nav-loader.js"></script>
    <script src="/js/auth-helper.js"></script>
    <script>requireAdminOrRedirect();</script>
    <style>
        body { background: #f9fafb; }

        .tab-bar {
            display: flex; gap: 0.25rem; background: white; border-radius: 12px;
            padding: 0.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 1.5rem; overflow-x: auto;
        }
        .tab-btn {
            padding: 0.625rem 1.25rem; border-radius: 8px; font-weight: 600;
            font-size: 0.875rem; border: none; cursor: pointer; white-space: nowrap;
            background: transparent; color: #6b7280; transition: all 0.2s; position: relative;
        }
        .tab-btn:hover { background: #f3f4f6; color: #374151; }
        .tab-btn.active { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        .tab-badge {
            position: absolute; top: 2px; right: 2px; background: #ef4444; color: white;
            font-size: 0.625rem; min-width: 16px; height: 16px; border-radius: 999px;
            display: flex; align-items: center; justify-content: center; font-weight: 700;
        }

        /* Chat UI */
        .chat-container { display: flex; height: calc(100vh - 240px); min-height: 400px; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .chat-sidebar { width: 260px; border-right: 1px solid #e5e7eb; display: flex; flex-direction: column; flex-shrink: 0; }
        .chat-sidebar-header { padding: 1rem; border-bottom: 1px solid #e5e7eb; display: flex; gap: 0.5rem; }
        .chat-sidebar-list { flex: 1; overflow-y: auto; padding: 0.5rem; }
        .conv-item { padding: 0.625rem 0.75rem; border-radius: 8px; cursor: pointer; margin-bottom: 2px; font-size: 0.8125rem; color: #374151; transition: background 0.15s; display: flex; justify-content: space-between; align-items: center; }
        .conv-item:hover { background: #f3f4f6; }
        .conv-item.active { background: #eef2ff; color: #4f46e5; font-weight: 600; }
        .conv-item .conv-delete { opacity: 0; color: #9ca3af; cursor: pointer; font-size: 1rem; }
        .conv-item:hover .conv-delete { opacity: 1; }
        .conv-item .conv-delete:hover { color: #ef4444; }

        .chat-main { flex: 1; display: flex; flex-direction: column; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 1.5rem; display: flex; flex-direction: column; gap: 1rem; }
        .msg { max-width: 85%; padding: 0.75rem 1rem; border-radius: 12px; font-size: 0.875rem; line-height: 1.6; white-space: pre-wrap; word-break: break-word; }
        .msg.user { align-self: flex-end; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-bottom-right-radius: 4px; }
        .msg.assistant { align-self: flex-start; background: #f3f4f6; color: #1f2937; border-bottom-left-radius: 4px; }
        .msg.assistant strong { color: #4f46e5; }
        .msg-meta { font-size: 0.6875rem; color: #9ca3af; margin-top: 4px; }
        .msg.assistant .msg-meta { color: #9ca3af; }
        .msg.user .msg-meta { color: rgba(255,255,255,0.7); }

        .chat-input-area { padding: 1rem; border-top: 1px solid #e5e7eb; display: flex; gap: 0.5rem; align-items: flex-end; }
        .chat-input-area textarea { flex: 1; resize: none; border: 1px solid #d1d5db; border-radius: 10px; padding: 0.625rem 0.875rem; font-size: 0.875rem; max-height: 120px; outline: none; font-family: inherit; }
        .chat-input-area textarea:focus { border-color: #667eea; box-shadow: 0 0 0 3px rgba(102,126,234,0.1); }
        .chat-send-btn { background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 10px; width: 40px; height: 40px; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .chat-send-btn:hover { opacity: 0.9; }
        .chat-send-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .quick-prompts { display: flex; gap: 0.5rem; flex-wrap: wrap; padding: 0.5rem 1rem; border-bottom: 1px solid #e5e7eb; align-items: center; }
        .quick-prompts.collapsed .quick-prompt { display: none; }
        .quick-prompt { padding: 0.375rem 0.75rem; border-radius: 999px; font-size: 0.75rem; border: 1px solid #d1d5db; cursor: pointer; background: white; color: #4b5563; transition: all 0.15s; white-space: nowrap; }
        .quick-prompt:hover { border-color: #667eea; color: #667eea; background: #eef2ff; }
        .quick-prompts-toggle { display: none; background: none; border: 1px solid #d1d5db; border-radius: 999px; width: 28px; height: 28px; font-size: 0.625rem; color: #9ca3af; cursor: pointer; flex-shrink: 0; transition: all 0.2s; }
        .quick-prompts-toggle:hover { border-color: #667eea; color: #667eea; }
        .quick-prompts.collapsed .quick-prompts-toggle { transform: rotate(-90deg); }

        .provider-toggle { display: flex; gap: 4px; background: #f3f4f6; border-radius: 8px; padding: 2px; }
        .provider-btn { padding: 4px 10px; border-radius: 6px; font-size: 0.6875rem; font-weight: 600; border: none; cursor: pointer; background: transparent; color: #6b7280; }
        .provider-btn.active { background: white; color: #374151; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

        .typing-indicator { display: inline-flex; gap: 4px; padding: 8px 12px; }
        .typing-dot { width: 6px; height: 6px; border-radius: 50%; background: #9ca3af; animation: typing 1.2s infinite; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%, 100% { opacity: 0.3; transform: translateY(0); } 50% { opacity: 1; transform: translateY(-3px); } }

        /* Insights */
        .insight-card { background: white; border-radius: 12px; padding: 1rem; box-shadow: 0 1px 4px rgba(0,0,0,0.06); border-left: 4px solid #d1d5db; transition: all 0.15s; }
        .insight-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .insight-card.severity-info { border-left-color: #3b82f6; }
        .insight-card.severity-warning { border-left-color: #f59e0b; }
        .insight-card.severity-critical { border-left-color: #ef4444; }
        .insight-card.is-read { opacity: 0.7; }
        .severity-badge { padding: 2px 8px; border-radius: 999px; font-size: 0.6875rem; font-weight: 600; text-transform: uppercase; }
        .severity-badge.info { background: #dbeafe; color: #1d4ed8; }
        .severity-badge.warning { background: #fef3c7; color: #92400e; }
        .severity-badge.critical { background: #fee2e2; color: #991b1b; }
        .category-pill { padding: 3px 10px; border-radius: 999px; font-size: 0.75rem; font-weight: 500; cursor: pointer; border: 1px solid #e5e7eb; background: white; color: #4b5563; transition: all 0.15s; }
        .category-pill:hover, .category-pill.active { border-color: #667eea; color: #667eea; background: #eef2ff; }

        /* Settings */
        .config-card { background: white; border-radius: 12px; padding: 1.25rem; box-shadow: 0 1px 4px rgba(0,0,0,0.06); }
        .config-card h3 { font-size: 0.9375rem; font-weight: 600; color: #1f2937; margin-bottom: 1rem; }
        .config-row { display: flex; justify-content: space-between; align-items: center; padding: 0.625rem 0; border-bottom: 1px solid #f3f4f6; }
        .config-row:last-child { border-bottom: none; }
        .config-label { font-size: 0.8125rem; color: #374151; }
        .config-desc { font-size: 0.6875rem; color: #9ca3af; }
        .toggle-switch { position: relative; width: 40px; height: 22px; cursor: pointer; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-track { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: #d1d5db; border-radius: 999px; transition: 0.2s; }
        .toggle-track::after { content: ''; position: absolute; top: 2px; left: 2px; width: 18px; height: 18px; border-radius: 50%; background: white; transition: 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        .toggle-switch input:checked + .toggle-track { background: #667eea; }
        .toggle-switch input:checked + .toggle-track::after { transform: translateX(18px); }

        .stat-card { background: white; border-radius: 12px; padding: 1.25rem; box-shadow: 0 1px 4px rgba(0,0,0,0.06); text-align: center; }
        .stat-value { font-size: 1.75rem; font-weight: 700; background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .stat-label { font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem; }

        .run-btn { padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.8125rem; font-weight: 600; border: 1px solid #d1d5db; cursor: pointer; background: white; color: #374151; transition: all 0.15s; }
        .run-btn:hover { border-color: #667eea; color: #667eea; }
        .run-btn.running { opacity: 0.6; cursor: not-allowed; }

        /* Suggestions */
        .sug-card { background: white; border-radius: 12px; padding: 1rem; box-shadow: 0 1px 4px rgba(0,0,0,0.06); border-left: 4px solid #d1d5db; transition: all 0.15s; }
        .sug-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .sug-card.priority-low { border-left-color: #6b7280; }
        .sug-card.priority-medium { border-left-color: #3b82f6; }
        .sug-card.priority-high { border-left-color: #f59e0b; }
        .sug-card.priority-critical { border-left-color: #ef4444; }
        .priority-badge { padding: 2px 8px; border-radius: 999px; font-size: 0.6875rem; font-weight: 600; text-transform: uppercase; }
        .priority-badge.low { background: #f3f4f6; color: #6b7280; }
        .priority-badge.medium { background: #dbeafe; color: #1d4ed8; }
        .priority-badge.high { background: #fef3c7; color: #92400e; }
        .priority-badge.critical { background: #fee2e2; color: #991b1b; }
        .sug-status-btn { padding: 3px 8px; border-radius: 6px; font-size: 0.6875rem; font-weight: 600; border: 1px solid #d1d5db; cursor: pointer; background: white; color: #4b5563; transition: all 0.15s; }
        .sug-status-btn:hover { border-color: #667eea; color: #667eea; }
        .sug-status-btn.active { background: #667eea; color: white; border-color: #667eea; }

        /* App Analyzer */
        .scan-section { background: white; border-radius: 12px; box-shadow: 0 1px 4px rgba(0,0,0,0.06); margin-bottom: 1rem; overflow: hidden; }
        .scan-section-header { padding: 0.875rem 1rem; display: flex; justify-content: space-between; align-items: center; cursor: pointer; user-select: none; border-bottom: 1px solid transparent; transition: all 0.15s; }
        .scan-section-header:hover { background: #f9fafb; }
        .scan-section-header.open { border-bottom-color: #e5e7eb; }
        .scan-section-header h3 { font-size: 0.875rem; font-weight: 600; color: #1f2937; display: flex; align-items: center; gap: 0.5rem; }
        .scan-section-body { padding: 1rem; display: none; }
        .scan-section-body.open { display: block; }
        .scan-badge { padding: 2px 8px; border-radius: 999px; font-size: 0.6875rem; font-weight: 600; }
        .scan-badge.ok { background: #d1fae5; color: #065f46; }
        .scan-badge.warn { background: #fef3c7; color: #92400e; }
        .scan-badge.err { background: #fee2e2; color: #991b1b; }
        .scan-table { width: 100%; font-size: 0.8125rem; border-collapse: collapse; }
        .scan-table th { text-align: left; padding: 0.5rem; color: #6b7280; font-weight: 600; border-bottom: 1px solid #e5e7eb; font-size: 0.75rem; text-transform: uppercase; }
        .scan-table td { padding: 0.5rem; border-bottom: 1px solid #f3f4f6; color: #374151; }
        .scan-issue { display: flex; align-items: start; gap: 0.5rem; padding: 0.5rem; background: #fffbeb; border-radius: 8px; margin-bottom: 0.5rem; font-size: 0.8125rem; }
        .scan-issue.critical { background: #fef2f2; }
        .scan-issue.info { background: #eff6ff; }
        .analyzer-stream { background: #f9fafb; border-radius: 10px; padding: 1.25rem; font-size: 0.8125rem; line-height: 1.7; min-height: 100px; max-height: 600px; overflow-y: auto; white-space: pre-wrap; word-break: break-word; }
        .analyzer-stream code { background: #e5e7eb; padding: 1px 4px; border-radius: 3px; font-size: 0.8em; }
        .analyzer-stream pre { background: #1f2937; color: #e5e7eb; padding: 1rem; border-radius: 8px; overflow-x: auto; margin: 0.75rem 0; position: relative; white-space: pre-wrap; }
        .copy-prompt-btn { position: absolute; top: 6px; right: 6px; padding: 3px 10px; border-radius: 6px; font-size: 0.6875rem; font-weight: 600; border: 1px solid rgba(255,255,255,0.2); cursor: pointer; background: rgba(255,255,255,0.1); color: #d1d5db; transition: all 0.15s; }
        .copy-prompt-btn:hover { background: rgba(255,255,255,0.2); color: white; }
        .prompt-output { background: #1f2937; color: #e5e7eb; padding: 1rem; border-radius: 10px; font-size: 0.8125rem; line-height: 1.6; font-family: 'Courier New', monospace; white-space: pre-wrap; word-break: break-word; position: relative; min-height: 60px; max-height: 400px; overflow-y: auto; }
        .focus-select { padding: 0.375rem 0.75rem; border-radius: 8px; border: 1px solid #d1d5db; font-size: 0.8125rem; background: white; }

        /* Dashboard */
        .dash-kpi-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
        .kpi-card { background: white; border-radius: 12px; padding: 1rem 1.25rem; box-shadow: 0 1px 4px rgba(0,0,0,0.06); }
        .kpi-label { font-size: 0.6875rem; color: #6b7280; text-transform: uppercase; font-weight: 600; letter-spacing: 0.025em; }
        .kpi-value { font-size: 1.5rem; font-weight: 700; color: #1f2937; margin: 0.25rem 0; }
        .kpi-change { font-size: 0.75rem; font-weight: 600; }
        .kpi-change.up { color: #10b981; }
        .kpi-change.down { color: #ef4444; }
        .kpi-change.neutral { color: #6b7280; }
        .kpi-sub { font-size: 0.6875rem; color: #9ca3af; }

        .dash-split { display: grid; grid-template-columns: 340px 1fr; gap: 1.5rem; margin-bottom: 1.5rem; }
        .dash-panel { background: white; border-radius: 12px; padding: 1.25rem; box-shadow: 0 1px 4px rgba(0,0,0,0.06); }
        .dash-panel h3 { font-size: 0.9375rem; font-weight: 700; color: #1f2937; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }

        .dash-insight-item { padding: 0.625rem; border-radius: 8px; border-left: 3px solid #d1d5db; margin-bottom: 0.5rem; cursor: pointer; transition: background 0.15s; }
        .dash-insight-item:hover { background: #f9fafb; }
        .dash-insight-item.sev-critical { border-left-color: #ef4444; }
        .dash-insight-item.sev-high { border-left-color: #f59e0b; }
        .dash-insight-item.sev-medium { border-left-color: #3b82f6; }
        .dash-insight-item.sev-low { border-left-color: #10b981; }
        .dash-insight-item.sev-info { border-left-color: #3b82f6; }
        .dash-insight-item.sev-warning { border-left-color: #f59e0b; }

        .scorecard-table { width: 100%; border-collapse: collapse; font-size: 0.8125rem; }
        .scorecard-table th { text-align: left; padding: 0.5rem 0.625rem; font-size: 0.6875rem; color: #6b7280; text-transform: uppercase; font-weight: 600; border-bottom: 2px solid #e5e7eb; }
        .scorecard-table td { padding: 0.5rem 0.625rem; border-bottom: 1px solid #f3f4f6; }
        .scorecard-table tr:hover { background: #f9fafb; }

        .chart-tabs { display: flex; gap: 0.25rem; margin-bottom: 1rem; }
        .chart-tab { padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.8125rem; font-weight: 600; border: 1px solid #e5e7eb; cursor: pointer; background: white; color: #6b7280; transition: all 0.15s; }
        .chart-tab:hover { border-color: #667eea; color: #667eea; }
        .chart-tab.active { background: #667eea; color: white; border-color: #667eea; }

        .dash-query-bar { background: white; border-radius: 12px; padding: 1rem 1.25rem; box-shadow: 0 1px 4px rgba(0,0,0,0.06); margin-bottom: 1.5rem; }
        .dash-query-input { display: flex; gap: 0.5rem; margin-bottom: 0.5rem; }
        .dash-query-input input { flex: 1; padding: 0.625rem 1rem; border-radius: 10px; border: 1px solid #d1d5db; font-size: 0.875rem; outline: none; }
        .dash-query-input input:focus { border-color: #667eea; box-shadow: 0 0 0 3px rgba(102,126,234,0.1); }
        .dash-query-input button { padding: 0.625rem 1.25rem; border-radius: 10px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; font-weight: 600; font-size: 0.875rem; cursor: pointer; white-space: nowrap; }
        .dash-query-input button:hover { opacity: 0.9; }
        .dash-quick-chips { display: flex; gap: 0.375rem; flex-wrap: wrap; }
        .dash-quick-chip { padding: 0.25rem 0.625rem; border-radius: 999px; font-size: 0.6875rem; border: 1px solid #e5e7eb; cursor: pointer; background: white; color: #4b5563; transition: all 0.15s; white-space: nowrap; }
        .dash-quick-chip:hover { border-color: #667eea; color: #667eea; background: #eef2ff; }

        @media (max-width: 768px) {
            .chat-sidebar { display: none; }
            .chat-container { height: calc(100vh - 200px); }
            .insight-grid { grid-template-columns: 1fr !important; }
            .dash-kpi-grid { grid-template-columns: repeat(2, 1fr); }
            .dash-split { grid-template-columns: 1fr; }
            /* Compact quick-prompts: single scrollable row on mobile */
            .quick-prompts-toggle { display: flex; align-items: center; justify-content: center; }
            .quick-prompts {
                flex-wrap: nowrap;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                padding: 0.375rem 0.75rem;
                gap: 0.375rem;
                scrollbar-width: none; /* Firefox */
            }
            .quick-prompts::-webkit-scrollbar { display: none; }
            .quick-prompts.collapsed { padding: 0.25rem 0.75rem; border-bottom: none; }
            .quick-prompt { font-size: 0.6875rem; padding: 0.25rem 0.625rem; flex-shrink: 0; }
            .chat-messages { padding: 0.75rem; gap: 0.625rem; }
            .chat-input-area { padding: 0.5rem 0.75rem; }
            .chat-input-area textarea { font-size: 0.8125rem; padding: 0.5rem 0.75rem; }
            .msg { font-size: 0.8125rem; padding: 0.625rem 0.875rem; }
        }
    </style>
</head>
<body data-page="ai">

<div id="nav-placeholder"></div>
<div id="subnav-placeholder"></div>

<main style="max-width: 1400px; margin: 0 auto; padding: 1rem;">
    <!-- Page header -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <div>
            <h1 style="font-size: 1.375rem; font-weight: 700; color: #1f2937; display: flex; align-items: center; gap: 0.5rem;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#667eea" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a4 4 0 0 1 4 4c0 1.95-1.4 3.58-3.25 3.93"/><path d="M8.24 4.73A4 4 0 0 1 12 2"/><path d="M5 10a4 4 0 0 1 6.5-3.1"/><path d="M2 14a4 4 0 0 1 3-3.87"/><path d="M7 18a4 4 0 0 1-2-7.46"/><path d="M9.84 21.02A4 4 0 0 1 7 18"/><path d="M14 22a4 4 0 0 1-2.18-3.17"/><path d="M17 18a4 4 0 0 1-5.22 3.81"/><path d="M22 14a4 4 0 0 1-5 3.87"/><path d="M19 10a4 4 0 0 1 3 3.87"/><path d="M12 12m-2 0a2 2 0 1 0 4 0 2 2 0 1 0-4 0"/></svg>
                AI Dashboard
            </h1>
            <p style="font-size: 0.8125rem; color: #6b7280;">AI-powered business intelligence and analysis</p>
        </div>
        <div class="provider-toggle" id="globalProvider">
            <button class="provider-btn active" data-provider="gemini" onclick="setGlobalProvider('gemini')">Gemini</button>
            <button class="provider-btn" data-provider="claude" onclick="setGlobalProvider('claude')">Claude</button>
        </div>
    </div>

    <!-- Tabs -->
    <div class="tab-bar">
        <button class="tab-btn active" onclick="switchTab('dashboard')">
            <svg style="width:14px;height:14px;vertical-align:-2px;margin-right:4px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
            Dashboard
        </button>
        <button class="tab-btn" onclick="switchTab('chat')">
            <svg style="width:14px;height:14px;vertical-align:-2px;margin-right:4px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
            Chat
        </button>
        <button class="tab-btn" onclick="switchTab('insights')">
            <svg style="width:14px;height:14px;vertical-align:-2px;margin-right:4px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v4m0 12v4m-7-7H1m22 0h-4m-2.636-6.364L14.95 7.05m-5.9 9.9l-1.414 1.414M19.364 5.636L17.95 7.05m-11.9 9.9l-1.414 1.414"/><circle cx="12" cy="12" r="3"/></svg>
            Insights
            <span class="tab-badge" id="insightsBadge" style="display:none">0</span>
        </button>
        <button class="tab-btn" onclick="switchTab('suggestions')">
            <svg style="width:14px;height:14px;vertical-align:-2px;margin-right:4px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18h6"/><path d="M10 22h4"/><path d="M12 2a7 7 0 0 0-4 12.7V17h8v-2.3A7 7 0 0 0 12 2z"/></svg>
            Suggestions
            <span class="tab-badge" id="suggestionsBadge" style="display:none">0</span>
        </button>
        <button class="tab-btn" onclick="switchTab('settings')">
            <svg style="width:14px;height:14px;vertical-align:-2px;margin-right:4px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9c.26.604.852.997 1.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
            Settings
        </button>
        <button class="tab-btn" onclick="switchTab('analyzer')">
            <svg style="width:14px;height:14px;vertical-align:-2px;margin-right:4px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/></svg>
            App Analyzer
        </button>
    </div>

    <!-- Tab: Dashboard -->
    <div id="tab-dashboard" class="tab-content">
        <!-- Quick AI Query Bar -->
        <div class="dash-query-bar">
            <div class="dash-query-input">
                <input type="text" id="dashQueryInput" placeholder="Ask anything about your business..." onkeydown="if(event.key==='Enter'){dashQuerySend()}">
                <button onclick="dashQuerySend()">Ask AI</button>
            </div>
            <div class="dash-quick-chips">
                <span class="dash-quick-chip" onclick="dashQuickQuery('Revenue today?')">Revenue today?</span>
                <span class="dash-quick-chip" onclick="dashQuickQuery('Branch performance this month')">Branch performance</span>
                <span class="dash-quick-chip" onclick="dashQuickQuery('Overdue collections breakdown')">Overdue?</span>
                <span class="dash-quick-chip" onclick="dashQuickQuery('What needs my attention today?')">Attention needed</span>
                <span class="dash-quick-chip" onclick="dashQuickQuery('Staff attendance today')">Attendance</span>
                <span class="dash-quick-chip" onclick="dashQuickQuery('Stock alerts - out of stock items')">Stock alerts</span>
            </div>
        </div>

        <!-- KPI Cards -->
        <div class="dash-kpi-grid" id="dashKpiGrid">
            <div class="kpi-card">
                <div class="kpi-label">Today's Revenue</div>
                <div class="kpi-value" id="kpiTodayRev">--</div>
                <div class="kpi-change neutral" id="kpiRevChange">vs yesterday</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Month Revenue</div>
                <div class="kpi-value" id="kpiMonthRev">--</div>
                <div class="kpi-sub" id="kpiMonthSub">Loading...</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Today's Collections</div>
                <div class="kpi-value" id="kpiCollections">--</div>
                <div class="kpi-sub" id="kpiCollSub">&nbsp;</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Overdue</div>
                <div class="kpi-value" id="kpiOverdue" style="color:#ef4444">--</div>
                <div class="kpi-sub" id="kpiOverdueSub">Loading...</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Staff Present</div>
                <div class="kpi-value" id="kpiStaff">--</div>
                <div class="kpi-sub" id="kpiStaffSub">&nbsp;</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">Stock Alerts</div>
                <div class="kpi-value" id="kpiStock">--</div>
                <div class="kpi-sub" id="kpiStockSub">Loading...</div>
            </div>
        </div>

        <!-- Insights Panel + Branch Scorecards -->
        <div class="dash-split">
            <!-- Insights Panel -->
            <div class="dash-panel" style="max-height: 420px; overflow-y: auto;">
                <h3>
                    <svg style="width:16px;height:16px" viewBox="0 0 24 24" fill="none" stroke="#667eea" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                    Recent Insights
                </h3>
                <div id="dashInsightsPanel">
                    <div style="text-align:center; padding:2rem; color:#9ca3af; font-size:0.8125rem;">Loading...</div>
                </div>
                <div style="margin-top:0.75rem;">
                    <button onclick="switchToTab('insights')" style="width:100%; padding:0.5rem; border-radius:8px; border:1px solid #e5e7eb; background:white; color:#667eea; font-size:0.8125rem; font-weight:600; cursor:pointer;">View All Insights</button>
                </div>
            </div>
            <!-- Branch Scorecards -->
            <div class="dash-panel" style="overflow-x: auto;">
                <h3>
                    <svg style="width:16px;height:16px" viewBox="0 0 24 24" fill="none" stroke="#667eea" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                    Branch Performance
                </h3>
                <div id="dashBranchScorecard">
                    <div style="text-align:center; padding:2rem; color:#9ca3af; font-size:0.8125rem;">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="dash-panel">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                <h3 style="margin-bottom:0;">
                    <svg style="width:16px;height:16px" viewBox="0 0 24 24" fill="none" stroke="#667eea" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
                    Analytics
                </h3>
                <div class="chart-tabs">
                    <button class="chart-tab active" onclick="showChart('trend', this)">Revenue Trend</button>
                    <button class="chart-tab" onclick="showChart('branch', this)">Branch Comparison</button>
                </div>
            </div>
            <div id="chartTrend" style="position:relative; height:320px;">
                <canvas id="revenueTrendChart"></canvas>
            </div>
            <div id="chartBranch" style="position:relative; height:320px; display:none;">
                <canvas id="branchCompareChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Tab: Chat -->
    <div id="tab-chat" class="tab-content" style="display:none">
        <div class="chat-container">
            <!-- Sidebar: conversation list -->
            <div class="chat-sidebar">
                <div class="chat-sidebar-header">
                    <button onclick="newConversation()" style="flex:1; padding:0.5rem; border-radius:8px; background:linear-gradient(135deg,#667eea,#764ba2); color:white; border:none; cursor:pointer; font-size:0.8125rem; font-weight:600;">+ New Chat</button>
                </div>
                <div class="chat-sidebar-list" id="convList"></div>
            </div>

            <!-- Main chat area -->
            <div class="chat-main">
                <div class="quick-prompts" id="quickPromptsBar">
                    <button class="quick-prompts-toggle" id="promptsToggle" onclick="toggleQuickPrompts()" title="Toggle suggestions">&#x25BC;</button>
                    <button class="quick-prompt" onclick="quickAsk('Give me a full business health check ‚Äî revenue, staff, collections, leads, stock')">Health Check</button>
                    <button class="quick-prompt" onclick="quickAsk('What needs my attention today? Flag any problems or urgent items')">Attention Needed</button>
                    <button class="quick-prompt" onclick="quickAsk('Revenue analysis ‚Äî branch breakdown, top customers, compare to yesterday and last week')">Revenue Analysis</button>
                    <button class="quick-prompt" onclick="quickAsk('Collection report ‚Äî overdue aging, top debtors, collection rate, payment promises due')">Collection Report</button>
                    <button class="quick-prompt" onclick="quickAsk('Full staff report ‚Äî who is present, absent, late arrivals, break violations, pending OT')">Staff Report</button>
                    <button class="quick-prompt" onclick="quickAsk('Today\'s attendance summary ‚Äî present count, absent list, any late arrivals')">Attendance</button>
                    <button class="quick-prompt" onclick="quickAsk('Inventory alerts ‚Äî out of stock items, below reorder level, recent stock checks')">Inventory Alerts</button>
                    <button class="quick-prompt" onclick="quickAsk('Leads pipeline ‚Äî status funnel, follow-ups due today, stale leads, top scored leads')">Leads Pipeline</button>
                    <button class="quick-prompt" onclick="quickAsk('What are some growth ideas for our paint business based on current data?')">Growth Ideas</button>
                    <button class="quick-prompt" onclick="quickAsk('Customer analysis ‚Äî top buyers this month, new vs returning, any concerns?')">Customer Analysis</button>
                    <button class="quick-prompt" onclick="quickAsk('Suggest software improvements for our business manager app based on what you see in the data')">Software Ideas</button>
                    <button class="quick-prompt" onclick="quickAsk('Compare this week vs last week ‚Äî revenue, collections, leads, staff performance')">Week Comparison</button>
                </div>
                <div class="chat-messages" id="chatMessages">
                    <div style="text-align:center; color:#9ca3af; padding:3rem 1rem; font-size:0.875rem;">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#667eea" stroke-width="1.5" style="margin:0 auto 1rem"><path d="M12 2a4 4 0 0 1 4 4c0 1.95-1.4 3.58-3.25 3.93"/><path d="M8.24 4.73A4 4 0 0 1 12 2"/><path d="M5 10a4 4 0 0 1 6.5-3.1"/><path d="M2 14a4 4 0 0 1 3-3.87"/><path d="M7 18a4 4 0 0 1-2-7.46"/><path d="M9.84 21.02A4 4 0 0 1 7 18"/><path d="M14 22a4 4 0 0 1-2.18-3.17"/><path d="M17 18a4 4 0 0 1-5.22 3.81"/><path d="M22 14a4 4 0 0 1-5 3.87"/><path d="M19 10a4 4 0 0 1 3 3.87"/><circle cx="12" cy="12" r="2"/></svg>
                        <p style="font-weight:700; color:#374151; margin-bottom:0.25rem; font-size:1rem;">QC Business Manager</p>
                        <p style="margin-bottom:0.5rem;">I have full access to all your business data ‚Äî revenue, staff, leads, stock, collections, and more.</p>
                        <p style="font-size:0.75rem; color:#9ca3af;">Ask me anything or use the quick prompts above to get started.</p>
                    </div>
                </div>
                <div class="chat-input-area">
                    <textarea id="chatInput" rows="1" placeholder="Ask me anything ‚Äî revenue, staff, leads, stock, growth ideas..." onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendMessage()}"></textarea>
                    <button class="chat-send-btn" id="sendBtn" onclick="sendMessage()">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab: Insights -->
    <div id="tab-insights" class="tab-content" style="display:none">
        <!-- Category filters -->
        <div style="display:flex; gap:0.5rem; flex-wrap:wrap; margin-bottom:1rem; align-items:center;">
            <button class="category-pill active" onclick="filterInsights('all', this)">All</button>
            <button class="category-pill" onclick="filterInsights('revenue', this)">Revenue</button>
            <button class="category-pill" onclick="filterInsights('collections', this)">Collections</button>
            <button class="category-pill" onclick="filterInsights('overdue', this)">Overdue</button>
            <button class="category-pill" onclick="filterInsights('staff', this)">Staff</button>
            <button class="category-pill" onclick="filterInsights('leads', this)">Leads</button>
            <button class="category-pill" onclick="filterInsights('marketing', this)">Marketing</button>
            <div style="flex:1"></div>
            <select id="severityFilter" onchange="filterInsights(currentCategory)" style="padding:0.375rem 0.75rem; border-radius:8px; border:1px solid #d1d5db; font-size:0.8125rem;">
                <option value="">All Severity</option>
                <option value="critical">Critical</option>
                <option value="warning">Warning</option>
                <option value="info">Info</option>
            </select>
            <button class="run-btn" onclick="markAllRead()">Mark All Read</button>
        </div>

        <!-- Manual run buttons -->
        <div style="display:flex; gap:0.5rem; flex-wrap:wrap; margin-bottom:1rem;">
            <button class="run-btn" id="runZoho" onclick="triggerAnalysis('zoho_daily', this)">Run Zoho Analysis</button>
            <button class="run-btn" id="runStaff" onclick="triggerAnalysis('staff_daily', this)">Run Staff Analysis</button>
            <button class="run-btn" id="runLeads" onclick="triggerAnalysis('lead_scoring', this)">Run Lead Scoring</button>
            <button class="run-btn" id="runMarketing" onclick="triggerAnalysis('marketing_tips', this)">Run Marketing Analysis</button>
        </div>

        <div id="insightsGrid" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap:1rem;" class="insight-grid"></div>
        <div id="insightsEmpty" style="text-align:center; padding:3rem; color:#9ca3af; display:none;">
            <p style="font-weight:600; margin-bottom:0.25rem;">No insights yet</p>
            <p style="font-size:0.8125rem;">Run an analysis to generate AI-powered business insights.</p>
        </div>
    </div>

    <!-- Tab: Suggestions -->
    <div id="tab-suggestions" class="tab-content" style="display:none">
        <div style="display:flex; gap:0.5rem; flex-wrap:wrap; margin-bottom:1rem; align-items:center;">
            <button class="category-pill active" onclick="filterSuggestions('all', this)">All</button>
            <button class="category-pill" onclick="filterSuggestions('operations', this)">Operations</button>
            <button class="category-pill" onclick="filterSuggestions('software', this)">Software</button>
            <button class="category-pill" onclick="filterSuggestions('marketing', this)">Marketing</button>
            <button class="category-pill" onclick="filterSuggestions('staffing', this)">Staffing</button>
            <button class="category-pill" onclick="filterSuggestions('inventory', this)">Inventory</button>
            <button class="category-pill" onclick="filterSuggestions('financial', this)">Financial</button>
            <button class="category-pill" onclick="filterSuggestions('growth', this)">Growth</button>
            <div style="flex:1"></div>
            <select id="sugStatusFilter" onchange="filterSuggestions(currentSugCategory)" style="padding:0.375rem 0.75rem; border-radius:8px; border:1px solid #d1d5db; font-size:0.8125rem;">
                <option value="">All Status</option>
                <option value="new">New</option>
                <option value="acknowledged">Acknowledged</option>
                <option value="in_progress">In Progress</option>
                <option value="implemented">Implemented</option>
                <option value="dismissed">Dismissed</option>
            </select>
        </div>

        <div id="suggestionsGrid" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(360px, 1fr)); gap:1rem;" class="insight-grid"></div>
        <div id="suggestionsEmpty" style="text-align:center; padding:3rem; color:#9ca3af; display:none;">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#d1d5db" stroke-width="1.5" style="margin:0 auto 1rem"><path d="M9 18h6"/><path d="M10 22h4"/><path d="M12 2a7 7 0 0 0-4 12.7V17h8v-2.3A7 7 0 0 0 12 2z"/></svg>
            <p style="font-weight:600; margin-bottom:0.25rem;">No suggestions yet</p>
            <p style="font-size:0.8125rem;">AI suggestions will appear here as the system analyzes your business data.</p>
        </div>
    </div>

    <!-- Tab: Settings -->
    <div id="tab-settings" class="tab-content" style="display:none">
        <!-- Stats row -->
        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:1rem; margin-bottom:1.5rem;">
            <div class="stat-card"><div class="stat-value" id="statRuns">-</div><div class="stat-label">Analysis Runs</div></div>
            <div class="stat-card"><div class="stat-value" id="statTokens">-</div><div class="stat-label">Tokens Used</div></div>
            <div class="stat-card"><div class="stat-value" id="statInsights">-</div><div class="stat-label">Total Insights</div></div>
            <div class="stat-card"><div class="stat-value" id="statMessages">-</div><div class="stat-label">Chat Messages</div></div>
            <div class="stat-card"><div class="stat-value" id="statCost">-</div><div class="stat-label">Est. Cost (USD)</div></div>
        </div>

        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap:1rem;">
            <!-- API Keys -->
            <div class="config-card">
                <h3>API Keys</h3>
                <div class="config-row">
                    <div><div class="config-label">Gemini API Key</div><div class="config-desc">Google AI Studio key (falls back to server .env)</div></div>
                    <div style="display:flex;gap:4px;align-items:center;">
                        <input type="password" id="cfgGeminiKey" placeholder="AIza..." style="width:200px; padding:0.375rem 0.5rem; border-radius:8px; border:1px solid #d1d5db; font-size:0.8125rem; font-family:monospace;">
                        <button onclick="toggleKeyVisibility('cfgGeminiKey', this)" style="border:none;background:none;cursor:pointer;font-size:1rem;color:#6b7280;" title="Show/hide">üëÅ</button>
                        <button onclick="saveApiKey('gemini_api_key', 'cfgGeminiKey')" class="run-btn" style="padding:0.375rem 0.75rem;">Save</button>
                    </div>
                </div>
                <div class="config-row">
                    <div><div class="config-label">Anthropic API Key</div><div class="config-desc">For Claude fallback provider</div></div>
                    <div style="display:flex;gap:4px;align-items:center;">
                        <input type="password" id="cfgClaudeKey" placeholder="sk-ant-..." style="width:200px; padding:0.375rem 0.5rem; border-radius:8px; border:1px solid #d1d5db; font-size:0.8125rem; font-family:monospace;">
                        <button onclick="toggleKeyVisibility('cfgClaudeKey', this)" style="border:none;background:none;cursor:pointer;font-size:1rem;color:#6b7280;" title="Show/hide">üëÅ</button>
                        <button onclick="saveApiKey('anthropic_api_key', 'cfgClaudeKey')" class="run-btn" style="padding:0.375rem 0.75rem;">Save</button>
                    </div>
                </div>
                <div class="config-row">
                    <div><div class="config-label">Gemini Model</div><div class="config-desc">Model for text chat/analysis</div></div>
                    <select id="cfgGeminiModel" onchange="saveConfig('gemini_model', this.value)" style="padding:0.375rem 0.75rem; border-radius:8px; border:1px solid #d1d5db; font-size:0.8125rem;">
                        <option value="gemini-2.0-flash">gemini-2.0-flash (Fast)</option>
                        <option value="gemini-2.0-flash-lite">gemini-2.0-flash-lite (Fastest)</option>
                        <option value="gemini-2.5-flash-preview-05-20">gemini-2.5-flash-preview (Latest)</option>
                        <option value="gemini-2.5-pro-preview-05-06">gemini-2.5-pro-preview (Best)</option>
                    </select>
                </div>
                <div class="config-row">
                    <div><div class="config-label">Claude Model</div><div class="config-desc">Model for Claude provider</div></div>
                    <select id="cfgClaudeModel" onchange="saveConfig('claude_model', this.value)" style="padding:0.375rem 0.75rem; border-radius:8px; border:1px solid #d1d5db; font-size:0.8125rem;">
                        <option value="claude-sonnet-4-20250514">Claude Sonnet 4 (Balanced)</option>
                        <option value="claude-haiku-4-5-20251001">Claude Haiku 4.5 (Fast)</option>
                    </select>
                </div>
            </div>

            <!-- Provider Config -->
            <div class="config-card">
                <h3>AI Provider Settings</h3>
                <div class="config-row">
                    <div><div class="config-label">Primary Provider</div><div class="config-desc">Used for all AI requests first</div></div>
                    <select id="cfgPrimary" onchange="saveConfig('primary_provider', this.value)" style="padding:0.375rem 0.75rem; border-radius:8px; border:1px solid #d1d5db; font-size:0.8125rem;">
                        <option value="gemini">Gemini</option>
                        <option value="claude">Claude</option>
                        <option value="clawdbot">Clawdbot (Kai)</option>
                    </select>
                </div>
                <div class="config-row">
                    <div><div class="config-label">Fallback Provider</div><div class="config-desc">Used when primary fails</div></div>
                    <select id="cfgFallback" onchange="saveConfig('fallback_provider', this.value)" style="padding:0.375rem 0.75rem; border-radius:8px; border:1px solid #d1d5db; font-size:0.8125rem;">
                        <option value="claude">Claude</option>
                        <option value="gemini">Gemini</option>
                        <option value="clawdbot">Clawdbot (Kai)</option>
                    </select>
                </div>
                <div class="config-row">
                    <div><div class="config-label">Temperature</div><div class="config-desc">Lower = more focused (0.1-1.0)</div></div>
                    <input type="number" id="cfgTemp" min="0.1" max="1" step="0.1" onchange="saveConfig('temperature', this.value)" style="width:70px; padding:0.375rem; border-radius:8px; border:1px solid #d1d5db; font-size:0.8125rem; text-align:center;">
                </div>
                <div class="config-row">
                    <div><div class="config-label">Max Tokens (Analysis)</div><div class="config-desc">Max output tokens for analysis runs</div></div>
                    <input type="number" id="cfgMaxTokens" min="256" max="8192" step="256" onchange="saveConfig('max_tokens_per_request', this.value)" style="width:80px; padding:0.375rem; border-radius:8px; border:1px solid #d1d5db; font-size:0.8125rem; text-align:center;">
                </div>
            </div>

            <!-- Chat Config -->
            <div class="config-card">
                <h3>Chat Settings (Business Manager)</h3>
                <div class="config-row">
                    <div><div class="config-label">Chat Max Tokens</div><div class="config-desc">Max output tokens for chat responses</div></div>
                    <input type="number" id="cfgChatMaxTokens" min="1024" max="16384" step="1024" onchange="saveConfig('chat_max_tokens', this.value)" style="width:80px; padding:0.375rem; border-radius:8px; border:1px solid #d1d5db; font-size:0.8125rem; text-align:center;">
                </div>
                <div class="config-row">
                    <div><div class="config-label">Chat Temperature</div><div class="config-desc">Higher = more creative chat (0.1-1.0)</div></div>
                    <input type="number" id="cfgChatTemp" min="0.1" max="1" step="0.1" onchange="saveConfig('chat_temperature', this.value)" style="width:70px; padding:0.375rem; border-radius:8px; border:1px solid #d1d5db; font-size:0.8125rem; text-align:center;">
                </div>
                <div class="config-row">
                    <div><div class="config-label">Daily Snapshots</div><div class="config-desc">Cache business data at 6AM, 12PM, 6PM IST</div></div>
                    <label class="toggle-switch"><input type="checkbox" id="cfgDailySnapshot" onchange="saveConfig('daily_snapshot_enabled', this.checked?'1':'0')"><span class="toggle-track"></span></label>
                </div>
                <div class="config-row">
                    <div><div class="config-label">Refresh Snapshot Now</div><div class="config-desc">Manually generate a fresh business snapshot</div></div>
                    <button class="run-btn" id="refreshSnapshotBtn" onclick="refreshSnapshot(this)">Refresh</button>
                </div>
            </div>

            <!-- Schedule Config -->
            <div class="config-card">
                <h3>Automated Schedules</h3>
                <div class="config-row">
                    <div><div class="config-label">Daily Zoho Analysis</div><div class="config-desc">Revenue, collections, overdue at 9 PM IST</div></div>
                    <label class="toggle-switch"><input type="checkbox" id="cfgZohoDaily" onchange="saveConfig('zoho_daily_enabled', this.checked?'1':'0')"><span class="toggle-track"></span></label>
                </div>
                <div class="config-row">
                    <div><div class="config-label">Daily Staff Analysis</div><div class="config-desc">Attendance, performance at 10:30 PM IST</div></div>
                    <label class="toggle-switch"><input type="checkbox" id="cfgStaffDaily" onchange="saveConfig('staff_daily_enabled', this.checked?'1':'0')"><span class="toggle-track"></span></label>
                </div>
                <div class="config-row">
                    <div><div class="config-label">Lead Scoring</div><div class="config-desc">Every 6 hours</div></div>
                    <label class="toggle-switch"><input type="checkbox" id="cfgLeadScoring" onchange="saveConfig('lead_scoring_enabled', this.checked?'1':'0')"><span class="toggle-track"></span></label>
                </div>
                <div class="config-row">
                    <div><div class="config-label">Weekly Marketing Tips</div><div class="config-desc">Monday 9 AM IST</div></div>
                    <label class="toggle-switch"><input type="checkbox" id="cfgMarketing" onchange="saveConfig('marketing_weekly_enabled', this.checked?'1':'0')"><span class="toggle-track"></span></label>
                </div>
                <div class="config-row">
                    <div><div class="config-label">WhatsApp Reports</div><div class="config-desc">Send analysis summaries via WhatsApp</div></div>
                    <label class="toggle-switch"><input type="checkbox" id="cfgWhatsApp" onchange="saveConfig('whatsapp_reports_enabled', this.checked?'1':'0')"><span class="toggle-track"></span></label>
                </div>
                <div class="config-row">
                    <div><div class="config-label">WhatsApp Recipients</div><div class="config-desc">Comma-separated phone numbers</div></div>
                    <input type="text" id="cfgRecipients" placeholder="91XXXXXXXXXX" onchange="saveConfig('whatsapp_report_recipients', this.value)" style="width:180px; padding:0.375rem 0.5rem; border-radius:8px; border:1px solid #d1d5db; font-size:0.8125rem;">
                </div>
            </div>
        </div>

        <!-- Recent Runs -->
        <div class="config-card" style="margin-top:1rem;">
            <h3>Recent Analysis Runs</h3>
            <div id="recentRuns" style="font-size:0.8125rem;"></div>
        </div>
    </div>

    <!-- Tab: App Analyzer -->
    <div id="tab-analyzer" class="tab-content" style="display:none">
        <!-- Section A: Scan Control -->
        <div style="display:flex; gap:1rem; align-items:center; margin-bottom:1.5rem; flex-wrap:wrap;">
            <button class="run-btn" id="scanAppBtn" onclick="runAppScan()" style="padding:0.625rem 1.5rem; font-size:0.9375rem; background:linear-gradient(135deg,#667eea,#764ba2); color:white; border:none; border-radius:10px; font-weight:700; cursor:pointer;">
                <svg style="width:16px;height:16px;vertical-align:-3px;margin-right:6px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                Scan Application
            </button>
            <span id="scanTimestamp" style="font-size:0.75rem; color:#9ca3af;"></span>
            <span id="scanSpinner" style="display:none; font-size:0.8125rem; color:#667eea;">
                <svg style="width:16px;height:16px;vertical-align:-3px;margin-right:4px;animation:spin 1s linear infinite" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 11-6.219-8.56"/></svg>
                Scanning...
            </span>
        </div>

        <!-- Section B: Scan Results -->
        <div id="scanResults" style="display:none">
            <!-- Database -->
            <div class="scan-section" id="secDatabase">
                <div class="scan-section-header" onclick="toggleScanSection('Database')">
                    <h3>
                        <svg style="width:16px;height:16px" viewBox="0 0 24 24" fill="none" stroke="#667eea" stroke-width="2"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>
                        Database Schema
                    </h3>
                    <div style="display:flex;gap:0.5rem;align-items:center;">
                        <span id="dbStats" class="scan-badge ok"></span>
                        <svg style="width:16px;height:16px;color:#9ca3af;transition:transform 0.2s" class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                    </div>
                </div>
                <div class="scan-section-body" id="bodyDatabase"></div>
            </div>

            <!-- Routes -->
            <div class="scan-section" id="secRoutes">
                <div class="scan-section-header" onclick="toggleScanSection('Routes')">
                    <h3>
                        <svg style="width:16px;height:16px" viewBox="0 0 24 24" fill="none" stroke="#667eea" stroke-width="2"><path d="M16 3h5v5"/><path d="M4 20L21 3"/><path d="M21 16v5h-5"/><path d="M15 15l6 6"/><path d="M4 4l5 5"/></svg>
                        API Routes
                    </h3>
                    <div style="display:flex;gap:0.5rem;align-items:center;">
                        <span id="routeStats" class="scan-badge ok"></span>
                        <svg style="width:16px;height:16px;color:#9ca3af;transition:transform 0.2s" class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                    </div>
                </div>
                <div class="scan-section-body" id="bodyRoutes"></div>
            </div>

            <!-- Errors -->
            <div class="scan-section" id="secErrors">
                <div class="scan-section-header" onclick="toggleScanSection('Errors')">
                    <h3>
                        <svg style="width:16px;height:16px" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                        Recent Errors
                    </h3>
                    <div style="display:flex;gap:0.5rem;align-items:center;">
                        <span id="errorStats" class="scan-badge ok"></span>
                        <svg style="width:16px;height:16px;color:#9ca3af;transition:transform 0.2s" class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                    </div>
                </div>
                <div class="scan-section-body" id="bodyErrors"></div>
            </div>

            <!-- Health -->
            <div class="scan-section" id="secHealth">
                <div class="scan-section-header" onclick="toggleScanSection('Health')">
                    <h3>
                        <svg style="width:16px;height:16px" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
                        Health Metrics
                    </h3>
                    <div style="display:flex;gap:0.5rem;align-items:center;">
                        <span id="healthStats" class="scan-badge ok"></span>
                        <svg style="width:16px;height:16px;color:#9ca3af;transition:transform 0.2s" class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                    </div>
                </div>
                <div class="scan-section-body" id="bodyHealth"></div>
            </div>

            <!-- Business -->
            <div class="scan-section" id="secBusiness">
                <div class="scan-section-header" onclick="toggleScanSection('Business')">
                    <h3>
                        <svg style="width:16px;height:16px" viewBox="0 0 24 24" fill="none" stroke="#667eea" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 7V4a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v3"/></svg>
                        Business Stats
                    </h3>
                    <div style="display:flex;gap:0.5rem;align-items:center;">
                        <span id="bizStats" class="scan-badge ok"></span>
                        <svg style="width:16px;height:16px;color:#9ca3af;transition:transform 0.2s" class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                    </div>
                </div>
                <div class="scan-section-body" id="bodyBusiness"></div>
            </div>
        </div>

        <!-- Section C: AI Analysis -->
        <div style="background:white; border-radius:12px; padding:1.25rem; box-shadow:0 1px 4px rgba(0,0,0,0.06); margin-bottom:1rem;">
            <h3 style="font-size:0.9375rem; font-weight:600; color:#1f2937; margin-bottom:1rem; display:flex; align-items:center; gap:0.5rem;">
                <svg style="width:18px;height:18px" viewBox="0 0 24 24" fill="none" stroke="#667eea" stroke-width="2"><path d="M12 2a4 4 0 0 1 4 4c0 1.95-1.4 3.58-3.25 3.93"/><path d="M8.24 4.73A4 4 0 0 1 12 2"/><circle cx="12" cy="12" r="2"/></svg>
                AI Deep Analysis
            </h3>
            <div style="display:flex; gap:0.75rem; margin-bottom:1rem; flex-wrap:wrap;">
                <select id="analysisFocus" class="focus-select">
                    <option value="all">All Areas</option>
                    <option value="database">Database Only</option>
                    <option value="routes">Routes Only</option>
                    <option value="errors">Errors Only</option>
                    <option value="performance">Performance Only</option>
                </select>
                <button class="run-btn" id="aiAnalyzeBtn" onclick="runAIAnalysis()" style="background:linear-gradient(135deg,#667eea,#764ba2); color:white; border:none;">
                    Run AI Analysis
                </button>
                <button class="run-btn" id="upgradeBtn" onclick="generateUpgrades()">
                    Upgrade Suggestions
                </button>
            </div>
            <div id="analysisOutput" class="analyzer-stream" style="display:none;"></div>
        </div>

        <!-- Section D: Custom Prompt Builder -->
        <div style="background:white; border-radius:12px; padding:1.25rem; box-shadow:0 1px 4px rgba(0,0,0,0.06);">
            <h3 style="font-size:0.9375rem; font-weight:600; color:#1f2937; margin-bottom:1rem; display:flex; align-items:center; gap:0.5rem;">
                <svg style="width:18px;height:18px" viewBox="0 0 24 24" fill="none" stroke="#667eea" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                Custom Prompt Builder
            </h3>
            <p style="font-size:0.8125rem; color:#6b7280; margin-bottom:0.75rem;">Describe what you want in plain language. AI will generate a technical implementation prompt you can paste into Claude Code.</p>
            <textarea id="customPromptInput" rows="3" placeholder="E.g., I want to add invoice printing with PDF download, or Add a customer feedback form with star ratings..." style="width:100%; padding:0.75rem; border-radius:10px; border:1px solid #d1d5db; font-size:0.875rem; font-family:inherit; resize:vertical; box-sizing:border-box;" onkeydown="if(event.key==='Enter'&&event.ctrlKey){generateCustomPrompt()}"></textarea>
            <div style="display:flex; gap:0.5rem; margin-top:0.75rem;">
                <button class="run-btn" id="customPromptBtn" onclick="generateCustomPrompt()" style="background:linear-gradient(135deg,#667eea,#764ba2); color:white; border:none;">Generate Prompt</button>
            </div>
            <div id="customPromptOutput" class="prompt-output" style="display:none; margin-top:1rem;"></div>
        </div>
    </div>
</main>

<script src="/js/socket-helper.js"></script>
<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentConvId = null;
let currentProvider = 'gemini';
let currentCategory = 'all';
let isStreaming = false;
const token = localStorage.getItem('auth_token');
const headers = { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token };

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TABS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchTab(tab) {
    document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
    document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
    document.getElementById('tab-' + tab).style.display = '';
    if (event && event.currentTarget) event.currentTarget.classList.add('active');
    else {
        // Find matching tab button by text
        document.querySelectorAll('.tab-btn').forEach(b => {
            if (b.textContent.trim().toLowerCase().replace(/\s+/g,'').includes(tab)) b.classList.add('active');
        });
    }
    if (tab === 'dashboard') loadDashboard();
    if (tab === 'insights') loadInsights();
    if (tab === 'suggestions') loadSuggestions();
    if (tab === 'settings') loadSettings();
}

// switchToTab: programmatic tab switch (no event)
function switchToTab(tab) {
    document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
    document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
    document.getElementById('tab-' + tab).style.display = '';
    const tabNames = { dashboard: 'Dashboard', chat: 'Chat', insights: 'Insights', suggestions: 'Suggestions', settings: 'Settings', analyzer: 'App Analyzer' };
    document.querySelectorAll('.tab-btn').forEach(b => {
        if (b.textContent.trim() === tabNames[tab]) b.classList.add('active');
    });
    if (tab === 'dashboard') loadDashboard();
    if (tab === 'insights') loadInsights();
    if (tab === 'suggestions') loadSuggestions();
    if (tab === 'settings') loadSettings();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PROVIDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setGlobalProvider(p) {
    currentProvider = p;
    document.querySelectorAll('#globalProvider .provider-btn').forEach(b => {
        b.classList.toggle('active', b.dataset.provider === p);
    });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONVERSATIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadConversations() {
    try {
        const resp = await fetch('/api/ai/conversations', { headers });
        const data = await resp.json();
        const list = document.getElementById('convList');
        list.innerHTML = '';
        (data.data || []).forEach(c => {
            const div = document.createElement('div');
            div.className = 'conv-item' + (c.id === currentConvId ? ' active' : '');
            div.innerHTML = `<span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escHtml(c.title)}</span>
                <span class="conv-delete" onclick="event.stopPropagation();deleteConversation(${c.id})">&times;</span>`;
            div.onclick = () => loadConversation(c.id);
            list.appendChild(div);
        });
    } catch (e) { /* ignore */ }
}

async function newConversation() {
    currentConvId = null;
    document.getElementById('chatMessages').innerHTML = `
        <div style="text-align:center; color:#9ca3af; padding:3rem 1rem; font-size:0.875rem;">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#667eea" stroke-width="1.5" style="margin:0 auto 1rem"><path d="M12 2a4 4 0 0 1 4 4c0 1.95-1.4 3.58-3.25 3.93"/><path d="M8.24 4.73A4 4 0 0 1 12 2"/><path d="M5 10a4 4 0 0 1 6.5-3.1"/><path d="M2 14a4 4 0 0 1 3-3.87"/><path d="M7 18a4 4 0 0 1-2-7.46"/><path d="M9.84 21.02A4 4 0 0 1 7 18"/><path d="M14 22a4 4 0 0 1-2.18-3.17"/><path d="M17 18a4 4 0 0 1-5.22 3.81"/><path d="M22 14a4 4 0 0 1-5 3.87"/><path d="M19 10a4 4 0 0 1 3 3.87"/><circle cx="12" cy="12" r="2"/></svg>
            <p style="font-weight:700; color:#374151; margin-bottom:0.25rem; font-size:1rem;">QC Business Manager</p>
            <p style="margin-bottom:0.5rem;">I have full access to all your business data ‚Äî revenue, staff, leads, stock, collections, and more.</p>
            <p style="font-size:0.75rem; color:#9ca3af;">Ask me anything or use the quick prompts above to get started.</p>
        </div>`;
    document.querySelectorAll('.conv-item').forEach(el => el.classList.remove('active'));
}

async function loadConversation(id) {
    currentConvId = id;
    try {
        const resp = await fetch(`/api/ai/conversations/${id}/messages`, { headers });
        const data = await resp.json();
        const container = document.getElementById('chatMessages');
        container.innerHTML = '';
        (data.data || []).forEach(m => {
            appendMessage(m.role, m.content, m.model);
        });
        container.scrollTop = container.scrollHeight;
        loadConversations(); // refresh active state
    } catch (e) { /* ignore */ }
}

async function deleteConversation(id) {
    if (!confirm('Delete this conversation?')) return;
    await fetch(`/api/ai/conversations/${id}`, { method: 'DELETE', headers });
    if (currentConvId === id) newConversation();
    loadConversations();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CHAT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function quickAsk(text) {
    document.getElementById('chatInput').value = text;
    sendMessage();
}

function toggleQuickPrompts() {
    const bar = document.getElementById('quickPromptsBar');
    bar.classList.toggle('collapsed');
}

async function sendMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    if (!message || isStreaming) return;

    input.value = '';
    input.style.height = 'auto';
    isStreaming = true;
    document.getElementById('sendBtn').disabled = true;

    // Show user message
    appendMessage('user', message);

    // Show typing indicator
    const typingEl = document.createElement('div');
    typingEl.className = 'msg assistant';
    typingEl.id = 'typing-indicator';
    typingEl.innerHTML = '<div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>';
    document.getElementById('chatMessages').appendChild(typingEl);
    scrollChat();

    try {
        const resp = await fetch('/api/ai/chat', {
            method: 'POST',
            headers,
            body: JSON.stringify({
                conversation_id: currentConvId,
                message,
                provider: currentProvider
            })
        });

        // Check for HTTP errors
        if (!resp.ok && resp.headers.get('content-type')?.includes('application/json')) {
            const ti = document.getElementById('typing-indicator');
            if (ti) ti.remove();
            const err = await resp.json();
            appendMessage('assistant', 'Error: ' + (err.error || err.message || 'Request failed'));
            isStreaming = false;
            document.getElementById('sendBtn').disabled = false;
            return;
        }

        // Remove typing indicator
        const ti = document.getElementById('typing-indicator');
        if (ti) ti.remove();

        // Create assistant message element
        const msgEl = document.createElement('div');
        msgEl.className = 'msg assistant';
        msgEl.innerHTML = '<span class="msg-text"></span><div class="msg-meta"></div>';
        document.getElementById('chatMessages').appendChild(msgEl);
        const textEl = msgEl.querySelector('.msg-text');
        const metaEl = msgEl.querySelector('.msg-meta');

        // Read SSE stream
        const reader = resp.body.getReader();
        const decoder = new TextDecoder();
        let fullText = '';
        let buffer = '';

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            buffer += decoder.decode(value, { stream: true });
            const lines = buffer.split('\n');
            buffer = lines.pop();

            for (const line of lines) {
                if (line.startsWith('data: ')) {
                    try {
                        const event = JSON.parse(line.slice(6));
                        if (event.type === 'conversation') {
                            currentConvId = event.id;
                            loadConversations();
                        } else if (event.type === 'done') {
                            metaEl.textContent = `${event.model} | ${event.tokens} tokens`;
                        } else if (event.type === 'error') {
                            textEl.textContent = 'Error: ' + event.error;
                            textEl.style.color = '#ef4444';
                        } else if (event.text) {
                            fullText += event.text;
                            textEl.innerHTML = renderMarkdown(fullText);
                            scrollChat();
                        }
                    } catch (e) { /* skip */ }
                }
            }
        }
    } catch (e) {
        const ti = document.getElementById('typing-indicator');
        if (ti) ti.remove();
        appendMessage('assistant', 'Error: ' + e.message);
    }

    isStreaming = false;
    document.getElementById('sendBtn').disabled = false;
    scrollChat();
}

function appendMessage(role, content, model) {
    const container = document.getElementById('chatMessages');
    // Remove placeholder if present
    const placeholder = container.querySelector('div[style*="text-align:center"]');
    if (placeholder) placeholder.remove();

    const div = document.createElement('div');
    div.className = 'msg ' + role;
    if (role === 'assistant') {
        div.innerHTML = `<span class="msg-text">${renderMarkdown(content)}</span>` +
            (model ? `<div class="msg-meta">${escHtml(model)}</div>` : '');
    } else {
        div.textContent = content;
    }
    container.appendChild(div);
    scrollChat();
}

function scrollChat() {
    const el = document.getElementById('chatMessages');
    el.scrollTop = el.scrollHeight;
}

function renderMarkdown(text) {
    // Simple markdown rendering (bold, italic, code, lists, headers)
    return escHtml(text)
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.+?)\*/g, '<em>$1</em>')
        .replace(/`([^`]+)`/g, '<code style="background:#e5e7eb;padding:1px 4px;border-radius:3px;font-size:0.8125em;">$1</code>')
        .replace(/^### (.+)$/gm, '<strong style="font-size:1em;display:block;margin-top:0.5em;">$1</strong>')
        .replace(/^## (.+)$/gm, '<strong style="font-size:1.05em;display:block;margin-top:0.75em;">$1</strong>')
        .replace(/^# (.+)$/gm, '<strong style="font-size:1.1em;display:block;margin-top:1em;">$1</strong>')
        .replace(/^- (.+)$/gm, '&bull; $1')
        .replace(/^(\d+)\. (.+)$/gm, '$1. $2')
        .replace(/\n/g, '<br>');
}

function escHtml(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

// Auto-resize textarea
document.getElementById('chatInput').addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INSIGHTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadInsights() {
    try {
        const sev = document.getElementById('severityFilter').value;
        let url = '/api/ai/insights?limit=100';
        if (currentCategory !== 'all') url += '&category=' + currentCategory;
        if (sev) url += '&severity=' + sev;

        const resp = await fetch(url, { headers });
        const data = await resp.json();
        const grid = document.getElementById('insightsGrid');
        const empty = document.getElementById('insightsEmpty');
        grid.innerHTML = '';

        if (!data.data || !data.data.length) {
            empty.style.display = '';
            return;
        }
        empty.style.display = 'none';

        data.data.forEach(i => {
            const card = document.createElement('div');
            card.className = `insight-card severity-${i.severity}${i.is_read ? ' is-read' : ''}`;
            card.innerHTML = `
                <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:0.5rem;">
                    <div style="display:flex;gap:0.5rem;align-items:center;">
                        <span class="severity-badge ${i.severity}">${i.severity}</span>
                        <span style="font-size:0.6875rem;color:#9ca3af;">${i.category}</span>
                    </div>
                    <div style="display:flex;gap:0.25rem;">
                        ${!i.is_read ? `<button onclick="markInsightRead(${i.id}, this)" style="border:none;background:none;cursor:pointer;font-size:0.75rem;color:#6b7280;" title="Mark read">&#10003;</button>` : ''}
                        <button onclick="dismissInsight(${i.id}, this)" style="border:none;background:none;cursor:pointer;font-size:0.875rem;color:#9ca3af;" title="Dismiss">&times;</button>
                    </div>
                </div>
                <div style="font-weight:600;font-size:0.875rem;color:#1f2937;margin-bottom:0.375rem;">${escHtml(i.title)}</div>
                <div style="font-size:0.8125rem;color:#4b5563;margin-bottom:0.5rem;">${escHtml(i.description || '')}</div>
                ${i.action_recommended ? `<div style="font-size:0.8125rem;color:#667eea;font-weight:500;">&#x27A4; ${escHtml(i.action_recommended)}</div>` : ''}
                <div style="font-size:0.6875rem;color:#9ca3af;margin-top:0.5rem;">${new Date(i.created_at).toLocaleString('en-IN')}</div>`;
            grid.appendChild(card);
        });
    } catch (e) { /* ignore */ }

    loadInsightsSummary();
}

function filterInsights(category, btn) {
    currentCategory = category;
    document.querySelectorAll('.category-pill').forEach(p => p.classList.remove('active'));
    if (btn) btn.classList.add('active');
    loadInsights();
}

async function markInsightRead(id, btn) {
    await fetch(`/api/ai/insights/${id}/read`, { method: 'PUT', headers });
    btn.closest('.insight-card').classList.add('is-read');
    btn.remove();
    loadInsightsSummary();
}

async function dismissInsight(id, btn) {
    await fetch(`/api/ai/insights/${id}/dismiss`, { method: 'PUT', headers });
    btn.closest('.insight-card').remove();
    loadInsightsSummary();
}

async function markAllRead() {
    const body = currentCategory !== 'all' ? { category: currentCategory } : {};
    await fetch('/api/ai/insights/read-all', { method: 'POST', headers, body: JSON.stringify(body) });
    loadInsights();
}

async function loadInsightsSummary() {
    try {
        const resp = await fetch('/api/ai/insights/summary', { headers });
        const data = await resp.json();
        const badge = document.getElementById('insightsBadge');
        if (data.total > 0) {
            badge.style.display = '';
            badge.textContent = data.total > 99 ? '99+' : data.total;
        } else {
            badge.style.display = 'none';
        }
    } catch (e) { /* ignore */ }
}

async function triggerAnalysis(type, btn) {
    btn.classList.add('running');
    btn.textContent = 'Running...';
    try {
        await fetch('/api/ai/analysis/run', {
            method: 'POST', headers,
            body: JSON.stringify({ type })
        });
        // Show toast
        showToast('Analysis started: ' + type.replace(/_/g, ' '));
        // Reload insights after a delay
        setTimeout(() => {
            loadInsights();
            btn.classList.remove('running');
            btn.textContent = btn.textContent.replace('Running...', 'Run ' + type.split('_').map(w => w[0].toUpperCase() + w.slice(1)).join(' '));
        }, 3000);
    } catch (e) {
        btn.classList.remove('running');
        showToast('Failed to start analysis', 'error');
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SUGGESTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentSugCategory = 'all';

async function loadSuggestions() {
    try {
        const status = document.getElementById('sugStatusFilter').value;
        let url = '/api/ai/suggestions?limit=100';
        if (currentSugCategory !== 'all') url += '&category=' + currentSugCategory;
        if (status) url += '&status=' + status;

        const resp = await fetch(url, { headers });
        const data = await resp.json();
        const grid = document.getElementById('suggestionsGrid');
        const empty = document.getElementById('suggestionsEmpty');
        grid.innerHTML = '';

        if (!data.data || !data.data.length) {
            empty.style.display = '';
            return;
        }
        empty.style.display = 'none';

        data.data.forEach(s => {
            const card = document.createElement('div');
            card.className = `sug-card priority-${s.priority}`;
            card.id = 'sug-' + s.id;

            const statusOptions = ['new','acknowledged','in_progress','implemented','dismissed'];
            const statusBtns = statusOptions.map(st =>
                `<button class="sug-status-btn${s.status === st ? ' active' : ''}" onclick="updateSuggestionStatus(${s.id}, '${st}', this)">${st.replace(/_/g, ' ')}</button>`
            ).join('');

            card.innerHTML = `
                <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:0.5rem;">
                    <div style="display:flex;gap:0.5rem;align-items:center;">
                        <span class="priority-badge ${s.priority}">${s.priority}</span>
                        <span style="font-size:0.6875rem;color:#9ca3af;">${s.category}</span>
                        <span style="font-size:0.6875rem;color:#9ca3af;background:#f3f4f6;padding:1px 6px;border-radius:4px;">${s.source}</span>
                    </div>
                </div>
                <div style="font-weight:600;font-size:0.875rem;color:#1f2937;margin-bottom:0.375rem;">${escHtml(s.suggestion)}</div>
                ${s.reasoning ? `<div style="font-size:0.8125rem;color:#4b5563;margin-bottom:0.5rem;">${escHtml(s.reasoning)}</div>` : ''}
                <div style="display:flex;gap:0.25rem;flex-wrap:wrap;margin-top:0.5rem;">${statusBtns}</div>
                <div style="font-size:0.6875rem;color:#9ca3af;margin-top:0.5rem;">${new Date(s.created_at).toLocaleString('en-IN')}</div>`;
            grid.appendChild(card);
        });
    } catch (e) { /* ignore */ }

    loadSuggestionsSummary();
}

function filterSuggestions(category, btn) {
    currentSugCategory = category;
    document.querySelectorAll('#tab-suggestions .category-pill').forEach(p => p.classList.remove('active'));
    if (btn) btn.classList.add('active');
    loadSuggestions();
}

async function updateSuggestionStatus(id, status, btn) {
    try {
        await fetch(`/api/ai/suggestions/${id}`, {
            method: 'PUT', headers,
            body: JSON.stringify({ status })
        });
        // Update UI: highlight clicked button, unhighlight others
        const card = document.getElementById('sug-' + id);
        if (card) {
            card.querySelectorAll('.sug-status-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }
        loadSuggestionsSummary();
        showToast('Status updated');
    } catch (e) {
        showToast('Failed to update', 'error');
    }
}

async function loadSuggestionsSummary() {
    try {
        const resp = await fetch('/api/ai/suggestions/summary', { headers });
        const data = await resp.json();
        const badge = document.getElementById('suggestionsBadge');
        const newCount = data.by_status?.new || 0;
        if (newCount > 0) {
            badge.style.display = '';
            badge.textContent = newCount > 99 ? '99+' : newCount;
        } else {
            badge.style.display = 'none';
        }
    } catch (e) { /* ignore */ }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SETTINGS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadSettings() {
    try {
        // Load config
        const cfgResp = await fetch('/api/ai/config', { headers });
        const cfg = await cfgResp.json();

        // API Keys ‚Äî server returns masked version (‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢xxxx)
        document.getElementById('cfgGeminiKey').value = cfg.gemini_api_key || '';
        document.getElementById('cfgGeminiKey').dataset.hasKey = cfg.gemini_api_key ? '1' : '0';
        document.getElementById('cfgClaudeKey').value = cfg.anthropic_api_key || '';
        document.getElementById('cfgClaudeKey').dataset.hasKey = cfg.anthropic_api_key ? '1' : '0';

        // Models
        if (cfg.gemini_model) document.getElementById('cfgGeminiModel').value = cfg.gemini_model;
        if (cfg.claude_model) document.getElementById('cfgClaudeModel').value = cfg.claude_model;

        // Provider settings
        document.getElementById('cfgPrimary').value = cfg.primary_provider || 'gemini';
        document.getElementById('cfgFallback').value = cfg.fallback_provider || 'claude';
        document.getElementById('cfgTemp').value = cfg.temperature || '0.3';
        document.getElementById('cfgMaxTokens').value = cfg.max_tokens_per_request || '4096';
        document.getElementById('cfgChatMaxTokens').value = cfg.chat_max_tokens || '8192';
        document.getElementById('cfgChatTemp').value = cfg.chat_temperature || '0.5';
        document.getElementById('cfgDailySnapshot').checked = cfg.daily_snapshot_enabled === '1';
        document.getElementById('cfgZohoDaily').checked = cfg.zoho_daily_enabled === '1';
        document.getElementById('cfgStaffDaily').checked = cfg.staff_daily_enabled === '1';
        document.getElementById('cfgLeadScoring').checked = cfg.lead_scoring_enabled === '1';
        document.getElementById('cfgMarketing').checked = cfg.marketing_weekly_enabled === '1';
        document.getElementById('cfgWhatsApp').checked = cfg.whatsapp_reports_enabled === '1';
        document.getElementById('cfgRecipients').value = cfg.whatsapp_report_recipients || '';

        // Load stats
        const statsResp = await fetch('/api/ai/stats', { headers });
        const stats = await statsResp.json();

        document.getElementById('statRuns').textContent = stats.analysis?.total_runs || 0;
        document.getElementById('statTokens').textContent = formatNumber(stats.analysis?.total_tokens + stats.chat?.chat_tokens || 0);
        document.getElementById('statInsights').textContent = stats.insights?.total_insights || 0;
        document.getElementById('statMessages').textContent = stats.chat?.total_messages || 0;
        document.getElementById('statCost').textContent = '$' + (stats.estimated_cost_usd || '0.00');

        // Recent runs
        const runsHtml = (stats.recent_runs || []).map(r => {
            const statusColor = r.status === 'completed' ? '#10b981' : r.status === 'failed' ? '#ef4444' : '#f59e0b';
            return `<div class="config-row">
                <div>
                    <div class="config-label">${r.analysis_type.replace(/_/g, ' ')}</div>
                    <div class="config-desc">${new Date(r.created_at).toLocaleString('en-IN')}</div>
                </div>
                <div style="display:flex;gap:0.75rem;align-items:center;">
                    <span style="font-size:0.75rem;color:#6b7280;">${r.tokens_used} tokens</span>
                    <span style="font-size:0.75rem;color:#6b7280;">${r.duration_ms ? (r.duration_ms/1000).toFixed(1)+'s' : '-'}</span>
                    <span style="color:${statusColor};font-weight:600;font-size:0.75rem;">${r.status}</span>
                </div>
            </div>`;
        }).join('');
        document.getElementById('recentRuns').innerHTML = runsHtml || '<p style="color:#9ca3af;padding:1rem;">No runs yet</p>';

    } catch (e) {
        console.error('Failed to load settings:', e);
    }
}

async function refreshSnapshot(btn) {
    btn.classList.add('running');
    btn.textContent = 'Refreshing...';
    try {
        await fetch('/api/ai/context/refresh', { method: 'POST', headers });
        showToast('Business snapshot refreshed');
    } catch (e) {
        showToast('Failed to refresh snapshot', 'error');
    }
    btn.classList.remove('running');
    btn.textContent = 'Refresh';
}

async function saveConfig(key, value) {
    try {
        await fetch('/api/ai/config', {
            method: 'PUT', headers,
            body: JSON.stringify({ [key]: value })
        });
        showToast('Setting saved');
    } catch (e) {
        showToast('Failed to save setting', 'error');
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// API KEY HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function maskKey(key) {
    if (!key) return '';
    if (key.startsWith('‚Ä¢‚Ä¢‚Ä¢‚Ä¢')) return key; // already masked from server
    return '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' + key.slice(-4);
}

function toggleKeyVisibility(inputId, btn) {
    const input = document.getElementById(inputId);
    if (input.type === 'password') {
        input.type = 'text';
        btn.textContent = 'üôà';
        btn.title = 'Hide';
    } else {
        input.type = 'password';
        btn.textContent = 'üëÅ';
        btn.title = 'Show';
    }
}

function saveApiKey(configKey, inputId) {
    const input = document.getElementById(inputId);
    const value = input.value.trim();
    // Don't save if it's the masked placeholder
    if (!value || value.startsWith('‚Ä¢‚Ä¢‚Ä¢‚Ä¢')) {
        showToast('Enter a new API key first', 'error');
        return;
    }
    saveConfig(configKey, value);
    // Re-mask after save
    input.value = maskKey(value);
    input.dataset.hasKey = '1';
    input.type = 'password';
}

// Clear masked value on focus so user can type a new key
document.addEventListener('DOMContentLoaded', function() {
    ['cfgGeminiKey', 'cfgClaudeKey'].forEach(function(id) {
        var el = document.getElementById(id);
        if (el) {
            el.addEventListener('focus', function() {
                if (this.value.startsWith('‚Ä¢‚Ä¢‚Ä¢‚Ä¢')) {
                    this.value = '';
                    this.type = 'text'; // show what they're typing
                }
            });
        }
    });
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// APP ANALYZER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let lastScanData = null;

async function runAppScan() {
    const btn = document.getElementById('scanAppBtn');
    const spinner = document.getElementById('scanSpinner');
    btn.disabled = true;
    spinner.style.display = '';

    try {
        const resp = await fetch('/api/ai/app-scan', { headers });
        const data = await resp.json();
        if (data.error) throw new Error(data.error);
        lastScanData = data;
        document.getElementById('scanTimestamp').textContent = 'Scanned: ' + new Date(data.timestamp).toLocaleString('en-IN') + (data.cached ? ' (cached)' : '') + ' ‚Äî ' + data.duration_ms + 'ms';
        document.getElementById('scanResults').style.display = '';
        renderScanResults(data);
    } catch (e) {
        showToast('Scan failed: ' + e.message, 'error');
    }

    btn.disabled = false;
    spinner.style.display = 'none';
}

function renderScanResults(data) {
    // Database
    if (data.database && !data.database.error) {
        const db = data.database;
        const issueCount = db.totalIssues || 0;
        document.getElementById('dbStats').textContent = db.totalTables + ' tables, ' + issueCount + ' issues';
        document.getElementById('dbStats').className = 'scan-badge ' + (issueCount > 5 ? 'warn' : 'ok');

        let html = '<table class="scan-table"><thead><tr><th>Table</th><th>Rows</th><th>Columns</th><th>Indexes</th><th>Issues</th></tr></thead><tbody>';
        db.tables.forEach(t => {
            const issueHtml = t.issues.length ? '<span style="color:#f59e0b;font-weight:600">' + t.issues.length + '</span>' : '<span style="color:#10b981">0</span>';
            html += '<tr><td style="font-weight:500">' + escHtml(t.name) + '</td><td>' + (t.rowCount || 0).toLocaleString() + '</td><td>' + t.columns.length + '</td><td>' + t.indexes.length + '</td><td>' + issueHtml + '</td></tr>';
        });
        html += '</tbody></table>';

        // Show issues with Generate Fix buttons
        const allIssues = db.tables.flatMap(t => t.issues.map(i => ({ ...i, table: t.name })));
        if (allIssues.length > 0) {
            html += '<h4 style="margin:1rem 0 0.5rem;font-size:0.8125rem;font-weight:600;color:#1f2937;">Detected Issues</h4>';
            allIssues.forEach(i => {
                html += '<div class="scan-issue ' + (i.severity || 'warning') + '">' +
                    '<div style="flex:1"><strong>' + escHtml(i.table) + '</strong>: ' + escHtml(i.message) + '</div>' +
                    '<button class="run-btn" style="padding:3px 8px;font-size:0.6875rem;white-space:nowrap" onclick="generateFixPrompt(\'' + escAttr(i.table + ': ' + i.message) + '\')">Generate Fix</button>' +
                    '</div>';
            });
        }
        document.getElementById('bodyDatabase').innerHTML = html;
    }

    // Routes
    if (data.routes && !data.routes.error) {
        const rt = data.routes;
        document.getElementById('routeStats').textContent = rt.totalCount + ' endpoints';
        document.getElementById('routeStats').className = 'scan-badge ok';

        let html = '<div style="display:flex;gap:1rem;margin-bottom:1rem;flex-wrap:wrap;">';
        Object.entries(rt.byMethod || {}).forEach(([method, count]) => {
            const colors = { GET: '#3b82f6', POST: '#10b981', PUT: '#f59e0b', DELETE: '#ef4444' };
            html += '<div style="padding:0.375rem 0.75rem;border-radius:8px;background:' + (colors[method] || '#6b7280') + '15;color:' + (colors[method] || '#6b7280') + ';font-weight:600;font-size:0.8125rem;">' + method + ': ' + count + '</div>';
        });
        html += '</div>';

        html += '<table class="scan-table"><thead><tr><th>Method</th><th>Path</th><th>File</th></tr></thead><tbody>';
        rt.routes.slice(0, 100).forEach(r => {
            const colors = { GET: '#3b82f6', POST: '#10b981', PUT: '#f59e0b', DELETE: '#ef4444' };
            html += '<tr><td><span style="color:' + (colors[r.method] || '#6b7280') + ';font-weight:600;font-size:0.75rem">' + r.method + '</span></td><td style="font-family:monospace;font-size:0.75rem">' + escHtml(r.path) + '</td><td style="color:#6b7280;font-size:0.75rem">' + escHtml(r.file) + '</td></tr>';
        });
        if (rt.routes.length > 100) html += '<tr><td colspan="3" style="color:#9ca3af;text-align:center">... and ' + (rt.routes.length - 100) + ' more</td></tr>';
        html += '</tbody></table>';
        document.getElementById('bodyRoutes').innerHTML = html;
    }

    // Errors
    if (data.errors && !data.errors.error) {
        const er = data.errors;
        const errCount = er.totalUniqueErrors || 0;
        document.getElementById('errorStats').textContent = errCount + ' unique errors';
        document.getElementById('errorStats').className = 'scan-badge ' + (errCount > 10 ? 'err' : errCount > 0 ? 'warn' : 'ok');

        let html = '';
        if (er.errors.length === 0) {
            html = '<p style="color:#10b981;font-weight:600;font-size:0.875rem;">No recent errors detected</p>';
        } else {
            html = '<table class="scan-table"><thead><tr><th>Error</th><th>Count</th><th>Last Seen</th><th></th></tr></thead><tbody>';
            er.errors.slice(0, 30).forEach(e => {
                html += '<tr><td style="font-family:monospace;font-size:0.75rem;max-width:500px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="' + escAttr(e.message) + '">' + escHtml(e.message.substring(0, 120)) + '</td><td style="font-weight:600;color:#ef4444">' + e.count + '</td><td style="font-size:0.75rem;color:#6b7280">' + (e.lastSeen ? new Date(e.lastSeen).toLocaleString('en-IN') : '-') + '</td><td><button class="run-btn" style="padding:2px 6px;font-size:0.625rem" onclick="generateFixPrompt(\'' + escAttr('Error: ' + e.message.substring(0, 200)) + '\')">Fix</button></td></tr>';
            });
            html += '</tbody></table>';
        }
        document.getElementById('bodyErrors').innerHTML = html;
    }

    // Health
    if (data.health && !data.health.error) {
        const h = data.health;
        document.getElementById('healthStats').textContent = h.dbConnected ? 'Healthy' : 'DB Down';
        document.getElementById('healthStats').className = 'scan-badge ' + (h.dbConnected ? 'ok' : 'err');

        let html = '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;">';
        html += '<div><div style="font-size:0.75rem;color:#6b7280;margin-bottom:2px">Memory (RSS)</div><div style="font-weight:600">' + h.memory.rss + '</div></div>';
        html += '<div><div style="font-size:0.75rem;color:#6b7280;margin-bottom:2px">Heap Used</div><div style="font-weight:600">' + h.memory.heapUsed + ' / ' + h.memory.heapTotal + '</div></div>';
        html += '<div><div style="font-size:0.75rem;color:#6b7280;margin-bottom:2px">Uptime</div><div style="font-weight:600">' + h.uptime.formatted + '</div></div>';
        html += '<div><div style="font-size:0.75rem;color:#6b7280;margin-bottom:2px">Node</div><div style="font-weight:600">' + h.nodeVersion + '</div></div>';
        html += '<div><div style="font-size:0.75rem;color:#6b7280;margin-bottom:2px">OS Memory</div><div style="font-weight:600">' + h.os.freeMem + ' free / ' + h.os.totalMem + '</div></div>';
        html += '<div><div style="font-size:0.75rem;color:#6b7280;margin-bottom:2px">CPUs</div><div style="font-weight:600">' + h.os.cpus + '</div></div>';
        html += '<div><div style="font-size:0.75rem;color:#6b7280;margin-bottom:2px">Load Avg</div><div style="font-weight:600">' + h.os.loadAvg.join(', ') + '</div></div>';
        html += '<div><div style="font-size:0.75rem;color:#6b7280;margin-bottom:2px">Database</div><div style="font-weight:600;color:' + (h.dbConnected ? '#10b981' : '#ef4444') + '">' + (h.dbConnected ? 'Connected' : 'Disconnected') + '</div></div>';
        html += '</div>';
        document.getElementById('bodyHealth').innerHTML = html;
    }

    // Business
    if (data.business && !data.business.error) {
        const biz = data.business;
        const total = Object.values(biz.counts).reduce((s, v) => s + (v > 0 ? v : 0), 0);
        document.getElementById('bizStats').textContent = total.toLocaleString() + ' total records';
        document.getElementById('bizStats').className = 'scan-badge ok';

        let html = '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:1rem;margin-bottom:1rem;">';
        Object.entries(biz.counts).forEach(([key, val]) => {
            html += '<div style="text-align:center;padding:0.75rem;background:#f9fafb;border-radius:8px;"><div style="font-size:1.25rem;font-weight:700;color:#667eea">' + (val >= 0 ? val.toLocaleString() : 'N/A') + '</div><div style="font-size:0.6875rem;color:#6b7280;margin-top:2px">' + key.replace(/_/g, ' ') + '</div></div>';
        });
        html += '</div>';

        if (biz.largeTables && biz.largeTables.length > 0) {
            html += '<h4 style="font-size:0.8125rem;font-weight:600;color:#1f2937;margin-bottom:0.5rem;">Largest Tables</h4>';
            html += '<table class="scan-table"><thead><tr><th>Table</th><th>Rows</th></tr></thead><tbody>';
            biz.largeTables.forEach(t => {
                html += '<tr><td>' + escHtml(t.name) + '</td><td>' + t.rowCount.toLocaleString() + '</td></tr>';
            });
            html += '</tbody></table>';
        }
        document.getElementById('bodyBusiness').innerHTML = html;
    }
}

function toggleScanSection(id) {
    const header = document.querySelector('#sec' + id + ' .scan-section-header');
    const body = document.getElementById('body' + id);
    const chevron = header.querySelector('.chevron');
    const isOpen = body.classList.contains('open');
    body.classList.toggle('open');
    header.classList.toggle('open');
    if (chevron) chevron.style.transform = isOpen ? '' : 'rotate(180deg)';
}

async function runAIAnalysis() {
    if (!lastScanData) { showToast('Run a scan first', 'error'); return; }
    const focus = document.getElementById('analysisFocus').value;
    const btn = document.getElementById('aiAnalyzeBtn');
    const output = document.getElementById('analysisOutput');

    btn.disabled = true;
    btn.textContent = 'Analyzing...';
    output.style.display = '';
    output.innerHTML = '<div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>';

    try {
        const resp = await fetch('/api/ai/app-analyze', {
            method: 'POST', headers,
            body: JSON.stringify({ scanData: lastScanData, focus })
        });

        const reader = resp.body.getReader();
        const decoder = new TextDecoder();
        let fullText = '';
        let buffer = '';

        output.innerHTML = '';

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            buffer += decoder.decode(value, { stream: true });
            const lines = buffer.split('\n');
            buffer = lines.pop();

            for (const line of lines) {
                if (line.startsWith('data: ')) {
                    try {
                        const event = JSON.parse(line.slice(6));
                        if (event.type === 'done') {
                            output.innerHTML += '<div style="margin-top:1rem;padding-top:0.75rem;border-top:1px solid #e5e7eb;font-size:0.6875rem;color:#9ca3af;">Model: ' + escHtml(event.model || '') + ' | Tokens: ' + (event.tokens || 0) + '</div>';
                        } else if (event.type === 'error') {
                            output.innerHTML += '<div style="color:#ef4444;font-weight:600;">Error: ' + escHtml(event.error) + '</div>';
                        } else if (event.text) {
                            fullText += event.text;
                            output.innerHTML = renderAnalysisMarkdown(fullText);
                            output.scrollTop = output.scrollHeight;
                        }
                    } catch (e) { /* skip */ }
                }
            }
        }

        // Post-process: add copy buttons to code blocks
        addCopyButtons(output);

    } catch (e) {
        output.innerHTML = '<div style="color:#ef4444">Error: ' + escHtml(e.message) + '</div>';
    }

    btn.disabled = false;
    btn.textContent = 'Run AI Analysis';
}

async function generateFixPrompt(issueText) {
    showToast('Generating fix prompt...');
    try {
        const resp = await fetch('/api/ai/generate-prompt', {
            method: 'POST', headers,
            body: JSON.stringify({ type: 'fix', description: issueText, context: lastScanData ? JSON.stringify({ tables: (lastScanData.database?.tables || []).map(t => t.name).join(', '), routes: lastScanData.routes?.totalCount || 0 }) : '' })
        });
        const data = await resp.json();
        if (data.error) throw new Error(data.error);

        // Show in analysis output
        const output = document.getElementById('analysisOutput');
        output.style.display = '';
        output.innerHTML = '<div style="margin-bottom:0.5rem;font-size:0.75rem;color:#6b7280;">Fix prompt for: ' + escHtml(issueText) + '</div>' +
            '<pre style="background:#1f2937;color:#e5e7eb;padding:1rem;border-radius:8px;white-space:pre-wrap;position:relative;">' + escHtml(data.prompt) + '</pre>' +
            '<div style="font-size:0.6875rem;color:#9ca3af;margin-top:0.5rem;">Model: ' + escHtml(data.model || '') + ' | Tokens: ' + (data.tokens || 0) + '</div>';
        addCopyButtons(output);
        output.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    } catch (e) {
        showToast('Failed: ' + e.message, 'error');
    }
}

async function generateUpgrades() {
    if (!lastScanData) { showToast('Run a scan first', 'error'); return; }
    const btn = document.getElementById('upgradeBtn');
    btn.disabled = true;
    btn.textContent = 'Generating...';

    try {
        const summaryContext = JSON.stringify({
            tables: (lastScanData.database?.tables || []).map(t => ({ name: t.name, rows: t.rowCount })),
            routeCount: lastScanData.routes?.totalCount,
            entities: lastScanData.business?.counts,
            health: lastScanData.health
        });

        const resp = await fetch('/api/ai/generate-prompt', {
            method: 'POST', headers,
            body: JSON.stringify({ type: 'upgrade', description: summaryContext, context: 'This is a paint shop business management app with modules for: staff/attendance, leads, products/inventory, estimates, collections, WhatsApp integration, AI analytics, painter loyalty program.' })
        });
        const data = await resp.json();
        if (data.error) throw new Error(data.error);

        const output = document.getElementById('analysisOutput');
        output.style.display = '';
        output.innerHTML = renderAnalysisMarkdown(data.prompt);
        addCopyButtons(output);
        output.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    } catch (e) {
        showToast('Failed: ' + e.message, 'error');
    }

    btn.disabled = false;
    btn.textContent = 'Upgrade Suggestions';
}

async function generateCustomPrompt() {
    const input = document.getElementById('customPromptInput');
    const text = input.value.trim();
    if (!text) { showToast('Describe what you want to build', 'error'); return; }

    const btn = document.getElementById('customPromptBtn');
    const output = document.getElementById('customPromptOutput');
    btn.disabled = true;
    btn.textContent = 'Generating...';
    output.style.display = '';
    output.textContent = 'Generating implementation prompt...';

    try {
        const resp = await fetch('/api/ai/generate-prompt', {
            method: 'POST', headers,
            body: JSON.stringify({
                type: 'custom',
                description: text,
                context: lastScanData ? JSON.stringify({
                    tables: (lastScanData.database?.tables || []).map(t => t.name).join(', '),
                    routeCount: lastScanData.routes?.totalCount,
                    entities: lastScanData.business?.counts
                }) : ''
            })
        });
        const data = await resp.json();
        if (data.error) throw new Error(data.error);

        output.innerHTML = escHtml(data.prompt) + '<button class="copy-prompt-btn" onclick="copyPrompt(this.parentElement)" style="position:absolute;top:8px;right:8px;">Copy</button>';
        output.style.position = 'relative';
    } catch (e) {
        output.textContent = 'Error: ' + e.message;
    }

    btn.disabled = false;
    btn.textContent = 'Generate Prompt';
}

function copyPrompt(el) {
    const text = el.innerText.replace(/\nCopy$/, '').trim();
    navigator.clipboard.writeText(text).then(() => showToast('Copied to clipboard')).catch(() => {
        // Fallback
        const ta = document.createElement('textarea');
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        ta.remove();
        showToast('Copied to clipboard');
    });
}

function addCopyButtons(container) {
    container.querySelectorAll('pre').forEach(pre => {
        if (pre.querySelector('.copy-prompt-btn')) return;
        const btn = document.createElement('button');
        btn.className = 'copy-prompt-btn';
        btn.textContent = 'Copy';
        btn.onclick = function() { copyPrompt(pre); };
        pre.style.position = 'relative';
        pre.appendChild(btn);
    });
}

function renderAnalysisMarkdown(text) {
    // Enhanced markdown for analysis output with code blocks
    let html = escHtml(text);

    // Code blocks (```...```)
    html = html.replace(/```(\w*)\n([\s\S]*?)```/g, function(match, lang, code) {
        return '<pre style="background:#1f2937;color:#e5e7eb;padding:1rem;border-radius:8px;white-space:pre-wrap;position:relative;margin:0.75rem 0;">' + code.trim() + '</pre>';
    });

    // Inline formatting
    html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.+?)\*/g, '<em>$1</em>')
        .replace(/`([^`]+)`/g, '<code style="background:#e5e7eb;padding:1px 4px;border-radius:3px;font-size:0.8em;">$1</code>')
        .replace(/^### (.+)$/gm, '<strong style="font-size:1em;display:block;margin-top:0.75em;color:#1f2937;">$1</strong>')
        .replace(/^## (.+)$/gm, '<strong style="font-size:1.05em;display:block;margin-top:1em;color:#1f2937;">$1</strong>')
        .replace(/^# (.+)$/gm, '<strong style="font-size:1.1em;display:block;margin-top:1.25em;color:#1f2937;">$1</strong>')
        .replace(/^- (.+)$/gm, '&bull; $1')
        .replace(/^(\d+)\. (.+)$/gm, '$1. $2')
        .replace(/\n/g, '<br>');

    return html;
}

function escAttr(str) {
    return str.replace(/'/g, "\\'").replace(/"/g, '&quot;').replace(/\n/g, ' ');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTILITIES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function formatNumber(n) {
    if (n >= 1000000) return (n/1000000).toFixed(1) + 'M';
    if (n >= 1000) return (n/1000).toFixed(1) + 'K';
    return String(n);
}

function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.style.cssText = `position:fixed;bottom:2rem;right:2rem;padding:0.75rem 1.25rem;border-radius:10px;font-size:0.8125rem;font-weight:600;z-index:10000;animation:slideIn 0.3s ease;color:white;background:${type==='error'?'#ef4444':'#10b981'};box-shadow:0 4px 12px rgba(0,0,0,0.15);`;
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => { toast.style.opacity = '0'; toast.style.transition = 'opacity 0.3s'; setTimeout(() => toast.remove(), 300); }, 2500);
}

// Socket.io for real-time updates
if (window.qcSocket) {
    window.qcSocket.emit('join_room', 'ai_dashboard');
    window.qcSocket.on('analysis_complete', function(data) {
        showToast('Analysis completed: ' + data.type.replace(/_/g, ' '));
        loadInsights();
        // Reset run button
        const btnMap = { zoho_daily: 'runZoho', staff_daily: 'runStaff', lead_scoring: 'runLeads', marketing_tips: 'runMarketing' };
        const btn = document.getElementById(btnMap[data.type]);
        if (btn) { btn.classList.remove('running'); }
    });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DASHBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let revenueTrendChart = null;
let branchCompareChart = null;
let dashRefreshTimer = null;

function formatINR(n) {
    n = Number(n) || 0;
    if (n >= 10000000) return '\u20B9' + (n/10000000).toFixed(1) + 'Cr';
    if (n >= 100000) return '\u20B9' + (n/100000).toFixed(1) + 'L';
    if (n >= 1000) return '\u20B9' + (n/1000).toFixed(1) + 'K';
    return '\u20B9' + n.toFixed(0);
}

function changeClass(pct) {
    return pct > 0 ? 'up' : pct < 0 ? 'down' : 'neutral';
}

function changeArrow(pct) {
    return pct > 0 ? '\u2191' : pct < 0 ? '\u2193' : '';
}

async function loadDashboard() {
    try {
        const resp = await fetch('/api/ai/dashboard', { headers });
        const json = await resp.json();
        if (!json.success) throw new Error(json.error || 'Failed');
        const d = json.data;
        renderKPIs(d.kpis);
        renderDashInsights(d.topInsights);
        renderBranchScorecard(d.branchScorecard);
        renderRevenueTrendChart(d.revenueTrend);
        renderBranchCompareChart(d.branchScorecard);
    } catch (e) {
        console.error('[Dashboard]', e);
    }

    // Auto-refresh every 60s
    clearInterval(dashRefreshTimer);
    dashRefreshTimer = setInterval(() => {
        if (document.getElementById('tab-dashboard').style.display !== 'none') {
            loadDashboard();
        } else {
            clearInterval(dashRefreshTimer);
        }
    }, 60000);
}

function renderKPIs(k) {
    document.getElementById('kpiTodayRev').textContent = formatINR(k.todayRevenue);
    const rc = k.revenueChange;
    const rcEl = document.getElementById('kpiRevChange');
    rcEl.className = 'kpi-change ' + changeClass(rc);
    rcEl.textContent = changeArrow(rc) + ' ' + Math.abs(rc).toFixed(1) + '% vs yesterday' + (k.yesterdayRevenue > 0 ? ' (' + formatINR(k.yesterdayRevenue) + ')' : '');

    document.getElementById('kpiMonthRev').textContent = formatINR(k.monthRevenue);
    const mc = k.lastMonthRevenue > 0 ? ((k.monthRevenue - k.lastMonthRevenue) / k.lastMonthRevenue * 100) : 0;
    const mSub = document.getElementById('kpiMonthSub');
    mSub.className = 'kpi-sub';
    mSub.innerHTML = '<span class="kpi-change ' + changeClass(mc) + '" style="font-size:0.6875rem">' + changeArrow(mc) + ' ' + Math.abs(mc).toFixed(1) + '%</span> vs last month (' + formatINR(k.lastMonthRevenue) + ')';

    document.getElementById('kpiCollections').textContent = formatINR(k.todayCollections);
    document.getElementById('kpiCollSub').textContent = 'Collected today';

    document.getElementById('kpiOverdue').textContent = formatINR(k.totalOverdue);
    document.getElementById('kpiOverdue').style.color = k.totalOverdue > 0 ? '#ef4444' : '#10b981';
    document.getElementById('kpiOverdueSub').textContent = k.overdueCount + ' invoices | 1-30d: ' + formatINR(k.overdueAgeing.days_1_30) + ', 31-60d: ' + formatINR(k.overdueAgeing.days_31_60);

    const staffPct = k.staffTotal > 0 ? Math.round(k.staffPresent / k.staffTotal * 100) : 0;
    document.getElementById('kpiStaff').textContent = k.staffPresent + '/' + k.staffTotal;
    document.getElementById('kpiStaff').style.color = staffPct >= 80 ? '#10b981' : staffPct >= 50 ? '#f59e0b' : '#ef4444';
    document.getElementById('kpiStaffSub').textContent = staffPct + '% present' + (k.activeLeads > 0 ? ' | ' + k.activeLeads + ' active leads' : '');

    document.getElementById('kpiStock').textContent = k.outOfStock + ' out';
    document.getElementById('kpiStock').style.color = k.outOfStock > 0 ? '#ef4444' : '#10b981';
    document.getElementById('kpiStockSub').textContent = k.lowStock + ' low stock items';
}

function renderDashInsights(insights) {
    const panel = document.getElementById('dashInsightsPanel');
    if (!insights || !insights.length) {
        panel.innerHTML = '<div style="text-align:center; padding:1.5rem; color:#9ca3af; font-size:0.8125rem;">No unread insights</div>';
        return;
    }
    panel.innerHTML = insights.map(i => {
        const sev = i.severity || 'info';
        const sevIcon = sev === 'critical' ? '\uD83D\uDD34' : sev === 'high' ? '\uD83D\uDFE0' : sev === 'warning' ? '\uD83D\uDFE1' : sev === 'medium' ? '\uD83D\uDD35' : '\uD83D\uDFE2';
        return '<div class="dash-insight-item sev-' + sev + '" onclick="markInsightRead(' + i.id + ', null); this.style.opacity=0.5">' +
            '<div style="display:flex;align-items:center;gap:0.375rem;margin-bottom:0.25rem;">' +
            '<span style="font-size:0.625rem">' + sevIcon + '</span>' +
            '<span style="font-size:0.6875rem;font-weight:600;color:#1f2937;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">' + escHtml(i.title) + '</span>' +
            '<span style="font-size:0.5625rem;color:#9ca3af">' + escHtml(i.category || '') + '</span>' +
            '</div>' +
            '<div style="font-size:0.6875rem;color:#6b7280;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden">' + escHtml(i.description || '') + '</div>' +
            '</div>';
    }).join('');
}

function renderBranchScorecard(branches) {
    const el = document.getElementById('dashBranchScorecard');
    if (!branches || !branches.length) {
        el.innerHTML = '<div style="text-align:center; padding:1.5rem; color:#9ca3af; font-size:0.8125rem;">No branch data available</div>';
        return;
    }
    let html = '<table class="scorecard-table"><thead><tr>' +
        '<th>Branch</th><th style="text-align:right">Month Rev</th><th style="text-align:right">Change</th>' +
        '<th style="text-align:right">Collections</th><th style="text-align:right">Coll %</th>' +
        '<th style="text-align:center">Stock</th><th style="text-align:center">OOS</th>' +
        '</tr></thead><tbody>';
    branches.forEach(b => {
        const chgClass = changeClass(b.revenueChange);
        const collPct = b.collectionRate.toFixed(0);
        const collColor = b.collectionRate >= 80 ? '#10b981' : b.collectionRate >= 60 ? '#f59e0b' : '#ef4444';
        html += '<tr>' +
            '<td style="font-weight:600">' + escHtml(b.branch) + '</td>' +
            '<td style="text-align:right">' + formatINR(b.monthRevenue) + '</td>' +
            '<td style="text-align:right" class="kpi-change ' + chgClass + '">' + changeArrow(b.revenueChange) + ' ' + Math.abs(b.revenueChange).toFixed(1) + '%</td>' +
            '<td style="text-align:right">' + formatINR(b.monthCollections) + '</td>' +
            '<td style="text-align:right;color:' + collColor + ';font-weight:600">' + collPct + '%</td>' +
            '<td style="text-align:center">' + b.stockItems + '</td>' +
            '<td style="text-align:center;color:' + (b.outOfStock > 0 ? '#ef4444' : '#10b981') + ';font-weight:600">' + b.outOfStock + '</td>' +
            '</tr>';
    });
    html += '</tbody></table>';
    el.innerHTML = html;
}

function renderRevenueTrendChart(trend) {
    const ctx = document.getElementById('revenueTrendChart');
    if (!ctx) return;
    if (revenueTrendChart) revenueTrendChart.destroy();

    const labels = (trend || []).map(r => {
        const d = new Date(r.date);
        return d.getDate() + '/' + (d.getMonth() + 1);
    });
    const revenues = (trend || []).map(r => r.revenue);
    const collections = (trend || []).map(r => r.collections);

    revenueTrendChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels,
            datasets: [
                { label: 'Revenue', data: revenues, borderColor: '#667eea', backgroundColor: 'rgba(102,126,234,0.1)', fill: true, tension: 0.3, pointRadius: 2 },
                { label: 'Collections', data: collections, borderColor: '#22c55e', backgroundColor: 'rgba(34,197,94,0.1)', fill: true, tension: 0.3, pointRadius: 2 }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'top', labels: { boxWidth: 12, font: { size: 11 } } } },
            scales: {
                y: { beginAtZero: true, ticks: { callback: function(v) { return v >= 100000 ? (v/100000).toFixed(0) + 'L' : v >= 1000 ? (v/1000).toFixed(0) + 'K' : v; }, font: { size: 10 } } },
                x: { ticks: { font: { size: 10 }, maxRotation: 0 } }
            },
            interaction: { intersect: false, mode: 'index' }
        }
    });
}

function renderBranchCompareChart(branches) {
    const ctx = document.getElementById('branchCompareChart');
    if (!ctx) return;
    if (branchCompareChart) branchCompareChart.destroy();

    const labels = (branches || []).map(b => b.branch);
    const thisMonth = (branches || []).map(b => b.monthRevenue);
    const lastMonth = (branches || []).map(b => b.lastMonthRevenue);

    branchCompareChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels,
            datasets: [
                { label: 'This Month', data: thisMonth, backgroundColor: '#667eea' },
                { label: 'Last Month', data: lastMonth, backgroundColor: '#e2e8f0' }
            ]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'top', labels: { boxWidth: 12, font: { size: 11 } } } },
            scales: {
                x: { beginAtZero: true, ticks: { callback: function(v) { return v >= 100000 ? (v/100000).toFixed(0) + 'L' : v >= 1000 ? (v/1000).toFixed(0) + 'K' : v; }, font: { size: 10 } } },
                y: { ticks: { font: { size: 11 } } }
            }
        }
    });
}

function showChart(type, btn) {
    document.querySelectorAll('.chart-tab').forEach(t => t.classList.remove('active'));
    if (btn) btn.classList.add('active');
    document.getElementById('chartTrend').style.display = type === 'trend' ? '' : 'none';
    document.getElementById('chartBranch').style.display = type === 'branch' ? '' : 'none';
}

function dashQuerySend() {
    const input = document.getElementById('dashQueryInput');
    const msg = input.value.trim();
    if (!msg) return;
    input.value = '';
    // Switch to Chat tab and send
    document.getElementById('chatInput').value = msg;
    switchToTab('chat');
    sendMessage();
}

function dashQuickQuery(text) {
    document.getElementById('chatInput').value = text;
    switchToTab('chat');
    sendMessage();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
loadDashboard();
loadConversations();
loadInsightsSummary();
loadSuggestionsSummary();
</script>

<style>
@keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
</style>

</body>
</html>
